#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : XL-Parser
# Website     : http://le-tools.com/XL-Parser.html
# SourceForge : https://sourceforge.net/p/xl-parser
# GitHub      : https://github.com/arioux/XL-Parser
# Description : Part of the XL-Toolkit, XL-Parser provides a bunch of functions for data extraction and analysis.
# Creation    : 2016-07-15
# Modified    : 2017-08-12
my $VERSION   = '1.1';
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2016-2017 Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use Win32::API();
use Win32::GUI qw(CBN_EDITCHANGE WM_COMMAND);
use Win32::GUI::Grid;
use Win32::Clipboard;
use Win32::Process;
use Win32::DriveInfo;
use DateTime;
use DateTime::Format::Duration;
use DateTime::Format::Strptime;
use DateTime::TimeZone;
use Encode qw(encode);
use Params::Validate::PP;
use B::Hooks::EndOfScope::PP;
use B::Hooks::EndOfScope::PP::FieldHash;
use Extract::Regex; # This is a personal module
use LWP::UserAgent;
use DBI;
use Geo::IP;
use Excel::Writer::XLSX;
use JSON qw(encode_json decode_json);
use threads;
use threads::shared;
require "XL-ParserConfig.pl";
require "XL-ParserGraph.pl";
require "XL-ParserLang.pl";
require "XL-ParserExtract.pl";
require "XL-ParserAnalysis.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $REF_ARG      = \@ARGV;                                                     # If objects passed (using SendTo)
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser"; }
else                                             { $USERDIR = $PROGDIR;                                 }
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $CONFIG_FILE  = "$USERDIR\\XL-Parser.ini";                                  # Configuration file
my $URL_DOC      = "http://le-tools.com/XL-ParserDoc.html";                    # Online documentation
my %CONFIG       :shared;                                                      # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW        :shared;                                                      # Arrow pointer
my $HOURGLASS    :shared;                                                      # Hourglass pointer
my $THR_PROCESS;                                                               # Thread for process
my $THR;                                                                       # Thread
my $THR_UPDATE;                                                                # Thread for update
my $START = 0;                                                                 # Indicate when program is started
my $MAXIMIZE = 0;                                                              # Is 1 if main window is maximized
my %ZONE_MAP = ('ADT'    => '-0300', # Atlantic Daylight Time                  # Ambiguous timezones
                'AST'    => '-0400', # Atlantic Standard Time
                'BST'    => '+0100', # British Summer Time
                'BT'     => '+0600', # Baghdad Time
                'CAT'    => '+0200', # Central Africa Time
                'CCT'    => '+0630', # Cocos Islands Time
                'CDT'    => '-0500', # Central Daylight Time
                'CST'    => '-0600', # Central Standard Time
                'EAST'   => '-0600', # Easter Island Standard Time
                'ECT'    => '-0500', # Ecuador Time
                'EDT'    => '-0400', # Eastern Daylight Time
                'EST'    => '-0500', # Eastern Standard Time
                'FDT'    => '-0100', # Fernando de Noronha Daylight Time
                'FST'    => '-0200', # Fernando de Noronha Standard Time
                'GST'    => '-0200', # South Georgia Time
                'IDT'    => '+0300', # Israel Daylight Time
                'IST'    => '+0200', # Israel Standard Time
                'MET'    => '+0100', # Middle European Time
                'NFT'    => '-0230', # Newfoundland Daylight Time
                'NST'    => '-0330', # Newfoundland Standard Time
                'PST'    => '-0800', # Pacific Standard Time
                'SAST'   => '+0200', # South Africa Standard Time
                'SST'    => '+0800', # Singapore Standard Time
                'WAST'   => '+0200', # West Africa Summer Time
                'WST'    => '+0800', # Western Standard Time}
              );

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#
my ($winICO, $logoBmp, $logo128Bmp, $openDirBmp, $openFileBmp, $processBmp, $stopBmp, $config32Bmp, $helpBmp,
    $aboutBmp, $config128Bmp, $clipboardBmp, $filterList128, $filterAdd, $filterEdit, $filterDel, $extractAdd,
    $extractDel, $report16, $refresh16, $addDB, $regexTools, $saveDB, $fileOpenBmp, $downloadBmp, $import16Bmp,
    $datetime16Bmp, $guess16Bmp, $datetimeAdd, $datetimeEdit, $datetimeDel, $left16Bmp, $help16Bmp, $fileNewBmp,
    $browseBmp, $options, $options128, $up16, $down16, $warning16, $LFDB16, $LFGuess16, $LFAdd, $LFEdit,
    $queryDB128, $LFRem, $addPattern16, $importTab16Bmp, $saveTab16Bmp, $checkBmp, $errorBmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#
&loadDefaultStr(\%STR);                                                        # Load default language (en)
&loadStr(\%STR, $LANG_FILE) if -e $LANG_FILE and -T $LANG_FILE;                # If language file, load translated strings

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#
my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 860;
my $winHeight = 490;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;
# Keyboard shorcut
my $accel = new Win32::GUI::AcceleratorTable('Ctrl-A' => 'selectAll');
# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'               ,
                                   -text        => 'XL-Parser'             ,
                                   -background  => [255, 255, 255]         ,
                                   -size        => [$winWidth, $winHeight] ,
                                   -pos         => [$winPosX , $winPosY]   ,
                                   -minsize     => [$winWidth, $winHeight] , );
$win->SetIcon($winICO);
# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGBu;
my $fontGB2;
my $font9;
my $font10;
my $font10b;
my $font10u;
my $font12;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $fontGBu = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $font9   = new Win32::GUI::Font(-name => 'Arial', -size =>  7);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1);
  $fontGBu = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 14, -bold => 1, -underline => 1);
  $font9   = new Win32::GUI::Font(-name => 'Arial', -size =>  9);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1, -underline => 1);
  $font12  = new Win32::GUI::Font(-name => 'Arial', -size => 12);
}
# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);
# Header
$win->AddLabel(       -name         => 'lblLogo'               ,
                      -size         => [260, 60]               ,
                      -pos          => [  0,  0]               ,
                      -bitmap       => $logoBmp                , );
$win->AddLabel(       -name         => 'lblHeader'             ,
                      -size         => [$winWidth-240, 60]     ,
                      -pos          => [240,  0]               ,
                      -background   => [250, 250, 250]         , );
# Input Tabstrip
$win->AddLabel(       -name         => 'lblInputT'             ,
                      -size         => [$winWidth, 24]         ,
                      -pos          => [  0, 60]               ,
                      -text         => ' '.$STR{'Input'}       ,
                      -font         => $fontGB                 ,
                      -foreground   => [255, 255, 255]         ,
                      -background   => [ 40, 200,  60]         , );
# Input tab
$win->AddRadioButton( -name         => 'rbInputDir'            ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5, 90]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbInputDir'}      ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -group        => 1                       , );
$win->AddRadioButton( -name         => 'rbInputFiles'          ,
                      -size         => [ 80, 22]               ,
                      -pos          => [ 90, 90]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbInputFiles'}    ,
                      -font         => $font10                 , );
$win->AddRadioButton( -name         => 'rbInputDatabase'       ,
                      -size         => [120, 22]               ,
                      -pos          => [195, 90]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbInputDatabase'} ,
                      -font         => $font10                 , );
$win->AddRadioButton( -name         => 'rbInputClipboard'      ,
                      -size         => [ 95, 22]               ,
                      -pos          => [320, 90]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbInputClipboard'},
                      -font         => $font10                 , );
$win->AddButton(      -name         => 'btnInputClipboard'     ,
                      -size         => [ 22, 22]               ,
                      -pos          => [420, 90]               ,
                      -bitmap       => $clipboardBmp           , );
$win->AddButton(      -name         => 'btnFileFilters'        ,
                      -size         => [110, 22]               ,
                      -pos          => [550, 90]               ,
                      -text         => $STR{'FileFilters'}.'...',
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnFileFormats'        ,
                      -size         => [110, 22]               ,
                      -pos          => [665, 90]               ,
                      -text         => $STR{'FileFormats'}.'...',
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfInput'               ,
                      -size         => [465, 22]               ,
                      -pos          => [  5,120]               ,
                      -font         => $font10                 , );
$win->AddButton(      -name         => 'btnInput'              ,
                      -size         => [ 22, 22]               ,
                      -pos          => [557,120]               ,
                      -bitmap       => $openDirBmp             , );
$win->AddCheckbox(    -name         => 'chInputDirRecurse'     ,
                      -size         => [135, 22]               ,
                      -pos          => [584,120]               ,
                      -text         => $STR{'chInputDirRecurse'},
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 1                       , );
# Functions section
$win->AddLabel(       -name       => 'lblFunctionsT'         ,
                      -size       => [$winWidth, 24]         ,
                      -pos        => [  0,322]               ,
                      -text       => ' '.$STR{'lblFunctionsT'},
                      -font       => $fontGB                 ,
                      -foreground => [255, 255, 255]         ,
                      -background => [ 40, 200,  60]         , );
$win->AddTabStrip(    -name       => 'TabFunctions'          ,
                      -size       => [$winWidth-4,24]        ,
                      -pos        => [  0,346]               ,
                      -font       => $font10                 ,
                      -background => [255, 255, 0]         , );
$win->TabFunctions->InsertItem(-text => $STR{'Extraction'}    );
$win->TabFunctions->InsertItem(-text => $STR{'WebLogAnalysis'});
$win->TabFunctions->InsertItem(-text => $STR{'SplitLogs'}     );
# Extraction
$win->AddTabStrip(    -name         => 'ExtractFunctions'      ,
                      -size         => [$winWidth-4,24]        ,
                      -pos          => [  0,353]               ,
                      -font         => $font10                 ,
                      -background   => [255, 255, 255]         , );
$win->ExtractFunctions->InsertItem(-text => $STR{'Expression'} );
$win->ExtractFunctions->InsertItem(-text => $STR{'SpecObjects'});
$win->AddGrid(        -name         => 'gridExtraction'        ,
                      -size         => [580, 70]               ,
                      -pos          => [  5,350]               ,
                      -background   => [255, 255, 255]         ,
                      -columns      => 6                       ,
                      -fixedrows    => 1                       ,
                      -fixedcolumns => 0                       ,
                      -editable     => 0                       , );
$win->AddButton(      -name         => 'btnExtractAdd'         ,
                      -size         => [ 22, 22]               ,
                      -pos          => [  5,185]               ,
                      -bitmap       => $extractAdd             ,
                      -tip          => $STR{'extractAddTip'}   , );
$win->AddButton(      -name         => 'btnExtractDel'         ,
                      -size         => [ 22, 22]               ,
                      -pos          => [ 29,185]               ,
                      -bitmap       => $extractDel             ,
                      -tip          => $STR{'extractDelTip'}   ,
                      -disabled     => 1                       , );
$win->AddButton(      -name         => 'btnExtractOpt'         ,
                      -size         => [ 22, 22]               ,
                      -pos          => [ 53,231]               ,
                      -bitmap       => $options                ,
                      -tip          => $STR{'winExprOpt'}      , );
$win->AddButton(      -name         => 'btnExtractImport'      ,
                      -size         => [ 22, 22]               ,
                      -pos          => [ 77,209]               ,
                      -bitmap       => $importTab16Bmp         ,
                      -tip          => $STR{'filterImportTip'} , );
$win->AddButton(      -name         => 'btnExtractSave'        ,
                      -size         => [ 22, 22]               ,
                      -pos          => [101,209]               ,
                      -bitmap       => $saveTab16Bmp           ,
                      -tip          => $STR{'ExprSaveTip'}     ,
                      -disabled     => 1                       , );
$win->AddButton(      -name         => 'btnExtractOpenRes'     ,
                      -size         => [ 22, 22]               ,
                      -pos          => [580,185]               ,
                      -bitmap       => $report16               ,
                      -tip          => $STR{'OpenResults'}.'...', );
$win->AddButton(      -name         => 'btnUpGrid'             ,
                      -size         => [ 22, 22]               ,
                      -pos          => [580,231]               ,
                      -bitmap       => $up16                   ,
                      -disabled     => 1                       , );
$win->AddButton(      -name         => 'btnDownGrid'           ,
                      -size         => [ 22, 22]               ,
                      -pos          => [580,255]               ,
                      -bitmap       => $down16                 ,
                      -disabled     => 1                       , );
$win->AddButton(      -name         => 'btnExtractRefresh'     ,
                      -size         => [ 22, 22]               ,
                      -pos          => [580,450]               ,
                      -bitmap       => $refresh16              ,
                      -tip          => $STR{'RefreshFL'}       ,
                      -disabled     => 1                       , );
# Special objects
$win->AddTreeView(    -name         => 'tvSO'                  ,
                      -size         => [300,100]               ,
                      -pos          => [  5,350]               ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -rootlines    => 1                       ,
                      -lines        => 1                       ,
                      -checkboxes   => 1                       ,
                      -buttons      => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chSO_Status'           , # Hidden checkbox, checked if any object is checked
                      -size         => [  0,  0]               ,
                      -pos          => [ 10,400]               ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
# Web Log analysis tab (file(s) or folder)
# Create or update database
$win->AddLabel(       -name         => 'lblCreateUpdateDB'     ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,353]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbInputDatabase'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbLACreateDB'          ,
                      -size         => [100, 22]               ,
                      -pos          => [120,350]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'createDB'}        ,
                      -font         => $font10                 ,
                      -group        => 1                       ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbLAUpdateDB'          ,
                      -size         => [150, 22]               ,
                      -pos          => [230,350]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'update3'}         ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLF'                 ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,378]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'winLFObj'}.':'    ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbLF'                  ,
                      -size         => [250,100]               ,
                      -pos          => [120,375]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnWinLFDB'            ,
                      -size         => [ 22, 22]               ,
                      -pos          => [373,375]               ,
                      -font         => $font10                 ,
                      -bitmap       => $LFDB16                 ,
                      -tip          => $STR{'openLFDB'}        ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLFGuess'            ,
                      -size         => [ 22, 22]               ,
                      -pos          => [397,375]               ,
                      -bitmap       => $LFGuess16              ,
                      -tip          => $STR{'guessFormat'}     ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAFileOrder'        ,
                      -size         => [100, 22]               ,
                      -pos          => [422,375]               ,
                      -text         => $STR{'LAFileOrder'}.'...',
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLASetReadOnly'       ,
                      -size         => [215, 22]               ,
                      -pos          => [530,375]               ,
                      -text         => $STR{'chLASetReadOnly'} ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAResolve'          ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,413]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Resolve'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAOptResISP'         ,
                      -size         => [150, 22]               ,
                      -pos          => [120,  7]               ,
                      -text         => $STR{'XLWhoisDB'}       ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAOptResGeoIP'       ,
                      -size         => [100, 22]               ,
                      -pos          => [275,  7]               ,
                      -text         => $STR{'GeoIPDB'}         ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAOptResUA'          ,
                      -size         => [125, 22]               ,
                      -pos          => [380,  7]               ,
                      -text         => "\u$STR{'LFUA'}"        ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAOptResWeekday'     ,
                      -size         => [145, 22]               ,
                      -pos          => [510,  7]               ,
                      -text         => $STR{'Weekday'}         ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAFilters'          ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,413]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Options'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAFilters'          ,
                      -size         => [120, 22]               ,
                      -pos          => [120,410]               ,
                      -text         => $STR{'selectFilters'}.'...',
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLALogFiltered'       ,
                      -size         => [150, 22]               ,
                      -pos          => [248,410]               ,
                      -text         => $STR{'chLALogFiltered'} ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLALogRejected'       ,
                      -size         => [150, 22]               ,
                      -pos          => [403,410]               ,
                      -text         => $STR{'chLALogRejected'} ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAIgnoreComments'   ,
                      -size         => [215, 22]               ,
                      -pos          => [558,410]               ,
                      -text         => $STR{'chLAIgnoreComments'},
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblDestLADB'           ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,416]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'dbFile'}.':'      ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfDestDir'             ,
                      -size         => [375, 22]               ,
                      -pos          => [120,413]               ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnDestDir'            ,
                      -size         => [ 22, 22]               ,
                      -pos          => [497,413]               ,
                      -bitmap       => $openDirBmp             ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLASelectDB'          ,
                      -size         => [250, 22]               ,
                      -pos          => [120,443]               ,
                      -text         => $STR{'chLASelectDB'}    ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
# Web Log analysis tab (database)
$win->AddTabStrip(    -name         => 'LAFunctions'           ,
                      -size         => [$winWidth-4,24]        ,
                      -pos          => [  0,353]               ,
                      -font         => $font10                 ,
                      -background   => [255, 255, 255]         ,
                      -visible      => 0                       , );
$win->LAFunctions->InsertItem(-text => $STR{'CurrentDatabase'});
$win->LAFunctions->InsertItem(-text => $STR{'updateDB'}       );
$win->LAFunctions->InsertItem(-text => $STR{'QueryDB'}        );
$win->LAFunctions->InsertItem(-text => $STR{'SearchSA'}       );
# Current Database
$win->AddGroupbox(    -name         => 'gbCurrDBGeneral'       ,
                      -title        => $STR{'general'}         ,
                      -size         => [580, 75]               ,
                      -pos          => [  5,373]               ,
                      -font         => $fontGB                 ,
                      -background   => [255, 255, 255]         ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBLastUpdate'   ,
                      -size         => [100, 22]               ,
                      -pos          => [ 10,373]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblCurrDBLastUpdate'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBLastUpdateVal',
                      -size         => [135, 22]               ,
                      -pos          => [115,373]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBPeriod'       ,
                      -size         => [ 80, 22]               ,
                      -pos          => [255,373]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblCurrDBPeriod'}.':',
                      -font         => $font10                 ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBPeriodVal'    ,
                      -size         => [270, 22]               ,
                      -pos          => [340,373]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrOf'        ,
                      -size         => [100, 22]               ,
                      -pos          => [ 10,398]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'NumberOf'}.':'    ,
                      -font         => $font10u                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrEntries'   ,
                      -size         => [ 70, 22]               ,
                      -pos          => [115,398]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Entries'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrEntriesVal',
                      -size         => [ 60, 22]               ,
                      -pos          => [190,398]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBFiltered'     ,
                      -size         => [ 80, 22]               ,
                      -pos          => [255,398]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblCurrDBFiltered'}.':',
                      -font         => $font10                 ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBFilteredVal'  ,
                      -size         => [ 70, 22]               ,
                      -pos          => [340,398]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBRejected'     ,
                      -size         => [ 90, 22]               ,
                      -pos          => [415,398]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblCurrDBRejected'}.':',
                      -font         => $font10                 ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBRejectedVal'  ,
                      -size         => [ 70, 22]               ,
                      -pos          => [510,398]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddGroupbox(    -name         => 'gbCurrDBSource'        ,
                      -title        => $STR{'chReportOptIncSource'},
                      -size         => [580,130]               ,
                      -pos          => [  5,433]               ,
                      -font         => $fontGB                 ,
                      -background   => [255, 255, 255]         ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBLogFormat'    ,
                      -size         => [100, 22]               ,
                      -pos          => [ 10,448]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'winLFObj'}.':'    ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBLogFormatVal' ,
                      -size         => [270, 22]               ,
                      -pos          => [115,448]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLACurrDBFiles'      ,
                      -size         => [120, 22]               ,
                      -pos          => [510,448]               ,
                      -text         => $STR{'winLACurrDBFiles'}.'...',
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBFilters'      ,
                      -size         => [100, 22]               ,
                      -pos          => [ 10,473]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Filters'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfCurrDBFiltersVal'    ,
                      -size         => [350, 32]               ,
                      -pos          => [115,476]               ,
                      -multiline    => 1                       ,
                      -autohscroll  => 1                       ,
                      -vscroll      => 1                       ,
                      -readonly     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLACurrDBFiltered'   ,
                      -size         => [100, 22]               ,
                      -pos          => [510,473]               ,
                      -text         => $STR{'lblCurrDBFiltered'}.'...',
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLACurrDBRejected'      ,
                      -size         => [100, 22]               ,
                      -pos          => [510,498]               ,
                      -text         => $STR{'lblCurrDBRejected'}.'...',
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddGroupbox(    -name         => 'gbCurrDBResolved'      ,
                      -title        => $STR{'Resolved'}        ,
                      -size         => [215,250]               ,
                      -pos          => [590,373]               ,
                      -font         => $fontGB                 ,
                      -background   => [255, 255, 255]         ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrResISP'    ,
                      -size         => [100, 22]               ,
                      -pos          => [595,383]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'isp'}.':'         ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrResISPVal',
                      -size         => [ 90, 22]               ,
                      -pos          => [700,383]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrResGeoIP'  ,
                      -size         => [100, 22]               ,
                      -pos          => [595,408]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'GeoIPDB'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBNbrResGeoIPVal',
                      -size         => [ 90, 22]               ,
                      -pos          => [700,408]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBResUAs'       ,
                      -size         => [100, 22]               ,
                      -pos          => [595,433]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Useragent'}.':'   ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBResUAsVal'    ,
                      -size         => [ 90, 22]               ,
                      -pos          => [700,433]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBResWDs'       ,
                      -size         => [100, 22]               ,
                      -pos          => [595,458]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Weekdays'}.':'    ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblCurrDBResWDsVal'    ,
                      -size         => [ 90, 22]               ,
                      -pos          => [700,458]               ,
                      -background   => [255, 255, 255]         ,
                      -foreground   => [  0, 153,   0]         ,
                      -font         => $font10b                ,
                      -align        => 'right'                 ,
                      -visible      => 0                       , );
# Update database
$win->AddLabel(       -name         => 'lblDestDB'             ,
                      -size         => [110, 22]               ,
                      -pos          => [  5,373]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'destination'}.':' ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbDestDBCurr'          ,
                      -size         => [200, 22]               ,
                      -pos          => [120,375]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbDestDBCurr'}    ,
                      -font         => $font10                 ,
                      -group        => 1                       ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbDestDBNew'           ,
                      -size         => [150, 22]               ,
                      -pos          => [330,375]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'rbDestDBNew'}     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
# Query database
$win->AddLabel(       -name         => 'lblLAQuerySelectShadowT',
                      -size         => [ 80, 22]               ,
                      -pos          => [  6,351]               ,
                      -foreground   => [180, 180, 180]         ,
                      -background   => [255, 255, 255]         ,
                      -text         => 'Select:'               ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQuerySelectT'     ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5,350]               ,
                      -addstyle     => 11                      , # Transparent
                      -foreground   => [ 50, 180,  0]          ,
                      -text         => 'Select:'               ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQuerySelectCols'  ,
                      -size         => [120, 22]               ,
                      -pos          => [ 90,350]               ,
                      -text         => $STR{'SelectColumn'}.'...',
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQueryFilter'      ,
                      -size         => [120, 22]               ,
                      -pos          => [215,350]               ,
                      -text         => $STR{'selectFilters'}.'...',
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAQueryGroupBy'      ,
                      -size         => [100, 22]               ,
                      -pos          => [345,350]               ,
                      -text         => 'Group by:'             ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbLAQueryGroupByCol'   ,
                      -size         => [ 90, 22]               ,
                      -pos          => [450,350]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->cbLAQueryGroupByCol->Add($STR{'LFclientIP'}, $STR{'DTDB'}, $STR{'Weekday'}, $STR{'LFHTTPmethod'},
                               $STR{'LFHTTPreq'}, $STR{'LFHTTPparam'}, $STR{'LFHTTPprot'}, $STR{'LFHTTPstatus'},
                               $STR{'LFsize'}, $STR{'LFReferer'}, $STR{'LFUA'});
$win->cbLAQueryGroupByCol->SetCurSel(0);
$win->AddButton(      -name         => 'btnLAQueryGroupByAdd'  ,
                      -size         => [ 23, 22]               ,
                      -pos          => [543,350]               ,
                      -text         => '+'                     ,
                      -font         => $font12                 ,
                      -align        => 'center'                ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAQueryOrderBy'      ,
                      -size         => [ 80, 22]               ,
                      -pos          => [574,350]               ,
                      -text         => 'Order by:'             ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbLAQueryOrderByCol'   ,
                      -size         => [ 90, 22]               ,
                      -pos          => [659,350]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->cbLAQueryOrderByCol->Add($STR{'LFclientIP'}, $STR{'DTDB'}, $STR{'Weekday'}, $STR{'LFHTTPmethod'},
                               $STR{'LFHTTPreq'}, $STR{'LFHTTPparam'}, $STR{'LFHTTPprot'}, $STR{'LFHTTPstatus'},
                               $STR{'LFsize'}, $STR{'LFReferer'}, $STR{'LFUA'});
$win->cbLAQueryOrderByCol->SetCurSel(0);
$win->AddCombobox(    -name         => 'cbLAQueryOrderBy'      ,
                      -size         => [ 60, 22]               ,
                      -pos          => [754,350]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->cbLAQueryOrderBy->Add('ASC', 'DESC');
$win->cbLAQueryOrderBy->SetCurSel(0);
$win->AddButton(      -name         => 'btnLAQueryOrderByAdd'  ,
                      -size         => [ 23, 22]               ,
                      -pos          => [817,350]               ,
                      -text         => '+'                     ,
                      -font         => $font12                 ,
                      -align        => 'center'                ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chLAQueryHavingCount'  ,
                      -size         => [100, 22]               ,
                      -pos          => [345,380]               ,
                      -text         => 'Having count:'         ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbLAQueryHavingCountCol',
                      -size         => [ 90, 22]               ,
                      -pos          => [450,380]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->cbLAQueryHavingCountCol->Add($STR{'LFclientIP'}, $STR{'DTDB'}, $STR{'Weekday'}, $STR{'LFHTTPmethod'},
                                   $STR{'LFHTTPreq'}, $STR{'LFHTTPparam'}, $STR{'LFHTTPprot'}, $STR{'LFHTTPstatus'},
                                   $STR{'LFsize'}, $STR{'LFReferer'}, $STR{'LFUA'});
$win->cbLAQueryHavingCountCol->SetCurSel(0);
$win->AddCombobox(    -name         => 'cbLAQueryHavingCount'  ,
                      -size         => [ 40, 22]               ,
                      -pos          => [545,380]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->cbLAQueryHavingCount->Add('>', '>=', '==', '!=', '<', '<=');
$win->cbLAQueryHavingCount->SetCurSel(0);
$win->AddTextfield(   -name         => 'tfLAQueryHavingCount'  ,
                      -size         => [ 50, 22]               ,
                      -pos          => [590,380]               ,
                      -number       => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQueryHavingCountAdd',
                      -size         => [ 23, 22]               ,
                      -pos          => [643,380]               ,
                      -text         => '+'                     ,
                      -font         => $font12                 ,
                      -align        => 'center'                ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryShadowT'     ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  6,454]               ,
                      -foreground   => [180, 180, 180]         ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Query'}.':'       ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryT'           ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5,453]               ,
                      -addstyle     => 11                      , # Transparent
                      -foreground   => [ 50, 180,  0]          ,
                      -text         => $STR{'Query'}.':'       ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQuerySelectSaved' ,
                      -size         => [120, 22]               ,
                      -pos          => [ 90,453]               ,
                      -text         => $STR{'SelectSaved'}.'...',
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQueryEdit'        ,
                      -size         => [ 80, 22]               ,
                      -pos          => [215,453]               ,
                      -text         => $STR{'Edit'}            ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQuerySave'        ,
                      -size         => [ 80, 22]               ,
                      -pos          => [300,453]               ,
                      -text         => $STR{'Save'}            ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQueryReset'       ,
                      -size         => [ 80, 22]               ,
                      -pos          => [385,453]               ,
                      -text         => $STR{'Reset'}           ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryOk'          ,
                      -size         => [302, 44]               ,
                      -pos          => [ 89, 449]               ,
                      -background   => [  0, 255,   0]         ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryErr'         ,
                      -size         => [302, 44]               ,
                      -pos          => [ 89,449]               ,
                      -background   => [255,   0,   0]         ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfLAQuery'             ,
                      -size         => [300, 42]               ,
                      -pos          => [ 90,450]               ,
                      -font         => $font10                 ,
                      -multiline    => 1                       ,
                      -wantreturn   => 1                       ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryOutputShadowT',
                      -size         => [ 80, 22]               ,
                      -pos          => [  6,479]               ,
                      -foreground   => [180, 180, 180]         ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'output'}.':'      ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLAQueryOutputT'     ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5,478]               ,
                      -addstyle     => 11                      , # Transparent
                      -foreground   => [ 50, 180,  0]          ,
                      -text         => $STR{'output'}.':'      ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLAQueryReportOpt'   ,
                      -size         => [120, 22]               ,
                      -pos          => [ 90,475]               ,
                      -text         => $STR{'ReportOpt'}.'...' ,
                      -visible      => 0                       , );
# Search database
$win->AddLabel(       -name         => 'lblLASearchOptShadowT' ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  6,351]               ,
                      -foreground   => [180, 180, 180]         ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Options'}.':'     ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLASearchOptT'       ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5,350]               ,
                      -addstyle     => 11                      , # Transparent
                      -foreground   => [ 50, 180,  0]          ,
                      -text         => $STR{'Options'}.':'     ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLASearchReset'      ,
                      -size         => [ 80, 22]               ,
                      -pos          => [  5,380]               ,
                      -text         => $STR{'Reset'}           ,
                      -disabled     => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLASearchReportOpt'  ,
                      -size         => [120, 22]               ,
                      -pos          => [235,350]               ,
                      -text         => $STR{'ReportOpt'}.'...' ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLASearchSAMaxRes'   ,
                      -size         => [100, 22]               ,
                      -pos          => [360,350]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'MaxResults'}.':'  ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfLASearchSAMaxRes'    ,
                      -size         => [ 50, 22]               ,
                      -pos          => [465,350]               ,
                      -number       => 1                       ,
                      -text         => 0                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLASearchSaveOptions',
                      -size         => [120, 22]               ,
                      -pos          => [520,350]               ,
                      -text         => $STR{'SaveOptions'}     ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnLASearchOpenResults',
                      -size         => [120, 22]               ,
                      -pos          => [645,350]               ,
                      -text         => $STR{'OpenResults'}.'...',
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLASearchSAIndShadowT',
                      -size         => [ 90, 22]               ,
                      -pos          => [  6,401]               ,
                      -foreground   => [180, 180, 180]         ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Indicators'}.':'  ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblLASearchSAIndT'     ,
                      -size         => [ 90, 22]               ,
                      -pos          => [  5,400]               ,
                      -addstyle     => 11                      , # Transparent
                      -foreground   => [ 50, 180,  0]          ,
                      -text         => $STR{'Indicators'}.':'  ,
                      -font         => $fontGBu                ,
                      -visible      => 0                       , );
$win->AddGrid(        -name         => 'gridLASearchSAInd'     ,
                      -size         => [300,100]               ,
                      -pos          => [110,400]               ,
                      -background   => [255, 255, 255]         ,
                      -columns      => 5                       ,
                      -fixedrows    => 1                       ,
                      -fixedcolumns => 0                       ,
                      -editable     => 1                       ,
                      -visible      => 0                       , );
# Split tab
$win->AddLabel(       -name         => 'lblSplitType'          ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,373]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'Type'}.':'        ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbSplitBySize'         ,
                      -size         => [150, 22]               ,
                      -pos          => [160,370]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'BySize'}          ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -group        => 1                       ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbSplitByLines'        ,
                      -size         => [200, 22]               ,
                      -pos          => [315,370]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'ByNbrLines'}      ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddRadioButton( -name         => 'rbSplitByTime'         ,
                      -size         => [100, 22]               ,
                      -pos          => [520,370]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'ByTime'}          ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
# By file size
$win->AddLabel(       -name         => 'lblSplitBySize'        ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,403]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblSplitBySize'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfSplitBySizeFrag'     ,
                      -size         => [ 55, 22]               ,
                      -pos          => [160,400]               ,
                      -number       => 1                       ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbSplitBySizeUnit'     ,
                      -size         => [ 38, 22]               ,
                      -pos          => [217,400]               ,
                      -dropdownlist => 1                       ,
                      -visible      => 0                       , );
$win->cbSplitBySizeUnit->Add($STR{'Kb2'}, $STR{'Mb2'}, $STR{'Gb2'},);
$win->cbSplitBySizeUnit->SetCurSel(0);
$win->AddCheckbox(    -name         => 'chSplitUseDTFN'  ,
                      -size         => [185, 22]               ,
                      -pos          => [265,430]               ,
                      -text         => $STR{'chSplitUseDTFN'},
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 0                       ,
                      -visible      => 0                       , );
# By number of lines
$win->AddLabel(       -name         => 'lblSplitByLinesNbr'    ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,403]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblSplitByLinesNbr'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfSplitByLinesNbr'     ,
                      -size         => [ 95, 22]               ,
                      -pos          => [160,400]               ,
                      -number       => 1                       ,
                      -visible      => 0                       , );
$win->AddUpDown(      -name         => 'upDownLinesNbr'        ,
                      -visible      => 0                       , );
$win->upDownLinesNbr->SetRange(1,1000000);
$win->upDownLinesNbr->SetPos(0);
# By time
$win->AddLabel(       -name         => 'lblSplitByTime'        ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,403]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblSplitByTime'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbSplitByTimeInter'    ,
                      -size         => [ 95, 22]               ,
                      -pos          => [160,400]               ,
                      -dropdownlist => 1                       ,
                      -visible      => 0                       , );
$win->cbSplitByTimeInter->Add($STR{'ByHour'}, $STR{'ByDay'}, $STR{'ByWeek'}, $STR{'ByMonth'},);
$win->cbSplitByTimeInter->SetCurSel(1);
$win->AddLabel(       -name         => 'lblSplitTimeFormat'    ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,403]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'lblSplitTimeFormat'}.':',
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddCombobox(    -name         => 'cbSplitTimeFormat'     ,
                      -size         => [250,100]               ,
                      -pos          => [160,400]               ,
                      -dropdownlist => 1                       ,
                      -vscroll      => 1                       ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnSplitTimeDTDB'      ,
                      -size         => [ 22, 22]               ,
                      -pos          => [413,400]               ,
                      -font         => $font10                 ,
                      -bitmap       => $datetime16Bmp          ,
                      -tip          => $STR{'openDTDB'}        ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnSplitTimeFormatGuess',
                      -size         => [ 22, 22]               ,
                      -pos          => [437,400]               ,
                      -bitmap       => $guess16Bmp             ,
                      -tip          => $STR{'guessFormat'}     ,
                      -visible      => 0                       , );
$win->AddLabel(       -name         => 'lblSplitDestDir'       ,
                      -size         => [150, 22]               ,
                      -pos          => [  5,403]               ,
                      -background   => [255, 255, 255]         ,
                      -text         => $STR{'destDir'}.':'     ,
                      -font         => $font10                 ,
                      -visible      => 0                       , );
$win->AddTextfield(   -name         => 'tfSplitDestDir'        ,
                      -size         => [335, 22]               ,
                      -pos          => [160,413]               ,
                      -visible      => 0                       , );
$win->AddButton(      -name         => 'btnSplitDestDir'       ,
                      -size         => [ 22, 22]               ,
                      -pos          => [497,413]               ,
                      -bitmap       => $openDirBmp             ,
                      -visible      => 0                       , );
$win->AddCheckbox(    -name         => 'chOpenSplitDestDir'    ,
                      -size         => [185, 22]               ,
                      -pos          => [562,400]               ,
                      -text         => $STR{'chOpenDstDir'}    ,
                      -background   => [255, 255, 255]         ,
                      -font         => $font10                 ,
                      -checked      => 1                       ,
                      -visible      => 0                       , );
# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [$winWidth, 80]         ,
                      -pos         => [  2,$winHeight-82]     ,
                      -background  => [245, 245, 245]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -background  => [245, 245, 245]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [495, 20]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [245, 245, 245]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [410, 20]               ,
                      -pos         => [ 10, $winHeight-55]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [ 85, 20]               ,
                      -pos         => [425, $winHeight-53]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [245, 245, 245]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [470,$winHeight-75]     ,
                      -bitmap      => $processBmp             ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'Process'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [470,$winHeight-75]     ,
                      -bitmap      => $stopBmp                ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'StopProcess'}     ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [555,$winHeight-75]     ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'Configuration'}   , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [600,$winHeight-75]     ,
                      -bitmap      => $helpBmp                ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [645,$winHeight-75]     ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [255, 255, 255]         ,
                      -tip         => $STR{'about'}           , );

#------------------------------------------------------------------------------#
# Report window
#------------------------------------------------------------------------------#
my $winReport = Win32::GUI::Window->new(    -name        => 'winReport'            ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'ReportOpt'}      ,
                                            -pos         => [$winPosX, $winPosY]   ,
                                            -size        => [680, 230]             ,
                                            -hasmaximize => 0                      ,
                                            -hasminimize => 0                      ,
                                            -resizable   => 0                      ,
                                            -dialogui    => 1                      , );
$winReport->SetIcon($winICO);
$winReport->AddLabel(         -name         => 'lblLogo'               ,
                              -size         => [128,128]               ,
                              -pos          => [  5,  5]               ,
                              -bitmap       => $options128             ,
                              -background   => [255, 255, 255]         , );
# Report options
$winReport->AddLabel(         -name         => 'lblReportOptShadowT'   ,
                              -size         => [150, 22]               ,
                              -pos          => [151,  6]               ,
                              -foreground   => [180, 180, 180]         ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'ReportOpt'}.':'   ,
                              -font         => $fontGB2                , );
$winReport->AddLabel(         -name         => 'lblReportOptT'         ,
                              -size         => [150, 22]               ,
                              -pos          => [150,  5]               ,
                              -addstyle     => 11                      , # Transparent
                              -foreground   => [ 50, 180,  0]          ,
                              -text         => $STR{'ReportOpt'}.':'   ,
                              -font         => $fontGB2                , );
$winReport->AddTextfield(     -name         => 'tfReportDir'           ,
                              -size         => [390, 22]               ,
                              -pos          => [150, 38]               ,
                              -tabstop      => 1                       , );
$winReport->AddCombobox(      -name         => 'cbReportFormat'        ,
                              -size         => [ 80, 22]               ,
                              -pos          => [543, 38]               ,
                              -dropdownlist => 1                       ,
                              -vscroll      => 1                       ,
                              -tabstop      => 1                       , );
$winReport->cbReportFormat->Add('XLSX', 'HTML', 'TXT (TSV)'            , );
$winReport->cbReportFormat->SetCurSel(0);
$winReport->AddButton(        -name         => 'btnReportDir'          ,
                              -size         => [ 22, 22]               ,
                              -pos          => [625, 38]               ,
                              -bitmap       => $openDirBmp             ,
                              -tip          => $STR{'btnReportDirTip'} ,
                              -tabstop      => 1                       , );
$winReport->AddButton(        -name         => 'btnOpenReportDir'      ,
                              -size         => [ 22, 22]               ,
                              -pos          => [649, 38]               ,
                              -bitmap       => $browseBmp              ,
                              -tip          => $STR{'btnOpenDirTip'}   ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReplaceReport'       ,
                              -size         => [200, 20]               ,
                              -pos          => [150, 68]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'chReplace'}       ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chOpenReport'          ,
                              -size         => [200, 20]               ,
                              -pos          => [410, 68]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'chOpenReport'}    ,
                              -font         => $font10                 ,
                              -checked      => 1                       ,
                              -tabstop      => 1                       , );
$winReport->AddLabel(         -name         => 'lblOutputDTFormat'     ,
                              -size         => [150, 22]               ,
                              -pos          => [150, 96]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'DTFormat'}.':'    ,
                              -font         => $font10                 , );
$winReport->AddCombobox(      -name         => 'cbOutputDTFormat'      ,
                              -size         => [250,100]               ,
                              -pos          => [305, 93]               ,
                              -dropdownlist => 1                       ,
                              -vscroll      => 1                       , );
$winReport->AddButton(        -name         => 'btnOutputFormatDTDB'   ,
                              -size         => [ 22, 22]               ,
                              -pos          => [558, 93]               ,
                              -font         => $font10                 ,
                              -bitmap       => $datetime16Bmp          ,
                              -tip          => $STR{'openDTDB'}        , );
# Include
$winReport->AddLabel(         -name         => 'lblReportOptInclude'   ,
                              -size         => [ 80, 22]               ,
                              -pos          => [150,120]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'Include'}.':'     ,
                              -font         => $font10u                , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncHeaders' ,
                              -size         => [150, 22]               ,
                              -pos          => [150,143]               ,
                              -text         => $STR{'chReportOptIncHeaders'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -checked      => 1                       ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncSource'  ,
                              -size         => [100, 22]               ,
                              -pos          => [305,143]               ,
                              -text         => $STR{'chReportOptIncSource'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -checked      => 0                       ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncISP'     ,
                              -size         => [100, 22]               ,
                              -pos          => [410,143]               ,
                              -text         => $STR{'isp'}             ,
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncGeoIP'   ,
                              -size         => [100, 22]               ,
                              -pos          => [515,143]               ,
                              -text         => $STR{'GeoIPDB'}         ,
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncUADetails',
                              -size         => [150, 22]               ,
                              -pos          => [150,168]               ,
                              -text         => $STR{'UADetails'}       ,
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winReport->AddCheckbox(      -name         => 'chReportOptIncWeekday' ,
                              -size         => [100, 22]               ,
                              -pos          => [305,168]               ,
                              -text         => $STR{'Weekday'}         ,
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -checked      => 0                       ,
                              -tabstop      => 1                       , );
$winReport->AddButton(        -name         => 'btnReportOk'           ,
                              -size         => [ 80, 30]               ,
                              -pos          => [$winReport->ScaleWidth()-88,168],
                              -text         => $STR{'Ok'}              ,
                              -font         => $font10                 ,
                              -disabled     => 1                       ,
                              -tabstop      => 1                       , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'winConfig'}       ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [800, 330]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);
$winConfig->AddLabel(   -name         => 'lblLogo'             ,
                        -size         => [128,128]             ,
                        -pos          => [  0,  5]             ,
                        -bitmap       => $config128Bmp         ,
                        -background   => [255, 255, 255]       , );
# Tabstrip
$winConfig->AddTabStrip(-name         => 'configTab'      ,
                        -size         => [$winConfig->ScaleWidth()-138,$winConfig->ScaleHeight()+1],
                        -pos          => [140,  0]        ,
                        -background   => [255, 255, 255]  ,
                        -tabstop      => 1                , );
$winConfig->configTab->InsertItem(-text         => $STR{'general'}                , );
$winConfig->configTab->InsertItem(-text         => $STR{'database'}               , );
$winConfig->configTab->InsertItem(-text         => 'XL-Parser '.$STR{'database'}  , );
$winConfig->configTab->InsertItem(-text         => 'XL-ToolKit '.$STR{'database'} , );
# General tab- Tool Section
$winConfig->AddLabel(       -name         => 'lblToolShadowT'        ,
                            -size         => [ 80, 22]               ,
                            -pos          => [151, 36]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'Tool'}.':'        ,
                            -font         => $fontGBu                , );
$winConfig->AddLabel(       -name         => 'lblToolT'              ,
                            -size         => [ 80, 22]               ,
                            -pos          => [150, 35]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'Tool'}.':'        ,
                            -font         => $fontGBu                , );
$winConfig->AddButton(      -name         => 'btnExportLang'         ,
                            -size         => [125, 24]               ,
                            -pos          => [150, 68]               ,
                            -text         => $STR{'Export'}.'Lang.ini',
                            -font         => $font10                 , );
$winConfig->AddButton(      -name         => 'btnOpenUserDir'        ,
                            -size         => [125, 24]               ,
                            -pos          => [285, 68]               ,
                            -text         => $STR{'OpenUserDir'}.'...',
                            -font         => $font10                 , );
$winConfig->AddButton(      -name         => 'btnCheckUpdate'        ,
                            -size         => [125, 24]               ,
                            -pos          => [150, 98]               ,
                            -text         => $STR{'checkUpdate'}     ,
                            -font         => $font10                 , );
$winConfig->AddCheckbox(    -name         => 'chAutoUpdate'          ,
                            -size         => [250, 20]               ,
                            -pos          => [285,100]               ,
                            -text         => $STR{'AutoUpdateTip'}   ,
                            -background   => [255, 255, 255]         ,
                            -font         => $font10                 ,
                            -tabstop      => 1                       ,
                            -checked      => 1                       , );
# General tab - Functions section
$winConfig->AddLabel(       -name         => 'lblFuncShadowT'        ,
                            -size         => [350, 22]               ,
                            -pos          => [151,136]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'lblFunctionsT'}.':',
                            -font         => $fontGBu                , );
$winConfig->AddLabel(       -name         => 'lblFuncT'              ,
                            -size         => [350, 22]               ,
                            -pos          => [150,135]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'lblFunctionsT'}.':',
                            -font         => $fontGBu                , );
$winConfig->AddCheckbox(    -name         => 'chFullScreen'          ,
                            -size         => [150, 20]               ,
                            -pos          => [285,137]               ,
                            -text         => $STR{'chFullScreen'}    ,
                            -background   => [255, 255, 255]         ,
                            -font         => $font10                 , );
$winConfig->AddCheckbox(    -name         => 'chRememberPos'         ,
                            -size         => [195, 20]               ,
                            -pos          => [440,137]               ,
                            -text         => $STR{'chRememberPos'}   ,
                            -background   => [255, 255, 255]         ,
                            -font         => $font10                 , );
$winConfig->AddLabel(       -name         => 'lblNsLookupTO1'        ,
                            -size         => [130, 22]               ,
                            -pos          => [150,168]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'NsLookupTO1'}.':' ,
                            -font         => $font10                 , );
$winConfig->AddTextfield(   -name         => 'tfLookupTO'            ,
                            -size         => [ 30, 24]               ,
                            -pos          => [285,165]               ,
                            -font         => $font10                 , );
$winConfig->AddLabel(       -name         => 'lblNsLookupTO2'        ,
                            -size         => [ 70, 22]               ,
                            -pos          => [320,168]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => lc($STR{'seconds'})     ,
                            -font         => $font10                 , );
$winConfig->AddLabel(       -name         => 'lblLocalTZ'            ,
                            -size         => [120, 22]               ,
                            -pos          => [150,201]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'localTimezone'}.':',
                            -font         => $font10                 , );
$winConfig->AddCombobox(    -name         => 'cbLocalTZ'             ,
                            -size         => [260,100]               ,
                            -pos          => [285,198]               ,
                            -font         => $font10                 ,
                            -dropdownlist => 1                       ,
                            -vscroll      => 1                       , );
$winConfig->AddLabel(       -name         => 'lblDefaultLang'        ,
                            -size         => [120, 22]               ,
                            -pos          => [150,231]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'defaultLang'}.':' ,
                            -font         => $font10                 , );
$winConfig->AddCombobox(    -name         => 'cbDefaultLang'         ,
                            -size         => [130,100]               ,
                            -pos          => [285,228]               ,
                            -font         => $font10                 ,
                            -dropdownlist => 1                       ,
                            -vscroll      => 1                       , );
# Database tab - MAC OUI Database section
$winConfig->AddLabel(       -name         => 'lblMACOUIDBShadowT'    ,
                            -size         => [250, 22]               ,
                            -pos          => [151, 36]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'OUIDB'}.':'       ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblMACOUIDBT'          ,
                            -size         => [250, 22]               ,
                            -pos          => [150, 35]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'OUIDB'}.':'       ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddCheckbox(    -name         => 'chMACOUIDBAutoUpt'     ,
                            -size         => [240, 20]               ,
                            -pos          => [535, 38]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'AutoUpdateTip'}   ,
                            -font         => $font10                 ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfMACOUIDB'            ,
                            -size         => [532, 22]               ,
                            -pos          => [150, 68]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnMACOUIDB'           ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684, 68]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnMACOUIDBUpt'        ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707, 68]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnMACOUIDBImport'     ,
                            -size         => [ 22, 22]               ,
                            -pos          => [730, 68]               ,
                            -bitmap       => $import16Bmp            ,
                            -tip          => $STR{'importOUIDB'}     ,
                            -visible      => 0                       , );
# Database tab - GeoIP Database section
$winConfig->AddLabel(       -name         => 'lblGeoIPDBShadowT'     ,
                            -size         => [250, 22]               ,
                            -pos          => [151,104]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'GeoIPDB'}.':'     ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblGeoIPDBT'           ,
                            -size         => [250, 22]               ,
                            -pos          => [150,103]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'GeoIPDB'}.':'     ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddCheckbox(    -name         => 'chGeoIPDBAutoUpt'      ,
                            -size         => [240, 20]               ,
                            -pos          => [535,106]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'AutoUpdateTip'}   ,
                            -font         => $font10                 ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfGeoIPDB'             ,
                            -size         => [532, 22]               ,
                            -pos          => [150,133]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnGeoIPDB'            ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684,133]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnGeoIPDBUpt'         ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,133]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );
# Database tab - Issuer Identification Number (IIN) Database section
$winConfig->AddLabel(       -name         => 'lblIINDBShadowT'       ,
                            -size         => [250, 22]               ,
                            -pos          => [151,169]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'IINLocalDB'}.':'  ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblIINDBT'             ,
                            -size         => [250, 22]               ,
                            -pos          => [150,168]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'IINLocalDB'}.':'  ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfIINDB'               ,
                            -size         => [532, 22]               ,
                            -pos          => [150,198]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnIINDB'              ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684,198]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnIINDBUpt'           ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,198]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );
# Database tab - TLD Database section
$winConfig->AddLabel(       -name         => 'lblTLDDBShadowT'       ,
                            -size         => [260, 22]               ,
                            -pos          => [151,234]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'lblTLDDB'}.':'    ,
                            -font         => $fontGBu                , 
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblTLDDBT'             ,
                            -size         => [260, 22]               ,
                            -pos          => [150,233]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'lblTLDDB'}.':'    ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       ,  );
$winConfig->AddCheckbox(    -name         => 'chTLDDBAutoUpt'        ,
                            -size         => [240, 20]               ,
                            -pos          => [535,236]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'AutoUpdateTip'}   ,
                            -font         => $font10                 ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfTLDDB'               ,
                            -size         => [532, 22]               ,
                            -pos          => [150,263]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnTLDDB'              ,
                            -size         => [ 22, 22]               ,
                            -pos          => [685,263]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'btnTLDDBTip'}     ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnTLDDBUpt'           ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,263]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );
# XL-Parser Database tab - Expression history and database section
$winConfig->AddLabel(       -name         => 'lblExprHistoDBShadowT' ,
                            -size         => [300, 22]               ,
                            -pos          => [151, 36]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'exprHistoAndDB'}.':' ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblExprHistoDBT'       ,
                            -size         => [300, 22]               ,
                            -pos          => [150, 35]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'exprHistoAndDB'}.':' ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfExprHistoDB'         ,
                            -size         => [532, 22]               ,
                            -pos          => [150, 63]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnExprHistoDB'        ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684, 63]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewExprHistoDB'     ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707, 63]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfExprDB'              ,
                            -size         => [532, 22]               ,
                            -pos          => [150, 88]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnExprDB'             ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684, 88]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewExprDB'          ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707, 88]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnExprDBImport'       ,
                            -size         => [ 22, 22]               ,
                            -pos          => [730, 88]               ,
                            -bitmap       => $import16Bmp            ,
                            -tip          => $STR{'ImportExprDB'}    ,
                            -visible      => 0                       , );
# XL-Parser Database tab - Log format database section
$winConfig->AddLabel(       -name         => 'lblLFDBShadowT'        ,
                            -size         => [250, 22]               ,
                            -pos          => [151,119]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'winLFDB'}.':'     ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblLFDBT'              ,
                            -size         => [250, 22]               ,
                            -pos          => [150,118]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'winLFDB'}.':'     ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfLFDB'                ,
                            -size         => [532, 22]               ,
                            -pos          => [150,148]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnLFDB'               ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684,148]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewLFDB'            ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,148]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnLFDBUpt'            ,
                            -size         => [ 22, 22]               ,
                            -pos          => [730,148]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );
# XL-Parser Database tab - Log Analysis Filter Database section
$winConfig->AddLabel(       -name         => 'lblLAFiltersDBShadowT' ,
                            -size         => [340, 22]               ,
                            -pos          => [151,179]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'LAFiltersDB'}.':' ,
                            -font         => $fontGBu                , 
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblLAFiltersDBT'       ,
                            -size         => [340, 22]               ,
                            -pos          => [150,178]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'LAFiltersDB'}.':' ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       ,  );
$winConfig->AddTextfield(   -name         => 'tfLAFiltersDB'         ,
                            -size         => [532, 22]               ,
                            -pos          => [150,208]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnLAFiltersDB'        ,
                            -size         => [ 22, 22]               ,
                            -pos          => [685,208]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewLAFiltersDB'     ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,208]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblSavedQueriesDBShadowT',
                            -size         => [340, 22]               ,
                            -pos          => [151,239]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'savedQueriesDB'}.':',
                            -font         => $fontGBu                , 
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblSavedQueriesDBT'    ,
                            -size         => [340, 22]               ,
                            -pos          => [150,238]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'savedQueriesDB'}.':',
                            -font         => $fontGBu                ,
                            -visible      => 0                       ,  );
$winConfig->AddTextfield(   -name         => 'tfSavedQueriesDB'      ,
                            -size         => [532, 22]               ,
                            -pos          => [150,268]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnSavedQueriesDB'     ,
                            -size         => [ 22, 22]               ,
                            -pos          => [685,268]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewSavedQueriesDB'  ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,268]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
# XL-ToolKit Database tab - XL-Whois database section
$winConfig->AddLabel(       -name         => 'lblXLWHOISDBShadowT'   ,
                            -size         => [250, 22]               ,
                            -pos          => [151, 36]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'XLWhoisDB'}.':'   ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblXLWHOISDBT'         ,
                            -size         => [250, 22]               ,
                            -pos          => [150, 35]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'XLWhoisDB'}.':'   ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfXLWHOISDB'           ,
                            -size         => [532, 22]               ,
                            -pos          => [150, 68]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnXLWHOISDB'          ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684, 68]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
# XL-ToolKit Database tab - Resolve TLD database section
$winConfig->AddLabel(       -name         => 'lblResTLDDBShadowT'    ,
                            -size         => [250, 22]               ,
                            -pos          => [151,104]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'SO_ResolveTLD'}.':',
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblResTLDDBT'          ,
                            -size         => [250, 22]               ,
                            -pos          => [150,103]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'SO_ResolveTLD'}.':',
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfResTLDDB'            ,
                            -size         => [532, 22]               ,
                            -pos          => [150,133]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnResTLDDB'           ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684,133]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectResTLDFile'},
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnResTLDDBUpt'        ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,133]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadResTLD'}  ,
                            -visible      => 0                       , );
# XL-ToolKit Database tab - Datetime database section
$winConfig->AddLabel(       -name         => 'lblDTDBShadowT'        ,
                            -size         => [250, 22]               ,
                            -pos          => [151,169]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'DTDB'}.':'        ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddLabel(       -name         => 'lblDTDBT'              ,
                            -size         => [250, 22]               ,
                            -pos          => [150,168]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [ 50, 180,  0]          ,
                            -text         => $STR{'DTDB'}.':'        ,
                            -font         => $fontGBu                ,
                            -visible      => 0                       , );
$winConfig->AddTextfield(   -name         => 'tfDTDB'                ,
                            -size         => [532, 22]               ,
                            -pos          => [150,198]               ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnDTDB'               ,
                            -size         => [ 22, 22]               ,
                            -pos          => [684,198]               ,
                            -bitmap       => $fileOpenBmp            ,
                            -tip          => $STR{'selectDBFile'}    ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnNewDTDB'            ,
                            -size         => [ 22, 22]               ,
                            -pos          => [707,198]               ,
                            -bitmap       => $fileNewBmp             ,
                            -tip          => $STR{'createDBTable'}   ,
                            -visible      => 0                       , );
$winConfig->AddButton(      -name         => 'btnDTDBUpt'            ,
                            -size         => [ 22, 22]               ,
                            -pos          => [730,198]               ,
                            -bitmap       => $downloadBmp            ,
                            -tip          => $STR{'downloadDB'}      ,
                            -visible      => 0                       , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        -parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [600, 170]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);
$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [460, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Other windows
#------------------------------------------------------------------------------#
my $winClip;
my $winFileFilters;
my $winFileFormats;
&createWinFileFormats();
&loadFileFormatsGrid("$USERDIR\\FileFormats.json", \$winFileFormats, \%STR);
my $winSelFileFilters;
my $winExtraction;
my $gridExprHistoMenu;
my $gridExprDBMenu;
my $winExprTool;
my $winExprOpt;
my $winLFDB;
my $winLFObj;
my $winFO;
my $winDTDB;
my $winDTObj;
my $winLAFilters;
my $winFilterSet;
my $winFieldFilter;
my $gridFFDBDBMenu;
my $winLACurrDBFiles;
my $gridCurrDBListFilesMenu;
my $winLAQueryCols;
my $winSaveQuery;
my $cbSQLQueryCat;
my $winLASavedQueries;
my $gridLASavedQueriesMenu;

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#
# Set grid headers and some listbox values
# Set Extraction grid header
$win->gridExtraction->SetCellText(0, 0, $STR{'Operator'});
$win->gridExtraction->SetCellText(0, 1, $STR{'Case'}    );
$win->gridExtraction->SetCellText(0, 2, $STR{'Regex'}   );
$win->gridExtraction->SetCellText(0, 3, $STR{'Invert'}  );
$win->gridExtraction->SetCellText(0, 4, $STR{'Expression'});
$win->gridExtraction->SetCellText(0, 5, $STR{'comment'} );
$win->gridExtraction->SetCellFormat(0, 0, 1); # Center column headers
$win->gridExtraction->SetCellFormat(0, 1, 1);
$win->gridExtraction->SetCellFormat(0, 2, 1);
$win->gridExtraction->SetCellFormat(0, 3, 1);
$win->gridExtraction->SetCellFormat(0, 4, 1);
$win->gridExtraction->SetCellFormat(0, 5, 1);
$win->gridExtraction->SetListMode(1);
# List of timezone
my @listTZ = DateTime::TimeZone->all_names;
foreach (@listTZ) { $winConfig->cbLocalTZ->Add($_); }
# List of language
my @lang = DateTime::Locale->ids();
foreach (sort @lang) { $winConfig->cbDefaultLang->Add($_); }
# Delete list of files
my $reportDir = $winReport->tfReportDir->Text();
unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
if (-T $CONFIG_FILE) {
  &loadConfig($CONFIG_FILE, $USERDIR, \%CONFIG, \$winConfig, \$winExtraction, \$winDTDB, \$winReport, \$win);
  $THR_UPDATE = threads->create(sub {
    sleep(1);
    # Check update for tool and databases ?
    if ($CONFIG{'TOOL_AUTO_UPDATE'} or $CONFIG{'MACOUI_DB_AUTO_UPDATE'} or $CONFIG{'GEOIP_DB_AUTO_UPDATE'}) {
      &updateAll($VERSION, $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig, \$winPb, \$win, \%STR);
    }
  });
  # Position the window
  if ($winConfig->chRememberPos->Checked() and exists($CONFIG{'SCREEN_LEFT'}) and exists($CONFIG{'SCREEN_TOP'})) {
    $win->Left($CONFIG{'SCREEN_LEFT'});
    $win->Top($CONFIG{'SCREEN_TOP'});
  }
  # Set input (objects sent)
  if ($$REF_ARG[0]) {
    if (!$$REF_ARG[1]) {
      if    (-d $$REF_ARG[0]) { # A folder
        $win->tfInput->Text($$REF_ARG[0]);
        $win->rbInputDir->Checked(1);
        $win->rbInputFiles->Checked(0);
        &rbInputDir_Click();
      } else { # Single file
        if ($$REF_ARG[0] =~ /\.db/) {
          $win->rbInputDatabase->Checked(1);
          $win->rbInputDir->Checked(0);
          $win->rbInputFiles->Checked(0);
          $win->rbInputClipboard->Checked(0);
          $win->tfInput->Text($$REF_ARG[0]);
          &rbInputDatabase_Click;
        } else {
          $win->tfInput->Text($$REF_ARG[0]);
          $win->rbInputDir->Checked(0);
          $win->rbInputFiles->Checked(1);
          &rbInputFiles_Click();
        }
      }
    } else { # Multiple files
      my $argStr;
      my @path = split(/\\/, $$REF_ARG[1]);
      pop(@path);
      $argStr = '"'.join("\\", @path).'" ';
      foreach my $file (@$REF_ARG) { $argStr .= '"'.(split(/\\/, $file))[-1].'" '; }
      chop($argStr);
      $win->tfInput->Text($argStr);
      $win->rbInputDir->Checked(0);
      $win->rbInputFiles->Checked(1);
      &rbInputFiles_Click();
    }
  # No input
  } else {
    $win->rbInputDir->Checked(1);
    $win->rbInputFiles->Checked(0);
    &rbInputDir_Click();
  }
} else {
  # Create the Configuration Wizard Window
  my $refWinCW = &createCW();
  &createWinLFDB(0);
  &createWinLFObj();
  &createWinDTDB(0);
  # First start of the tool, Load configuration wizard
  $THR_UPDATE = threads->create(sub { &firstStart($refWinCW); });
}
$START = 1;
if ($CONFIG{'FULL_SCREEN'}) { $win->Show(3); }
else                        { $win->Show();  }
Win32::GUI::Dialog();

#--------------------------#
sub winMain_Terminate
#--------------------------#
{
  # Remember position
  my $winLeft   = $win->AbsLeft();
  my $winTop    = $win->AbsTop();
  $CONFIG{'SCREEN_LEFT'} = $winLeft;
  $CONFIG{'SCREEN_TOP'}  = $winTop;
  &saveConfig($CONFIG_FILE, \%CONFIG);
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  -1; # Close program
  
}  #--- End winMain_Terminate

#--------------------------#
sub winMain_Maximize { $MAXIMIZE = 1; }
#--------------------------#

#--------------------------#
sub winMain_Resize
#--------------------------#
{
  if ($MAXIMIZE) { $CONFIG{'FULL_SCREEN'} = 1; $MAXIMIZE = 0; }
  elsif ($START) { $CONFIG{'FULL_SCREEN'} = 0; }
  # Header
  $win->lblHeader->Width($win->ScaleWidth()-240);
  # Input section
  $win->lblInputT->Width($win->ScaleWidth());
  $win->btnFileFilters->Left($win->ScaleWidth()-230);
  $win->btnFileFormats->Left($win->ScaleWidth()-115);
  $win->tfInput->Width($win->ScaleWidth()-174);
  $win->btnInput->Left($win->ScaleWidth()-167);
  $win->chInputDirRecurse->Left($win->ScaleWidth()-142);
  # Functions section
  my $topSection = 155;
  $win->lblFunctionsT->Width($win->ScaleWidth());
  $win->lblFunctionsT->Top($topSection);
  $win->TabFunctions->Width($win->ScaleWidth()+3);
  $win->TabFunctions->Top($topSection+24);
  # Extraction functions
  $win->ExtractFunctions->Top($topSection+47);
  $win->ExtractFunctions->Width($win->ScaleWidth()+4);
  $win->ExtractFunctions->Height($win->ScaleHeight()-96);
  $win->gridExtraction->Top($topSection+100);
  $win->gridExtraction->Width($win->ScaleWidth()-31);
  $win->gridExtraction->Height($win->ScaleHeight()-$topSection-160);
  $win->gridExtraction->AutoSizeColumns();
  $win->gridExtraction->ExpandLastColumn();
  $win->gridExtraction->Refresh();
  $win->btnExtractAdd->Top($topSection+76);
  $win->btnExtractDel->Top($topSection+76);
  $win->btnExtractOpt->Top($topSection+76);
  $win->btnExtractImport->Top($topSection+76);
  $win->btnExtractSave->Top($topSection+76);
  $win->btnExtractOpenRes->Top($topSection+76);
  $win->btnUpGrid->Top($topSection+100);
  $win->btnDownGrid->Top($topSection+124);
  $win->btnExtractOpenRes->Left($win->ScaleWidth()-25);
  $win->btnUpGrid->Left($win->ScaleWidth()-25);
  $win->btnDownGrid->Left($win->ScaleWidth()-25);
  $win->btnExtractRefresh->Left($win->ScaleWidth()-25);
  $win->btnExtractRefresh->Top($win->ScaleHeight()-82);
  # Special objects
  $win->tvSO->Top($topSection+77);
  $win->tvSO->Height($win->ScaleHeight()-$topSection-137);
  $win->tvSO->Width($win->ScaleWidth()-32);
  # Web Log Analysis functions
  $win->LAFunctions->Top($topSection+47);
  $win->LAFunctions->Width($win->ScaleWidth()+4);
  $win->LAFunctions->Height($win->ScaleHeight()-96);
  # Log analysis (Create or update database)
  $win->lblCreateUpdateDB->Top($topSection+56);
  $win->rbLACreateDB->Top($topSection+53);
  $win->rbLAUpdateDB->Top($topSection+53);
  $win->lblLF->Top($topSection+83);
  $win->cbLF->Top($topSection+80);
  $win->btnWinLFDB->Top($topSection+80);
  $win->btnLFGuess->Top($topSection+80);
  $win->btnLAFileOrder->Top($topSection+80);
  $win->chLASetReadOnly->Top($topSection+80);
  $win->lblLAResolve->Top($topSection+113);
  $win->chLAOptResISP->Top($topSection+110);
  $win->chLAOptResGeoIP->Top($topSection+110);
  $win->chLAOptResUA->Top($topSection+110);
  $win->chLAOptResWeekday->Top($topSection+110);
  $win->lblLAFilters->Top($topSection+143);
  $win->btnLAFilters->Top($topSection+140);
  $win->chLALogFiltered->Top($topSection+140);
  $win->chLALogRejected->Top($topSection+140);
  $win->chLAIgnoreComments->Top($topSection+140);
  $win->lblDestLADB->Top($topSection+173);
  $win->tfDestDir->Top($topSection+170);
  $win->btnDestDir->Top($topSection+170);
  $win->chLASelectDB->Top($topSection+197);
  $win->tfDestDir->Width($win->ScaleWidth()-339);
  $win->btnDestDir->Left($win->ScaleWidth()-217);
  # Current database
  $win->gbCurrDBGeneral->Top($topSection+75);
  $win->gbCurrDBGeneral->Width($win->ScaleWidth()-230);
  $win->lblCurrDBLastUpdate->Top($topSection+98);
  $win->lblCurrDBLastUpdateVal->Top($topSection+98);
  $win->lblCurrDBPeriod->Top($topSection+98);
  $win->lblCurrDBPeriodVal->Top($topSection+98);
  $win->lblCurrDBNbrOf->Top($topSection+123);
  $win->lblCurrDBNbrEntries->Top($topSection+123);
  $win->lblCurrDBNbrEntriesVal->Top($topSection+123);
  $win->lblCurrDBFiltered->Top($topSection+123);
  $win->lblCurrDBFilteredVal->Top($topSection+123);
  $win->lblCurrDBRejected->Top($topSection+123);
  $win->lblCurrDBRejectedVal->Top($topSection+123);
  $win->gbCurrDBSource->Top($topSection+150);
  $win->gbCurrDBSource->Height($win->ScaleHeight()-$win->gbCurrDBGeneral->Top()-130);
  $win->gbCurrDBSource->Width($win->ScaleWidth()-230);
  $win->lblCurrDBLogFormat->Top($topSection+175);
  $win->lblCurrDBLogFormatVal->Top($topSection+175);
  $win->btnLACurrDBFiles->Top($topSection+172);
  $win->btnLACurrDBFiles->Left($win->ScaleWidth()-455);
  $win->btnLACurrDBRejected->Top($topSection+172);
  $win->btnLACurrDBRejected->Left($win->ScaleWidth()-330);
  $win->lblCurrDBFilters->Top($topSection+200);
  $win->tfCurrDBFiltersVal->Top($topSection+200);
  $win->tfCurrDBFiltersVal->Height($win->ScaleHeight()-$win->gbCurrDBGeneral->Top()-185);
  $win->tfCurrDBFiltersVal->Width($win->ScaleWidth()-450);
  $win->btnLACurrDBFiltered->Top($topSection+200);
  $win->btnLACurrDBFiltered->Left($win->ScaleWidth()-330);
  $win->gbCurrDBResolved->Top($topSection+75);
  $win->lblCurrDBNbrResISP->Top($topSection+98);
  $win->lblCurrDBNbrResISPVal->Top($topSection+98);
  $win->lblCurrDBNbrResGeoIP->Top($topSection+123);
  $win->lblCurrDBNbrResGeoIPVal->Top($topSection+123);
  $win->lblCurrDBResUAs->Top($topSection+148);
  $win->lblCurrDBResUAsVal->Top($topSection+148);
  $win->lblCurrDBResWDs->Top($topSection+173);
  $win->lblCurrDBResWDsVal->Top($topSection+173);
  my $resolvedLeft = $win->ScaleWidth()-220;
  $win->gbCurrDBResolved->Left($resolvedLeft);
  $win->gbCurrDBResolved->Height($win->ScaleHeight()-$topSection-130);
  $win->lblCurrDBNbrResISP->Left($resolvedLeft+5);
  $win->lblCurrDBNbrResISPVal->Left($win->ScaleWidth()-100);
  $win->lblCurrDBNbrResGeoIP->Left($resolvedLeft+5);
  $win->lblCurrDBNbrResGeoIPVal->Left($win->ScaleWidth()-100);
  $win->lblCurrDBResUAs->Left($resolvedLeft+5);
  $win->lblCurrDBResUAsVal->Left($win->ScaleWidth()-100);
  $win->lblCurrDBResWDs->Left($resolvedLeft+5);
  $win->lblCurrDBResWDsVal->Left($win->ScaleWidth()-100);
  # Update database
  $win->lblDestDB->Top($topSection+83);
  $win->rbDestDBCurr->Top($topSection+80);
  $win->rbDestDBNew->Top($topSection+80);
  # Query database
  $win->lblLAQuerySelectShadowT->Top($topSection+81);
  $win->lblLAQuerySelectT->Top($topSection+80);
  $win->btnLAQuerySelectCols->Top($topSection+80);
  $win->btnLAQueryFilter->Top($topSection+80);
  $win->chLAQueryGroupBy->Top($topSection+80);
  $win->cbLAQueryGroupByCol->Top($topSection+80);
  $win->btnLAQueryGroupByAdd->Top($topSection+80);
  $win->chLAQueryOrderBy->Top($topSection+80);
  $win->cbLAQueryOrderByCol->Top($topSection+80);
  $win->cbLAQueryOrderBy->Top($topSection+80);
  $win->btnLAQueryOrderByAdd->Top($topSection+80);
  $win->chLAQueryHavingCount->Top($topSection+108);
  $win->cbLAQueryHavingCountCol->Top($topSection+108);
  $win->cbLAQueryHavingCount->Top($topSection+108);
  $win->tfLAQueryHavingCount->Top($topSection+108);
  $win->btnLAQueryHavingCountAdd->Top($topSection+108);
  $win->lblLAQueryShadowT->Top($topSection+138);
  $win->lblLAQueryT->Top($topSection+137);
  $win->btnLAQuerySelectSaved->Top($topSection+137);
  $win->btnLAQueryEdit->Top($topSection+137);
  $win->btnLAQuerySave->Top($topSection+137);
  $win->btnLAQueryReset->Top($topSection+137);
  $win->tfLAQuery->Top($topSection+163);
  $win->lblLAQueryOk->Top($topSection+162);
  $win->lblLAQueryErr->Top($topSection+162);
  $win->tfLAQuery->Width($win->ScaleWidth()-95);
  $win->tfLAQuery->Height($win->ScaleHeight()-$win->tfLAQuery->Top()-85);
  $win->lblLAQueryOk->Width($win->ScaleWidth()-93);
  $win->lblLAQueryOk->Height($win->ScaleHeight()-$win->tfLAQuery->Top()-83);
  $win->lblLAQueryErr->Width($win->ScaleWidth()-93);
  $win->lblLAQueryErr->Height($win->ScaleHeight()-$win->tfLAQuery->Top()-83);
  $win->lblLAQueryOutputShadowT->Top($win->ScaleHeight()-79);
  $win->lblLAQueryOutputT->Top($win->ScaleHeight()-80);
  $win->btnLAQueryReportOpt->Top($win->ScaleHeight()-80);
  # Suspicious activities
  $win->lblLASearchOptShadowT->Top($topSection+81);
  $win->lblLASearchOptT->Top($topSection+80);
  $win->btnLASearchReportOpt->Top($topSection+80);
  $win->lblLASearchSAMaxRes->Top($topSection+83);
  $win->tfLASearchSAMaxRes->Top($topSection+80);
  $win->btnLASearchSaveOptions->Top($topSection+80);
  $win->btnLASearchOpenResults->Top($topSection+80);
  $win->lblLASearchSAIndShadowT->Top($topSection+108);
  $win->lblLASearchSAIndT->Top($topSection+107);
  $win->btnLASearchReset->Top($topSection+137);
  $win->gridLASearchSAInd->Top($topSection+107);
  $win->gridLASearchSAInd->Width($win->ScaleWidth()-115);
  $win->gridLASearchSAInd->Height($win->ScaleHeight()-$topSection-162);
  $win->gridLASearchSAInd->AutoSizeColumns();
  $win->gridLASearchSAInd->ExpandLastColumn();
  # Split logs
  $win->lblSplitType->Top($topSection+56);
  $win->rbSplitBySize->Top($topSection+53);
  $win->rbSplitByLines->Top($topSection+53);
  $win->rbSplitByTime->Top($topSection+53);
  $win->lblSplitBySize->Top($topSection+86);
  $win->tfSplitBySizeFrag->Top($topSection+83);
  $win->cbSplitBySizeUnit->Top($topSection+83);
  $win->chSplitUseDTFN->Top($topSection+83);
  $win->lblSplitByLinesNbr->Top($topSection+86);
  $win->tfSplitByLinesNbr->Top($topSection+83);
  $win->upDownLinesNbr->Top($topSection+83);
  $win->lblSplitByTime->Top($topSection+86);
  $win->cbSplitByTimeInter->Top($topSection+83);
  $win->lblSplitTimeFormat->Top($topSection+116);
  $win->cbSplitTimeFormat->Top($topSection+113);
  $win->btnSplitTimeDTDB->Top($topSection+113);
  $win->btnSplitTimeFormatGuess->Top($topSection+113);
  $win->lblSplitDestDir->Top($topSection+143);
  $win->tfSplitDestDir->Top($topSection+143);
  $win->btnSplitDestDir->Top($topSection+143);
  $win->chOpenSplitDestDir->Top($topSection+143);
  $win->tfSplitDestDir->Width($win->ScaleWidth()-379);
  $win->btnSplitDestDir->Left($win->ScaleWidth()-217);
  $win->chOpenSplitDestDir->Left($win->ScaleWidth()-190);
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-52);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-35);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-240);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-330);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-315);
  $win->btnProcess->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinConfig->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);
  
}  #--- End winMain_Resize

#--------------------------#
sub rbInputDir_Click
#--------------------------#
{
  if ($win->TabFunctions->GetItemCount() != 3) {
    $win->TabFunctions->DeleteAllItems();
    $win->TabFunctions->InsertItem(-text => $STR{'Extraction'});
    $win->TabFunctions->InsertItem(-text => $STR{'WebLogAnalysis'});
    $win->TabFunctions->InsertItem(-text => $STR{'SplitLogs'});
    $win->TabFunctions->SetCurSel(0);
    &TabFunctions_Click();
  } elsif ($win->TabFunctions->GetString($win->TabFunctions->SelectedItem()) eq $STR{'WebLogAnalysis'}) {
    &TabFunctions_Click();
  }
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  $winFO->gridFO->DeleteNonFixedRows() if $winFO;
  # Input Dir options
  $win->btnFileFilters->Show();
  $win->btnFileFormats->Show();
  $win->tfInput->Show();
  $win->btnInput->Show();
  $win->chInputDirRecurse->Show();
  # If input textfield contain something that is not a directory, delete it
  $win->tfInput->Text('') if $win->tfInput->Text() and !-d $win->tfInput->Text();
  &isProcessReady(0);
  
}  #--- End rbInputDir_Click

#--------------------------#
sub rbInputFiles_Click
#--------------------------#
{
  if ($win->TabFunctions->GetItemCount() != 3) {
    $win->TabFunctions->DeleteAllItems();
    $win->TabFunctions->InsertItem(-text => $STR{'Extraction'});
    $win->TabFunctions->InsertItem(-text => $STR{'WebLogAnalysis'});
    $win->TabFunctions->InsertItem(-text => $STR{'SplitLogs'});
    $win->TabFunctions->SetCurSel(0);
    &TabFunctions_Click();
  } elsif ($win->TabFunctions->GetString($win->TabFunctions->SelectedItem()) eq $STR{'WebLogAnalysis'}) {
    &TabFunctions_Click();
  }
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  $winFO->gridFO->DeleteNonFixedRows() if $winFO;
  # InputFiles options
  $win->btnFileFilters->Hide();
  $win->btnFileFormats->Show();
  $win->tfInput->Show();
  $win->btnInput->Show();
  $win->chInputDirRecurse->Hide();
  # If input textfield contain something that is not a file, delete it
  $win->tfInput->Text('') if $win->tfInput->Text() and !-f $win->tfInput->Text();
  &isProcessReady(0);

}  #--- End rbInputFiles_Click

#--------------------------#
sub rbInputDatabase_Click
#--------------------------#
{
  $win->TabFunctions->DeleteAllItems();
  $win->TabFunctions->InsertItem(-text => $STR{'WebLogAnalysis'});
  $win->TabFunctions->SetCurSel(0);
  &TabFunctions_Click();
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  # Input Database options
  $win->btnFileFilters->Hide();
  $win->btnFileFormats->Hide();
  $win->tfInput->Show();
  $win->btnInput->Show();
  $win->chInputDirRecurse->Hide();
  # If input textfield contain something that is not a valid database
  my $dbFile = $win->tfInput->Text();
  $win->tfInput->Text('') if !$dbFile or $dbFile !~ /\.db/ or !&validLADB($dbFile);
  &isProcessReady(0);

}  #--- End rbInputDatabase_Click

#--------------------------#
sub rbInputClipboard_Click
#--------------------------#
{
  $win->TabFunctions->DeleteAllItems();
  $win->TabFunctions->InsertItem(-text => $STR{'Extraction'});
  $win->TabFunctions->SetCurSel(0);
  &TabFunctions_Click();
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  $winFO->gridFO->DeleteNonFixedRows() if $winFO;
  # Input Clipboard options
  $win->btnFileFilters->Hide();
  $win->btnFileFormats->Hide();
  $win->tfInput->Text('');
  $win->tfInput->Hide();
  $win->btnInput->Hide();
  $win->chInputDirRecurse->Hide();
  # Reset File Formats selection
  for (my $row = 1; $row <= $winFileFormats->gridFileFormats->GetRows(); $row++) {
    $winFileFormats->gridFileFormats->SetCellCheck($row, 0, 0);
  }
  $winFileFormats->gridFileFormats->SetCellCheck(1, 0, 1); # Plain text is selected by default
  &isProcessReady(0);

}  #--- End rbInputClipboard_Click

#--------------------------#
sub btnInputClipboard_Click
#--------------------------#
{
  &createWinClip() if !$winClip;
  # Gather clipboard content
  if (my $text = Win32::Clipboard::GetText()) {
    $winClip->tfClip->Text($text);
  } else { $winClip->tfClip->Text($STR{'errNoTextData'}); }
  $winClip->Center($win);
  $winClip->DoModal();
  return(1);

}  #--- End btnInputClipboard_Click

#--------------------------#
sub createWinClip
#--------------------------#
{
  # Clipboard Window
  $winClip = Win32::GUI::Window->new( -name        => 'winClip'               ,
                                      -background  => [255, 255, 255]         ,
                                      -parent      => $win                    ,
                                      -text        => $STR{'rbInputClipboard'},
                                      -pos         => [$winPosX, $winPosY]    ,
                                      -size        => [$winWidth,$winHeight]  ,
                                      -minsize     => [$winWidth,$winHeight]  ,
                                      -hasmaximize => 1                       ,
                                      -hasminimize => 1                       ,
                                      -resizable   => 1                       ,
                                      -dialogui    => 1                       ,
                                      -accel       => $accel                  , );
  $winClip->SetIcon($winICO);
  $winClip->AddTextfield( -name        => 'tfClip'            ,
                          -size        => [$winWidth-25, $winHeight-85] ,
                          -pos         => [  5,  5]           ,
                          -background  => [255, 255, 255]     ,
                          -multiline   => 1                   ,
                          -wantreturn  => 1                   ,
                          -hscroll     => 1                   ,
                          -vscroll     => 1                   , );
  $winClip->AddButton(    -name        => 'btnClipOk'         ,
                          -text        => $STR{'Ok'}          ,
                          -size        => [ 80, 30]           ,
                          -pos         => [($winWidth-170)/2,$winHeight-73] ,
                          -ok          => 1                   ,
                          -default     => 1                   , );
  $winClip->AddButton(    -name        => 'btnClipEdit'       ,
                          -text        => $STR{'Edit'}        ,
                          -size        => [ 80, 30]           ,
                          -pos         => [($winWidth-170)/2+100,$winHeight-73] ,
                          -disabled    => 1                   , );

}  #--- End createWinClip

#--------------------------#
sub winClip_Resize
#--------------------------#
{
  $winClip->tfClip->Resize(    $winClip->ScaleWidth()-12        , $winClip->ScaleHeight()-50);
  $winClip->btnClipOk->Move(  ($winClip->ScaleWidth()-170)/2    , $winClip->ScaleHeight()-38);
  $winClip->btnClipEdit->Move(($winClip->ScaleWidth()-170)/2+100, $winClip->ScaleHeight()-38);
  return(1);

}  #--- End winClip_Resize

#--------------------------#
sub selectAll_Click { $winClip->tfClip->SelectAll(); } # Select Clipboard Textfield
#--------------------------#

#--------------------------#
sub tfClip_Change
#--------------------------#
{
  my $tfClip = $winClip->tfClip->Text();
  if ($tfClip) { $winClip->btnClipEdit->Enable();  }
  else         { $winClip->btnClipEdit->Disable(); }

}  #--- End tfClip_Change

#--------------------------#
sub btnClipOk_Click { return(-1); }  #--- End btnClipOk_Click
#--------------------------#

#--------------------------#
sub btnClipEdit_Click
#--------------------------#
{
  # Set clipboard content
  my $text = $winClip->tfClip->Text();
  Win32::Clipboard::Set($text);
  $winClip->btnClipEdit->Disable();

}  #--- End btnClipEdit_Click

#--------------------------#
sub btnFileFilters_Click
#--------------------------#
{
  &createWinFileFilters() if !$winFileFilters;
  $winFileFilters->Center($win);
  $winFileFilters->Show();
  return(1);

}  #--- End btnFileFilters_Click

#--------------------------#
sub createWinFileFilters
#--------------------------#
{
  # Create File Filters window
  $winFileFilters = Win32::GUI::Window->new(-name        => 'winFileFilters'       ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'FileFilters'}    ,
                                            -pos         => [$winPosX, $winPosY]   ,
                                            -size        => [790, 220]             ,
                                            -minsize     => [790, 220]             ,
                                            -hasmaximize => 1                      ,
                                            -hasminimize => 1                      ,
                                            -resizable   => 1                      ,
                                            -dialogui    => 1                      , );
  $winFileFilters->SetIcon($winICO);
  $winFileFilters->AddLabel(    -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  0,  5]               ,
                                -bitmap       => $filterList128          ,
                                -background   => [255, 255, 255]         , );
  # File filters grid
  $winFileFilters->AddGrid(     -name         => 'gridFileFilters'       ,
                                -size         => [610,180]               ,
                                -pos          => [140,  5]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 5                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -editable     => 0                       ,
                                -hscroll      => 1                       ,
                                -vscroll      => 1                       , );
  $winFileFilters->gridFileFilters->SetListMode(1);
  $winFileFilters->AddButton(   -name         => 'btnFileFilterAdd'      ,
                                -size         => [ 22, 22]               ,
                                -pos          => [580,  5]               ,
                                -bitmap       => $filterAdd              ,
                                -tip          => $STR{'filterAddTip'}    , );
  $winFileFilters->AddButton(   -name         => 'btnFileFilterDel'      ,
                                -size         => [ 22, 22]               ,
                                -pos          => [602,  5]               ,
                                -bitmap       => $filterDel              ,
                                -tip          => $STR{'filterDelTip'}    ,
                                -disabled     => 1                       , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersImport'  ,
                                -size         => [ 22, 22]               ,
                                -pos          => [580, 29]               ,
                                -bitmap       => $importTab16Bmp         ,
                                -tip          => $STR{'filterImportTip'} , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersSave'    ,
                                -size         => [ 22, 22]               ,
                                -pos          => [602, 29]               ,
                                -bitmap       => $saveTab16Bmp           ,
                                -tip          => $STR{'filterSaveTip'}   ,
                                -disabled     => 1                       , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersOk'      ,
                                -text         => $STR{'Ok'}              ,
                                -size         => [ 60, 30]               ,
                                -pos          => [195,190]               ,
                                -font         => $font10                 ,
                                -ok           => 1                       ,
                                -default      => 1                       , );
  # Set File Filter grid header
  $winFileFilters->gridFileFilters->SetCellText(0, 0, $STR{'Operator'} );
  $winFileFilters->gridFileFilters->SetCellText(0, 1, $STR{'Type'}     );
  $winFileFilters->gridFileFilters->SetCellText(0, 2, $STR{'TypeOp'}   );
  $winFileFilters->gridFileFilters->SetCellText(0, 3, $STR{'flags'}    );
  $winFileFilters->gridFileFilters->SetCellText(0, 4, $STR{'searchStr'});
  $winFileFilters->gridFileFilters->SetCellFormat(0, 0, 1); # Center column headers
  $winFileFilters->gridFileFilters->SetCellFormat(0, 1, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 2, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 3, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 4, 1);
  $winFileFilters->gridFileFilters->AutoSize();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  
}  #--- End createWinFileFilters

#--------------------------#
sub winFileFilters_Resize
#--------------------------#
{
  $winFileFilters->gridFileFilters->Width($winFileFilters->ScaleWidth()-190);
  $winFileFilters->gridFileFilters->Height($winFileFilters->ScaleHeight()-45);
  $winFileFilters->gridFileFilters->AutoSize();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->btnFileFilterAdd->Left($winFileFilters->ScaleWidth()-48);
  $winFileFilters->btnFileFilterDel->Left($winFileFilters->ScaleWidth()-24);
  $winFileFilters->btnFileFiltersImport->Left($winFileFilters->ScaleWidth()-48);
  $winFileFilters->btnFileFiltersSave->Left($winFileFilters->ScaleWidth()-24);
  $winFileFilters->btnFileFiltersOk->Left($winFileFilters->ScaleWidth()/2);
  $winFileFilters->btnFileFiltersOk->Top($winFileFilters->ScaleHeight()-35);

}  #--- End winFileFilters_Resize

#--------------------------#
sub btnFileFiltersOk_Click
#--------------------------#
{
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  $winFO->gridFO->DeleteNonFixedRows() if $winFO;
  &winFileFilters_Terminate();

}  #--- End btnFileFiltersOk_Click

#--------------------------#
sub winFileFilters_Terminate
#--------------------------#
{
  $winFileFilters->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winFileFilters_Terminate

#--------------------------#
sub btnFileFormats_Click
#--------------------------#
{
  # Show File Formats Window
  $winFileFormats->Center($win);
  $winFileFormats->Show();
  return(1);

}  #--- End btnFileFormats_Click

#--------------------------#
sub createWinFileFormats
#--------------------------#
{
  # File Formats Window
  $winFileFormats = Win32::GUI::Window->new(-name        => 'winFileFormats'      ,
                                            -background  => [255, 255, 255]       ,
                                            -parent      => $win                  ,
                                            -text        => $STR{'FileFormats'}   ,
                                            -pos         => [$winPosX, $winPosY]  ,
                                            -size        => [450,380]             ,
                                            -minsize     => [450,380]             ,
                                            -hasmaximize => 0                     ,
                                            -hasminimize => 0                     ,
                                            -resizable   => 0                     ,
                                            -dialogui    => 1                     , );
  $winFileFormats->SetIcon($winICO);
  $winFileFormats->AddGrid(   -name         => 'gridFileFormats'       ,
                              -size         => [435,305]               ,
                              -pos          => [  5,  5]               ,
                              -background   => [255, 255, 255]         ,
                              -columns      => 4                       ,
                              -fixedrows    => 1                       ,
                              -fixedcolumns => 0                       ,
                              -editable     => 1                       , );
  $winFileFormats->gridFileFormats->SetListMode(1);
  $winFileFormats->AddButton( -name         => 'btnFileFormatsReset'   ,
                              -text         => $STR{'Reset'}           ,
                              -size         => [ 70, 30]               ,
                              -pos          => [160,315]               ,
                              -font         => $font10                 ,
                              -disabled     => 1                       , );
  $winFileFormats->AddButton( -name         => 'btnFileFormatsOk'      ,
                              -text         => $STR{'Ok'}              ,
                              -size         => [ 60, 30]               ,
                              -pos          => [240,315]               ,
                              -font         => $font10                 ,
                              -ok           => 1                       ,
                              -default      => 1                       , );

}  #--- End createWinFileFormats

#--------------------------#
sub gridFileFormats_Click
#--------------------------#
{
  # Local variables
  my ($row, $col) = @_;
  &saveFileFormats($row) if ($row == 4 or $row == 5) and $col == 3;
  
}  #--- End gridFileFormats_Click
  
#--------------------------#
sub gridFileFormats_EndEdit
#--------------------------#
{
  # Local variables
  my ($row, $col) = @_;
  &saveFileFormats($row) if $row and ($col == 2 or $col == 3);
	$winFileFormats->gridFileFormats->AutoSize();
	$winFileFormats->gridFileFormats->ExpandLastColumn();

}  #--- End gridFileFormats_EndEdit

#--------------------------#
sub saveFileFormats
#--------------------------#
{
  # Selected row values
  my $row     = shift;
  my $name    = $winFileFormats->gridFileFormats->GetCellText($row, 1);
  my $extList = $winFileFormats->gridFileFormats->GetCellText($row, 2);
  # If file already exists, load values
  my $refFileFormats = &loadFileFormats("$USERDIR\\FileFormats.json", \%STR);
  # Save changes
  if ($$refFileFormats{$row}{name} eq $name) {
    $$refFileFormats{$row}{extList} = $extList;
    # Options
    if ($$refFileFormats{$row}{name} eq 'Doc' or $$refFileFormats{$row}{name} eq 'Docx' or
        my $option = $winFileFormats->gridFileFormats->GetCellCheck($row, 3)) { # Doc or Docx checkbox option
      $$refFileFormats{$row}{options} = 1;
    } elsif ($$refFileFormats{$row}{name} eq $STR{'Unicode'}) { # Unicode combo options
      $$refFileFormats{$row}{options} = $winFileFormats->gridFileFormats->GetCellText($row, 3);
    }
    # Save indicators in JSON file
    my $jsonObj  = JSON->new;
    my $jsonText = $jsonObj->encode($refFileFormats);
    if (open(my $json, '>:encoding(cp1252)', "$USERDIR\\FileFormats.json")) {
      print $json $jsonText;
      close($json);
      $winFileFormats->btnFileFormatsReset->Enable();
    }
  }
  
}  #--- End saveFileFormats

#--------------------------#
sub btnFileFormatsReset_Click
#--------------------------#
{
  unlink("$USERDIR\\FileFormats.json") if -f "$USERDIR\\FileFormats.json";
  $winFileFormats->gridFileFormats->DeleteNonFixedRows();
  &loadFileFormatsGrid("$USERDIR\\FileFormats.json", \$winFileFormats, \%STR);
  $winFileFormats->btnFileFormatsReset->Disable();

}  #--- End btnFileFormatsReset_Click

#--------------------------#
sub btnFileFormatsOk_Click
#--------------------------#
{
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  &winFileFormats_Terminate();

}  #--- End btnFileFormatsOk_Click

#--------------------------#
sub winFileFormats_Terminate
#--------------------------#
{
  $winFileFormats->Hide();
  $win->BringWindowToTop();
  return(0);

}  #--- End winFileFormats_Terminate

#--------------------------#
sub tfInput_Change
#--------------------------#
{
  if (my $input = $win->tfInput->Text() and ($win->rbInputDir->Checked() or $win->rbInputFiles->Checked())) {
    unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
    $win->btnExtractRefresh->Disable();
    my @input = split(/" "/, $input);
    my @listExts;
    # Delete list of files
    my $reportDir = $winReport->tfReportDir->Text();
    unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
    $win->btnExtractRefresh->Disable();
    $winFO->gridFO->DeleteNonFixedRows() if $winFO;
    # Reset File Formats selection
    for (my $row = 1; $row <= $winFileFormats->gridFileFormats->GetRows(); $row++) {
      $winFileFormats->gridFileFormats->SetCellCheck($row, 0, 0);
    }
    if (!$input[1]) {
      if    (!-d $input[0]) { # Not a folder
        if ($input[0] =~ /\./) {
          my @partsPath = split(/\./, $input[0]);
          my $extension = pop(@partsPath);
          push(@listExts, $extension);
        }
      }
    } else { # Multiple files
      foreach my $file (@input) {
        $file =~ s/\"//g;
        if (!-d $file and -e "$input[0]\\$file") {
          if ($file =~ /\./) {
            my @partsPath = split(/\./, $file);
            my $extension = pop(@partsPath);
            push(@listExts, $extension);
          }
        }
      }
    }
    if (scalar(@listExts)) { &selFileFormats(\@listExts, \$winFileFormats, \%STR); }
    # Count selected File Formats
    my $nbrSelFileFormats = 0;
    for (my $row = 1; $row <= $winFileFormats->gridFileFormats->GetRows(); $row++) {
      $nbrSelFileFormats++ if $winFileFormats->gridFileFormats->GetCellCheck($row, 0);
    }
    $winFileFormats->gridFileFormats->SetCellCheck(1, 0, 1) if !$nbrSelFileFormats; # Plain text is selected by default
  }
  &isProcessReady(0);
  
}  #--- End winFileFormats_Terminate

#--------------------------#
sub btnInput_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfInput->Text();
  my $dir;
  # Select a folder
  if ($win->rbInputDir->Checked()) {
    if ($lastDir) {
      my (@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1, -directory  => $lastDir);
    } else {
      $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1);
    }
    # Selected folder
    if ($dir and -d $dir) {
      chop($dir) if $dir =~ /\\$/;
      $win->tfInput->Text($dir);
    }
  # Select a file
  } else {
    my @filesStr;
    if ($lastDir) {
      # Textfield contained a folder
      if (-d $lastDir) {
        my (@parts) = split(/\\/, $lastDir);
        if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      # Textfield contained a file or a list of files
      } else {
        # Multiple files
        $lastDir = (split(/" "/, $lastDir))[0] if $lastDir =~ /" "/;
        # Single file
        my @parts = split(/ /, $lastDir);
        if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      }
      # Database is checked (add a filter and no multiselection allowed)
      if ($win->rbInputDatabase->Checked()) {
        @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                     ,
                                                  -title         => $STR{'selectDBFile'}.':' ,
                                                  -filter        => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                                  -filemustexist => 1                        ,
                                                  -directory     => $lastDir                 ,
                                                  -explorer      => 1                        , );
      } else {
        @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                  -title         => $STR{'selFiles'}.':' ,
                                                  -defaultfilter => 0                    ,
                                                  -filemustexist => 1                    ,
                                                  -multisel      => 1                    ,
                                                  -directory     => $lastDir             ,
                                                  -explorer      => 1                    , );
      }
    # The textfield was empty and database is checked (add a filter and no multiselection allowed)
    } elsif ($win->rbInputDatabase->Checked()) {
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                     ,
                                                -title         => $STR{'selectDBFile'}.':' ,
                                                -filter        => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                                -filemustexist => 1                        ,
                                                -explorer      => 1                        , );
    # The textfield was empty
    } else {
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -explorer      => 1                    , );
    }
    # Selected file
    if ($filesStr[0] and scalar(@filesStr) > 0) {
      # Single file
      if ($filesStr[0] and scalar(@filesStr) == 1) {
        # Valid database
        if ($win->rbInputDatabase->Checked() and &validLADB($filesStr[0])) {
          $win->tfInput->Text($filesStr[0]);
          threads->create(sub {
            &updateCurrDatabaseInfos($filesStr[0], $winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}),
                                     \$winLACurrDBFiles, \$win, \%STR);
            $win->btnLAFilters->Enable();
          });
        # Valid file
        } elsif (-d $filesStr[0] or -f $filesStr[0]) { $win->tfInput->Text($filesStr[0]); }
      # Multiple files
      } else {
        my $filesStr;
        foreach my $file (@filesStr) { $filesStr .= "\"$file\" "; }
        chop($filesStr);
        $win->tfInput->Text($filesStr);
      }
    }
  }
  &isProcessReady(0);
  
}  #--- End btnInputDir_Click

#--------------------------#
sub chInputDirRecurse_Click
#--------------------------#
{
  # Delete list of files
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  $winFO->gridFO->DeleteNonFixedRows() if $winFO;
  
}  #--- End chInputDirRecurse_Click

#--------------------------#
sub btnFileFilterAdd_Click
#--------------------------#
{
  &createWinSelFileFilters() if !$winSelFileFilters;
  # Reset Filter window controls
  $winSelFileFilters->lblSelFileFiltersEditRow->Text('');
  $winSelFileFilters->lblSelFileFiltersOp->Disable();
  $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
  $winSelFileFilters->cbSelFileFiltersOp->Disable();
  $winSelFileFilters->TabSelFileFiltersType->SetCurSel(0);
  &TabSelFileFiltersType_Change();
  $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
  $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
  $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
  $winSelFileFilters->chSelFileFiltersContainsCase->Checked(0);
  $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(0);
  $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(0);
  $winSelFileFilters->tfSelFileFiltersContains->Text('');
  $winSelFileFilters->tfSelFileFiltersSize->Text('');
  $winSelFileFilters->tfSelFileFiltersItemList->Text('');
  # Enable/Disable operator
  if ($winFileFilters->gridFileFilters->GetRows() > 1) {
    $winSelFileFilters->lblSelFileFiltersOp->Enable();
    $winSelFileFilters->cbSelFileFiltersOp->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersOp->Disable();
    $winSelFileFilters->cbSelFileFiltersOp->Disable();
  }
  $winSelFileFilters->Center($win);
  $winSelFileFilters->Show();

}  #--- End btnFileFilterAdd_Click

#--------------------------#
sub gridFileFilters_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  &createWinSelFileFilters() if !$winSelFileFilters;
  if ($row != 0) {
    # Gather values of current selection
    my $operator  = $winFileFilters->gridFileFilters->GetCellText($row, 0);
    my $type      = $winFileFilters->gridFileFilters->GetCellText($row, 1);
    my $typeOp    = $winFileFilters->gridFileFilters->GetCellText($row, 2);
    my $flagsStr  = $winFileFilters->gridFileFilters->GetCellText($row, 3);
    my $searchStr = $winFileFilters->gridFileFilters->GetCellText($row, 4);
    # Set values
    $winSelFileFilters->lblSelFileFiltersEditRow->Text($row);
    if    ($type eq $STR{'Contains'}           ) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(0); }
    elsif ($type eq $STR{'rbFiltersSize'}      ) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(1); }
    elsif ($type eq $STR{'rbFiltersLastAccess'}) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(2); }
    elsif ($type eq $STR{'rbFiltersLastModif'} ) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(3); }
    &TabSelFileFiltersType_Change();
    if ($row == 1) { # First line, no operator
      $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
      $winSelFileFilters->cbSelFileFiltersOp->Disable();
    } else {
      $winSelFileFilters->cbSelFileFiltersOp->SetCurSel($winSelFileFilters->cbSelFileFiltersOp->FindStringExact($operator));
      $winSelFileFilters->cbSelFileFiltersOp->Enable();
    }
    # Reset other values
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->chSelFileFiltersContainsCase->Checked(0);
    $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(0);
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(0);
    $winSelFileFilters->tfSelFileFiltersContains->Text('');
    $winSelFileFilters->tfSelFileFiltersSize->Text('');
    $winSelFileFilters->tfSelFileFiltersItemList->Text('');
    # If input is file(s), disable all controls except File Formats
    if ($win->rbInputFiles->Checked()) {
      $winSelFileFilters->chSelFileFiltersContainsCase->Disable();
      $winSelFileFilters->chSelFileFiltersContainsRegex->Disable();
      $winSelFileFilters->chSelFileFiltersContainsFileOnly->Disable();
      $winSelFileFilters->lblSelFileFiltersContainOk->Disable();
      $winSelFileFilters->lblSelFileFiltersContainErr->Disable();
      $winSelFileFilters->lblSelFileFiltersContainWarn->Disable();
      $winSelFileFilters->tfSelFileFiltersContains->Disable();
      $winSelFileFilters->cbSelFileFiltersSizeOp->Disable();
      $winSelFileFilters->tfSelFileFiltersSize->Disable();
      $winSelFileFilters->cbSelFileFiltersSizeUnit->Disable();
      $winSelFileFilters->lblSelFileFiltersItemList->Disable();
      $winSelFileFilters->tfSelFileFiltersItemList->Disable();
      $winSelFileFilters->cbSelFileFiltersLastAccess->Disable();
      $winSelFileFilters->dtSelFileFiltersLastAccess->Disable();
      $winSelFileFilters->cbSelFileFiltersLastModif->Disable();
      $winSelFileFilters->dtSelFileFiltersLastModif->Disable();
    } else {
      $winSelFileFilters->chSelFileFiltersContainsCase->Enable();
      $winSelFileFilters->chSelFileFiltersContainsRegex->Enable();
      $winSelFileFilters->chSelFileFiltersContainsFileOnly->Enable();
      $winSelFileFilters->lblSelFileFiltersContainOk->Enable();
      $winSelFileFilters->lblSelFileFiltersContainErr->Enable();
      $winSelFileFilters->lblSelFileFiltersContainWarn->Enable();
      $winSelFileFilters->tfSelFileFiltersContains->Enable();
      $winSelFileFilters->cbSelFileFiltersSizeOp->Enable();
      $winSelFileFilters->tfSelFileFiltersSize->Enable();
      $winSelFileFilters->cbSelFileFiltersSizeUnit->Enable();
      $winSelFileFilters->lblSelFileFiltersItemList->Enable();
      $winSelFileFilters->tfSelFileFiltersItemList->Enable();
      $winSelFileFilters->cbSelFileFiltersLastAccess->Enable();
      $winSelFileFilters->dtSelFileFiltersLastAccess->Enable();
      $winSelFileFilters->cbSelFileFiltersLastModif->Enable();
      $winSelFileFilters->dtSelFileFiltersLastModif->Enable();
    }
    # Filter is Contains
    if ($type eq $STR{'Contains'}) {
      my ($case, $regex, $fileOnly) = split(/-/, $flagsStr);
      $winSelFileFilters->chSelFileFiltersContainsCase->Checked(1)     if $case;
      $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(1)    if $regex;
      $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(1) if $fileOnly;
      $winSelFileFilters->tfSelFileFiltersContains->Text($searchStr);
    # Filter by size
    } elsif ($type eq $STR{'rbFiltersSize'}) {
      $winSelFileFilters->cbSelFileFiltersSizeOp->SetCurSel($winSelFileFilters->cbSelFileFiltersSizeOp->FindStringExact($typeOp));
      my ($size, $sizeUnit) = split(/ /, $searchStr);
      $winSelFileFilters->tfSelFileFiltersSize->Text($size);
      $winSelFileFilters->cbSelFileFiltersSizeUnit->SetCurSel($winSelFileFilters->cbSelFileFiltersSizeUnit->FindStringExact($sizeUnit));
    # Filter by last accessed datetime
    } elsif ($type eq $STR{'rbFiltersLastAccess'}) {
      $winSelFileFilters->cbSelFileFiltersLastAccess->SetCurSel($winSelFileFilters->cbSelFileFiltersLastAccess->FindStringExact($typeOp));
      my ($y, $m, $d) = split(/-/, $searchStr);
      $winSelFileFilters->dtSelFileFiltersLastAccess->SetDate($y, $m, $d);
    # Filter by last modified datetime
    } elsif ($type eq $STR{'rbFiltersLastModif'}) {
      $winSelFileFilters->cbSelFileFiltersLastModif->SetCurSel($winSelFileFilters->cbSelFileFiltersLastModif->FindStringExact($typeOp));
      my ($y, $m, $d) = split(/-/, $searchStr);
      $winSelFileFilters->dtSelFileFiltersLastModif->SetDate($y, $m, $d);
    }
  }
  $winSelFileFilters->btnSelFileFiltersOk->Enable();
  $winSelFileFilters->Center($win);
  $winSelFileFilters->Show();
  $win->Disable();

}  #--- End gridFileFilters_DblClick

#--------------------------#
sub createWinSelFileFilters
#--------------------------#
{
  # Select File Filters window
  $winSelFileFilters = Win32::GUI::Window->new( -name        => 'winSelFileFilters'    ,
                                                -background  => [255, 255, 255]        ,
                                                -parent      => $win                   ,
                                                -text        => $STR{'FileFilters'}    ,
                                                -pos         => [$winPosX, $winPosY]   ,
                                                -size        => [595, 250]             ,
                                                -hasmaximize => 0                      ,
                                                -hasminimize => 0                      ,
                                                -resizable   => 0                      ,
                                                -dialogui    => 1                      , );
  $winSelFileFilters->SetIcon($winICO);
  $winSelFileFilters->AddLabel(     -name         => 'lblLogo'               ,
                                    -size         => [128,128]               ,
                                    -pos          => [  0,  5]               ,
                                    -bitmap       => $filterList128          ,
                                    -background   => [255, 255, 255]         , );
  $winSelFileFilters->AddTabStrip(  -name         => 'TabSelFileFiltersType' ,
                                    -size         => [451,223]               ,
                                    -pos          => [140,  0]               ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       ,
                                    -background   => [255, 255, 255]         , );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'}           , );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'rbFiltersSize'}      , );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'rbFiltersLastAccess'}, );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'rbFiltersLastModif'} , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersOp'   ,
                                    -size         => [100, 22]               ,
                                    -pos          => [145, 38]               ,
                                    -text         => $STR{'Operator'}.':'    ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersOp'    ,
                                    -size         => [ 60, 22]               ,
                                    -pos          => [250, 35]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersOp->Add($STR{'OR'}, $STR{'AND'}, );
  $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersEditRow',
                                    -size         => [ 10, 22]               ,
                                    -pos          => [540, 38]               ,
                                    -visible      => 0                       , ); # Hidden, Edit mode from caller
  # Filter: Contains
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsCase',
                                    -size         => [125, 22]               ,
                                    -pos          => [145, 70]               ,
                                    -text         => $STR{'Case'}            ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsRegex',
                                    -size         => [ 60, 22]               ,
                                    -pos          => [275, 70]               ,
                                    -text         => $STR{'Regex'}           ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsFileOnly',
                                    -size         => [200, 22]               ,
                                    -pos          => [370, 70]               ,
                                    -text         => $STR{'FilenameOnly'}    ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainOk',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [  0, 255,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainErr',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [255,   0,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainWarn',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [255, 255,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersContains',
                                    -size         => [430, 70]               ,
                                    -pos          => [145, 95]               ,
                                    -multiline    => 1                       ,
                                    -wantreturn   => 1                       ,
                                    -vscroll      => 1                       ,
                                    -autohscroll  => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->tfSelFileFiltersContains->MaxLength(5000000);
  # Filter: File size
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersSizeOp',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersSizeOp->Add($STR{'Smaller'}, $STR{'Equal'}, $STR{'Bigger'}, );
  $winSelFileFilters->cbSelFileFiltersSizeOp->SetCurSel(0);
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersSize'  ,
                                    -size         => [ 80, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -number       => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersSizeUnit',
                                    -size         => [ 80, 22]               ,
                                    -pos          => [450, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersSizeUnit->Add($STR{'b'}, $STR{'Kb'}, $STR{'Mb'},$STR{'Gb'});
  $winSelFileFilters->cbSelFileFiltersSizeUnit->SetCurSel(0);
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersItemList',
                                    -size         => [ 60, 22]               ,
                                    -pos          => [145, 95]               ,
                                    -background   => [255, 255, 255]         ,
                                    -text         => 'List:'                 ,
                                    -font         => $font10                 ,
                                    -visible      => 0                       ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersItemList',
                                    -size         => [280, 70]               ,
                                    -pos          => [250, 95]               ,
                                    -multiline    => 1                       ,
                                    -wantreturn   => 1                       ,
                                    -vscroll      => 1                       ,
                                    -autohscroll  => 1                       ,
                                    -visible      => 0                       ,
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->tfSelFileFiltersItemList->MaxLength(5000000);
  # Filter: Last accessed
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersLastAccess',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersLastAccess->Add($STR{'Before'}, $STR{'Equal'}, $STR{'After'});
  $winSelFileFilters->cbSelFileFiltersLastAccess->SetCurSel(0);
  $winSelFileFilters->AddDateTime(  -name         => 'dtSelFileFiltersLastAccess',
                                    -size         => [110, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "shortdate"             ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  # Filter: Last modified
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersLastModif',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersLastModif->Add($STR{'Before'}, $STR{'Equal'},$STR{'After'});
  $winSelFileFilters->cbSelFileFiltersLastModif->SetCurSel(0);
  $winSelFileFilters->AddDateTime(  -name         => 'dtSelFileFiltersLastModif',
                                    -size         => [110, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "shortdate"             ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersNotReady',
                                    -size         => [ 30, 30]               ,
                                    -pos          => [225,180]               ,
                                    -text         => '?'                     ,
                                    -font         => $font10                 , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersOk'   ,
                                    -size         => [100, 30]               ,
                                    -pos          => [270,180]               ,
                                    -text         => $STR{'SetAddFilter'}    ,
                                    -font         => $font10                 ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersCancel',
                                    -size         => [100, 30]               ,
                                    -pos          => [385,180]               ,
                                    -text         => $STR{'cancel'}          ,
                                    -font         => $font10                 , );
  
}  #--- End createWinSelFileFilters

#--------------------------#
sub TabSelFileFiltersType_Change
#--------------------------#
{
  # Local variables
  my $type = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  # Contains
  if (!$type) {
    $winSelFileFilters->chSelFileFiltersContainsCase->Show();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Show();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Show();
    $winSelFileFilters->tfSelFileFiltersContains->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    $winSelFileFilters->lblSelFileFiltersItemList->Hide();
    $winSelFileFilters->tfSelFileFiltersItemList->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # File size
  } elsif ($type == 1) {
    $winSelFileFilters->cbSelFileFiltersSizeOp->Show();
    $winSelFileFilters->tfSelFileFiltersSize->Show();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # Last accessed
  } elsif ($type == 2) {
    $winSelFileFilters->cbSelFileFiltersLastAccess->Show();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # Last modified
  } else {
    $winSelFileFilters->cbSelFileFiltersLastModif->Show();
    $winSelFileFilters->dtSelFileFiltersLastModif->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
  }
  &isSelFileFiltersReady(0);

}  #--- End TabSelFileFiltersType_Change

#--------------------------#
sub chSelFileFiltersContainsRegex_Click { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersContains_Change     { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersSize_Change         { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersItemList_Change     { &isSelFileFiltersReady(0); }
sub dtSelFileFiltersLastAccess_Change   { &isSelFileFiltersReady(0); }
sub dtSelFileFiltersLastModif_Change    { &isSelFileFiltersReady(0); }
#--------------------------#

#--------------------------#
sub cbSelFileFiltersSizeOp_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }

}  #--- End cbSelFileFiltersSizeOp_Change

#--------------------------#
sub cbSelFileFiltersLastAccess_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }
  &isSelFileFiltersReady(0);

}  #--- End cbSelFileFiltersLastAccess_Change

#--------------------------#
sub cbSelFileFiltersLastModif_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }
  &isSelFileFiltersReady(0);

}  #--- End cbSelFileFiltersLastModif_Change

#--------------------------#
sub isSelFileFiltersReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $type    = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  my $nextStep;
  # Contains
  if (!$type) {
    my $regexStr = $winSelFileFilters->tfSelFileFiltersContains->Text();
    if ($regexStr) {
      if ($winSelFileFilters->chSelFileFiltersContainsRegex->Checked()) {
        my ($statusRegex, $msg);
        my $nbrLines = $winSelFileFilters->tfSelFileFiltersContains->GetLineCount();
        if ($nbrLines == 1) { ($statusRegex, $msg) = &validRegex($regexStr); }
        else {
          my $i = 0;
          while ($i <= $nbrLines) {
            if (my $line = $winSelFileFilters->tfSelFileFiltersContains->GetLine($i)) {
              ($statusRegex, $msg) = &validRegex($line);
              last if $statusRegex == 1;
            }
            $i++;
          }
        }
        # Warning
        if      ($statusRegex == 2) {
          $winSelFileFilters->lblSelFileFiltersContainWarn->Show();
          $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
          $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
        # Error
        } elsif ($statusRegex == 1) {
          $winSelFileFilters->lblSelFileFiltersContainErr->Show();
          $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
          $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
          $nextStep = $STR{'errRegex'}.' '.$msg;
        # Ok
        } else {
          $winSelFileFilters->lblSelFileFiltersContainOk->Show();
          $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
          $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
        }
      }
    } else {
      $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
      $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
      $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
      $nextStep = $STR{'setContains'};
    }
  # File size
  } elsif ($type == 1) {
    my $op = $winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel();
    if (($op == 1 and !$winSelFileFilters->tfSelFileFiltersSize->Text() and !$winSelFileFilters->tfSelFileFiltersItemList->Text()) or
        ($op != 1 and !$winSelFileFilters->tfSelFileFiltersSize->Text())) {
      $nextStep = $STR{'setFileSize'};
    } elsif ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of size
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d+$/) { $nextStep = $STR{'setFileSize'}; last; }
        }
        $i++;
      }
    }
  # Last accessed
  } elsif ($type == 2) {
    my $op = $winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel();
    if ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) { $nextStep = $STR{'setDate'}; last; }
        }
        $i++;
      }
    }
  # Last modified
  } elsif ($type == 3) {
    my $op = $winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel();
    if ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) { $nextStep = $STR{'setDate'}; last; }
        }
        $i++;
      }
    }
  }
  # Return an error message or enable the button
  if ($nextStep) {
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    $winSelFileFilters->btnSelFileFiltersNotReady->Enable();
    Win32::GUI::MessageBox($winSelFileFilters, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    $winSelFileFilters->btnSelFileFiltersNotReady->Disable();
  }
  
}  #--- End isSelFileFiltersReady

#--------------------------#
sub btnSelFileFiltersNotReady_Click { &isSelFileFiltersReady(1); }
sub btnSelFileFiltersCancel_Click   { &winSelFileFilters_Terminate(); }
#--------------------------#

#--------------------------#
sub winSelFileFilters_Terminate
#--------------------------#
{
  $winSelFileFilters->Hide();
  $winFileFilters->Enable();
  return(0);

}  #--- End winSelFileFilters_Terminate

#--------------------------#
sub btnSelFileFiltersOk_Click
#--------------------------#
{
  # Close Filter window
  &winSelFileFilters_Terminate();
  # Local variables
  my $editRow  = $winSelFileFilters->lblSelFileFiltersEditRow->Text();
  my $operator = 0;
  my $type     = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  my $typeOp;
  my $flags;
  my @searchStrings;
  my $searchStr;
  $operator = $winSelFileFilters->cbSelFileFiltersOp->GetString($winSelFileFilters->cbSelFileFiltersOp->GetCurSel())
  if ($winSelFileFilters->cbSelFileFiltersOp->IsEnabled());
  if (!$type) {
    # Search strings
    for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersContains->GetLineCount(); $i++) {
      push(@searchStrings, $winSelFileFilters->tfSelFileFiltersContains->GetLine($i)) if $winSelFileFilters->tfSelFileFiltersContains->GetLine($i);
    }
    # Flags
    if ($winSelFileFilters->chSelFileFiltersContainsCase->Checked())     { $flags  = '1-'; }
    else                                                                 { $flags  = '0-'; }
    if ($winSelFileFilters->chSelFileFiltersContainsRegex->Checked())    { $flags .= '1-'; }
    else                                                                 { $flags .= '0-'; }
    if ($winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked()) { $flags .= '1';  }
    else                                                                 { $flags .= '0';  }
  # File size
  } elsif ($type == 1) {
    $typeOp      = $winSelFileFilters->cbSelFileFiltersSizeOp->GetString($winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel());
    my $sizeUnit = $winSelFileFilters->cbSelFileFiltersSizeUnit->GetString($winSelFileFilters->cbSelFileFiltersSizeUnit->GetCurSel());
    push(@searchStrings, $winSelFileFilters->tfSelFileFiltersSize->Text()." $sizeUnit") if $winSelFileFilters->tfSelFileFiltersSize->Text();
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)." $sizeUnit") if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  # Last accessed
  } elsif ($type == 2) {
    $typeOp = $winSelFileFilters->cbSelFileFiltersLastAccess->GetString($winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel());
    if ($winSelFileFilters->dtSelFileFiltersLastAccess->GetDate()) {
      my ($d, $m, $y) = $winSelFileFilters->dtSelFileFiltersLastAccess->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  # Last modified
  } elsif ($type == 3) {
    $typeOp = $winSelFileFilters->cbSelFileFiltersLastModif->GetString($winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel());
    if ($winSelFileFilters->dtSelFileFiltersLastModif->GetDate()) {
      my ($d, $m, $y) = $winSelFileFilters->dtSelFileFiltersLastModif->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  }
  # Feed the grid
  my $typeStr  = $winSelFileFilters->TabSelFileFiltersType->GetString($type);
  my $nbrItems = scalar(@searchStrings);
  $operator = $STR{'OR'} if $nbrItems > 1;
  if (@searchStrings) {
    my $row;
    foreach my $string (@searchStrings) {
      if ($string) {
        if ($editRow) { $row = $editRow++; } # Edit mode
        else          { $row = $winFileFilters->gridFileFilters->InsertRow('-', -1); }
        if ($operator and $row > 1) {
          $winFileFilters->gridFileFilters->SetCellText($row, 0, $operator);
          $winFileFilters->gridFileFilters->SetCellEditable($row, 0, 1);
          $winFileFilters->gridFileFilters->SetCellType($row, 0, 6);
          $winFileFilters->gridFileFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
        }
        $winFileFilters->gridFileFilters->SetCellText($row, 1, $typeStr);
        $winFileFilters->gridFileFilters->SetCellText($row, 2, $typeOp) if $typeOp;
        $winFileFilters->gridFileFilters->SetCellText($row, 3, $flags ) if $flags;
        $winFileFilters->gridFileFilters->SetCellText($row, 4, $string);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 1, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 2, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 3, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 4, 0);
      }
    }
  } else { # File formats
    my $row;
    if ($editRow) { $row = $editRow; } # Edit mode
    else          { $row = $winFileFilters->gridFileFilters->InsertRow('-', -1); }
    if ($operator and $row > 1) {
      $winFileFilters->gridFileFilters->SetCellText($row, 0, $operator);
      $winFileFilters->gridFileFilters->SetCellEditable($row, 0, 1);
      $winFileFilters->gridFileFilters->SetCellType($row, 0, 6);
      $winFileFilters->gridFileFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
    }
    $winFileFilters->gridFileFilters->SetCellText($row, 1, $typeStr);
    $winFileFilters->gridFileFilters->SetCellText($row, 2, $typeOp) if $typeOp;
    $winFileFilters->gridFileFilters->SetCellEditable($row, 1, 0);
    $winFileFilters->gridFileFilters->SetCellEditable($row, 2, 0);
    $winFileFilters->gridFileFilters->SetCellEditable($row, 3, 0);
    $winFileFilters->gridFileFilters->SetCellText($row, 4, $searchStr) if $searchStr;
    $winFileFilters->gridFileFilters->SetCellEditable($row, 4, 0);
  }
  $winFileFilters->gridFileFilters->AutoSizeColumns();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->gridFileFilters->Refresh();
  $winFileFilters->btnFileFilterDel->Enable();
  $winFileFilters->btnFileFiltersSave->Enable();

}  #--- End btnSelFileFiltersOk_Click
  
#--------------------------#
sub btnFileFilterDel_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $winFileFilters->gridFileFilters->GetSelectedCellRange();
  my $firstSelectedRow;
  my $lastSelectedRow;
  if    ($coord[2]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[2]; }
  elsif ($coord[0]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[0]; }
  else {
    $firstSelectedRow = $winFileFilters->gridFileFilters->GetRows()-1;
    $lastSelectedRow  = $winFileFilters->gridFileFilters->GetRows()-1;
  }
  for (my $row = $lastSelectedRow; $row >= $firstSelectedRow; $row--) {
    $winFileFilters->gridFileFilters->DeleteRow($row) if $winFileFilters->gridFileFilters->IsCellSelected($row, 0);
  }
  # Reset first line operator
  $winFileFilters->gridFileFilters->SetCellText(1, 0, '-') if $winFileFilters->gridFileFilters->GetCellText(1, 0) ne '-';
  # Disable Delete buttons if no more filter
  if ($winFileFilters->gridFileFilters->GetRows() == 1) {
    $winFileFilters->btnFileFilterDel->Disable();
    $winFileFilters->btnFileFiltersSave->Disable();
  }
  $winFileFilters->gridFileFilters->AutoSizeColumns();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->gridFileFilters->Refresh();

}  #--- End btnFileFilterDel_Click

#--------------------------#
sub btnFileFiltersImport_Click
#--------------------------#
{
  # Local variables
  my $dir;
  if (-d "$USERDIR\\FileFilters") { $dir = "$USERDIR\\FileFilters"; }
  else                            { $dir = $USERDIR;                }
  # Select the json file
  my $file = Win32::GUI::GetOpenFileName( -owner         => $winFileFilters            ,
                                          -title         => $STR{'selFile'}.':'        ,
                                          -filter        => ['JSON (*.json)', '*.json'],
                                          -filemustexist => 1                          ,
                                          -directory     => $dir                       ,
                                          -explorer      => 1                          , );
  if ($file and -T $file) {
    if (open(my $json, $file)) {
      my $jsonText = <$json>;
      close($json);
      my $jsonObj = JSON->new;
      my $refFilter = $jsonObj->decode($jsonText);
      $winFileFilters->gridFileFilters->DeleteNonFixedRows(); # Reset grid
      foreach my $row (sort {$a <=> $b} keys %{$refFilter}) {
        # Feed the grid
        if ($$refFilter{$row}{type} and my $newLine = $winFileFilters->gridFileFilters->InsertRow('-', -1)) {
          $winFileFilters->gridFileFilters->SetCellText($newLine, 0, $$refFilter{$row}{operator});
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 0, 1);
          $winFileFilters->gridFileFilters->SetCellType($newLine, 0, 6);
          $winFileFilters->gridFileFilters->SetCellOptions($newLine, 0, [$STR{'OR'}, $STR{'AND'}]);
          $winFileFilters->gridFileFilters->SetCellText($newLine, 1, $$refFilter{$row}{type});
          $winFileFilters->gridFileFilters->SetCellText($newLine, 2, $$refFilter{$row}{typeOp}  ) if $$refFilter{$row}{typeOp};
          $winFileFilters->gridFileFilters->SetCellText($newLine, 3, $$refFilter{$row}{flagsStr}) if $$refFilter{$row}{flagsStr};
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 1, 0);
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 2, 0);
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 3, 0);
          $winFileFilters->gridFileFilters->SetCellText($newLine, 4, $$refFilter{$row}{searchStr}) if $$refFilter{$row}{searchStr};
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 4, 0);
        }
      }
      if ($winFileFilters->gridFileFilters->GetRows() > 1) {
        $winFileFilters->gridFileFilters->AutoSizeColumns();
        $winFileFilters->gridFileFilters->ExpandLastColumn();
        $winFileFilters->gridFileFilters->Refresh();
        $winFileFilters->btnFileFilterDel->Enable();
        $winFileFilters->btnFileFiltersSave->Enable();
      }
    } else { Win32::GUI::MessageBox($winFileFilters, "$STR{'errorOpening'} $file", $STR{'errorOpening'}, 0x40010); }
  }
  
}  #--- End btnFileFiltersImport_Click

#--------------------------#
sub btnFileFiltersSave_Click
#--------------------------#
{
  # Create the directory for File Filters files (json)
  if (!-d "$USERDIR\\FileFilters") { mkdir("$USERDIR\\FileFilters"); }
  # Show SaveFileWindow for database
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winFileFilters            ,
                                          -title            => $STR{'selFile'}.':'        ,
                                          -filter           => ['JSON (*.json)', '*.json'],
                                          -directory        => "$USERDIR\\FileFilters"    ,
                                          -overwriteprompt  => 1                          , );
  if ($file) {
    $file .= '.json' if $file !~ /\.json$/;
    # Gather all filters
    my %filters;
    for (my $row = 1; $row <= $winFileFilters->gridFileFilters->GetRows(); $row++) {
      $filters{$row}{operator}  = $winFileFilters->gridFileFilters->GetCellText($row, 0);
      $filters{$row}{type}      = $winFileFilters->gridFileFilters->GetCellText($row, 1);
      $filters{$row}{typeOp}    = $winFileFilters->gridFileFilters->GetCellText($row, 2);
      $filters{$row}{flagsStr}  = $winFileFilters->gridFileFilters->GetCellText($row, 3);
      $filters{$row}{searchStr} = $winFileFilters->gridFileFilters->GetCellText($row, 4);
    }
    # Create or update JSON
    my $jsonObj = JSON->new;
    my $jsonText = $jsonObj->encode(\%filters);
    if (open(my $json, '>:encoding(cp1252)', $file)) {
      print $json $jsonText;
      close($json);
    } else { Win32::GUI::MessageBox($winFileFilters, "$STR{'errorWriting'} $file", $STR{'errorWriting'}, 0x40010); }
  }
  
}  #--- End btnFileFiltersSave_Click

#--------------------------#
sub TabFunctions_Click
#--------------------------#
{
  # Local variables
  my $functionStr = $win->TabFunctions->GetString($win->TabFunctions->SelectedItem());
  # Extraction tab
  if ($functionStr eq $STR{'Extraction'}) {
    $win->ExtractFunctions->Show();
    $win->ExtractFunctions->SetCurSel(0);
    &ExtractFunctions_Click();
    # Hide Log Analysis controls
    $win->LAFunctions->Hide();
    $win->lblCreateUpdateDB->Hide();
    $win->rbLACreateDB->Hide();
    $win->rbLAUpdateDB->Hide();
    $win->lblLF->Hide();
    $win->cbLF->Hide();
    $win->btnWinLFDB->Hide();
    $win->btnLFGuess->Hide();
    $win->btnLAFileOrder->Hide();
    $win->chLASetReadOnly->Hide();
    $win->lblLAResolve->Hide();
    $win->chLAOptResISP->Hide();
    $win->chLAOptResGeoIP->Hide();
    $win->chLAOptResUA->Hide();
    $win->chLAOptResWeekday->Hide();
    $win->lblLAFilters->Hide();
    $win->btnLAFilters->Hide();
    $win->chLALogFiltered->Hide();
    $win->chLALogRejected->Hide();
    $win->chLAIgnoreComments->Hide();
    $win->lblDestDB->Hide();
    $win->lblDestLADB->Hide();
    $win->tfDestDir->Hide();
    $win->btnDestDir->Hide();
    $win->chLASelectDB->Hide();
    $win->rbDestDBCurr->Hide();
    $win->rbDestDBNew->Hide();
    $win->lblLAQuerySelectShadowT->Hide();
    $win->lblLAQuerySelectT->Hide();
    $win->btnLAQuerySelectCols->Hide();    
    $win->btnLAQueryFilter->Hide();
    $win->chLAQueryGroupBy->Hide();
    $win->cbLAQueryGroupByCol->Hide();
    $win->btnLAQueryGroupByAdd->Hide();
    $win->chLAQueryOrderBy->Hide();
    $win->cbLAQueryOrderByCol->Hide();
    $win->cbLAQueryOrderBy->Hide();
    $win->btnLAQueryOrderByAdd->Hide();
    $win->chLAQueryHavingCount->Hide();
    $win->cbLAQueryHavingCountCol->Hide();
    $win->cbLAQueryHavingCount->Hide();
    $win->tfLAQueryHavingCount->Hide();
    $win->btnLAQueryHavingCountAdd->Hide();
    $win->lblLAQueryShadowT->Hide();
    $win->lblLAQueryT->Hide();
    $win->btnLAQuerySelectSaved->Hide();
    $win->btnLAQueryEdit->Hide();
    $win->btnLAQuerySave->Hide();
    $win->btnLAQueryReset->Hide();
    $win->tfLAQuery->Hide();
    $win->lblLAQueryOk->Hide();
    $win->lblLAQueryErr->Hide();
    $win->lblLAQueryOutputShadowT->Hide();
    $win->lblLAQueryOutputT->Hide();
    $win->btnLAQueryReportOpt->Hide();
    $win->lblLASearchOptShadowT->Hide();
    $win->lblLASearchOptT->Hide();
    $win->btnLASearchReportOpt->Hide();
    $win->lblLASearchSAMaxRes->Hide();
    $win->tfLASearchSAMaxRes->Hide();
    $win->btnLASearchSaveOptions->Hide();
    $win->btnLASearchOpenResults->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndT->Hide();
    $win->btnLASearchReset->Hide();
    $win->gridLASearchSAInd->Hide();
    $win->gbCurrDBGeneral->Hide();
    $win->lblCurrDBLastUpdate->Hide();
    $win->lblCurrDBLastUpdateVal->Hide();
    $win->lblCurrDBPeriod->Hide();
    $win->lblCurrDBPeriodVal->Hide();
    $win->lblCurrDBNbrOf->Hide();
    $win->lblCurrDBNbrEntries->Hide();
    $win->lblCurrDBNbrEntriesVal->Hide();
    $win->lblCurrDBFiltered->Hide();
    $win->lblCurrDBFilteredVal->Hide();
    $win->lblCurrDBRejected->Hide();
    $win->lblCurrDBRejectedVal->Hide();
    $win->gbCurrDBSource->Hide();
    $win->lblCurrDBLogFormat->Hide();
    $win->lblCurrDBLogFormatVal->Hide();
    $win->btnLACurrDBFiles->Hide();
    $win->lblCurrDBFilters->Hide();
    $win->tfCurrDBFiltersVal->Hide();
    $win->btnLACurrDBFiltered->Hide();
    $win->btnLACurrDBRejected->Hide();
    $win->gbCurrDBResolved->Hide();
    $win->lblCurrDBNbrResISP->Hide();
    $win->lblCurrDBNbrResISPVal->Hide();
    $win->lblCurrDBNbrResGeoIP->Hide();
    $win->lblCurrDBNbrResGeoIPVal->Hide();
    $win->lblCurrDBResUAs->Hide();
    $win->lblCurrDBResUAsVal->Hide();
    $win->lblCurrDBResWDs->Hide();
    $win->lblCurrDBResWDsVal->Hide();
    # Hide Split logs controls
    $win->lblSplitType->Hide();
    $win->rbSplitBySize->Hide();
    $win->lblSplitBySize->Hide();
    $win->tfSplitBySizeFrag->Hide();
    $win->cbSplitBySizeUnit->Hide();
    $win->chSplitUseDTFN->Hide();
    $win->rbSplitByLines->Hide();
    $win->lblSplitByLinesNbr->Hide();
    $win->tfSplitByLinesNbr->Hide();
    $win->upDownLinesNbr->Hide();
    $win->rbSplitByTime->Hide();
    $win->lblSplitByTime->Hide();
    $win->cbSplitByTimeInter->Hide();
    $win->lblSplitTimeFormat->Hide();
    $win->cbSplitTimeFormat->Hide();
    $win->btnSplitTimeDTDB->Hide();
    $win->btnSplitTimeFormatGuess->Hide();
    $win->lblSplitDestDir->Hide();
    $win->tfSplitDestDir->Hide();
    $win->btnSplitDestDir->Hide();
    $win->chOpenSplitDestDir->Hide();
  # Log analysis tab
  } elsif ($functionStr eq $STR{'WebLogAnalysis'}) {
    if (!$winLFDB) {
      &createWinLFDB(1);
      &createWinLFObj() if !$winLFObj;
      &createWinDTDB(1) if !$winDTDB;
    }
    if ($win->rbInputDatabase->Checked()) {
      $win->ExtractFunctions->SetCurSel(0);
      $win->LAFunctions->Show();
      &LAFunctionsTabUpdate();
      $win->lblCreateUpdateDB->Hide();
      $win->rbLACreateDB->Hide();
      $win->rbLAUpdateDB->Hide();
      $win->lblLF->Hide();
      $win->cbLF->Hide();
      $win->btnWinLFDB->Hide();
      $win->btnLFGuess->Hide();
      $win->btnLAFileOrder->Hide();
      $win->chLASetReadOnly->Hide();
      $win->chLALogFiltered->Hide();
      $win->chLALogRejected->Hide();
      $win->chLAIgnoreComments->Hide();
    } else {
      $win->LAFunctions->Hide();
      $win->lblCreateUpdateDB->Show();
      $win->rbLACreateDB->Show();
      $win->rbLAUpdateDB->Show();
      $win->lblLF->Show();
      $win->cbLF->Show();
      $win->btnWinLFDB->Show();
      $win->btnLFGuess->Show();
      if ($win->rbInputDir->Checked()) { $win->btnLAFileOrder->Show(); }
      else                             { $win->btnLAFileOrder->Hide(); }
      $win->chLASetReadOnly->Show();
      $win->lblLAResolve->Show();
      $win->chLAOptResISP->Show();
      $win->chLAOptResGeoIP->Show();
      $win->chLAOptResUA->Show();
      $win->chLAOptResWeekday->Show();
      $win->lblLAFilters->Show();
      $win->btnLAFilters->Show();
      $win->chLALogFiltered->Show();
      $win->chLALogRejected->Show();
      $win->chLAIgnoreComments->Show();
      $win->lblDestLADB->Show();
      $win->tfDestDir->Show();
      $win->btnDestDir->Show();
      $win->chLASelectDB->Show();
      &uncheckAllFilterSets(\$winLAFilters) if $winLAFilters;
    }
    # Hide Extraction controls
    $win->ExtractFunctions->Hide();
    $win->gridExtraction->Hide();
    $win->btnExtractOpenRes->Hide();
    $win->btnExtractAdd->Hide();
    $win->btnExtractDel->Hide();
    $win->btnExtractImport->Hide();
    $win->btnExtractSave->Hide();
    $win->btnUpGrid->Hide();
    $win->btnExtractOpt->Hide();
    $win->btnDownGrid->Hide();
    $win->btnExtractRefresh->Hide();
    $win->tvSO->Hide();
    # Hide Split logs controls
    $win->lblSplitType->Hide();
    $win->rbSplitBySize->Hide();
    $win->lblSplitBySize->Hide();
    $win->tfSplitBySizeFrag->Hide();
    $win->cbSplitBySizeUnit->Hide();
    $win->chSplitUseDTFN->Hide();
    $win->rbSplitByLines->Hide();
    $win->lblSplitByLinesNbr->Hide();
    $win->tfSplitByLinesNbr->Hide();
    $win->upDownLinesNbr->Hide();
    $win->rbSplitByTime->Hide();
    $win->lblSplitByTime->Hide();
    $win->cbSplitByTimeInter->Hide();
    $win->lblSplitTimeFormat->Hide();
    $win->cbSplitTimeFormat->Hide();
    $win->btnSplitTimeDTDB->Hide();
    $win->btnSplitTimeFormatGuess->Hide();
    $win->lblSplitDestDir->Hide();
    $win->tfSplitDestDir->Hide();
    $win->btnSplitDestDir->Hide();
    $win->chOpenSplitDestDir->Hide();
  # Split logs tab
  } elsif ($functionStr eq $STR{'SplitLogs'}) {
    &createWinLFObj() if !$winLFObj;
    &createWinDTDB(1) if !$winDTDB;
    $win->ExtractFunctions->Hide();
    $win->lblSplitType->Show();
    $win->rbSplitBySize->Show();
    $win->rbSplitByLines->Show();
    $win->rbSplitByTime->Show();
    &chSplitTypeChange;
    $win->lblSplitDestDir->Show();
    $win->tfSplitDestDir->Show();
    $win->btnSplitDestDir->Show();
    $win->chOpenSplitDestDir->Show();
    if ($win->rbInputClipboard->Checked() or $win->rbInputDatabase->Checked()) {
      $win->lblSplitDestDir->Disable();
      $win->tfSplitDestDir->Disable();
      $win->btnSplitDestDir->Disable();
      $win->chOpenSplitDestDir->Disable();
    } else {
      $win->lblSplitDestDir->Enable();
      $win->tfSplitDestDir->Enable();
      $win->btnSplitDestDir->Enable();
      $win->chOpenSplitDestDir->Enable();
    }
    # Hide Extraction controls
    $win->gridExtraction->Hide();
    $win->btnExtractOpenRes->Hide();
    $win->btnExtractAdd->Hide();
    $win->btnExtractDel->Hide();
    $win->btnExtractImport->Hide();
    $win->btnExtractSave->Hide();
    $win->btnUpGrid->Hide();
    $win->btnExtractOpt->Hide();
    $win->btnDownGrid->Hide();
    $win->btnExtractRefresh->Hide();
    $win->tvSO->Hide();
    # Hide Log Analysis controls
    $win->LAFunctions->Hide();
    $win->lblCreateUpdateDB->Hide();
    $win->rbLACreateDB->Hide();
    $win->rbLAUpdateDB->Hide();
    $win->lblLF->Hide();
    $win->cbLF->Hide();
    $win->btnWinLFDB->Hide();
    $win->btnLFGuess->Hide();
    $win->btnLAFileOrder->Hide();
    $win->chLASetReadOnly->Hide();
    $win->lblLAResolve->Hide();
    $win->chLAOptResISP->Hide();
    $win->chLAOptResGeoIP->Hide();
    $win->chLAOptResUA->Hide();
    $win->chLAOptResWeekday->Hide();
    $win->lblLAFilters->Hide();
    $win->btnLAFilters->Hide();
    $win->chLALogFiltered->Hide();
    $win->chLALogRejected->Hide();
    $win->chLAIgnoreComments->Hide();
    $win->lblDestDB->Hide();
    $win->lblDestLADB->Hide();
    $win->tfDestDir->Hide();
    $win->btnDestDir->Hide();
    $win->rbDestDBCurr->Hide();
    $win->rbDestDBNew->Hide();
    $win->chLASelectDB->Hide();
    $win->lblLAQuerySelectShadowT->Hide();
    $win->lblLAQuerySelectT->Hide();
    $win->btnLAQuerySelectCols->Hide();    
    $win->btnLAQueryFilter->Hide();
    $win->chLAQueryGroupBy->Hide();
    $win->cbLAQueryGroupByCol->Hide();
    $win->btnLAQueryGroupByAdd->Hide();
    $win->chLAQueryOrderBy->Hide();
    $win->cbLAQueryOrderByCol->Hide();
    $win->cbLAQueryOrderBy->Hide();
    $win->btnLAQueryOrderByAdd->Hide();
    $win->chLAQueryHavingCount->Hide();
    $win->cbLAQueryHavingCountCol->Hide();
    $win->cbLAQueryHavingCount->Hide();
    $win->tfLAQueryHavingCount->Hide();
    $win->btnLAQueryHavingCountAdd->Hide();
    $win->lblLAQueryShadowT->Hide();
    $win->lblLAQueryT->Hide();
    $win->btnLAQuerySelectSaved->Hide();
    $win->btnLAQueryEdit->Hide();
    $win->btnLAQuerySave->Hide();
    $win->btnLAQueryReset->Hide();
    $win->tfLAQuery->Hide();
    $win->lblLAQueryOk->Hide();
    $win->lblLAQueryErr->Hide();
    $win->lblLAQueryOutputShadowT->Hide();
    $win->lblLAQueryOutputT->Hide();
    $win->btnLAQueryReportOpt->Hide();
    $win->lblLASearchOptShadowT->Hide();
    $win->lblLASearchOptT->Hide();
    $win->btnLASearchReportOpt->Hide();
    $win->lblLASearchSAMaxRes->Hide();
    $win->tfLASearchSAMaxRes->Hide();
    $win->btnLASearchSaveOptions->Hide();
    $win->btnLASearchOpenResults->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndT->Hide();
    $win->btnLASearchReset->Hide();
    $win->gridLASearchSAInd->Hide();
    $win->gbCurrDBGeneral->Hide();
    $win->lblCurrDBLastUpdate->Hide();
    $win->lblCurrDBLastUpdateVal->Hide();
    $win->lblCurrDBPeriod->Hide();
    $win->lblCurrDBPeriodVal->Hide();
    $win->lblCurrDBNbrOf->Hide();
    $win->lblCurrDBNbrEntries->Hide();
    $win->lblCurrDBNbrEntriesVal->Hide();
    $win->lblCurrDBFiltered->Hide();
    $win->lblCurrDBFilteredVal->Hide();
    $win->lblCurrDBRejected->Hide();
    $win->lblCurrDBRejectedVal->Hide();
    $win->gbCurrDBSource->Hide();
    $win->lblCurrDBLogFormat->Hide();
    $win->lblCurrDBLogFormatVal->Hide();
    $win->btnLACurrDBFiles->Hide();
    $win->lblCurrDBFilters->Hide();
    $win->tfCurrDBFiltersVal->Hide();
    $win->btnLACurrDBFiltered->Hide();
    $win->btnLACurrDBRejected->Hide();
    $win->gbCurrDBResolved->Hide();
    $win->lblCurrDBNbrResISP->Hide();
    $win->lblCurrDBNbrResISPVal->Hide();
    $win->lblCurrDBNbrResGeoIP->Hide();
    $win->lblCurrDBNbrResGeoIPVal->Hide();
    $win->lblCurrDBResUAs->Hide();
    $win->lblCurrDBResUAsVal->Hide();
    $win->lblCurrDBResWDs->Hide();
    $win->lblCurrDBResWDsVal->Hide();
  }
  &isProcessReady(0);
  
}  #--- End TabFunctions_Click

#--------------------------#
sub ExtractFunctions_Click
#--------------------------#
{
  # Local variables
  my $functionStr = $win->ExtractFunctions->GetString($win->ExtractFunctions->SelectedItem());
  # Expression tab
  if ($functionStr eq $STR{'Expression'}) {
    # Show Expression controls
    $win->gridExtraction->Hide();
    $win->btnExtractOpenRes->Hide();
    $win->btnExtractAdd->Hide();
    $win->btnExtractDel->Hide();
    $win->btnExtractImport->Hide();
    $win->btnExtractSave->Hide();
    $win->btnUpGrid->Hide();
    $win->btnExtractOpt->Hide();
    $win->btnDownGrid->Hide();
    $win->btnExtractRefresh->Hide();
    $win->gridExtraction->Show();
    $win->btnExtractOpenRes->Show();
    $win->btnExtractAdd->Show();
    $win->btnExtractDel->Show();
    $win->btnExtractImport->Show();
    $win->btnExtractSave->Show();
    $win->btnUpGrid->Show();
    $win->btnExtractOpt->Show();
    $win->btnDownGrid->Show();
    $win->btnExtractRefresh->Show();
    # Hide Special objects controls
    $win->tvSO->Hide();
    &isProcessReady(0);
  # Special objects tab
  } elsif ($functionStr eq $STR{'SpecObjects'}) {
    if ($win->tvSO->GetCount() < 1) {
      # Set Special objects treeview values
      my $parent;
      my $node;
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_IPv4Addr'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_GeoIP'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_ResolveTLD'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_IPv6Addr'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_ResolveTLD'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_URLs'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_URL_RemParam'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_ResolveTLD'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_Emails'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_Emails_Valid'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_ResolveTLD'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_Hostnames'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_ResolveTLD'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_DomainNames'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_ResolveTLD'});
      $node = $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_NSLookup'});
      $win->tvSO->InsertItem(-parent => $node, -text => $STR{'SO_IPAddr_XLWhoisDB'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_MACAddr'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_MACAddr_ResOUI'});
      $parent = $win->tvSO->InsertItem(-text => $STR{'SO_CreditCards'});
      $win->tvSO->InsertItem(-parent => $parent, -text => $STR{'SO_CC_ResIC'});
    }
    $win->tvSO->Show();
    $win->btnExtractOpenRes->Show();
    $win->btnExtractRefresh->Show();
    # Hide Expression controls
    $win->gridExtraction->Hide();
    $win->btnExtractAdd->Hide();
    $win->btnExtractDel->Hide();
    $win->btnExtractImport->Hide();
    $win->btnExtractSave->Hide();
    $win->btnUpGrid->Hide();
    $win->btnExtractOpt->Hide();
    $win->btnDownGrid->Hide();
    &isProcessReady(0);
  }
  return(1);

}  #--- End ExtractFunctions_Click

#--------------------------#
sub gridExtraction_Click
#--------------------------#
{
  # Local variables
  my $row = shift;
  my $nbrRows = $win->gridExtraction->GetRows() - 1;
  # Up and down button, at least 2 expressions
  if ($nbrRows > 1 and $row != 0) {
    # Up button enabled if not the first one
    if ($row != 1) { $win->btnUpGrid->Enable();  }
    else           { $win->btnUpGrid->Disable(); }
    # Down button enabled if not the last one
    if ($row != $nbrRows) { $win->btnDownGrid->Enable();  }
    else                  { $win->btnDownGrid->Disable(); }
  }
  return(1);

}  #--- End gridExtraction_Click

#--------------------------#
sub btnUpGrid_Click
#--------------------------#
{
  # Local variables
  my $upRow   = ($win->gridExtraction->GetSelectedCellRange())[0];
  my $downRow = $upRow - 1;
  # Get selected row values
  if ($downRow > 0) { # Not the first line
    # Values to move up
    my $upOperator      = $win->gridExtraction->GetCellText( $upRow, 0);
    my $upCase          = $win->gridExtraction->GetCellCheck($upRow, 1);
    my $upRegex         = $win->gridExtraction->GetCellCheck($upRow, 2);
    my $upInvert        = $win->gridExtraction->GetCellCheck($upRow, 3);
    my $upExpr          = $win->gridExtraction->GetCellText( $upRow, 4);
    my $upComment       = $win->gridExtraction->GetCellText( $upRow, 5);
    # Values to move down
    my $downOperator    = $win->gridExtraction->GetCellText( $downRow, 0);
    my $downCase        = $win->gridExtraction->GetCellCheck($downRow, 1);
    my $downRegex       = $win->gridExtraction->GetCellCheck($downRow, 2);
    my $downInvert      = $win->gridExtraction->GetCellCheck($downRow, 3);
    my $downExpr        = $win->gridExtraction->GetCellText( $downRow, 4);
    my $downComment     = $win->gridExtraction->GetCellText( $downRow, 5);
    # Move values up
    if ($downRow == 1)  { $win->gridExtraction->SetCellText($downRow, 0, '-');         } # First row, no operator
    else                { $win->gridExtraction->SetCellText($downRow, 0, $upOperator); }
    if ($upCase)        { $win->gridExtraction->SetCellCheck($downRow, 1, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 1, 0);  }
    if ($upRegex)       { $win->gridExtraction->SetCellCheck($downRow, 2, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 2, 0);  }
    if ($upInvert)      { $win->gridExtraction->SetCellCheck($downRow, 3, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 3, 0);  }
    $win->gridExtraction->SetCellText($downRow, 4, $upExpr);
    if ($upComment)     { $win->gridExtraction->SetCellText($downRow, 5, $upComment); }
    else                { $win->gridExtraction->SetCellText($downRow, 5, '');         }
    $win->gridExtraction->SetSelectedCellRange($downRow, 0, $downRow, 5);
    # Move values down
    if ($downRow == 1)  { $win->gridExtraction->SetCellText($upRow, 0, $STR{'OR'});    } # Operator was '-'
    else                { $win->gridExtraction->SetCellText($upRow, 0, $downOperator); }
    if ($downCase)      { $win->gridExtraction->SetCellCheck($upRow, 1, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 1, 0);  }
    if ($downRegex)     { $win->gridExtraction->SetCellCheck($upRow, 2, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 2, 0);  }
    if ($downInvert)    { $win->gridExtraction->SetCellCheck($upRow, 3, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 3, 0);  }
    $win->gridExtraction->SetCellText($upRow, 4, $downExpr);
    if ($downComment)   { $win->gridExtraction->SetCellText($upRow, 5, $downComment); }
    else                { $win->gridExtraction->SetCellText($upRow, 5, '');           }
    &gridExtraction_Click($downRow);
    $win->gridExtraction->SetSelectedCellRange($downRow, 0, $downRow, 5);
    $win->gridExtraction->Refresh();
  }
  return(1);
  
}  #--- End btnUpGrid_Click

#--------------------------#
sub btnDownGrid_Click
#--------------------------#
{
  # Local variables
  my $downRow = ($win->gridExtraction->GetSelectedCellRange())[0];
  my $nbrRows = $win->gridExtraction->GetRows() - 1;
  my $upRow   = $downRow + 1;
  # Get selected row values
  if ($downRow < $win->gridExtraction->GetRows()) { # Not the last line
    # Values to move down
    my $downOperator    = $win->gridExtraction->GetCellText( $downRow, 0);
    my $downCase        = $win->gridExtraction->GetCellCheck($downRow, 1);
    my $downRegex       = $win->gridExtraction->GetCellCheck($downRow, 2);
    my $downInvert      = $win->gridExtraction->GetCellCheck($downRow, 3);
    my $downExpr        = $win->gridExtraction->GetCellText( $downRow, 4);
    my $downComment     = $win->gridExtraction->GetCellText( $downRow, 5);
    # Values to move up
    my $upOperator      = $win->gridExtraction->GetCellText( $upRow, 0);
    my $upCase          = $win->gridExtraction->GetCellCheck($upRow, 1);
    my $upRegex         = $win->gridExtraction->GetCellCheck($upRow, 2);
    my $upInvert        = $win->gridExtraction->GetCellCheck($upRow, 3);
    my $upExpr          = $win->gridExtraction->GetCellText( $upRow, 4);
    my $upComment       = $win->gridExtraction->GetCellText( $upRow, 5);
    # Move values down
    if ($downRow == 1)  { $win->gridExtraction->SetCellText($upRow, 0, $STR{'OR'});    } # Operator was '-'
    else                { $win->gridExtraction->SetCellText($upRow, 0, $downOperator); }
    if ($downCase)      { $win->gridExtraction->SetCellCheck($upRow, 1, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 1, 0);  }
    if ($downRegex)     { $win->gridExtraction->SetCellCheck($upRow, 2, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 2, 0);  }
    if ($downInvert)    { $win->gridExtraction->SetCellCheck($upRow, 3, 1);  }
    else                { $win->gridExtraction->SetCellCheck($upRow, 3, 0);  }
    $win->gridExtraction->SetCellText($upRow, 4, $downExpr);
    if ($downComment)   { $win->gridExtraction->SetCellText($upRow, 5, $downComment); }
    else                { $win->gridExtraction->SetCellText($upRow, 5, '');           }
    $win->gridExtraction->SetSelectedCellRange($upRow, 0, $upRow, 5);
    # Move values up
    if ($downRow == 1)  { $win->gridExtraction->SetCellText($downRow, 0, '-');         } # First row, no operator
    else                { $win->gridExtraction->SetCellText($downRow, 0, $upOperator); }
    if ($upCase)        { $win->gridExtraction->SetCellCheck($downRow, 1, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 1, 0);  }
    if ($upRegex)       { $win->gridExtraction->SetCellCheck($downRow, 2, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 2, 0);  }
    if ($upInvert)      { $win->gridExtraction->SetCellCheck($downRow, 3, 1);  }
    else                { $win->gridExtraction->SetCellCheck($downRow, 3, 0);  }
    $win->gridExtraction->SetCellText($downRow, 4, $upExpr);
    if ($upComment)     { $win->gridExtraction->SetCellText($downRow, 5, $upComment); }
    else                { $win->gridExtraction->SetCellText($downRow, 5, '');         }
    &gridExtraction_Click($upRow);
    $win->gridExtraction->SetSelectedCellRange($upRow, 0, $upRow, 5);
    $win->gridExtraction->Refresh();
  }
  return(1);
  
}  #--- End btnDownGrid_Click

#--------------------------#
sub btnExtractAdd_Click
#--------------------------#
{
  &createWinExtraction() if !$winExtraction;
  # Reset Extract window controls
  $winExtraction->lblExtractOp->Disable();
  $winExtraction->cbExtractOp->SetCurSel(0);
  $winExtraction->cbExtractOp->Disable();
  $winExtraction->lblExtractEditRow->Text('');
  $winExtraction->chExtractExprCase->Checked(0);
  $winExtraction->chExtractExprRegex->Checked(0);
  $winExtraction->chExtractExprInvert->Checked(0);
  $winExtraction->tfExtractExpr->Text('');
  $winExtraction->tfExtractComment->Text('');
  $winExtraction->TabExtractType->SetCurSel(0);
  &TabExtractType_Change();
  $winExtraction->lblExtractExprOk->Hide();
  $winExtraction->lblExtractExprErr->Hide();
  $winExtraction->lblExtractExprWarn->Hide();
  # Enable/Disable operator
  if ($win->gridExtraction->GetRows() > 1) { $winExtraction->lblExtractOp->Enable();  $winExtraction->cbExtractOp->Enable();  }
  else                                     { $winExtraction->lblExtractOp->Disable(); $winExtraction->cbExtractOp->Disable(); }
  $winExtraction->Center($win);
  $winExtraction->Show();
  $win->Disable();

}  #--- End btnExtractAdd_Click

#--------------------------#
sub gridExtraction_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  &createWinExtraction() if !$winExtraction;
  if ($row) {
    # Gather values of current selection
    my $operator = $win->gridExtraction->GetCellText( $row, 0);
    my $case     = $win->gridExtraction->GetCellCheck($row, 1);
    my $regex    = $win->gridExtraction->GetCellCheck($row, 2);
    my $invert   = $win->gridExtraction->GetCellCheck($row, 3);
    my $expr     = $win->gridExtraction->GetCellText( $row, 4);
    my $comment  = $win->gridExtraction->GetCellText( $row, 5);
    # Set values
    $winExtraction->lblExtractEditRow->Text($row);
    $winExtraction->TabExtractType->SetCurSel(0);
    &TabExtractType_Change();
    if ($row == 1) { # First line, no operator
      $winExtraction->cbExtractOp->SetCurSel(0);
      $winExtraction->cbExtractOp->Disable();
      $winExtraction->lblExtractOp->Disable();
    } else {
      $winExtraction->cbExtractOp->SetCurSel($winExtraction->cbExtractOp->FindStringExact($operator));
      $winExtraction->cbExtractOp->Enable();
      $winExtraction->lblExtractOp->Enable();
    }
    $winExtraction->chExtractExprCase->Checked(0);
    $winExtraction->chExtractExprRegex->Checked(0);
    $winExtraction->chExtractExprInvert->Checked(0);
    $winExtraction->lblExtractExprOk->Hide();
    $winExtraction->lblExtractExprErr->Hide();
    $winExtraction->lblExtractExprWarn->Hide();
    $winExtraction->chExtractExprCase->Checked(1)   if $case;
    $winExtraction->chExtractExprRegex->Checked(1)  if $regex;
    $winExtraction->chExtractExprInvert->Checked(1) if $invert;
    $winExtraction->tfExtractExpr->Text($expr);
    $winExtraction->tfExtractComment->Text($comment);
  }
  $winExtraction->Center($win);
  $winExtraction->Show();
  $win->Disable();
  &isExtractReady(0);

}  #--- End gridExtraction_DblClick

#--------------------------#
sub createWinExtraction
#--------------------------#
{
  # Extraction window
  $winExtraction = Win32::GUI::Window->new( -name        => 'winExtraction'        ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'Expression'}     ,
                                            -pos         => [$winPosX , $winPosY]  ,
                                            -size        => [$winWidth, 400]       ,
                                            -minsize     => [$winWidth, 320]       ,
                                            -hasmaximize => 1                      ,
                                            -hasminimize => 1                      ,
                                            -resizable   => 1                      ,
                                            -dialogui    => 1                      , );
  $winExtraction->SetIcon($winICO);
  $winExtraction->AddLabel(     -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  0,  5]               ,
                                -bitmap       => $logo128Bmp             ,
                                -background   => [255, 255, 255]         , );
  $winExtraction->AddTabStrip(  -name         => 'TabExtractType'        ,
                                -size         => [$winWidth-154,413]     ,
                                -pos          => [140,  0]               ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       ,
                                -background   => [255, 255, 255]         , );
  $winExtraction->TabExtractType->InsertItem(-text => $STR{'Expression'}  , );
  $winExtraction->TabExtractType->InsertItem(-text => $STR{'exprHistory'} , );
  $winExtraction->TabExtractType->InsertItem(-text => $STR{'exprDatabase'}, );
  $winExtraction->AddLabel(     -name         => 'lblExtractOp'          ,
                                -size         => [100, 22]               ,
                                -pos          => [145, 38]               ,
                                -text         => $STR{'Operator'}.':'    ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         ,
                                -disabled     => 1                       , );
  $winExtraction->AddCombobox(  -name         => 'cbExtractOp'           ,
                                -size         => [ 60, 22]               ,
                                -pos          => [250, 35]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winExtraction->cbExtractOp->Add($STR{'OR'}, $STR{'AND'}, );
  $winExtraction->cbExtractOp->SetCurSel(0);
  $winExtraction->AddLabel(     -name         => 'lblExtractEditRow'     ,
                                -size         => [ 10, 22]               ,
                                -pos          => [400, 38]               ,
                                -visible      => 0                       , ); # Hidden, Edit mode from caller
  # New expression
  $winExtraction->AddCheckbox(  -name         => 'chExtractExprCase'     ,
                                -size         => [125, 22]               ,
                                -pos          => [145, 70]               ,
                                -text         => $STR{'Case'}            ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExtraction->AddCheckbox(  -name         => 'chExtractExprRegex'    ,
                                -size         => [ 80, 22]               ,
                                -pos          => [275, 70]               ,
                                -text         => $STR{'Regex'}           ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExtraction->AddCheckbox(  -name         => 'chExtractExprInvert'   ,
                                -size         => [ 80, 22]               ,
                                -pos          => [375, 70]               ,
                                -text         => $STR{'Invert'}          ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExtraction->AddCombobox(  -name         => 'cbLExtractREShorcuts'  ,
                                -size         => [260,100]               ,
                                -pos          => [500, 69]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       , );
  $winExtraction->cbLExtractREShorcuts->Add(
    $STR{'cbLExtractREShorcuts'}   , '. : '    .$STR{'REShorcuts1'} , '\d : '   .$STR{'REShorcuts2'},
    '\D : '   .$STR{'REShorcuts3'} , '\w : '   .$STR{'REShorcuts4'} , '\W : '   .$STR{'REShorcuts5'},
    '\s : '   .$STR{'REShorcuts6'} , '\S : '   .$STR{'REShorcuts7'} , '\t : '   .$STR{'REShorcuts8'},
    '\r : '   .$STR{'REShorcuts9'} , '\n : '   .$STR{'REShorcuts10'}, '[] : '   .$STR{'REShorcuts11'},
    '[^] : '  .$STR{'REShorcuts12'}, '() : '   .$STR{'REShorcuts13'}, '(?:) : ' .$STR{'REShorcuts14'},
    '| : '    .$STR{'REShorcuts15'}, '^ : '    .$STR{'REShorcuts16'}, '$ : '    .$STR{'REShorcuts17'},
    '* : '    .$STR{'REShorcuts18'}, '+ : '    .$STR{'REShorcuts19'}, '? : '    .$STR{'REShorcuts20'},
    '{n} : '  .$STR{'REShorcuts21'}, '{n,} : ' .$STR{'REShorcuts22'}, '{n,m} : '.$STR{'REShorcuts23'},
    );
  $winExtraction->cbLExtractREShorcuts->SetCurSel(0);
  
  $winExtraction->AddLabel(     -name         => 'lblExtractExprOk'      ,
                                -size         => [553, 72]               ,
                                -pos          => [144, 94]               ,
                                -background   => [  0, 255,   0]         ,
                                -visible      => 0                       , );
  $winExtraction->AddLabel(     -name         => 'lblExtractExprErr'     ,
                                -size         => [553, 72]               ,
                                -pos          => [144, 94]               ,
                                -background   => [255,   0,   0]         ,
                                -visible      => 0                       , );
  $winExtraction->AddLabel(     -name         => 'lblExtractExprWarn'    ,
                                -size         => [553, 72]               ,
                                -pos          => [144, 94]               ,
                                -background   => [255, 255,   0]         ,
                                -visible      => 0                       , );
  $winExtraction->AddTextfield( -name         => 'tfOldExprHidden'       ,
                                -size         => [$winWidth-165, 70]     ,
                                -pos          => [145, 95]               ,
                                -multiline    => 1                       ,
                                -visible      => 0                       , );
  $winExtraction->AddTextfield( -name         => 'tfExtractExpr'         ,
                                -size         => [$winWidth-165, 70]     ,
                                -pos          => [145, 95]               ,
                                -font         => $font10                 ,
                                -multiline    => 1                       ,
                                -wantreturn   => 1                       ,
                                -vscroll      => 1                       ,
                                -autohscroll  => 1                       ,
                                -tabstop      => 1                       , );
  $winExtraction->tfExtractExpr->MaxLength(5000000);
  $winExtraction->AddButton(    -name         => 'btnExtractExprAddDB'   ,
                                -size         => [ 22, 22]               ,
                                -pos          => [$winWidth-28,95]       ,
                                -bitmap       => $addDB                  ,
                                -tip          => $STR{'btnExtractExprAddDBTip'},
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winExtraction->AddButton(    -name         => 'btnExtractExprSaveDB'  ,
                                -size         => [ 22, 22]               ,
                                -pos          => [$winWidth-28,95]      ,
                                -bitmap       => $saveDB                 ,
                                -tip          => $STR{'btnExtractExprSaveDBTip'},
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winExtraction->AddButton(    -name         => 'btnExtractExprTools'   ,
                                -size         => [ 22, 22]               ,
                                -pos          => [$winWidth-28,118]      ,
                                -bitmap       => $regexTools             ,
                                -tip          => $STR{'btnExtractExprToolsTip'},
                                -tabstop      => 1                       , );
  $winExtraction->AddLabel(     -name         => 'lblExtractComment'     ,
                                -size         => [ 95, 22]               ,
                                -pos          => [145, 170]              ,
                                -text         => $STR{'comment'}.':'     ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winExtraction->AddTextfield( -name         => 'tfExtractComment'      ,
                                -size         => [$winWidth-250, 24]     ,
                                -pos          => [245,170]               ,
                                -tabstop      => 1                       , );
  # Expression history
  $winExtraction->AddCheckbox(  -name         => 'chEnableExprHistory'   ,
                                -size         => [ 80, 22]               ,
                                -pos          => [145, 70]               ,
                                -text         => $STR{'Enable'}          ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winExtraction->AddLabel(     -name         => 'lblExprHistoryMax'     ,
                                -size         => [150, 22]               ,
                                -pos          => [490, 70]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'lblExprHistoryMax'}.':',
                                -align        => 'right'                 ,
                                -font         => $font10                 ,
                                -visible      => 0                       , );
  $winExtraction->AddTextfield( -name         => 'tfExprHistoryMax'      ,
                                -size         => [ 55, 24]               ,
                                -pos          => [645, 67]               ,
                                -number       => 1                       ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winExtraction->AddGrid(      -name         => 'gridExprHistory'       ,
                                -size         => [555, 70]               ,
                                -pos          => [145, 95]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 6                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winExtraction->gridExprHistory->SetListMode(1);
  # Popup menu for Expression History grid
  $gridExprHistoMenu = new Win32::GUI::Menu(
    "gridExprHistoMenu"           => "gridExprHistoMenu",
    "> $STR{'sendToExprTool'}..." => "sendToExprTool"  ,
    "> $STR{'exprHistoAddToDB'}"  => "exprHistoAddToDB",
    "> $STR{'Delete'}"            => "exprHistoDelete" ,
  );
  # Expression database
  $winExtraction->AddGrid(      -name         => 'gridExprDatabase'      ,
                                -size         => [555, 95]               ,
                                -pos          => [145, 70]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 6                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winExtraction->gridExprDatabase->SetListMode(1);
  # Popup menu for Expression Database grid
  $gridExprDBMenu = new Win32::GUI::Menu(
    "gridExprDBMenu"              => "gridExprDBMenu",
    "> $STR{'sendToExprTool'}..." => "sendToExprTool",
    "> $STR{'Edit'}"              => "exprDBEdit"    ,
    "> $STR{'Delete'}"            => "exprDBDelete"  ,
  );
  $winExtraction->AddButton(    -name         => 'btnExtractNotReady'    ,
                                -size         => [ 30, 30]               ,
                                -pos          => [$winWidth/2-100,365]   ,
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winExtraction->AddButton(    -name         => 'btnExtractOk'          ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2-60,365]   ,
                                -text         => $STR{'SetAddFilter'}    ,
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winExtraction->AddButton(    -name         => 'btnExtractCancel'      ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2+50,365]    ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );
  # Enable Expression history
  if (exists($CONFIG{'EXPR_HISTORY'}))     { $winExtraction->chEnableExprHistory->Checked($CONFIG{'EXPR_HISTORY'}); }
  else                                     { $winExtraction->chEnableExprHistory->Checked(1);                       } # Default is checked
  if (exists($CONFIG{'EXPR_HISTORY_MAX'})) { $winExtraction->tfExprHistoryMax->Text($CONFIG{'EXPR_HISTORY_MAX'});   }
  else                                     { $winExtraction->tfExprHistoryMax->Text(100);                           } # Default is 100
  # Set Expression History grid header
  $winExtraction->gridExprHistory->SetCellText(0, 0, $STR{'Date'}  );
  $winExtraction->gridExprHistory->SetCellText(0, 1, $STR{'Case'}  );
  $winExtraction->gridExprHistory->SetCellText(0, 2, $STR{'Regex'} );
  $winExtraction->gridExprHistory->SetCellText(0, 3, $STR{'Invert'});
  $winExtraction->gridExprHistory->SetCellText(0, 4, $STR{'Expression'});
  $winExtraction->gridExprHistory->SetCellText(0, 5, $STR{'comment'});
  $winExtraction->gridExprHistory->SetCellFormat(0, 0, 1); # Center column headers
  $winExtraction->gridExprHistory->SetCellFormat(0, 1, 1);
  $winExtraction->gridExprHistory->SetCellFormat(0, 2, 1);
  $winExtraction->gridExprHistory->SetCellFormat(0, 3, 1);
  $winExtraction->gridExprHistory->SetCellFormat(0, 4, 1);
  $winExtraction->gridExprHistory->SetCellFormat(0, 5, 1);
  # Set Expression Database grid header
  $winExtraction->gridExprDatabase->SetCellText(0, 0, $STR{'used'}   );
  $winExtraction->gridExprDatabase->SetCellText(0, 1, $STR{'Case'}   );
  $winExtraction->gridExprDatabase->SetCellText(0, 2, $STR{'Regex'}  );
  $winExtraction->gridExprDatabase->SetCellText(0, 3, $STR{'Invert'} );
  $winExtraction->gridExprDatabase->SetCellText(0, 4, $STR{'Expression'});
  $winExtraction->gridExprDatabase->SetCellText(0, 5, $STR{'comment'});
  $winExtraction->gridExprDatabase->SetCellFormat(0, 0, 1); # Center column headers
  $winExtraction->gridExprDatabase->SetCellFormat(0, 1, 1);
  $winExtraction->gridExprDatabase->SetCellFormat(0, 2, 1);
  $winExtraction->gridExprDatabase->SetCellFormat(0, 3, 1);
  $winExtraction->gridExprDatabase->SetCellFormat(0, 4, 1);
  $winExtraction->gridExprDatabase->SetCellFormat(0, 5, 1);
  # Load the Expression History or create if doesn't exist
  if ($CONFIG{'EXPR_HISTO_DB'} and -f $CONFIG{'EXPR_HISTO_DB'} and &validExprHistoDB($CONFIG{'EXPR_HISTO_DB'})) {
    &loadExprHistoDB($winConfig->tfExprHistoDB->Text(), \$winExtraction,
                     $winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}), \$win, \%STR);
  } elsif ((!$CONFIG{'EXPR_HISTO_DB'} or !-f $CONFIG{'EXPR_HISTO_DB'} or !&validExprHistoDB($CONFIG{'EXPR_HISTO_DB'}))
           and $winExtraction->chEnableExprHistory->Checked()) {
    my $exprHistoDBFile = "$USERDIR\\ExprHisto.db";
    $winConfig->tfExprHistoDB->Text($exprHistoDBFile) if &createExprHistoDB($exprHistoDBFile);
  }
  # Load the Expression database
  if ($CONFIG{'EXPR_DB'} and -f $CONFIG{'EXPR_DB'} and &validExprDB($CONFIG{'EXPR_DB'})) {
    &loadExprDB($winConfig->tfExprDB->Text(), \$winExtraction, \$win, \%STR);
  } elsif (!$CONFIG{'EXPR_DB'} or !-f $CONFIG{'EXPR_DB'} or !&validExprDB($CONFIG{'EXPR_DB'})) {
    my $exprDBFile = "$USERDIR\\Expr.db";
    $winConfig->tfExprDB->Text($exprDBFile) if &createExprDB($exprDBFile);
  }
  
}  #--- End createWinExtraction

#--------------------------#
sub winExtraction_Resize
#--------------------------#
{
  # Type
  $winExtraction->TabExtractType->Width($winExtraction->ScaleWidth()-138);
  $winExtraction->TabExtractType->Height($winExtraction->ScaleHeight()+1);
  $winExtraction->cbLExtractREShorcuts->Left($winExtraction->ScaleWidth()-288);
  $winExtraction->lblExtractExprOk->Width($winExtraction->ScaleWidth()-170);
  $winExtraction->lblExtractExprErr->Width($winExtraction->ScaleWidth()-170);
  $winExtraction->lblExtractExprWarn->Width($winExtraction->ScaleWidth()-170);
  $winExtraction->lblExtractExprOk->Height($winExtraction->ScaleHeight()-178);
  $winExtraction->lblExtractExprErr->Height($winExtraction->ScaleHeight()-178);
  $winExtraction->lblExtractExprWarn->Height($winExtraction->ScaleHeight()-178);
  $winExtraction->tfExtractExpr->Width($winExtraction->ScaleWidth()-172);
  $winExtraction->tfExtractExpr->Height($winExtraction->ScaleHeight()-180);
  $winExtraction->lblExtractComment->Top($winExtraction->ScaleHeight()-77);
  $winExtraction->tfExtractComment->Top($winExtraction->ScaleHeight()-80);
  $winExtraction->tfExtractComment->Width($winExtraction->ScaleWidth()-270);
  $winExtraction->btnExtractExprAddDB->Left($winExtraction->ScaleWidth()-24);
  $winExtraction->btnExtractExprSaveDB->Left($winExtraction->ScaleWidth()-24);
  $winExtraction->btnExtractExprTools->Left($winExtraction->ScaleWidth()-24);
  $winExtraction->lblExprHistoryMax->Left($winExtraction->ScaleWidth()-215);
  $winExtraction->tfExprHistoryMax->Left($winExtraction->ScaleWidth()-60);
  $winExtraction->gridExprHistory->Width($winExtraction->ScaleWidth()-149);
  $winExtraction->gridExprHistory->Height($winExtraction->ScaleHeight()-150);
  $winExtraction->gridExprHistory->AutoSizeColumns();
  my $sortedCol = $winExtraction->gridExprHistory->GetSortColumn();
  my $currWidth = $winExtraction->gridExprHistory->GetColumnWidth($sortedCol);
  $winExtraction->gridExprHistory->SetColumnWidth($sortedCol, $currWidth+15);
  $winExtraction->gridExprHistory->ExpandLastColumn();
  $winExtraction->gridExprHistory->Refresh();
  $winExtraction->gridExprDatabase->Width($winExtraction->ScaleWidth()-149);
  $winExtraction->gridExprDatabase->Height($winExtraction->ScaleHeight()-125);
  $winExtraction->gridExprDatabase->AutoSizeColumns();
  $currWidth = $winExtraction->gridExprDatabase->GetColumnWidth(0);
  $winExtraction->gridExprDatabase->SetColumnWidth(0, $currWidth+15);
  $winExtraction->gridExprDatabase->ExpandLastColumn();
  $winExtraction->gridExprDatabase->Refresh();
  # Buttons
  $winExtraction->btnExtractNotReady->Left(($winExtraction->ScaleWidth()/2)-80);
  $winExtraction->btnExtractOk->Left(($winExtraction->ScaleWidth()/2)-40);
  $winExtraction->btnExtractCancel->Left(($winExtraction->ScaleWidth()/2)+70);
  $winExtraction->btnExtractNotReady->Top($winExtraction->ScaleHeight()-40);
  $winExtraction->btnExtractOk->Top($winExtraction->ScaleHeight()-40);
  $winExtraction->btnExtractCancel->Top($winExtraction->ScaleHeight()-40);
  
}  #--- End winExtraction_Resize

#--------------------------#
sub TabExtractType_Change
#--------------------------#
{
  # Local variables
  my $type = $winExtraction->TabExtractType->SelectedItem();
  # Expression tab
  if (!$type) {
    # Show new expression controls
    $winExtraction->chExtractExprCase->Show();
    $winExtraction->chExtractExprRegex->Show();
    $winExtraction->chExtractExprInvert->Show();
    $winExtraction->cbLExtractREShorcuts->Show();
    $winExtraction->tfExtractExpr->Show();
    $winExtraction->btnExtractExprAddDB->Show();
    $winExtraction->btnExtractExprSaveDB->Hide();
    $winExtraction->btnExtractExprTools->Show();
    $winExtraction->lblExtractComment->Show();
    $winExtraction->tfExtractComment->Show();
    # Hide Expression history controls
    $winExtraction->chEnableExprHistory->Hide();
    $winExtraction->gridExprHistory->Hide();
    $winExtraction->lblExprHistoryMax->Hide();
    $winExtraction->tfExprHistoryMax->Hide();
    # Hide Expression database controls
    $winExtraction->gridExprDatabase->Hide();
  # Expression history
  } elsif ($type == 1) {
    # Show Expression history controls
    $winExtraction->chEnableExprHistory->Show();
    $winExtraction->lblExprHistoryMax->Show();
    $winExtraction->tfExprHistoryMax->Show();
    $winExtraction->gridExprHistory->Show();
    # Hide new expression controls
    $winExtraction->chExtractExprCase->Hide();
    $winExtraction->chExtractExprRegex->Hide();
    $winExtraction->chExtractExprInvert->Hide();
    $winExtraction->cbLExtractREShorcuts->Hide();
    $winExtraction->tfExtractExpr->Hide();
    $winExtraction->btnExtractExprAddDB->Hide();
    $winExtraction->btnExtractExprSaveDB->Hide();
    $winExtraction->btnExtractExprTools->Hide();
    $winExtraction->lblExtractComment->Hide();
    $winExtraction->tfExtractComment->Hide();
    # Hide Expression database controls
    $winExtraction->gridExprDatabase->Hide();
  # Expression database
  } else {
    # Show Expression database controls
    $winExtraction->gridExprDatabase->Show();
    # Hide new expression controls
    $winExtraction->chExtractExprCase->Hide();
    $winExtraction->chExtractExprRegex->Hide();
    $winExtraction->chExtractExprInvert->Hide();
    $winExtraction->cbLExtractREShorcuts->Hide();
    $winExtraction->tfExtractExpr->Hide();
    $winExtraction->btnExtractExprAddDB->Hide();
    $winExtraction->btnExtractExprSaveDB->Hide();
    $winExtraction->btnExtractExprTools->Hide();
    $winExtraction->lblExtractComment->Hide();
    $winExtraction->tfExtractComment->Hide();
    # Hide Expression history controls
    $winExtraction->chEnableExprHistory->Hide();
    $winExtraction->gridExprHistory->Hide();
    $winExtraction->lblExprHistoryMax->Hide();
    $winExtraction->tfExprHistoryMax->Hide();
  }
  &isExtractReady(0);

}  #--- End TabExtractType_Change

#--------------------------#
sub chExtractExprRegex_Click { &isExtractReady(0); }
sub tfExtractExpr_Change     { &isExtractReady(0); }
#--------------------------#

#--------------------------#
sub cbLExtractREShorcuts_Change
#--------------------------#
{
  if (my $curSel = $winExtraction->cbLExtractREShorcuts->GetCurSel()) {
    my $selShortcut = $winExtraction->cbLExtractREShorcuts->GetString($curSel);
    my $REshortcut  = (split(/ : /, $selShortcut))[0];
    $winExtraction->tfExtractExpr->ReplaceSel($REshortcut);
  }
  
}  #--- End cbLExtractREShorcuts_Change

#--------------------------#
sub btnExtractExprAddDB_Click
#--------------------------#
{
  # Local variables
  my $type    = $winExtraction->TabExtractType->SelectedItem();
  my $expr    = $winExtraction->tfExtractExpr->GetLine(0);
  my $case    = $winExtraction->chExtractExprCase->Checked();
  my $regex   = $winExtraction->chExtractExprRegex->Checked();
  my $invert  = $winExtraction->chExtractExprInvert->Checked();
  my $comment = $winExtraction->tfExtractComment->Text();
  my $newLine;
  # Select or create Expression database
  my $exprDBFile = $winConfig->tfExprDB->Text();
  if (!-f $exprDBFile or !&validExprDB($exprDBFile)) {
    $exprDBFile = "$USERDIR\\Expr.db";
    $winConfig->tfExprDB->Text($exprDBFile) if &createExprDB($exprDBFile);
  }
  my $dsn = "DBI:SQLite:dbname=$exprDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Verify if it already exists
    if ($dbh->selectrow_array('SELECT expr FROM EXPR_DB WHERE expr == ?', undef, $expr)) {
      Win32::GUI::MessageBox($winExtraction, $STR{'errEntryExists'}, $STR{'warning'}, 0x40030);
      return(0);
    }
    # Add to Expression database
    # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
    my $sth = $dbh->prepare('INSERT INTO EXPR_DB (used, matchcase, regex, invert, expr, comment) VALUES(?,?,?,?,?,?)');
    my $rv  = $sth->execute(0, $case, $regex, $invert, $expr, $comment);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winExtraction, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Add to Grid
      if ($newLine = $winExtraction->gridExprDatabase->InsertRow($expr, -1)) {
        $winExtraction->gridExprDatabase->SetCellText($newLine, 0, 0);
        $winExtraction->gridExprDatabase->SetCellType($newLine, 1, 4);
        $winExtraction->gridExprDatabase->SetCellType($newLine, 2, 4);
        $winExtraction->gridExprDatabase->SetCellType($newLine, 3, 4);
        if ($case)   { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 1); }
        else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 0); }
        if ($regex)  { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 1); }
        else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 0); }
        if ($invert) { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 1); }
        else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 0); }
        $winExtraction->gridExprDatabase->SetCellText($newLine, 4, $expr);
        $winExtraction->gridExprDatabase->SetCellText($newLine, 5, $comment) if $comment;
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 0, 0);
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 1, 1);
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 2, 1);
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 3, 1);
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 4, 0);
        $winExtraction->gridExprDatabase->SetCellEditable($newLine, 5, 1);
        # Refresh grid
        $winExtraction->gridExprDatabase->SortCells(0, 0, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2); }); # Sort by used, descending
        $winExtraction->gridExprDatabase->AutoSizeColumns();
        my $currWidth = $winExtraction->gridExprDatabase->GetColumnWidth(0);
        $winExtraction->gridExprDatabase->SetColumnWidth(0, $currWidth+15);
        $winExtraction->gridExprDatabase->ExpandLastColumn();
        # Final message
        Win32::GUI::MessageBox($winExtraction, $STR{'addedExprDB'}, $STR{'exprDatabase'}, 0x40040);
      } else { Win32::GUI::MessageBox($winExtraction, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }
  # Return to database expression tab
  if ($newLine) {
    $winExtraction->TabExtractType->SetCurSel(2);
    &TabExtractType_Change();
    $winExtraction->gridExprDatabase->EnsureCellVisible($newLine,0);
  }

}  #--- End btnExtractExprAddDB_Click

#--------------------------#
sub btnExtractExprSaveDB_Click
#--------------------------#
{
  # Local variables
  my $oldExpr    = $winExtraction->tfOldExprHidden->Text();
  my $newExpr    = $winExtraction->tfExtractExpr->GetLine(0);
  my $case       = $winExtraction->chExtractExprCase->Checked();
  my $regex      = $winExtraction->chExtractExprRegex->Checked();
  my $invert     = $winExtraction->chExtractExprInvert->Checked();
  my $comment    = $winExtraction->tfExtractComment->Text();
  my $exprDBFile = $winConfig->tfExprDB->Text();
  my $dsn = "DBI:SQLite:dbname=$exprDBFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
            or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
  # Delete the old expression
  # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
  my $sth = $dbh->prepare('DELETE from EXPR_DB where expr == ?');
  my $rv  = $sth->execute($oldExpr);
  if ($rv < 0) { Win32::GUI::MessageBox($winExtraction, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  else { 
    # Find the entry in grid and delete
    for (my $k = 0; $k < $winExtraction->gridExprDatabase->GetRows(); $k++) {
      my $currEntryExpr = $winExtraction->gridExprDatabase->GetCellText($k, 4);
      if ($oldExpr eq $currEntryExpr) {
        $winExtraction->gridExprDatabase->DeleteRow($k);
        last;
      }
    }
  }
  # Create the new entry
  # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
  $sth = $dbh->prepare('INSERT INTO EXPR_DB (used, matchcase, regex, invert, expr, comment) VALUES(?,?,?,?,?,?)');
  $rv  = $sth->execute(0, $case, $regex, $invert, $newExpr, $comment);
  if ($rv < 0) {
    Win32::GUI::MessageBox($winExtraction, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
    return(0);
  } else {
    # Add to Grid
    if (my $newLine = $winExtraction->gridExprDatabase->InsertRow($newExpr, -1)) {
      $winExtraction->gridExprDatabase->SetCellText($newLine, 0, 0);
      $winExtraction->gridExprDatabase->SetCellType($newLine, 1, 4);
      $winExtraction->gridExprDatabase->SetCellType($newLine, 2, 4);
      $winExtraction->gridExprDatabase->SetCellType($newLine, 3, 4);
      #$winExtraction->gridExprDatabase->SetCellFormat($newLine, 1, 1); # Center column (doesn't work for this type)
      #$winExtraction->gridExprDatabase->SetCellFormat($newLine, 2, 1);
      #$winExtraction->gridExprDatabase->SetCellFormat($newLine, 3, 1);
      if ($case)   { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 1);  }
      else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 0);  }
      if ($regex)  { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 1);  }
      else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 0);  }
      if ($invert) { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 1);  }
      else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 0);  }
      $winExtraction->gridExprDatabase->SetCellText($newLine, 4, $newExpr);
      $winExtraction->gridExprDatabase->SetCellText($newLine, 5, $comment) if $comment;
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 0, 0);
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 1, 1);
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 2, 1);
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 3, 1);
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 4, 0);
      $winExtraction->gridExprDatabase->SetCellEditable($newLine, 5, 1);
      # Refresh grid
      $winExtraction->gridExprDatabase->SortCells(0, 0, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2); }); # Sort by used, descending
      $winExtraction->gridExprDatabase->AutoSizeColumns();
      my $currWidth = $winExtraction->gridExprDatabase->GetColumnWidth(0);
      $winExtraction->gridExprDatabase->SetColumnWidth(0, $currWidth+15);
      $winExtraction->gridExprDatabase->ExpandLastColumn();
      # Final message
      Win32::GUI::MessageBox($winExtraction, $STR{'editedExprDB'}, $STR{'exprDatabase'}, 0x40040);
    } else { Win32::GUI::MessageBox($winExtraction, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
  }

}  #--- End btnExtractExprSaveDB_Click

#--------------------------#
sub btnExtractExprTools_Click
#--------------------------#
{
  &openWinExprTool($winExtraction->chExtractExprCase->Checked()  , $winExtraction->chExtractExprRegex->Checked(),
                   $winExtraction->chExtractExprInvert->Checked(), $winExtraction->tfExtractExpr->Text());

}  #--- End btnExtractExprTools_Click

#--------------------------#
sub openWinExprTool
#--------------------------#
{
  # Local variables
  my ($case, $regex, $invert, $expr) = @_;
  &createWinExprTool() if !$winExprTool;
  $case   ? $winExprTool->chExprToTestCase->Checked(1) :$winExprTool->chExprToTestCase->Checked(0);
  $regex  ? $winExprTool->chExprToTestRegex->Checked(1):$winExprTool->chExprToTestRegex->Checked(0);
  $invert ? $winExprTool->chExprToTestRegex->Checked(1):$winExprTool->chExprToTestInvert->Checked(0);
  $winExprTool->tfExprToTest->Text($expr);
  &testExpression();
  $winExprTool->Center($winExtraction);
  $winExprTool->Show();
  $winExtraction->Disable();

}  #--- End openWinExprTool

#--------------------------#
sub createWinExprTool
#--------------------------#
{
  # Expression tool window
  $winExprTool = Win32::GUI::Window->new( -name        => 'winExprTool'          ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winExprTool'}    ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [650, 430]             ,
                                          -minsize     => [650, 430]             ,
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      , );
  $winExprTool->SetIcon($winICO);
  $winExprTool->AddLabel(       -name         => 'lblExprToTestShadowT'  ,
                                -size         => [150, 22]               ,
                                -pos          => [  6,  6]               ,
                                -foreground   => [180, 180, 180]         ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Expression'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddLabel(       -name         => 'lblExprToTestT'        ,
                                -size         => [150, 22]               ,
                                -pos          => [  5,  5]               ,
                                -addstyle     => 11                      , # Transparent
                                -foreground   => [ 50, 180,  0]          ,
                                -text         => $STR{'Expression'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddCheckbox(    -name         => 'chExprToTestCase'      ,
                                -size         => [125, 22]               ,
                                -pos          => [200,  8]               ,
                                -text         => $STR{'Case'}            ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExprTool->AddCheckbox(    -name         => 'chExprToTestRegex'     ,
                                -size         => [ 80, 22]               ,
                                -pos          => [330,  8]               ,
                                -text         => $STR{'Regex'}           ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExprTool->AddCheckbox(    -name         => 'chExprToTestInvert'    ,
                                -size         => [ 80, 22]               ,
                                -pos          => [430,  8]               ,
                                -text         => $STR{'Invert'}          ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winExprTool->AddLabel(       -name         => 'lblExprToTestOk'       ,
                                -size         => [$winExprTool->ScaleWidth()-8, 47],
                                -pos          => [  4, 34]               ,
                                -background   => [  0, 255,   0]         ,
                                -visible      => 0                       , );
  $winExprTool->AddLabel(       -name         => 'lblExprToTestErr'      ,
                                -size         => [$winExprTool->ScaleWidth()-8, 47],
                                -pos          => [  4, 34]               ,
                                -background   => [255,   0,   0]         ,
                                -visible      => 0                       , );
  $winExprTool->AddLabel(       -name         => 'lblExprToTestWarn'     ,
                                -size         => [$winExprTool->ScaleWidth()-8, 47],
                                -pos          => [  4, 34]               ,
                                -background   => [255, 255,   0]         ,
                                -visible      => 0                       , );
  $winExprTool->AddTextfield(   -name         => 'tfExprToTest'          ,
                                -size         => [$winExprTool->ScaleWidth()-10, 45],
                                -pos          => [  5, 35]               ,
                                -font         => $font10                 ,
                                -multiline    => 1                       ,
                                -wantreturn   => 1                       ,
                                -vscroll      => 1                       ,
                                -autohscroll  => 1                       ,
                                -tabstop      => 1                       , );
  $winExprTool->AddLabel(       -name         => 'lblDataSampleShadowT'  ,
                                -size         => [150, 22]               ,
                                -pos          => [  6, 86]               ,
                                -foreground   => [180, 180, 180]         ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'lblDataSample'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddLabel(       -name         => 'lblDataSampleT'        ,
                                -size         => [150, 22]               ,
                                -pos          => [  5, 85]               ,
                                -addstyle     => 11                      , # Transparent
                                -foreground   => [ 50, 180,  0]          ,
                                -text         => $STR{'lblDataSample'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddTextfield(   -name         => 'tfDataSample'          ,
                                -size         => [$winExprTool->ScaleWidth()-10,100],
                                -pos          => [  5,110]               ,
                                -font         => $font10                 ,
                                -multiline    => 1                       ,
                                -wantreturn   => 1                       ,
                                -vscroll      => 1                       ,
                                -hscroll      => 1                       ,
                                -tabstop      => 1                       , );
  $winExprTool->AddLabel(       -name         => 'lblTestResShadowT'     ,
                                -size         => [150, 22]               ,
                                -pos          => [  6,216]               ,
                                -foreground   => [180, 180, 180]         ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Results'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddLabel(       -name         => 'lblTestResT'           ,
                                -size         => [150, 22]               ,
                                -pos          => [  5,215]               ,
                                -addstyle     => 11                      , # Transparent
                                -foreground   => [ 50, 180,  0]          ,
                                -text         => $STR{'Results'}.':',
                                -font         => $fontGB2                , );
  $winExprTool->AddTextfield(   -name         => 'tfTestRes'             ,
                                -size         => [$winExprTool->ScaleWidth()-10,100],
                                -pos          => [  5,240]               ,
                                -font         => $font10                 ,
                                -multiline    => 1                       ,
                                -wantreturn   => 1                       ,
                                -vscroll      => 1                       ,
                                -hscroll      => 1                       ,
                                -tabstop      => 1                       , );
  $winExprTool->AddButton(      -name         => 'btnExprTestNotReady'   ,
                                -size         => [ 30, 30]               ,
                                -pos          => [$winExprTool->ScaleWidth()/2-120,350],
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winExprTool->AddButton(      -name         => 'btnExprTestOk'         ,
                                -size         => [100, 30]               ,
                                -pos          => [$winExprTool->ScaleWidth()/2-80,350],
                                -text         => $STR{'Ok'}              ,
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winExprTool->AddButton(      -name         => 'btnExprTestCancel'     ,
                                -size         => [100, 30]               ,
                                -pos          => [$winExprTool->ScaleWidth()/2+30,350],
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );

}  #--- End createWinExprTool

#--------------------------#
sub winExprTool_Resize
#--------------------------#
{
  # Left and Width
  $winExprTool->lblExprToTestOk->Width($winExprTool->ScaleWidth()-8);
  $winExprTool->lblExprToTestErr->Width($winExprTool->ScaleWidth()-8);
  $winExprTool->lblExprToTestWarn->Width($winExprTool->ScaleWidth()-8);
  $winExprTool->tfExprToTest->Width($winExprTool->ScaleWidth()-10);
  $winExprTool->tfDataSample->Width($winExprTool->ScaleWidth()-10);
  $winExprTool->tfTestRes->Width($winExprTool->ScaleWidth()-10);
  $winExprTool->btnExprTestNotReady->Left($winExprTool->ScaleWidth()/2-120);
  $winExprTool->btnExprTestOk->Left($winExprTool->ScaleWidth()/2-80);
  $winExprTool->btnExprTestCancel->Left($winExprTool->ScaleWidth()/2+30);
  # Top and Height  
  my $top2 = $winExprTool->tfExprToTest->Top()+$winExprTool->tfExprToTest->Height();
  $winExprTool->lblDataSampleShadowT->Top($top2+6);
  $winExprTool->lblDataSampleT->Top($top2+5);
  $winExprTool->tfDataSample->Top($top2+35);
  $winExprTool->tfDataSample->Height((($winExprTool->ScaleHeight()-$top2)/2.4)-35);
  my $top3 = $winExprTool->tfDataSample->Top()+$winExprTool->tfDataSample->Height();
  $winExprTool->lblTestResShadowT->Top($top3+6);
  $winExprTool->lblTestResT->Top($top3+5);
  $winExprTool->tfTestRes->Top($top3+35);
  $winExprTool->tfTestRes->Height($winExprTool->ScaleHeight()-$top3-85);
  $winExprTool->btnExprTestNotReady->Top($winExprTool->ScaleHeight()-40);
  $winExprTool->btnExprTestOk->Top($winExprTool->ScaleHeight()-40);
  $winExprTool->btnExprTestCancel->Top($winExprTool->ScaleHeight()-40);
  
}  #--- End winExprTool_Resize

#--------------------------#
sub chExprToTestCase_Click    { &testExpression(0); }
sub chExprToTestRegex_Click   { &testExpression(0); }
sub chExprToTestInvert_Click  { &testExpression(0); }
sub tfExprToTest_Change       { &testExpression(0); }
sub tfDataSample_Change       { &testExpression(0); }
sub btnExprTestNotReady_Click { &testExpression(1); }
#--------------------------#

#--------------------------#
sub testExpression
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $expr    = $winExprTool->tfExprToTest->Text();
  my ($statusRegex, $msg);
  $winExprTool->tfTestRes->Text(''); # Reset Results
  # Valid expression
  if ($winExprTool->chExprToTestRegex->Checked()) {
    ($statusRegex, $msg) = &validRegex($expr);
    # Warning
    if      ($statusRegex == 2) {
      $winExprTool->lblExprToTestWarn->Show();
      $winExprTool->lblExprToTestOk->Hide();
      $winExprTool->lblExprToTestErr->Hide();
    # Error
    } elsif ($statusRegex == 1) {
      $winExprTool->lblExprToTestErr->Show();
      $winExprTool->lblExprToTestOk->Hide();
      $winExprTool->lblExprToTestWarn->Hide();
    # Ok
    } else {
      $winExprTool->lblExprToTestOk->Show();
      $winExprTool->lblExprToTestErr->Hide();
      $winExprTool->lblExprToTestWarn->Hide();
    }
  }
  # Return an error message
  if ($statusRegex) {
    $winExprTool->btnExprTestOk->Disable();
    $winExprTool->btnExprTestNotReady->Enable();
    Win32::GUI::MessageBox($winExprTool, "$STR{'errorMsg'}\n\n$STR{'errRegex'}: $msg", $STR{'error'}, 0x40040) if $confirm;
  # Expression is ok
  } elsif ($expr) {
    my $i = 0;
    my %expr;
    $expr{'expr'} = $expr;
    if ($winExprTool->chExprToTestCase->Checked()  ) { $expr{case}   = 1; } else { $expr{case}   = 0; }
    if ($winExprTool->chExprToTestRegex->Checked() ) { $expr{regex}  = 1; } else { $expr{regex}  = 0; }
    if ($winExprTool->chExprToTestInvert->Checked()) { $expr{invert} = 1; } else { $expr{invert} = 0; }
    while ($i <= $winExprTool->tfDataSample->GetLineCount()) {
      if (my $line = $winExprTool->tfDataSample->GetLine($i)) {
        my ($result, $nbrRes, $refListRes) = &textExpr($line, \%expr, $expr);
        if ($result) {
          my $lineRes;
          my @results = split(/\t/, (@{$refListRes})[0]);
          shift(@results);
          foreach (@results) { $lineRes .= "$_\t"; }
          chop($lineRes);          
          $winExprTool->tfTestRes->Append("$lineRes\r\n");
        }
      }
      $i++;
    }
    $winExprTool->btnExprTestOk->Enable();
    $winExprTool->btnExprTestNotReady->Disable();
  }

}  #--- End testExpression

#--------------------------#
sub btnExprTestOk_Click
#--------------------------#
{
  $winExtraction->tfExtractExpr->Text($winExprTool->tfExprToTest->Text());
  $winExtraction->chExtractExprCase->Checked($winExprTool->chExprToTestCase->Checked());
  $winExtraction->chExtractExprRegex->Checked($winExprTool->chExprToTestRegex->Checked());
  $winExtraction->chExtractExprInvert->Checked($winExprTool->chExprToTestInvert->Checked());
  &winExprTool_Terminate();

}  #--- End btnExprTestOk_Click

#--------------------------#
sub btnExprTestCancel_Click { &winExprTool_Terminate(); }
#--------------------------#

#--------------------------#
sub winExprTool_Terminate
#--------------------------#
{
  $winExprTool->Hide();
  $winExtraction->Enable();
  $winExtraction->Show();
  $winExtraction->BringWindowToTop();
  return(0);

}  #--- End winExprTool_Terminate

#--------------------------#
sub chEnableExprHistory_Click
#--------------------------#
{
  # Save the choice
  if ($winExtraction->chEnableExprHistory->Checked()) {
    $CONFIG{'EXPR_HISTORY'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'EXPR_HISTORY'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chEnableExprHistory_Click

#--------------------------#
sub tfExprHistoryMax_Change
#--------------------------#
{
  # Save the choice
  $CONFIG{'EXPR_HISTORY_MAX'} = $winExtraction->tfExprHistoryMax->Text();
  &saveConfig($CONFIG_FILE, \%CONFIG);

}  #--- End tfExprHistoryMax_Change

#--------------------------#
sub gridExprHistory_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  if (!$row and (!$column or $column > 3)) {
    $winExtraction->gridExprHistory->SetHeaderSort();
    my $order = $winExtraction->gridExprHistory->GetSortAscending();
    if    (!$column)    { $winExtraction->gridExprHistory->SortCells($column, $order, \&sortByDate); }
    elsif ($column > 3) { $winExtraction->gridExprHistory->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); }); }
    $winExtraction->gridExprHistory->Refresh();
  }
  return(1);

}  #--- End gridExprHistory_Click

#--------------------------#
sub gridExprHistory_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  &btnExtractOk_Click() if $row;

}  #--- End gridExprHistory_DblClick

#--------------------------#
sub sortByDate
#--------------------------#
{
  # Local variables
  my ($a, $b) = @_;
  my $strp = DateTime::Format::Strptime->new(pattern => '%F %T');
  my $dt1  = $strp->parse_datetime($a);
  my $dt2  = $strp->parse_datetime($b);
  return (DateTime->compare($dt1,$dt2));

}  #--- End sortByDate

#--------------------------#
sub gridExprHistory_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my (@coord) = $winExtraction->gridExprHistory->GetSelectedCellRange();
  # Select the right entry if not selected or select has change
  $winExtraction->gridExprHistory->SetSelectedCellRange($row, 0, $row, 5)
  if (($coord[0] and ($row < $coord[0])) or ($coord[2] and ($row > $coord[2])) or !$coord[0]);
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winExtraction->TrackPopupMenu($gridExprHistoMenu->{gridExprHistoMenu},$X, $Y);
  return(1);

}  #--- End gridExprHistory_RClick

#--------------------------#
sub exprHistoAddToDB_Click
#--------------------------#
{
  # Local variables
  my (@coord)    = $winExtraction->gridExprHistory->GetSelectedCellRange();
  my $exprDBFile = $winConfig->tfExprDB->Text();
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winExtraction->gridExprHistory->Refresh();
      # Status bar
      &winPb_Terminate;
      $winExtraction->ChangeCursor($ARROW);
      threads->exit();
    };
    # Select data to add
    my $lastSelectedRow;
    my $nbrEntries2Add = 0;
    if ($coord[2]) { $lastSelectedRow = $coord[2]; $nbrEntries2Add = $coord[2] - $coord[0]; }
    else           { $lastSelectedRow = $coord[0]; }
    $nbrEntries2Add++;
    # Show progress window
    my $j = 0;
    $winPb->lblPbCurr->Text($STR{'addingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2Add");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2Add);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winExtraction);
    $winPb->Show();
    $winExtraction->Disable();
    $winExtraction->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$exprDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
    my $sth = $dbh->prepare('INSERT INTO EXPR_DB (used, matchcase, regex, invert, expr, comment) VALUES(?,?,?,?,?,?)');
    # Loop each entry and add
    for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
      if ($winExtraction->gridExprHistory->IsCellSelected($row, 3)) {
        my $case    = $winExtraction->gridExprHistory->GetCellCheck($row, 1);
        my $regex   = $winExtraction->gridExprHistory->GetCellCheck($row, 2);
        my $invert  = $winExtraction->gridExprHistory->GetCellCheck($row, 3);
        my $expr    = $winExtraction->gridExprHistory->GetCellText( $row, 4);
        my $comment = $winExtraction->gridExprHistory->GetCellText( $row, 5);
        # Check if entry already exist
        my $exprExists = 0;
        for (my $k = 0; $k < $winExtraction->gridExprDatabase->GetRows(); $k++) {
          my $currEntryExpr = $winExtraction->gridExprDatabase->GetCellText($k, 4);
          if ($expr eq $currEntryExpr) { $exprExists = 1; last; }
        }
        # Add to database if doesn't exist
        if (!$exprExists) {
          my $rv = $sth->execute(0, $case, $regex, $invert, $expr, $comment);
          if ($rv < 0) {
            Win32::GUI::MessageBox($winExtraction, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
            return(0);
          } else {
            # Add to Grid
            if (my $newLine = $winExtraction->gridExprDatabase->InsertRow($expr, -1)) {
              $winExtraction->gridExprDatabase->SetCellText($newLine, 0, 0);
              $winExtraction->gridExprDatabase->SetCellType($newLine, 1, 4);
              $winExtraction->gridExprDatabase->SetCellType($newLine, 2, 4);
              $winExtraction->gridExprDatabase->SetCellType($newLine, 3, 4);
              if ($case)   { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 1); }
              else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 1, 0); }
              if ($regex)  { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 1); }
              else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 2, 0); }
              if ($invert) { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 1); }
              else         { $winExtraction->gridExprDatabase->SetCellCheck($newLine, 3, 0); }
              $winExtraction->gridExprDatabase->SetCellText($newLine, 4, $expr);
              $winExtraction->gridExprDatabase->SetCellText($newLine, 5, $comment) if $comment;
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 0, 0);
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 1, 1);
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 2, 1);
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 3, 1);
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 4, 0);
              $winExtraction->gridExprDatabase->SetCellEditable($newLine, 5, 1);
              # Refresh grid
              $winExtraction->gridExprDatabase->SortCells(0, 0, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2); }); # Sort by used, descending
              $winExtraction->gridExprDatabase->AutoSizeColumns();
              my $currWidth = $winExtraction->gridExprDatabase->GetColumnWidth(0);
              $winExtraction->gridExprDatabase->SetColumnWidth(0, $currWidth+15);
              $winExtraction->gridExprDatabase->ExpandLastColumn();
              # Final message
              Win32::GUI::MessageBox($winExtraction, $STR{'addedExprDB'}, $STR{'exprDatabase'}, 0x40040);
            } else { Win32::GUI::MessageBox($winExtraction, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
          }
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2Add");
      $winPb->pbWinPb->StepIt();
    }
    $winExtraction->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    $winExtraction->gridExprHistory->AutoSizeColumns();
    my $sortedCol = $winExtraction->gridExprHistory->GetSortColumn();
    my $currWidth = $winExtraction->gridExprHistory->GetColumnWidth($sortedCol);
    $winExtraction->gridExprHistory->SetColumnWidth($sortedCol, $currWidth+15);
    $winExtraction->gridExprHistory->ExpandLastColumn();
    $winExtraction->gridExprHistory->Refresh();
  });
  return(1);

}  #--- End exprHistoAddToDB_Click

#--------------------------#
sub exprHistoDelete_Click
#--------------------------#
{
  # Local variables
  my (@coord)         = $winExtraction->gridExprHistory->GetSelectedCellRange();
  my $nbrEntries      = $winExtraction->gridExprHistory->GetRows();
  my $exprHistoDBFile = $winConfig->tfExprHistoDB->Text();
  my @Entries2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winExtraction->gridExprHistory->IsCellSelected($row, 4)) {
      my $exprEntry = $winExtraction->gridExprHistory->GetCellText($row, 4);
      push(@Entries2del, $exprEntry);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winExtraction->gridExprHistory->Refresh();
      # Status bar
      &winPb_Terminate;
      $winExtraction->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrEntries2del = @Entries2del;
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winExtraction);
    $winPb->Show();
    $winExtraction->Disable();
    $winExtraction->ChangeCursor($HOURGLASS);
    my $dsn = "DBI:SQLite:dbname=$exprHistoDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $exprEntry2del (@Entries2del) {
      for (my $i = 0; $i < $nbrEntries; $i++) {
        my $exprEntry = $winExtraction->gridExprHistory->GetCellText($i, 4);
        # Entry have been found
        if ($exprEntry eq $exprEntry2del) {
          # Delete entry in DB
          # Database: table = EXPR_HISTO_DB, Fields = date, matchcase, regex, invert, expr, comment
          my $sth = $dbh->prepare('DELETE from EXPR_HISTO_DB where expr == ?');
          my $rv = $sth->execute($exprEntry);
          if ($rv < 0) { Win32::GUI::MessageBox($winExtraction, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = $i; $k < $winExtraction->gridExprHistory->GetRows(); $k++) {
              my $currEntryExpr = $winExtraction->gridExprHistory->GetCellText($k, 4);
              if ($exprEntry eq $currEntryExpr) {
                $winExtraction->gridExprHistory->DeleteRow($k);
                last;
              }
            }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2del");
      $winPb->pbWinPb->StepIt();
    }
    $winExtraction->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    $winExtraction->gridExprHistory->AutoSizeColumns();
    my $sortedCol = $winExtraction->gridExprHistory->GetSortColumn();
    my $currWidth = $winExtraction->gridExprHistory->GetColumnWidth($sortedCol);
    $winExtraction->gridExprHistory->SetColumnWidth($sortedCol, $currWidth+15);
    $winExtraction->gridExprHistory->ExpandLastColumn();
    $winExtraction->gridExprHistory->Refresh();
  });
  return(1);

}  #--- End exprHistoDelete_Click

#--------------------------#
sub addExprHisto
#--------------------------#
{
  # Local variables
  my ($case, $regex, $invert, $expr, $comment) = @_;
  my $exprHistoDBFile = $winConfig->tfExprHistoDB->Text();
  my $unixtime        = time;
  my $dt              = DateTime->from_epoch(epoch => $unixtime); # Convert unixtime
  # Connect to DB
  my $dsn = "DBI:SQLite:dbname=$exprHistoDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Add or update in Expression history database
    # Database: table = EXPR_HISTO_DB, Fields = date, matchcase, regex, invert, expr, comment
    my $sth = $dbh->prepare('INSERT OR REPLACE INTO EXPR_HISTO_DB (date, matchcase, regex, invert, expr, comment) VALUES(?,?,?,?,?,?)');
    my $rv  = $sth->execute($unixtime, $case, $regex, $invert, $expr, $comment);
    if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010); }
    else {
      my $modified = 0;
      # Check if expression exists in Expression history grid, if so modify it
      $dt->set_time_zone($winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}));
      for (my $k = 0; $k < $winExtraction->gridExprHistory->GetRows(); $k++) {
        my $currEntryExpr = $winExtraction->gridExprHistory->GetCellText($k, 4);
        # Exists modify it
        if ($expr eq $currEntryExpr) {
          $winExtraction->gridExprHistory->SetCellText($k, 0, $dt->strftime('%F %T')); # Date
          if ($case)    { $winExtraction->gridExprHistory->SetCellCheck($k, 1, 1);  }  # Case
          else          { $winExtraction->gridExprHistory->SetCellCheck($k, 1, 0);  }
          if ($regex)   { $winExtraction->gridExprHistory->SetCellCheck($k, 2, 1);  }  # Regex
          else          { $winExtraction->gridExprHistory->SetCellCheck($k, 2, 0);  }
          if ($invert)  { $winExtraction->gridExprHistory->SetCellCheck($k, 3, 1);  }  # Invert
          else          { $winExtraction->gridExprHistory->SetCellCheck($k, 3, 0);  }
          $winExtraction->gridExprHistory->SetCellText($k, 4, $expr);                  # Expr
          $winExtraction->gridExprHistory->SetCellText($k, 5, $comment) if $comment;   # Comment
          $modified = 1;
          last;
        }
      }
      # Doesn't exists, Add
      if (!$modified and my $newLine = $winExtraction->gridExprHistory->InsertRow($expr, -1)) {
        $winExtraction->gridExprHistory->SetCellText($newLine, 0, $dt->strftime('%F %T')); # Date
        $winExtraction->gridExprHistory->SetCellType($newLine, 1, 4);
        $winExtraction->gridExprHistory->SetCellType($newLine, 2, 4);
        $winExtraction->gridExprHistory->SetCellType($newLine, 3, 4);
        if ($case)   { $winExtraction->gridExprHistory->SetCellCheck($newLine, 1, 1);  }   # Case
        else         { $winExtraction->gridExprHistory->SetCellCheck($newLine, 1, 0);  }
        if ($regex)  { $winExtraction->gridExprHistory->SetCellCheck($newLine, 2, 1);  }   # Regex
        else         { $winExtraction->gridExprHistory->SetCellCheck($newLine, 2, 0);  }
        if ($invert) { $winExtraction->gridExprHistory->SetCellCheck($newLine, 3, 1);  }   # Invert
        else         { $winExtraction->gridExprHistory->SetCellCheck($newLine, 3, 0);  }
        $winExtraction->gridExprHistory->SetCellText($newLine, 4, $expr);                  # Expr
        $winExtraction->gridExprHistory->SetCellText($newLine, 5, $comment) if $comment;   # Comment
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 0, 0);
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 1, 0);
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 2, 0);
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 3, 0);
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 4, 0);
        $winExtraction->gridExprHistory->SetCellEditable($newLine, 5, 0);
        # Sort by date, descending (newest first)
        $winExtraction->gridExprHistory->SortCells(0, 0, \&sortByDate);
        # Check if maximum of entries in history has been exceeded
        my $maxHisto = $winExtraction->tfExprHistoryMax->Text();
        $maxHisto++; # Don't count header
        if ($winExtraction->gridExprHistory->GetRows() > $maxHisto - 1) {
          my $oldestExpr = $winExtraction->gridExprHistory->GetCellText($maxHisto, 4);
          # Delete entry in DB
          # Database: table = EXPR_HISTO_DB, Fields = date, matchcase, regex, invert, expr, comment
          $sth = $dbh->prepare('DELETE from EXPR_HISTO_DB where expr == ?');
          $rv  = $sth->execute($oldestExpr);
          if ($rv < 0) { Win32::GUI::MessageBox($winExtraction, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = 0; $k < $winExtraction->gridExprHistory->GetRows(); $k++) {
              my $currEntryExpr = $winExtraction->gridExprHistory->GetCellText($k, 4);
              if ($oldestExpr eq $currEntryExpr) {
                $winExtraction->gridExprHistory->DeleteRow($k);
                last;
              }
            }
          }
        }
      }
      # Refresh grid
      $winExtraction->gridExprHistory->SortCells(0, 0, \&sortByDate);
      $winExtraction->gridExprHistory->AutoSizeColumns();
      $winExtraction->gridExprHistory->ExpandLastColumn();
      $winExtraction->gridExprHistory->Refresh();
    }
    $dbh->disconnect();
  } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }

}  #--- End addExprHisto
  
#--------------------------#
sub gridExprDatabase_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  # Sorting
  if (!$row) {
    $winExtraction->gridExprDatabase->SetHeaderSort();
    my $order = $winExtraction->gridExprDatabase->GetSortAscending();
    if    (!$column)    { $winExtraction->gridExprDatabase->SortCells($column, $order, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2);         }); }
    elsif ($column > 3) { $winExtraction->gridExprDatabase->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); }); }
    $winExtraction->gridExprDatabase->Refresh();
  # Selection
  } elsif ($column == 1 or $column == 2) {
    my $exprDBFile = $winConfig->tfExprDB->Text();
    my $expr       = $winExtraction->gridExprDatabase->GetCellText($row, 4);
    # Add or modify comment in Expression Database
    if (-f $exprDBFile) {
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$exprDBFile";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
      my $sth = $dbh->prepare('UPDATE EXPR_DB SET matchcase = ?, regex = ?, invert = ? WHERE ? == expr');
      my $rv  = $sth->execute($winExtraction->gridExprDatabase->GetCellCheck($row, 1),
                              $winExtraction->gridExprDatabase->GetCellCheck($row, 2),
                              $winExtraction->gridExprDatabase->GetCellCheck($row, 3),
                              $expr);
      Win32::GUI::MessageBox($win, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010) if $rv < 0;
      $dbh->disconnect();
    }
  }
  return(1);

}  #--- End gridExprDatabase_Click

#--------------------------#
sub gridExprDatabase_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my (@coord) = $winExtraction->gridExprDatabase->GetSelectedCellRange();
  # Select the right entry if not selected or select has change
  $winExtraction->gridExprDatabase->SetSelectedCellRange($row, 0, $row, 5)
  if (($coord[0] and ($row < $coord[0])) or ($coord[2] and ($row > $coord[2])) or !$coord[0]);
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winExtraction->TrackPopupMenu($gridExprDBMenu->{gridExprDBMenu},$X, $Y);
  return(1);

}  #--- End gridExprDatabase_RClick

#--------------------------#
sub gridExprDatabase_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  &btnExtractOk_Click() if $row;

}  #--- End gridExprDatabase_DblClick

#--------------------------#
sub sendToExprTool_Click
#--------------------------#
{
  # Local variables
  my ($expr, $case, $regex);
  # From Expression history
  if ($winExtraction->TabExtractType->SelectedItem() == 1) {
    my ($row) = ($winExtraction->gridExprHistory->GetSelectedCellRange())[0];
    &openWinExprTool($winExtraction->gridExprHistory->GetCellCheck($row, 1),
                     $winExtraction->gridExprHistory->GetCellCheck($row, 2),
                     $winExtraction->gridExprHistory->GetCellCheck($row, 3),
                     $winExtraction->gridExprHistory->GetCellText( $row, 4));
  # From Expression database
  } else {
    my ($row) = ($winExtraction->gridExprDatabase->GetSelectedCellRange())[0];
    &openWinExprTool($winExtraction->gridExprDatabase->GetCellCheck($row, 1),
                     $winExtraction->gridExprDatabase->GetCellCheck($row, 2),
                     $winExtraction->gridExprDatabase->GetCellCheck($row, 3),
                     $winExtraction->gridExprDatabase->GetCellText( $row, 4));
  }

}  #--- End sendToExprTool_Click

#--------------------------#
sub gridExprDatabase_EndEdit
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  # Comment has changed
  if ($column == 4) {
    my $exprDBFile = $winConfig->tfExprDB->Text();
    my $expr       = $winExtraction->gridExprDatabase->GetCellText($row, 4);
    # Add or modify comment in Expression Database
    if (-f $exprDBFile) {
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$exprDBFile";
      my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
                or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
      my $sth = $dbh->prepare('UPDATE EXPR_DB SET comment = ? WHERE ? == expr');
      my $rv  = $sth->execute($winExtraction->gridExprDatabase->GetCellText($row, 4), $expr);
      Win32::GUI::MessageBox($win, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010) if $rv < 0;
      $dbh->disconnect();
    }
  }
  
}  #--- End gridExprDatabase_EndEdit

#--------------------------#
sub exprDBEdit_Click
#--------------------------#
{
  # Local variables
  my $row = ($winExtraction->gridExprDatabase->GetSelectedCellRange())[0];
  if ($row != 0) {
    # Set Expression tab control values
    $winExtraction->cbExtractOp->SetCurSel(0);
    $winExtraction->cbExtractOp->Disable();
    $winExtraction->chExtractExprCase->Checked($winExtraction->gridExprDatabase->GetCellCheck($row, 1));
    $winExtraction->chExtractExprRegex->Checked($winExtraction->gridExprDatabase->GetCellCheck($row, 2));
    $winExtraction->chExtractExprInvert->Checked($winExtraction->gridExprDatabase->GetCellCheck($row, 3));
    $winExtraction->tfOldExprHidden->Text($winExtraction->gridExprDatabase->GetCellText($row, 4));
    $winExtraction->tfExtractExpr->Text($winExtraction->gridExprDatabase->GetCellText($row, 4));
    $winExtraction->tfExtractComment->Text($winExtraction->gridExprDatabase->GetCellText($row, 5));
    $winExtraction->TabExtractType->SetCurSel(0);
    &TabExtractType_Change();
  }
  return(1);

}  #--- End exprDBEdit_Click

#--------------------------#
sub exprDBDelete_Click
#--------------------------#
{
  # Local variables
  my (@coord)    = $winExtraction->gridExprDatabase->GetSelectedCellRange();
  my $nbrEntries = $winExtraction->gridExprDatabase->GetRows();
  my $exprDBFile = $winConfig->tfExprDB->Text();
  my @Entries2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winExtraction->gridExprDatabase->IsCellSelected($row, 4)) {
      my $exprEntry = $winExtraction->gridExprDatabase->GetCellText($row, 4);
      push(@Entries2del, $exprEntry);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winExtraction->gridExprDatabase->Refresh();
      # Status bar
      &winPb_Terminate;
      $winExtraction->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrEntries2del = @Entries2del;
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winExtraction);
    $winPb->Show();
    $winExtraction->Disable();
    $winExtraction->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$exprDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $exprEntry2del (@Entries2del) {
      for (my $i = 0; $i < $nbrEntries; $i++) {
        my $exprEntry = $winExtraction->gridExprDatabase->GetCellText($i, 4);
        if ($exprEntry eq $exprEntry2del) {
          # Delete entry in DB
          # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
          my $sth = $dbh->prepare('DELETE from EXPR_DB where expr == ?');
          my $rv = $sth->execute($exprEntry);
          if ($rv < 0) { Win32::GUI::MessageBox($winExtraction, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = $i; $k < $winExtraction->gridExprDatabase->GetRows(); $k++) {
              my $currEntryExpr = $winExtraction->gridExprDatabase->GetCellText($k, 4);
              if ($exprEntry eq $currEntryExpr) {
                $winExtraction->gridExprDatabase->DeleteRow($k);
                last;
              }
            }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2del");
      $winPb->pbWinPb->StepIt();
    }
    $winExtraction->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    $winExtraction->gridExprDatabase->Refresh();
  });
  return(1);

}  #--- End exprDBDelete_Click

#--------------------------#
sub isExtractReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $type    = $winExtraction->TabExtractType->SelectedItem();
  # Possible values are: 0 = newExtractExpr, 1 = Expression history, 2 = Expression database
  my $nextStep;
  # Expression
  if (!$type) {
    my $expr = $winExtraction->tfExtractExpr->Text();
    if ($expr) {
      # Add or Edit
      if ($winExtraction->tfOldExprHidden->Text()) {
        $winExtraction->btnExtractExprAddDB->Hide();
        $winExtraction->btnExtractExprSaveDB->Show();
      } else {
        $winExtraction->btnExtractExprAddDB->Show();
        $winExtraction->btnExtractExprAddDB->Enable();
        $winExtraction->btnExtractExprSaveDB->Hide();
      }
      if ($winExtraction->chExtractExprRegex->Checked()) {
        my ($statusRegex, $msg);
        my $nbrLines = $winExtraction->tfExtractExpr->GetLineCount();
        if ($nbrLines == 1) { ($statusRegex, $msg) = &validRegex($expr); }
        else {
          my $i = 0;
          while ($i <= $nbrLines) {
            if (my $line = $winExtraction->tfExtractExpr->GetLine($i)) {
              ($statusRegex, $msg) = &validRegex($line);
              last if $statusRegex == 1;
            }
            $i++;
          }
        }
        # Warning
        if      ($statusRegex == 2) {
          $winExtraction->lblExtractExprWarn->Show();
          $winExtraction->lblExtractExprOk->Hide();
          $winExtraction->lblExtractExprErr->Hide();
        # Error
        } elsif ($statusRegex == 1) {
          $winExtraction->lblExtractExprErr->Show();
          $winExtraction->lblExtractExprOk->Hide();
          $winExtraction->lblExtractExprWarn->Hide();
          $nextStep = $STR{'errRegex'};
        # Ok
        } else {
          $winExtraction->lblExtractExprOk->Show();
          $winExtraction->lblExtractExprErr->Hide();
          $winExtraction->lblExtractExprWarn->Hide();
        }
      } else {
        $winExtraction->lblExtractExprOk->Hide();
        $winExtraction->lblExtractExprErr->Hide();
        $winExtraction->lblExtractExprWarn->Hide();
      }
    } else {
      $winExtraction->btnExtractExprAddDB->Disable();
      $winExtraction->lblExtractExprOk->Hide();
      $winExtraction->lblExtractExprErr->Hide();
      $winExtraction->lblExtractExprWarn->Hide();
      $nextStep = $STR{'setContains'};
    }
  }
  # Return an error message or enable the button
  if ($nextStep) {
    $winExtraction->btnExtractOk->Disable();
    $winExtraction->btnExtractNotReady->Enable();
    Win32::GUI::MessageBox($winExtraction, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winExtraction->btnExtractOk->Enable();
    $winExtraction->btnExtractNotReady->Disable();
  }
  
}  #--- End isExtractReady

#--------------------------#
sub btnExtractNotReady_Click { &isExtractReady(1); }
#--------------------------#

#--------------------------#
sub btnExtractCancel_Click { &winExtraction_Terminate(); }
#--------------------------#

#--------------------------#
sub winExtraction_Terminate
#--------------------------#
{
  $winExtraction->tfOldExprHidden->Text('');
  $winExtraction->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winExtraction_Terminate

#--------------------------#
sub btnExtractOk_Click
#--------------------------#
{
  # Close Extract window
  &winExtraction_Terminate();
  # Local variables
  my $editRow  = $winExtraction->lblExtractEditRow->Text();
  my $operator = 0;
  my $type     = $winExtraction->TabExtractType->SelectedItem();
  my $index    = 0;
  $operator    = $winExtraction->cbExtractOp->GetString($winExtraction->cbExtractOp->GetCurSel());
  my %expressions;
  # Expression
  if (!$type) {
    my $case    = $winExtraction->chExtractExprCase->Checked();
    my $regex   = $winExtraction->chExtractExprRegex->Checked();
    my $invert  = $winExtraction->chExtractExprInvert->Checked();
    my $comment = $winExtraction->tfExtractComment->Text();
    for ($index = 0; $index <= $winExtraction->tfExtractExpr->GetLineCount(); $index++) {
      if ($winExtraction->tfExtractExpr->GetLine($index)) {
        if    (!$index  ) { $expressions{$index}{operator} = '-';        }
        elsif ($operator) { $expressions{$index}{operator} = $operator;  }
        else              { $expressions{$index}{operator} = $STR{'OR'}; }
        $expressions{$index}{case}    = $case;
        $expressions{$index}{regex}   = $regex;
        $expressions{$index}{invert}  = $invert;
        $expressions{$index}{expr}    = $winExtraction->tfExtractExpr->GetLine($index);
        $expressions{$index}{comment} = $comment;
      }
    }
  # Expression history
  } elsif ($type == 1) {
    my (@coord) = $winExtraction->gridExprHistory->GetSelectedCellRange();
    my $lastSelectedRow; 
    if ($coord[2]) { $lastSelectedRow = $coord[2]; }
    else           { $lastSelectedRow = $coord[0]; }
    for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
      if ($winExtraction->gridExprHistory->IsCellSelected($row, 4)) {
        if    (!$index  ) { $expressions{$index}{operator} = '-';        }
        elsif ($operator) { $expressions{$index}{operator} = $operator;  }
        else              { $expressions{$index}{operator} = $STR{'OR'}; }
        $expressions{$index}{case}    = $winExtraction->gridExprHistory->GetCellCheck($row, 1);
        $expressions{$index}{regex}   = $winExtraction->gridExprHistory->GetCellCheck($row, 2);
        $expressions{$index}{invert}  = $winExtraction->gridExprHistory->GetCellCheck($row, 3);
        $expressions{$index}{expr}    = $winExtraction->gridExprHistory->GetCellText($row, 4);
        $expressions{$index}{comment} = $winExtraction->gridExprHistory->GetCellText($row, 5);
        $index++;
      }
    }
  # Expression database
  } elsif ($type == 2) {
    my (@coord) = $winExtraction->gridExprDatabase->GetSelectedCellRange();
    my $lastSelectedRow; 
    if ($coord[2]) { $lastSelectedRow = $coord[2]; }
    else           { $lastSelectedRow = $coord[0]; }
    for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
      if ($winExtraction->gridExprDatabase->IsCellSelected($row, 4)) {
        if    (!$index  ) { $expressions{$index}{operator} = '-';        }
        elsif ($operator) { $expressions{$index}{operator} = $operator;  }
        else              { $expressions{$index}{operator} = $STR{'OR'}; }
        $expressions{$index}{case}    = $winExtraction->gridExprDatabase->GetCellCheck($row, 1);
        $expressions{$index}{regex}   = $winExtraction->gridExprDatabase->GetCellCheck($row, 2);
        $expressions{$index}{invert}  = $winExtraction->gridExprDatabase->GetCellCheck($row, 3);
        $expressions{$index}{expr}    = $winExtraction->gridExprDatabase->GetCellText($row, 4);
        $expressions{$index}{comment} = $winExtraction->gridExprDatabase->GetCellText($row, 5);
        $index++;
      }
    }
  }
  # Feed the grid
  if ($index) {
    my $row;
    for (my $i = 0; $i <= $index; $i++) {
      if ($expressions{$i}{expr}) {
        if ($editRow) { $row = $editRow++; } # Edit mode
        else          { $row = $win->gridExtraction->InsertRow('-', -1); }
        $win->gridExtraction->SetCellText($row, 0, $expressions{$i}{operator});
        $win->gridExtraction->SetCellEditable($row, 0, 1);
        $win->gridExtraction->SetCellType($row, 0, 6);
        $win->gridExtraction->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
        $win->gridExtraction->SetCellType($row, 1, 4);
        $win->gridExtraction->SetCellType($row, 2, 4);
        $win->gridExtraction->SetCellType($row, 3, 4);
        if ($expressions{$i}{case})   { $win->gridExtraction->SetCellCheck($row, 1, 1);  }
        else                          { $win->gridExtraction->SetCellCheck($row, 1, 0);  }
        if ($expressions{$i}{regex})  { $win->gridExtraction->SetCellCheck($row, 2, 1);  }
        else                          { $win->gridExtraction->SetCellCheck($row, 2, 0);  }
        if ($expressions{$i}{invert}) { $win->gridExtraction->SetCellCheck($row, 3, 1);  }
        else                          { $win->gridExtraction->SetCellCheck($row, 3, 0);  }
        $win->gridExtraction->SetCellText($row, 4, $expressions{$i}{expr});
        $win->gridExtraction->SetCellText($row, 5, $expressions{$i}{comment}) if $expressions{$i}{'comment'};
        $win->gridExtraction->SetCellEditable($row, 1, 1);
        $win->gridExtraction->SetCellEditable($row, 2, 1);
        $win->gridExtraction->SetCellEditable($row, 3, 1);
        $win->gridExtraction->SetCellEditable($row, 4, 1);
        $win->gridExtraction->SetCellEditable($row, 5, 1);
      }
    }
  }
  $win->gridExtraction->AutoSizeColumns();
  $win->gridExtraction->ExpandLastColumn();
  $win->gridExtraction->Refresh();
  $win->btnExtractDel->Enable();
  $win->btnExtractSave->Enable();
  &isProcessReady(0);

}  #--- End btnExtractOk_Click
  
#--------------------------#
sub btnExtractDel_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $win->gridExtraction->GetSelectedCellRange();
  my $firstSelectedRow;
  my $lastSelectedRow;
  if    ($coord[2]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[2]; }
  elsif ($coord[0]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[0]; }
  else {
    $firstSelectedRow = $win->gridExtraction->GetRows()-1;
    $lastSelectedRow  = $win->gridExtraction->GetRows()-1;
  }
  # Delete selected row
  for (my $row = $lastSelectedRow; $row >= $firstSelectedRow; $row--) {
    $win->gridExtraction->DeleteRow($row);
  }
  # Reset first line operator
  if ($win->gridExtraction->GetCellText(1, 0) ne '-') {
    $win->gridExtraction->SetCellText(1, 0, '-');
    $win->gridExtraction->SetCellEditable(1, 0, 0);
  }
  # Disable buttons ?
  if      ($win->gridExtraction->GetRows() == 1) {
    $win->btnExtractDel->Disable();
    $win->btnExtractSave->Disable();
  } elsif ($win->gridExtraction->GetRows() == 2) {
    $win->btnUpGrid->Disable();
    $win->btnDownGrid->Disable();
  }
  $win->gridExtraction->AutoSizeColumns();
  $win->gridExtraction->ExpandLastColumn();
  $win->gridExtraction->Refresh();
  &isProcessReady(0);

}  #--- End btnExtractDel_Click

#--------------------------#
sub btnExtractImport_Click
#--------------------------#
{
  # Local variables
  my $dir;
  if (-d "$USERDIR\\Expressions") { $dir = "$USERDIR\\Expressions"; }
  else                            { $dir = $USERDIR;                }
  # Select the json file
  my $file = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                          -title         => $STR{'selFile'}.':'        ,
                                          -filter        => ['JSON (*.json)', '*.json'],
                                          -filemustexist => 1                          ,
                                          -directory     => $dir                       ,
                                          -explorer      => 1                          , );
  if ($file and -T $file) {
    if (open(my $json, $file)) {
      my $jsonText = <$json>;
      close($json);
      my $jsonObj = JSON->new;
      my $refExpr = $jsonObj->decode($jsonText);
      $win->gridExtraction->DeleteNonFixedRows(); # Reset grid
      foreach my $row (sort {$a <=> $b} keys %{$refExpr}) {
        # Feed the grid
        if ($$refExpr{$row}{expr} and my $newLine = $win->gridExtraction->InsertRow('-', -1)) {
          $win->gridExtraction->SetCellText($newLine, 0, $$refExpr{$row}{operator});
          $win->gridExtraction->SetCellEditable($newLine, 0, 1);
          $win->gridExtraction->SetCellType($newLine, 0, 6);
          $win->gridExtraction->SetCellOptions($newLine, 0, [$STR{'OR'}, $STR{'AND'}]);
          $win->gridExtraction->SetCellType($newLine, 1, 4);
          $win->gridExtraction->SetCellType($newLine, 2, 4);
          $win->gridExtraction->SetCellType($newLine, 3, 4);
          if ($$refExpr{$row}{case})   { $win->gridExtraction->SetCellCheck($newLine, 1, 1);  }
          else                         { $win->gridExtraction->SetCellCheck($newLine, 1, 0);  }
          if ($$refExpr{$row}{regex})  { $win->gridExtraction->SetCellCheck($newLine, 2, 1);  }
          else                         { $win->gridExtraction->SetCellCheck($newLine, 2, 0);  }
          if ($$refExpr{$row}{invert}) { $win->gridExtraction->SetCellCheck($newLine, 3, 1);  }
          else                         { $win->gridExtraction->SetCellCheck($newLine, 3, 0);  }
          $win->gridExtraction->SetCellText($newLine, 4, $$refExpr{$row}{expr});
          $win->gridExtraction->SetCellText($newLine, 5, $$refExpr{$row}{comment}) if $$refExpr{$row}{comment};
          $win->gridExtraction->SetCellEditable($newLine, 1, 1);
          $win->gridExtraction->SetCellEditable($newLine, 2, 1);
          $win->gridExtraction->SetCellEditable($newLine, 3, 1);
          $win->gridExtraction->SetCellEditable($newLine, 4, 1);
          $win->gridExtraction->SetCellEditable($newLine, 5, 1);
        }
      }
      if ($win->gridExtraction->GetRows() > 1) {
        $win->gridExtraction->AutoSizeColumns();
        $win->gridExtraction->ExpandLastColumn();
        $win->gridExtraction->Refresh();
        $win->btnExtractDel->Enable();
        $win->btnExtractSave->Enable();
      }
    } else { Win32::GUI::MessageBox($win, "$STR{'errorOpening'} $file", $STR{'errorOpening'}, 0x40010); }
  }
  &isProcessReady(0);
  
}  #--- End btnExtractImport_Click

#--------------------------#
sub btnExtractSave_Click
#--------------------------#
{
  # Create the directory for Expressions files (json)
  if (!-d "$USERDIR\\Expressions") { mkdir("$USERDIR\\Expressions"); }
  # Show SaveFileWindow for database
  my $file = Win32::GUI::GetSaveFileName( -owner            => $win                       ,
                                          -title            => $STR{'selFile'}.':'        ,
                                          -filter           => ['JSON (*.json)', '*.json'],
                                          -directory        => "$USERDIR\\Expressions"    ,
                                          -overwriteprompt  => 1                          , );
  if ($file) {
    $file .= '.json' if $file !~ /\.json$/;
    # Gather all filters
    my %expressions;
    for (my $row = 1; $row <= $win->gridExtraction->GetRows(); $row++) {
      $expressions{$row}{operator} = $win->gridExtraction->GetCellText( $row, 0);
      $expressions{$row}{case}     = $win->gridExtraction->GetCellCheck($row, 1);
      $expressions{$row}{regex}    = $win->gridExtraction->GetCellCheck($row, 2);
      $expressions{$row}{invert}   = $win->gridExtraction->GetCellCheck($row, 3);
      $expressions{$row}{expr}     = $win->gridExtraction->GetCellText( $row, 4);
      $expressions{$row}{comment}  = $win->gridExtraction->GetCellText( $row, 5);
    }
    # Create or update JSON
    my $jsonObj = JSON->new;
    my $jsonText = $jsonObj->encode(\%expressions);
    if (open(my $json, '>:encoding(cp1252)', $file)) {
      print $json $jsonText;
      close($json);
    } else { Win32::GUI::MessageBox($win, "$STR{'errorWriting'} $file", $STR{'errorWriting'}, 0x40010); }
  }
  
}  #--- End btnExtractSave_Click

#--------------------------#
sub btnExtractOpt_Click
#--------------------------#
{
  &createWinExprOpt() if !$winExprOpt;
  $winExprOpt->Center($win);
  $winExprOpt->Show();
  $win->Disable();

}  #--- End btnExtractOpt_Click

#--------------------------#
sub createWinExprOpt
#--------------------------#
{
  # Expression Extraction options window
  $winExprOpt = Win32::GUI::Window->new(-name        => 'winExprOpt'           ,
                                        -background  => [255, 255, 255]        ,
                                        -parent      => $win                   ,
                                        -text        => $STR{'winExprOpt'}     ,
                                        -pos         => [$winPosX, $winPosY]   ,
                                        -size        => [600, 230]             ,
                                        -hasmaximize => 0                      ,
                                        -hasminimize => 0                      ,
                                        -resizable   => 0                      ,
                                        -dialogui    => 1                      , );
  $winExprOpt->SetIcon($winICO);
  $winExprOpt->AddLabel(      -name         => 'lblLogo'               ,
                              -size         => [128,128]               ,
                              -pos          => [  5,  5]               ,
                              -bitmap       => $options128             ,
                              -background   => [255, 255, 255]         , );
  # Search options
  $winExprOpt->AddLabel(      -name         => 'lblExprOptShadowT'     ,
                              -size         => [200, 22]               ,
                              -pos          => [151,  6]               ,
                              -foreground   => [180, 180, 180]         ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'winExprOpt'}.':'  ,
                              -font         => $fontGB2                , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptT'           ,
                              -size         => [200, 22]               ,
                              -pos          => [150,  5]               ,
                              -addstyle     => 11                      , # Transparent
                              -foreground   => [ 50, 180,  0]          ,
                              -text         => $STR{'winExprOpt'}.':'  ,
                              -font         => $fontGB2                , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptMode'        ,
                              -size         => [120, 22]               ,
                              -pos          => [150, 38]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'Mode'}.':'        ,
                              -font         => $font10u                , );
  $winExprOpt->AddRadioButton(-name         => 'rbExprOptSearchByLine' ,
                              -size         => [145, 22]               ,
                              -pos          => [290, 35]               ,
                              -text         => $STR{'rbExprOptSearchByLine'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -group        => 1                       ,
                              -checked      => 1                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddRadioButton(-name         => 'rbExprOptSearchByFile' ,
                              -size         => [145, 22]               ,
                              -pos          => [455, 35]               ,
                              -text         => $STR{'rbExprOptSearchByFile'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -checked      => 0                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptMaxResults'  ,
                              -size         => [130, 22]               ,
                              -pos          => [150, 68]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'MaxResults'}.':'  ,
                              -font         => $font10u                , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptMaxResFile'  ,
                              -size         => [ 70, 22]               ,
                              -pos          => [290, 68]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'lblExprOptMaxResFile'}.':',
                              -font         => $font10                 , );
  $winExprOpt->AddTextfield(  -name         => 'tfExprOptMaxResFile'   ,
                              -size         => [ 40, 22]               ,
                              -pos          => [395, 65]               ,
                              -number       => 1                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptMaxResTot'   ,
                              -size         => [ 60, 22]               ,
                              -pos          => [455, 68]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'lblExprOptMaxResTot'}.':',
                              -font         => $font10                 , );
  $winExprOpt->AddTextfield(  -name         => 'tfExprOptMaxResTot'    ,
                              -size         => [ 40, 22]               ,
                              -pos          => [515, 65]               ,
                              -number       => 1                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptIncContext'  ,
                              -size         => [130, 22]               ,
                              -pos          => [150, 98]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'lblExprOptIncContext'}.':',
                              -font         => $font10u                , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptIncContextLineBefore',
                              -size         => [100, 22]               ,
                              -pos          => [290, 98]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'lblExprOptIncContextLineBefore'}.':',
                              -font         => $font10                 , );
  $winExprOpt->AddTextfield(  -name         => 'tfExprOptIncContextLineBefore',
                              -size         => [ 40, 22]               ,
                              -pos          => [395, 95]               ,
                              -number       => 1                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptIncContextLineAfter'   ,
                              -size         => [ 55, 22]               ,
                              -pos          => [455, 98]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'After'}.':'       ,
                              -font         => $font10                 , );
  $winExprOpt->AddTextfield(  -name         => 'tfExprOptIncContextLineAfter',
                              -size         => [ 40, 22]               ,
                              -pos          => [515, 95]               ,
                              -number       => 1                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddLabel(      -name         => 'lblExprOptNoDuplicate' ,
                              -size         => [130, 22]               ,
                              -pos          => [150,128]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'chExprOptNoDuplicate'}.':',
                              -font         => $font10u                , );
  $winExprOpt->AddCheckbox(   -name         => 'chExprOptNoDuplicate'  ,
                              -size         => [ 22, 22]               ,
                              -pos          => [290,126]               ,
                              -background   => [255, 255, 255]         ,
                              -checked      => 0                       ,
                              -tabstop      => 1                       , );
  $winExprOpt->AddButton(     -name         => 'btnExprOptOk'          ,
                              -size         => [ 80, 30]               ,
                              -pos          => [285,160]               ,
                              -text         => $STR{'Ok'}              ,
                              -font         => $font10                 , );

}  #--- End createWinExprOpt

#--------------------------#
sub rbExprOptSearchByLine_Click
#--------------------------#
{
  # Enable other controls
  $winExprOpt->lblExprOptMaxResFile->Enable();
  $winExprOpt->tfExprOptMaxResFile->Enable();
  $winExprOpt->lblExprOptMaxResTot->Enable();
  $winExprOpt->tfExprOptMaxResTot->Enable();
  $winExprOpt->lblExprOptIncContext->Enable();
  $winExprOpt->lblExprOptIncContextLineBefore->Enable();
  $winExprOpt->tfExprOptIncContextLineBefore->Enable();
  $winExprOpt->lblExprOptIncContextLineAfter->Enable();
  $winExprOpt->tfExprOptIncContextLineAfter->Enable();
  $winExprOpt->lblExprOptNoDuplicate->Enable();
  $winExprOpt->chExprOptNoDuplicate->Enable();
  
}  #--- End rbExprOptSearchByLine_Click

#--------------------------#
sub rbExprOptSearchByFile_Click
#--------------------------#
{
  # Disable other controls
  $winExprOpt->lblExprOptMaxResFile->Disable();
  $winExprOpt->tfExprOptMaxResFile->Disable();
  $winExprOpt->lblExprOptMaxResTot->Disable();
  $winExprOpt->tfExprOptMaxResTot->Disable();
  $winExprOpt->lblExprOptIncContext->Disable();
  $winExprOpt->lblExprOptIncContextLineBefore->Disable();
  $winExprOpt->tfExprOptIncContextLineBefore->Disable();
  $winExprOpt->lblExprOptIncContextLineAfter->Disable();
  $winExprOpt->tfExprOptIncContextLineAfter->Disable();
  $winExprOpt->lblExprOptNoDuplicate->Disable();
  $winExprOpt->chExprOptNoDuplicate->Disable();
  
}  #--- End rbExprOptSearchByFile_Click

#--------------------------#
sub btnExprOptOk_Click { &winExprOpt_Terminate(); }
#--------------------------#

#--------------------------#
sub winExprOpt_Terminate
#--------------------------#
{
  $winExprOpt->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winExprOpt_Terminate

#--------------------------#
sub btnExtractOpenRes_Click
#--------------------------#
{
  # Local variables
  my $dir = $winReport->tfReportDir->Text();
  my $resFile;
  # Select the json file
  if ($dir) {
    $resFile = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                            -title         => $STR{'selFile'}.':'        ,
                                            -filter        => ['JSON (*.json)', '*.json'],
                                            -filemustexist => 1                          ,
                                            -directory     => $dir                       ,
                                            -explorer      => 1                          , );
  } else {
    $resFile = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                            -title         => $STR{'selFile'}.':'        ,
                                            -filter        => ['JSON (*.json)', '*.json'],
                                            -filemustexist => 1                          ,
                                            -explorer      => 1                          , );
  }
  # Validate the file and launch the process
  if ($resFile and -T $resFile) {
    if (open(my $json, $resFile)) {
      my $jsonText = <$json>;
      close($json);
      if ($jsonText =~ /"byFile":/ and ($jsonText =~ /"byExpr":/ or $jsonText =~ /"bySO":/)) {
        # Open Extraction Results
        my $procID  = time;
        my $command = 'XL-Parser-process ' . "Extract-Results $procID \"$PROGDIR\" \"$resFile\" \"$USERDIR\"";
        Win32::Process::Create(my $processObj, $PROGDIR .'\XL-Parser-process.exe', $command, 0, NORMAL_PRIORITY_CLASS, $PROGDIR);
      } else { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }
  return(1);
  
}  #--- End btnExtractOpenRes_Click

#--------------------------#
sub btnExtractRefresh_Click
#--------------------------#
{
  my $reportDir = $winReport->tfReportDir->Text();
  unlink("$reportDir\\CurrentListFiles.json") if $reportDir and -f "$reportDir\\CurrentListFiles.json";
  $win->btnExtractRefresh->Disable();
  
}  #--- End btnExtractRefresh_Click

#--------------------------#
sub tvSO_Click
#--------------------------#
{
  # This function simulates a "Oncheck" event, but checkbox status is updated when the function return
  # So if the user checks the box, the status will be uncheck when calling this function
  
  # Local variables
  my ($X, $Y)      = Win32::GUI::GetCursorPos();
  $X              -= $win->tvSO->AbsLeft();
  $Y              -= $win->tvSO->AbsTop();
  my $clickedNode  = $win->tvSO->HitTest($X, $Y);
  my $checkState   = 0;
  # Third level, these options required Nslookup
  if ($X >= 64 and $X <= 75 and $clickedNode) {
    my $checked = $win->tvSO->ItemCheck($clickedNode);
    # Check parents
    if (!$checked and my $parentNode = $win->tvSO->GetParent($clickedNode)) {
      $checkState = 1;
      $win->tvSO->ItemCheck($parentNode, 1);
      if ($parentNode = $win->tvSO->GetParent($parentNode)) {
        if (!$win->tvSO->ItemCheck($parentNode)) {
          $win->tvSO->ItemCheck($parentNode, 1);
          Win32::GUI::MessageBox($win, $STR{'warnLookup'}, $STR{'warning'}, 0x40030);
        }
      }
    }
  # Second level
  } elsif ($X >= 44 and $X <= 56 and $clickedNode) {
    my $checked = $win->tvSO->ItemCheck($clickedNode);
    if (!$checked and my $parentNode = $win->tvSO->GetParent($clickedNode)) {
      $checkState = 1;
      my %item    = $win->tvSO->GetItem($clickedNode);
      Win32::GUI::MessageBox($win, $STR{'warnLookup'}, $STR{'warning'}, 0x40030) if $item{-text} eq $STR{'SO_NSLookup'};
      # Check parent
      $win->tvSO->ItemCheck($parentNode, 1) if !$win->tvSO->ItemCheck($parentNode);
    # Uncheck child, if so
    } elsif (my $childNode = $win->tvSO->GetChild($clickedNode)) { $win->tvSO->ItemCheck($childNode, 0); }
  # First level
  } elsif ($X >= 25 and $X <= 37 and $clickedNode) {
    my $checked = $win->tvSO->ItemCheck($clickedNode);
    # It's a parent, if unchecked, unchek all childs
    if ($checked and my $childNode = $win->tvSO->GetChild($clickedNode)) {
      $win->tvSO->ItemCheck($childNode, 0);
      while ($childNode = $win->tvSO->GetNextSibling($childNode)) {
        $win->tvSO->ItemCheck($childNode, 0);
        if (my $subChildNode = $win->tvSO->GetChild($childNode)) { $win->tvSO->ItemCheck($subChildNode, 0); }
      }
    } else { $checkState = 1; }
  }
  # Update the checking status
  if ($checkState) { $win->chSO_Status->Checked(1); }
  else {
    $checkState   = 0;
    my $firstNode = $win->tvSO->GetRoot();
    if ($firstNode) {
      $checkState++ if $win->tvSO->ItemCheck($firstNode);
      my $nextNode = $firstNode;
      while ($nextNode = $win->tvSO->GetNextSibling($nextNode)) { $checkState++ if $win->tvSO->ItemCheck($nextNode); }
      if ($checkState > 0) { $win->chSO_Status->Checked(1); }
      else                 { $win->chSO_Status->Checked(0); }
    }
  }
  $win->tvSO->BringWindowToTop();
  &isProcessReady(0);
  
}  #--- End tvSO_Click

#--------------------------#
sub LAFunctions_Click
#--------------------------#
{
  &LAFunctionsTabUpdate();
  &isProcessReady(0);
  
}  #--- End LAFunctions_Click

#--------------------------#
sub LAFunctionsTabUpdate
#--------------------------#
{
  # Filter Sets controls
  my $functionStr = $win->LAFunctions->GetString($win->LAFunctions->SelectedItem());
  # Current Database controls
  if ($functionStr eq $STR{'CurrentDatabase'}) {
    $win->gbCurrDBGeneral->Show();
    $win->lblCurrDBLastUpdate->Show();
    $win->lblCurrDBLastUpdateVal->Show();
    $win->lblCurrDBPeriod->Show();
    $win->lblCurrDBPeriodVal->Show();
    $win->lblCurrDBNbrOf->Show();
    $win->lblCurrDBNbrEntries->Show();
    $win->lblCurrDBNbrEntriesVal->Show();
    $win->lblCurrDBFiltered->Show();
    $win->lblCurrDBFilteredVal->Show();
    $win->lblCurrDBRejected->Show();
    $win->lblCurrDBRejectedVal->Show();
    $win->gbCurrDBSource->Show();
    $win->lblCurrDBLogFormat->Show();
    $win->lblCurrDBLogFormatVal->Show();
    $win->btnLACurrDBFiles->Show();
    $win->btnLACurrDBRejected->Show();
    $win->lblCurrDBFilters->Show();
    $win->tfCurrDBFiltersVal->Show();
    $win->btnLACurrDBFiltered->Show();
    $win->gbCurrDBResolved->Show();
    $win->lblCurrDBNbrResISP->Show();
    $win->lblCurrDBNbrResISPVal->Show();
    $win->lblCurrDBNbrResGeoIP->Show();
    $win->lblCurrDBNbrResGeoIPVal->Show();
    $win->lblCurrDBResUAs->Show();
    $win->lblCurrDBResUAsVal->Show();
    $win->lblCurrDBResWDs->Show();
    $win->lblCurrDBResWDsVal->Show();
    my $dbFile = $win->tfInput->Text();
    if (!$win->lblCurrDBPeriodVal->Text()) {
      $win->btnLACurrDBFiles->Disable();
      if ($dbFile =~ /\.db$/ and &validLADB($dbFile)) {
        threads->create(sub {
          &updateCurrDatabaseInfos($dbFile, $winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}),
                                   \$winLACurrDBFiles, \$win, \%STR);
          $win->btnLAFilters->Enable();
        });
      }
    }
    $win->lblDestDB->Hide();
    $win->rbDestDBCurr->Hide();
    $win->rbDestDBNew->Hide();
    $win->chLASetReadOnly->Hide();
    $win->lblLAResolve->Hide();
    $win->chLAOptResISP->Hide();
    $win->chLAOptResGeoIP->Hide();
    $win->chLAOptResUA->Hide();
    $win->chLAOptResWeekday->Hide();
    $win->lblLAFilters->Hide();
    $win->btnLAFilters->Hide();
    $win->chLALogFiltered->Hide();
    $win->chLALogRejected->Hide();
    $win->chLAIgnoreComments->Hide();
    $win->lblDestLADB->Hide();
    $win->tfDestDir->Hide();
    $win->btnDestDir->Hide();
    $win->chLASelectDB->Hide();
    $win->lblLAQuerySelectShadowT->Hide();
    $win->lblLAQuerySelectT->Hide();
    $win->btnLAQuerySelectCols->Hide();    
    $win->btnLAQueryFilter->Hide();
    $win->chLAQueryGroupBy->Hide();
    $win->cbLAQueryGroupByCol->Hide();
    $win->btnLAQueryGroupByAdd->Hide();
    $win->chLAQueryOrderBy->Hide();
    $win->cbLAQueryOrderByCol->Hide();
    $win->cbLAQueryOrderBy->Hide();
    $win->btnLAQueryOrderByAdd->Hide();
    $win->chLAQueryHavingCount->Hide();
    $win->cbLAQueryHavingCountCol->Hide();
    $win->cbLAQueryHavingCount->Hide();
    $win->tfLAQueryHavingCount->Hide();
    $win->btnLAQueryHavingCountAdd->Hide();
    $win->lblLAQueryShadowT->Hide();
    $win->lblLAQueryT->Hide();
    $win->btnLAQuerySelectSaved->Hide();
    $win->btnLAQueryEdit->Hide();
    $win->btnLAQuerySave->Hide();
    $win->btnLAQueryReset->Hide();
    $win->tfLAQuery->Hide();
    $win->lblLAQueryOk->Hide();
    $win->lblLAQueryErr->Hide();
    $win->lblLAQueryOutputShadowT->Hide();
    $win->lblLAQueryOutputT->Hide();
    $win->btnLAQueryReportOpt->Hide();
    $win->lblLASearchOptShadowT->Hide();
    $win->lblLASearchOptT->Hide();
    $win->btnLASearchReportOpt->Hide();
    $win->lblLASearchSAMaxRes->Hide();
    $win->tfLASearchSAMaxRes->Hide();
    $win->btnLASearchSaveOptions->Hide();
    $win->btnLASearchOpenResults->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndT->Hide();
    $win->btnLASearchReset->Hide();
    $win->gridLASearchSAInd->Hide();
  # Update Database controls
  } elsif ($functionStr eq $STR{'updateDB'}) {
    $win->lblDestDB->Show();
    $win->rbDestDBCurr->Show();
    $win->rbDestDBNew->Show();
    $win->lblLAResolve->Show();
    $win->chLAOptResISP->Show();
    $win->chLAOptResGeoIP->Show();
    $win->chLAOptResUA->Show();
    $win->chLAOptResWeekday->Show();
    $win->lblLAFilters->Show();
    $win->btnLAFilters->Show();
    # Create a new database
    if ($win->rbDestDBNew->Checked()) {
      $win->lblDestLADB->Show();
      $win->tfDestDir->Show();
      $win->btnDestDir->Show();
      $win->chLASelectDB->Show();
    # Update current database
    } else {
      $win->lblDestLADB->Hide();
      $win->tfDestDir->Hide();
      $win->btnDestDir->Hide();
      $win->chLASelectDB->Hide();
    }
    &uncheckAllFilterSets(\$winLAFilters) if $winLAFilters;
    $win->gbCurrDBGeneral->Hide();
    $win->lblCurrDBLastUpdate->Hide();
    $win->lblCurrDBLastUpdateVal->Hide();
    $win->lblCurrDBPeriod->Hide();
    $win->lblCurrDBPeriodVal->Hide();
    $win->lblCurrDBNbrOf->Hide();
    $win->lblCurrDBNbrEntries->Hide();
    $win->lblCurrDBNbrEntriesVal->Hide();
    $win->lblCurrDBFiltered->Hide();
    $win->lblCurrDBFilteredVal->Hide();
    $win->lblCurrDBRejected->Hide();
    $win->lblCurrDBRejectedVal->Hide();
    $win->gbCurrDBSource->Hide();
    $win->lblCurrDBLogFormat->Hide();
    $win->lblCurrDBLogFormatVal->Hide();
    $win->btnLACurrDBFiles->Hide();
    $win->lblCurrDBFilters->Hide();
    $win->tfCurrDBFiltersVal->Hide();
    $win->btnLACurrDBFiltered->Hide();
    $win->btnLACurrDBRejected->Hide();
    $win->gbCurrDBResolved->Hide();
    $win->lblCurrDBNbrResISP->Hide();
    $win->lblCurrDBNbrResISPVal->Hide();
    $win->lblCurrDBNbrResGeoIP->Hide();
    $win->lblCurrDBNbrResGeoIPVal->Hide();
    $win->lblCurrDBResUAs->Hide();
    $win->lblCurrDBResUAsVal->Hide();
    $win->lblCurrDBResWDs->Hide();
    $win->lblCurrDBResWDsVal->Hide();
    $win->lblLAQuerySelectShadowT->Hide();
    $win->lblLAQuerySelectT->Hide();
    $win->btnLAQuerySelectCols->Hide();
    $win->btnLAQueryFilter->Hide();
    $win->chLAQueryGroupBy->Hide();
    $win->cbLAQueryGroupByCol->Hide();
    $win->btnLAQueryGroupByAdd->Hide();
    $win->chLAQueryOrderBy->Hide();
    $win->cbLAQueryOrderByCol->Hide();
    $win->cbLAQueryOrderBy->Hide();
    $win->btnLAQueryOrderByAdd->Hide();
    $win->chLAQueryHavingCount->Hide();
    $win->cbLAQueryHavingCountCol->Hide();
    $win->cbLAQueryHavingCount->Hide();
    $win->tfLAQueryHavingCount->Hide();
    $win->btnLAQueryHavingCountAdd->Hide();
    $win->lblLAQueryShadowT->Hide();
    $win->lblLAQueryT->Hide();
    $win->btnLAQuerySelectSaved->Hide();
    $win->btnLAQueryEdit->Hide();
    $win->btnLAQuerySave->Hide();
    $win->btnLAQueryReset->Hide();
    $win->tfLAQuery->Hide();
    $win->lblLAQueryOk->Hide();
    $win->lblLAQueryErr->Hide();
    $win->lblLAQueryOutputShadowT->Hide();
    $win->lblLAQueryOutputT->Hide();
    $win->btnLAQueryReportOpt->Hide();
    $win->lblLASearchOptShadowT->Hide();
    $win->lblLASearchOptT->Hide();
    $win->btnLASearchReportOpt->Hide();
    $win->lblLASearchSAMaxRes->Hide();
    $win->tfLASearchSAMaxRes->Hide();
    $win->btnLASearchSaveOptions->Hide();
    $win->btnLASearchOpenResults->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndT->Hide();
    $win->btnLASearchReset->Hide();
    $win->gridLASearchSAInd->Hide();
  # Query
  } elsif ($functionStr eq $STR{'QueryDB'}) {
    $win->lblLAQuerySelectShadowT->Show();
    $win->lblLAQuerySelectT->Show();
    $win->btnLAQuerySelectCols->Left(90);
    $win->btnLAQuerySelectCols->Show();
    $win->btnLAQueryFilter->Show();
    $win->chLAQueryGroupBy->Show();
    $win->cbLAQueryGroupByCol->Show();
    $win->btnLAQueryGroupByAdd->Show();
    $win->chLAQueryOrderBy->Show();
    $win->cbLAQueryOrderByCol->Show();
    $win->cbLAQueryOrderBy->Show();
    $win->btnLAQueryOrderByAdd->Show();
    $win->chLAQueryHavingCount->Show();
    $win->cbLAQueryHavingCountCol->Show();
    $win->cbLAQueryHavingCount->Show();
    $win->tfLAQueryHavingCount->Show();
    $win->btnLAQueryHavingCountAdd->Show();
    $win->lblLAQueryShadowT->Show();
    $win->lblLAQueryT->Show();
    $win->btnLAQuerySelectSaved->Show();
    $win->btnLAQueryEdit->Show();
    $win->btnLAQuerySave->Show();
    $win->btnLAQueryReset->Show();
    $win->tfLAQuery->Show();
    $win->lblLAQueryOutputShadowT->Show();
    $win->lblLAQueryOutputT->Show();
    $win->btnLAQueryReportOpt->Show();
    # Reset Select Columns Window
    if ($winLAQueryCols) {
      $winLAQueryCols->chLAQueryColsDistinct->Checked(0);
      $winLAQueryCols->rbLAQueryColsAll->Checked(1);
      $winLAQueryCols->rbLAQueryColsSel->Checked(0);
      $winLAQueryCols->chLAQueryColsAllCount->Checked(0);
      for (my $i = 1; $i < 12; $i++) {
        $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 0, 0);
        $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 1, 0);
      }
    }
    &uncheckAllFilterSets(\$winLAFilters) if $winLAFilters;
    $win->lblDestDB->Hide();
    $win->rbDestDBCurr->Hide();
    $win->rbDestDBNew->Hide();
    $win->chLASetReadOnly->Hide();
    $win->lblLAResolve->Hide();
    $win->chLAOptResISP->Hide();
    $win->chLAOptResGeoIP->Hide();
    $win->chLAOptResUA->Hide();
    $win->chLAOptResWeekday->Hide();
    $win->lblLAFilters->Hide();
    $win->btnLAFilters->Hide();
    $win->chLALogFiltered->Hide();
    $win->chLALogRejected->Hide();
    $win->chLAIgnoreComments->Hide();
    $win->lblDestLADB->Hide();
    $win->tfDestDir->Hide();
    $win->btnDestDir->Hide();
    $win->chLASelectDB->Hide();
    $win->gbCurrDBGeneral->Hide();
    $win->lblCurrDBLastUpdate->Hide();
    $win->lblCurrDBLastUpdateVal->Hide();
    $win->lblCurrDBPeriod->Hide();
    $win->lblCurrDBPeriodVal->Hide();
    $win->lblCurrDBNbrOf->Hide();
    $win->lblCurrDBNbrEntries->Hide();
    $win->lblCurrDBNbrEntriesVal->Hide();
    $win->lblCurrDBFiltered->Hide();
    $win->lblCurrDBFilteredVal->Hide();
    $win->lblCurrDBRejected->Hide();
    $win->lblCurrDBRejectedVal->Hide();
    $win->gbCurrDBSource->Hide();
    $win->lblCurrDBLogFormat->Hide();
    $win->lblCurrDBLogFormatVal->Hide();
    $win->btnLACurrDBFiles->Hide();
    $win->lblCurrDBFilters->Hide();
    $win->tfCurrDBFiltersVal->Hide();
    $win->btnLACurrDBFiltered->Hide();
    $win->btnLACurrDBRejected->Hide();
    $win->gbCurrDBResolved->Hide();
    $win->lblCurrDBNbrResISP->Hide();
    $win->lblCurrDBNbrResISPVal->Hide();
    $win->lblCurrDBNbrResGeoIP->Hide();
    $win->lblCurrDBNbrResGeoIPVal->Hide();
    $win->lblCurrDBResUAs->Hide();
    $win->lblCurrDBResUAsVal->Hide();
    $win->lblCurrDBResWDs->Hide();
    $win->lblCurrDBResWDsVal->Hide();
    $win->lblLASearchOptShadowT->Hide();
    $win->lblLASearchOptT->Hide();
    $win->btnLASearchReportOpt->Hide();
    $win->lblLASearchSAMaxRes->Hide();
    $win->tfLASearchSAMaxRes->Hide();
    $win->btnLASearchSaveOptions->Hide();
    $win->btnLASearchOpenResults->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndShadowT->Hide();
    $win->lblLASearchSAIndT->Hide();
    $win->btnLASearchReset->Hide();
    $win->gridLASearchSAInd->Hide();
  # Search suspect activites
  } elsif ($functionStr eq $STR{'SearchSA'}) {
    $win->lblLASearchOptShadowT->Show();
    $win->btnLAQuerySelectCols->Left(110);
    $win->btnLAQuerySelectCols->Show();
    $win->lblLASearchOptT->Show();
    $win->btnLASearchReportOpt->Show();
    $win->lblLASearchSAMaxRes->Show();
    $win->tfLASearchSAMaxRes->Show();
    $win->btnLASearchSaveOptions->Show();
    $win->btnLASearchOpenResults->Show();
    $win->lblLASearchSAIndShadowT->Show();
    $win->lblLASearchSAIndT->Show();
    $win->btnLASearchReset->Show();
    $win->gridLASearchSAInd->Show();
    &loadSAIndGrid("$USERDIR\\SA_Indicators.json", \$win, \%STR) if $win->gridLASearchSAInd->GetRows() < 2;
    # Reset Select Columns Window
    if ($winLAQueryCols) {
      $winLAQueryCols->chLAQueryColsDistinct->Checked(0);
      $winLAQueryCols->rbLAQueryColsAll->Checked(1);
      $winLAQueryCols->rbLAQueryColsSel->Checked(0);
      $winLAQueryCols->chLAQueryColsAllCount->Checked(0);
      for (my $i = 1; $i < 12; $i++) {
        $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 0, 0);
        $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 1, 0);
      }
    }
    $winReport->cbReportFormat->SetCurSel(2);
    $winReport->chReportOptIncISP->Checked(1);
    $winReport->chReportOptIncGeoIP->Checked(1);
    $win->lblDestDB->Hide();
    $win->rbDestDBCurr->Hide();
    $win->rbDestDBNew->Hide();
    $win->chLASetReadOnly->Hide();
    $win->lblLAResolve->Hide();
    $win->chLAOptResISP->Hide();
    $win->chLAOptResGeoIP->Hide();
    $win->chLAOptResUA->Hide();
    $win->chLAOptResWeekday->Hide();
    $win->lblLAFilters->Hide();
    $win->btnLAFilters->Hide();
    $win->chLALogFiltered->Hide();
    $win->chLALogRejected->Hide();
    $win->chLAIgnoreComments->Hide();
    $win->lblDestLADB->Hide();
    $win->tfDestDir->Hide();
    $win->btnDestDir->Hide();
    $win->chLASelectDB->Hide();
    $win->gbCurrDBGeneral->Hide();
    $win->lblCurrDBLastUpdate->Hide();
    $win->lblCurrDBLastUpdateVal->Hide();
    $win->lblCurrDBPeriod->Hide();
    $win->lblCurrDBPeriodVal->Hide();
    $win->lblCurrDBNbrOf->Hide();
    $win->lblCurrDBNbrEntries->Hide();
    $win->lblCurrDBNbrEntriesVal->Hide();
    $win->lblCurrDBFiltered->Hide();
    $win->lblCurrDBFilteredVal->Hide();
    $win->lblCurrDBRejected->Hide();
    $win->lblCurrDBRejectedVal->Hide();
    $win->gbCurrDBSource->Hide();
    $win->lblCurrDBLogFormat->Hide();
    $win->lblCurrDBLogFormatVal->Hide();
    $win->btnLACurrDBFiles->Hide();
    $win->lblCurrDBFilters->Hide();
    $win->tfCurrDBFiltersVal->Hide();
    $win->btnLACurrDBFiltered->Hide();
    $win->btnLACurrDBRejected->Hide();
    $win->gbCurrDBResolved->Hide();
    $win->lblCurrDBNbrResISP->Hide();
    $win->lblCurrDBNbrResISPVal->Hide();
    $win->lblCurrDBNbrResGeoIP->Hide();
    $win->lblCurrDBNbrResGeoIPVal->Hide();
    $win->lblCurrDBResUAs->Hide();
    $win->lblCurrDBResUAsVal->Hide();
    $win->lblCurrDBResWDs->Hide();
    $win->lblCurrDBResWDsVal->Hide();
    $win->lblLAQuerySelectShadowT->Hide();
    $win->lblLAQuerySelectT->Hide();
    $win->btnLAQueryFilter->Hide();
    $win->chLAQueryGroupBy->Hide();
    $win->cbLAQueryGroupByCol->Hide();
    $win->btnLAQueryGroupByAdd->Hide();
    $win->chLAQueryOrderBy->Hide();
    $win->cbLAQueryOrderByCol->Hide();
    $win->cbLAQueryOrderBy->Hide();
    $win->btnLAQueryOrderByAdd->Hide();
    $win->chLAQueryHavingCount->Hide();
    $win->cbLAQueryHavingCountCol->Hide();
    $win->cbLAQueryHavingCount->Hide();
    $win->tfLAQueryHavingCount->Hide();
    $win->btnLAQueryHavingCountAdd->Hide();
    $win->lblLAQueryShadowT->Hide();
    $win->lblLAQueryT->Hide();
    $win->btnLAQuerySelectSaved->Hide();
    $win->btnLAQueryEdit->Hide();
    $win->btnLAQuerySave->Hide();
    $win->btnLAQueryReset->Hide();
    $win->tfLAQuery->Hide();
    $win->lblLAQueryOk->Hide();
    $win->lblLAQueryErr->Hide();
    $win->lblLAQueryOutputShadowT->Hide();
    $win->lblLAQueryOutputT->Hide();
    $win->btnLAQueryReportOpt->Hide();
  }
  
}  #--- End LAFunctionsTabUpdate

#--------------------------#
sub cbLF_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub btnWinLFDB_Click
#--------------------------#
{
  if (my $selRow = ($winLFDB->gridLF->GetSelectedCellRange())[0]) {
    $winLFDB->btnLFEdit->Enable();
    $winLFDB->btnLFDel->Enable();
  } else {
    $winLFDB->btnLFEdit->Disable();
    $winLFDB->btnLFDel->Disable();
  }
  $winLFDB->Center($win);
  $winLFDB->Show();
  $win->Disable();
  return(1);

}  #--- End btnWinLFDB_Click

#--------------------------#
sub createWinLFDB
#--------------------------#
{
  my $load = shift;
  # Log format database window
  $winLFDB = Win32::GUI::Window->new( -name        => 'winLFDB'              ,
                                      -background  => [255, 255, 255]        ,
                                      -parent      => $win                   ,
                                      -text        => $STR{'winLFDB'}        ,
                                      -pos         => [$winPosX, $winPosY]   ,
                                      -size        => [$winWidth, 300]       ,
                                      -minsize     => [$winWidth, 200]       ,
                                      -hasmaximize => 1                      ,
                                      -hasminimize => 1                      ,
                                      -resizable   => 1                      ,
                                      -dialogui    => 1                      , );
  $winLFDB->SetIcon($winICO);
  # Log Format grid
  $winLFDB->AddGrid(        -name         => 'gridLF'                ,
                            -size         => [880,180]               ,
                            -pos          => [  5,  5]               ,
                            -background   => [255, 255, 255]         ,
                            -columns      => 4                       ,
                            -fixedrows    => 1                       ,
                            -fixedcolumns => 0                       ,
                            -editable     => 0                       ,
                            -hscroll      => 1                       ,
                            -vscroll      => 1                       , );
  $winLFDB->gridLF->SetListMode(1);
  $winLFDB->AddButton(      -name         => 'btnLFAdd'              ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887,  5]               ,
                            -bitmap       => $LFAdd                  ,
                            -tip          => $STR{'btnLFAdd'}        ,
                            -tabstop      => 1                       , );
  $winLFDB->AddButton(      -name         => 'btnLFEdit'             ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887, 37]               ,
                            -bitmap       => $LFEdit                 ,
                            -tip          => $STR{'btnLFEdit'}       ,
                            -disabled     => 1                       ,
                            -tabstop      => 1                       , );
  $winLFDB->AddButton(      -name         => 'btnLFDel'              ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887, 69]               ,
                            -bitmap       => $LFRem                  ,
                            -tip          => $STR{'btnLFDel'}        ,
                            -disabled     => 1                       ,
                            -tabstop      => 1                       , );
  # Set Log format grid header
  $winLFDB->gridLF->SetCellText(0, 0, $STR{'Name'}  );
  $winLFDB->gridLF->SetCellText(0, 1, $STR{'sample'}  );
  $winLFDB->gridLF->SetCellText(0, 2, $STR{'pattern'} );
  $winLFDB->gridLF->SetCellText(0, 3, $STR{'Regex'}   );
  if ($load) {
    # Load the Log format Database and add data to Log format controls
    if ($CONFIG{'LF_DB_FILE'} and -f $CONFIG{'LF_DB_FILE'} and &validLFDB($CONFIG{'LF_DB_FILE'})) {
      &loadLFDB($winConfig->tfLFDB->Text(), \$winLFDB, \$win, \%STR);
      &cbInputLFFormatAddITems();
      $win->cbLF->SetCurSel(0);
    # If don't exist, ask to download it
    } else {
      my $answer = Win32::GUI::MessageBox($win, "$STR{'LFDBNotExist'} ?", $STR{'winLFDB'}, 0x1024);
      if ($answer == 6) { # Answer: Yes (6), No (7)
        my $errMsg = &downloadLFDB("$USERDIR\\LF.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                   \$winConfig, \$winLFDB, \$winLFObj, \$winPb, \$win, \%STR);
        if ($errMsg) { Win32::GUI::MessageBox($win, "$errMsg"          , $STR{'error'}      , 0x40010); }
        else         { Win32::GUI::MessageBox($win, $STR{'updatedLFDB'}, "XL-Parser $VERSION", 0x40040); }
      } else { # Create an empty LF database
        my $LFDBFile = "$USERDIR\\LF.db";
        $winConfig->tfLFDB->Text($LFDBFile) if &createLFDB($LFDBFile);
      }
    }
  }
  
}  #--- End createWinLFDB

#--------------------------#
sub winLFDB_Resize
#--------------------------#
{
  $winLFDB->gridLF->Width($winLFDB->ScaleWidth()-39);
  $winLFDB->gridLF->Height($winLFDB->ScaleHeight()-10);
  $winLFDB->gridLF->AutoSizeColumns();
  $winLFDB->gridLF->Refresh();
  $winLFDB->btnLFAdd->Left($winLFDB->ScaleWidth()-32);
  $winLFDB->btnLFEdit->Left($winLFDB->ScaleWidth()-32);
  $winLFDB->btnLFDel->Left($winLFDB->ScaleWidth()-32);

}  #--- End winLFDB_Resize

#--------------------------#
sub gridLF_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $nbrRows = $winLFDB->gridLF->GetRows() - 1;
  if (!$row) {
    $winLFDB->gridLF->SetHeaderSort();
    my $order = $winLFDB->gridLF->GetSortAscending();
    $winLFDB->gridLF->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); });
    $winLFDB->gridLF->Refresh();
  } else {
    $winLFDB->btnLFEdit->Enable();
    $winLFDB->btnLFDel->Enable();
  }
  return(1);

}  #--- End gridLF_Click

#--------------------------#
sub gridLF_DblClick
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  &btnLFEdit_Click() if $row;

}  #--- End gridLF_DblClick

#--------------------------#
sub btnLFAdd_Click
#--------------------------#
{
  &createWinLFObj() if !$winLFObj;
  # Reset all values
  $winLFObj->tfLFObjName->Text('');
  $winLFObj->tfLFObjName->ReadOnly(0);
  $winLFObj->tfLFObjSample->Text('');
  $winLFObj->tfLFObjSample->ReadOnly(0);
  $winLFObj->tfLFObjPattern->Text('');
  $winLFObj->cbLFObjPattern->SetCurSel(0);
  $winLFObj->lblLFObjRegexOk->Hide();
  $winLFObj->lblLFObjRegexErr->Hide();
  $winLFObj->lblLFObjRegexWarn->Hide();
  $winLFObj->tfLFObjRegex->Text('');
  $winLFObj->chLFObjRegexAuto->Checked(1);
  $winLFObj->gridLFObjParsedData->DeleteNonFixedRows();
  $winLFObj->gridLFObjParsedData->AutoSizeColumns();
  $winLFObj->gridLFObjParsedData->ExpandLastColumn();
  $winLFObj->gridLFObjParsedData->Refresh();
  # Update controls
  $winLFObj->btnLFObjFromInput->Enable();
  $winLFObj->btnLFPatternFromIISLog->Enable();
  $winLFObj->btnLFObjAdd->Show();
  $winLFObj->btnLFObjEdit->Hide();
  $winLFObj->Center($win);
  $winLFObj->Show();
  $winLFDB->Disable();
  return(1);

}  #--- End btnLFAdd_Click

#--------------------------#
sub btnLFEdit_Click
#--------------------------#
{
  &createWinLFObj() if !$winLFObj;
  # Load the current values
  my $selRow = ($winLFDB->gridLF->GetSelectedCellRange())[0];
  $winLFObj->tfLFObjName->Text($winLFDB->gridLF->GetCellText($selRow, 0));
  $winLFObj->tfLFObjName->ReadOnly(1);
  $winLFObj->tfLFObjSample->Text($winLFDB->gridLF->GetCellText($selRow, 1));
  $winLFObj->tfLFObjPattern->Text($winLFDB->gridLF->GetCellText($selRow, 2));
  $winLFObj->tfLFObjRegex->Text($winLFDB->gridLF->GetCellText($selRow, 3));
  # Update controls
  $winLFObj->btnLFObjFromInput->Enable();
  $winLFObj->btnLFPatternFromIISLog->Enable();
  $winLFObj->btnLFObjAdd->Hide();
  $winLFObj->btnLFObjEdit->Show();
  $winLFObj->Center($win);
  $winLFObj->Show();
  $winLFDB->Disable();
  return(1);

}  #--- End btnLFEdit_Click

#--------------------------#
sub createWinLFObj
#--------------------------#
{
  # Log format Object window
  $winLFObj = Win32::GUI::Window->new(-name        => 'winLFObj'             ,
                                      -background  => [255, 255, 255]        ,
                                      -parent      => $win                   ,
                                      -text        => $STR{'winLFObj'}       ,
                                      -pos         => [$winPosX, $winPosY]   ,
                                      -size        => [$winWidth, 450]       ,
                                      -minsize     => [$winWidth, 450]       ,
                                      -hasmaximize => 1                      ,
                                      -hasminimize => 1                      ,
                                      -resizable   => 1                      ,
                                      -dialogui    => 1                      , );
  $winLFObj->SetIcon($winICO);
  $winLFObj->AddLabel(          -name         => 'lblLFObjName'          ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5,  8]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Name'}.':'        ,
                                -font         => $font10                 , );
  $winLFObj->AddTextfield(      -name         => 'tfLFObjName'           ,
                                -size         => [285, 24]               ,
                                -pos          => [100,  5]               ,
                                -tabstop      => 1                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjSample'        ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5, 38]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'sample'}.':'      ,
                                -font         => $font10                 , );
  $winLFObj->AddTextfield(      -name         => 'tfLFObjSample'         ,
                                -size         => [285, 24]               ,
                                -pos          => [100, 35]               ,
                                -tabstop      => 1                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjFromInput'     ,
                                -size         => [150, 24]               ,
                                -pos          => [390, 35]               ,
                                -text         => $STR{'btnDTObjFromInput'},
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjPatternInsert' ,
                                -size         => [ 24, 24]               ,
                                -pos          => [100, 65]               ,
                                -bitmap       => $addPattern16           ,
                                -tip          => $STR{'btnPatternAdd'}   ,
                                -disabled     => 1                       , );
  $winLFObj->AddCombobox(       -name         => 'cbLFObjPattern'        ,
                                -size         => [110,100]               ,
                                -pos          => [126, 65]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       ,
                                -disabled     => 1                       , );
  $winLFObj->cbLFObjPattern->Add($STR{'LFclientIP'}  , $STR{'DTDB'}      ,
                                 $STR{'LFHTTPmethod'}, $STR{'LFHTTPreq'} ,
                                 $STR{'LFHTTPparam'} , $STR{'LFHTTPprot'},
                                 $STR{'LFHTTPstatus'}, $STR{'LFsize'}    ,
                                 $STR{'LFReferer'}   , $STR{'LFUA'}      ,
                                 $STR{'other'}       , );
  $winLFObj->cbLFObjPattern->SetCurSel(0);
  $winLFObj->AddButton(         -name         => 'btnLFPatternFromIISLog',
                                -size         => [150, 24]               ,
                                -pos          => [390, 65]               ,
                                -text         => $STR{'btnLFPatternFromIISLog'},
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjDT'            ,
                                -size         => [110, 22]               ,
                                -pos          => [250, 68]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'lblSplitTimeFormat'}.':',
                                -font         => $font10                 ,
                                -visible      => 0                       , );
  $winLFObj->AddCombobox(       -name         => 'cbLFObjDT'             ,
                                -size         => [265,100]               ,
                                -pos          => [365, 65]               ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       ,
                                -font         => $font10                 ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjDTDB'          ,
                                -size         => [ 24, 24]               ,
                                -pos          => [633, 65]               ,
                                -font         => $font10                 ,
                                -bitmap       => $datetime16Bmp          ,
                                -tip          => $STR{'openDTDB'}        ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjDTGuess'       ,
                                -size         => [ 24, 24]               ,
                                -pos          => [659, 65]               ,
                                -bitmap       => $guess16Bmp             ,
                                -tip          => $STR{'guessFormat'}     ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winLFObj->AddCheckbox(       -name         => 'chLFObjHasSpaces'      ,
                                -size         => [200, 22]               ,
                                -pos          => [250, 68]               ,
                                -text         => $STR{'chLFObjHasSpaces'},
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -checked      => 0                       ,
                                -visible      => 0                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjPattern'       ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5, 98]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'pattern'}.':'     ,
                                -font         => $font10                 , );
  $winLFObj->AddTextfield(      -name         => 'tfLFObjPattern'        ,
                                -size         => [285, 24]               ,
                                -pos          => [100, 95]               ,
                                -tabstop      => 1                       ,
                                -disabled     => 1                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjRegex'         ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5,128]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Regex'}.':'       ,
                                -font         => $font10                 , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjRegexOk'       ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99,124]               ,
                                -background   => [  0, 255,   0]         ,
                                -visible      => 0                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjRegexErr'      ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99,124]               ,
                                -background   => [255,   0,   0]         ,
                                -visible      => 0                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjRegexWarn'     ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99,124]               ,
                                -background   => [255, 255,   0]         ,
                                -visible      => 0                       , );
  $winLFObj->AddTextfield(      -name         => 'tfLFObjRegex'          ,
                                -size         => [285, 24]               ,
                                -pos          => [100,125]               ,
                                -tabstop      => 1                       ,
                                -disabled     => 1                       , );
  $winLFObj->AddCheckbox(       -name         => 'chLFObjRegexAuto'      ,
                                -size         => [150, 22]               ,
                                -pos          => [390,125]               ,
                                -text         => $STR{'matchPattern'}    ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -checked      => 1                       , );
  $winLFObj->AddLabel(          -name         => 'lblLFObjParsed'        ,
                                -size         => [ 95, 22]               ,
                                -pos          => [  5,158]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'parsed'}.':'      ,
                                -font         => $font10                 , );
  $winLFObj->AddGrid(           -name         => 'gridLFObjParsedData'   ,
                                -size         => [550,375]               ,
                                -pos          => [100,156]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 2                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -editable     => 0                       , );
  $winLFObj->gridLFObjParsedData->SetCellText(0, 0, $STR{'Name'});
  $winLFObj->gridLFObjParsedData->SetCellText(0, 1, $STR{'Value'});
  $winLFObj->AddButton(         -name         => 'btnLFObjNotReady'      ,
                                -size         => [ 30, 30]               ,
                                -pos          => [255,250]               ,
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winLFObj->AddButton(         -name         => 'btnLFObjAdd'           ,
                                -size         => [ 60, 30]               ,
                                -pos          => [295,250]               ,
                                -text         => $STR{'add'}             ,
                                -font         => $font10                 ,
                                -disabled     => 1                       ,
                                -visible      => 0                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjEdit'          ,
                                -size         => [ 60, 30]               ,
                                -pos          => [295,250]               ,
                                -text         => $STR{'Edit'}            ,
                                -font         => $font10                 ,
                                -disabled     => 1                       ,
                                -visible      => 0                       , );
  $winLFObj->AddButton(         -name         => 'btnLFObjCancel'        ,
                                -size         => [ 70, 30]               ,
                                -pos          => [360,250]               ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );

}  #--- End createWinLFObj

#--------------------------#
sub winLFObj_Resize
#--------------------------#
{
  $winLFObj->tfLFObjName->Width($winLFObj->ScaleWidth()-254);
  $winLFObj->tfLFObjSample->Width($winLFObj->ScaleWidth()-254);
  $winLFObj->btnLFObjFromInput->Left($winLFObj->ScaleWidth()-152);
  $winLFObj->btnLFPatternFromIISLog->Left($winLFObj->ScaleWidth()-152);
  $winLFObj->tfLFObjPattern->Width($winLFObj->ScaleWidth()-254);
  $winLFObj->lblLFObjRegexOk->Width($winLFObj->ScaleWidth()-252);
  $winLFObj->lblLFObjRegexErr->Width($winLFObj->ScaleWidth()-252);
  $winLFObj->lblLFObjRegexWarn->Width($winLFObj->ScaleWidth()-252);
  $winLFObj->tfLFObjRegex->Width($winLFObj->ScaleWidth()-254);
  $winLFObj->chLFObjRegexAuto->Left($winLFObj->ScaleWidth()-150);
  $winLFObj->gridLFObjParsedData->Width($winLFObj->ScaleWidth()-254);
  $winLFObj->gridLFObjParsedData->Height($winLFObj->ScaleHeight()-195);
  $winLFObj->gridLFObjParsedData->AutoSizeColumns();
  $winLFObj->gridLFObjParsedData->ExpandLastColumn();
  $winLFObj->gridLFObjParsedData->Refresh();
  $winLFObj->btnLFObjNotReady->Left(($winLFObj->ScaleWidth()/2)-130);
  $winLFObj->btnLFObjAdd->Left(($winLFObj->ScaleWidth()/2)-60);
  $winLFObj->btnLFObjEdit->Left(($winLFObj->ScaleWidth()/2)-60);
  $winLFObj->btnLFObjCancel->Left(($winLFObj->ScaleWidth()/2)+5);
  $winLFObj->btnLFObjNotReady->Top($winLFObj->ScaleHeight()-35);
  $winLFObj->btnLFObjAdd->Top($winLFObj->ScaleHeight()-35);
  $winLFObj->btnLFObjEdit->Top($winLFObj->ScaleHeight()-35);
  $winLFObj->btnLFObjCancel->Top($winLFObj->ScaleHeight()-35);

}  #--- End winLFObj_Resize

#--------------------------#
sub tfLFObjName_Change   { &isLFObjReady(0); }
sub tfLFObjSample_Change { &isLFObjReady(0); }
#--------------------------#

#--------------------------#
sub btnLFObjFromInput_Click
#--------------------------#
{
  # Get first line of one file in input
  my $firstLine;
  if ($win->rbInputDir->Checked() or $win->rbInputFiles->Checked()) {
    my $oneFile = &getOneFile;
    if (open(my $fh, $oneFile)) {
      while (<$fh>) { $firstLine = $_ if $_ !~ /^#/; }
      close($fh);
      $winLFObj->tfLFObjSample->Text($firstLine);
    } else { Win32::GUI::MessageBox($winLFObj, "$STR{'errorOpening'} $oneFile...", $STR{'error'}, 0x40010); }
  }
  
}  #--- End btnLFObjFromInput_Click

#--------------------------#
sub btnLFPatternFromIISLog_Click
#--------------------------#
{
  # Get first line of one file in input
  my $IISPatternStr;
  if ($win->rbInputDir->Checked() or $win->rbInputFiles->Checked()) {
    my $oneFile = &getOneFile;
    if (open(my $fh, $oneFile)) {
      while (<$fh>) { if ($_ =~ /^#Fields:/) { $IISPatternStr = $_; last; } }
      close($fh);
      if ($IISPatternStr =~ s/^#Fields: //) {
        my $patternStr;
        $IISPatternStr =~ s/date time/datetime/;
        my @fields = split(/ /, $IISPatternStr);
        my %fieldPattern = ('datetime' => 'datetime', 'cs-method' => 'http_method', => 'cs-uri-stem' => 'http_request',
                            'cs-uri-query' => 'http_params', 'c-ip' => 'remoteIP', 'cs-version' => 'http_protocol',
                            'cs(User-Agent)' => 'useragent', 'cs(Referer)' => 'referer', 'sc-status' => 'http_status',
                            'sc-bytes' => 'size');
        foreach my $field (@fields) {
          if (exists($fieldPattern{$field})) {
            if ($field eq 'datetime') {
              # Get the date format
              my $oneLine = $winLFObj->tfLFObjSample->Text();
              if (my $sample = (&findDTFormatInLog($oneLine))) {
                $sample =~ s/ /%20/g;
                $patternStr .= $fieldPattern{$field}.'('.$sample.') ';
              # If date not found
              } else { Win32::GUI::MessageBox($winLFObj, "STR{'Date'} $STR{'formatNotFound'}...", $STR{'error'}, 0x40010); return(1); }
            } else { $patternStr .= $fieldPattern{$field} . ' '; }
          } else { $patternStr .= 'other' . ' '; }
        }
        # Write pattern in the textfield
        if ($patternStr) {
          chop($patternStr);
          while ($patternStr =~ s/ other$//) { }
          $winLFObj->tfLFObjPattern->Text($patternStr);
        } else { Win32::GUI::MessageBox($winLFObj, "$STR{'formatNotFound'}...", $STR{'error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($winLFObj, "$STR{'formatNotFound'}...", $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($winLFObj, "$STR{'errorOpening'} $oneFile...", $STR{'error'}, 0x40010); }
  }
  
}  #--- End btnLFPatternFromIISLog_Click

#--------------------------#
sub btnLFObjPatternInsert_Click
#--------------------------#
{
  # Local variables
  my $LFObjPattern = $winLFObj->cbLFObjPattern->GetCurSel();
  # Possible values are: 0 = LFclientIP, 1 = DTDB, 2 = LFHTTPmethod, 3 = LFHTTPreq, 4 = LFHTTPparam, 5 = LFHTTPprot,
  #                      6 = LFHTTPstatus, 7 = LFsize, 8 = LFReferer, 9 = LFUA, 10 = other
  my @LFObjPatternStr = ('remoteIP', 'datetime', 'http_method', 'http_request', 'http_params', 'http_protocol',
                         'http_status', 'size', 'referer', 'useragent', 'other');
  # Add a space before each new pattern
  $winLFObj->tfLFObjPattern->Append(' ') if $winLFObj->tfLFObjPattern->Text;
  # Datetime
  if ($LFObjPattern == 1) {
    my $DTFormatSample = $winLFObj->cbLFObjDT->GetString($winLFObj->cbLFObjDT->GetCurSel());
    if ($DTFormatSample ne $STR{'selectDTFormat'}.'...') {
      $DTFormatSample =~ s/ /%20/g;
      $winLFObj->tfLFObjPattern->Append($LFObjPatternStr[$LFObjPattern]."($DTFormatSample)");
    }
  # May contain spaces
  } elsif (($LFObjPattern == 8 or $LFObjPattern == 9) and $winLFObj->chLFObjHasSpaces->Checked()) {
    $winLFObj->tfLFObjPattern->Append('"'.$LFObjPatternStr[$LFObjPattern].'-s"');
  } else { $winLFObj->tfLFObjPattern->Append($LFObjPatternStr[$LFObjPattern].''); }
  &isLFObjReady(0);

}  #--- End btnLFObjPatternInsert_Click

#--------------------------#
sub cbLFObjPattern_Change
#--------------------------#
{
  # Local variables
  my $LFObjPattern = $winLFObj->cbLFObjPattern->GetCurSel();
  # Possible values are: 0 = LFclientIP, 1 = DTDB, 2 = LFHTTPmethod, 3 = LFHTTPreq, 4 = LFHTTPparam, 5 = LFHTTPprot,
  #                      6 = LFHTTPstatus, 7 = LFsize, 8 = LFReferer, 9 = LFUA, 10 = other
  # Datetime options
  if ($LFObjPattern == 1) {
    $winLFObj->lblLFObjDT->Show();
    $winLFObj->cbLFObjDT->Show();
    $winLFObj->btnLFObjDTDB->Show();
    $winLFObj->btnLFObjDTGuess->Show();
  } else {
    $winLFObj->lblLFObjDT->Hide();
    $winLFObj->cbLFObjDT->Hide();
    $winLFObj->btnLFObjDTDB->Hide();
    $winLFObj->btnLFObjDTGuess->Hide();
  }
  # Referer and useragent options
  if ($LFObjPattern == 8 or $LFObjPattern == 9) { $winLFObj->chLFObjHasSpaces->Show(); }
  else                                          { $winLFObj->chLFObjHasSpaces->Hide(); }

}  #--- End cbLFObjPattern_Change

#--------------------------#
sub btnLFObjDTDB_Click
#--------------------------#
{
  if (my $selRow = ($winDTDB->gridDT->GetSelectedCellRange())[0]) {
    $winDTDB->btnDTEdit->Enable();
    $winDTDB->btnDTDel->Enable();
  } else {
    $winDTDB->btnDTEdit->Disable();
    $winDTDB->btnDTDel->Disable();
  }
  $winDTDB->Center($win);
  $winDTDB->Show();
  return(1);

}  #--- End btnLFObjDTDB_Click

#--------------------------#
sub createWinDTDB
#--------------------------#
{
  my $load = shift;
  # Datetime database window
  $winDTDB = Win32::GUI::Window->new( -name        => 'winDTDB'              ,
                                      -background  => [255, 255, 255]        ,
                                      -parent      => $win                   ,
                                      -text        => $STR{'winDTDB'}        ,
                                      -pos         => [$winPosX, $winPosY]   ,
                                      -size        => [$winWidth, 350]       ,
                                      -minsize     => [$winWidth, 350]       ,
                                      -hasmaximize => 1                      ,
                                      -hasminimize => 1                      ,
                                      -resizable   => 1                      ,
                                      -dialogui    => 1                      , );
  $winDTDB->SetIcon($winICO);
  # Datetime grid
  $winDTDB->AddGrid(        -name         => 'gridDT'                ,
                            -size         => [880,180]               ,
                            -pos          => [  5,  5]               ,
                            -background   => [255, 255, 255]         ,
                            -columns      => 6                       ,
                            -fixedrows    => 1                       ,
                            -fixedcolumns => 0                       ,
                            -editable     => 0                       , );
  $winDTDB->gridDT->SetListMode(1);
  $winDTDB->AddButton(      -name         => 'btnDTAdd'              ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887,  5]               ,
                            -bitmap       => $datetimeAdd            ,
                            -tip          => $STR{'btnDTAdd'}        ,
                            -tabstop      => 1                       , );
  $winDTDB->AddButton(      -name         => 'btnDTEdit'             ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887, 37]               ,
                            -bitmap       => $datetimeEdit           ,
                            -tip          => $STR{'btnDTEdit'}       ,
                            -disabled     => 1                       ,
                            -tabstop      => 1                       , );
  $winDTDB->AddButton(      -name         => 'btnDTDel'              ,
                            -size         => [ 30, 30]               ,
                            -pos          => [887, 69]               ,
                            -bitmap       => $datetimeDel            ,
                            -tip          => $STR{'btnDTDel'}        ,
                            -disabled     => 1                       ,
                            -tabstop      => 1                       , );
  # Set Datetime grid header
  $winDTDB->gridDT->SetCellText(0, 0, $STR{'sample'}  );
  $winDTDB->gridDT->SetCellText(0, 1, $STR{'pattern'} );
  $winDTDB->gridDT->SetCellText(0, 2, $STR{'Regex'}   );
  $winDTDB->gridDT->SetCellText(0, 3, $STR{'timezone'});
  $winDTDB->gridDT->SetCellText(0, 4, $STR{'useAs'}   );
  $winDTDB->gridDT->SetCellText(0, 5, $STR{'comment'} );
  $winDTDB->gridDT->SetCellFormat(0, 0, 1); # Center column headers
  $winDTDB->gridDT->SetCellFormat(0, 1, 1);
  $winDTDB->gridDT->SetCellFormat(0, 2, 1);
  $winDTDB->gridDT->SetCellFormat(0, 3, 1);
  $winDTDB->gridDT->SetCellFormat(0, 4, 1);
  $winDTDB->gridDT->SetCellFormat(0, 5, 1);
  if ($load) {
    # Load the Datetime Database and add data to datetime controls
    if ($CONFIG{'DT_DB_FILE'} and -f $CONFIG{'DT_DB_FILE'} and &validDTDB($CONFIG{'DT_DB_FILE'})) {
      &loadDTDB;
      &cbInputDTFormatAddITems();
      $winLFObj->cbLFObjDT->SetCurSel(0);
      $win->cbSplitTimeFormat->SetCurSel(0);
      &cbOutputDTFormatAddITems();
      if ($CONFIG{'DEFAULT_OUTPUT_DT_FORMAT'}) {
        $winReport->cbOutputDTFormat->SetCurSel($winReport->cbOutputDTFormat->FindStringExact($CONFIG{'DEFAULT_OUTPUT_DT_FORMAT'}));
      } else { $winReport->cbOutputDTFormat->SetCurSel(0); }
    # If don't exist, ask to download it
    } else {
      my $answer = Win32::GUI::MessageBox($win, "$STR{'DTDBNotExist'} ?", $STR{'winDTDB'}, 0x1024);
      if ($answer == 6) { # Answer: Yes (6), No (7)
        my $errMsg = &downloadDTDB("$USERDIR\\DT.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                   \$winConfig, \$winLFObj, \$winDTDB, \$winReport, \$winPb, \$win, \%STR);
        if ($errMsg) { Win32::GUI::MessageBox($win, "$errMsg"          , $STR{'error'}      , 0x40010); }
        else         { Win32::GUI::MessageBox($win, $STR{'updatedDTDB'}, "XL-Parser $VERSION", 0x40040); }
      }
    }
  }

}  #--- End createWinDTDB

#--------------------------#
sub btnLFObjDTGuess_Click
#--------------------------#
{
  # Guess format of the first item
  my $oneLine = $winLFObj->tfLFObjSample->Text();
  if (my $sample = (&findDTFormatInLog($oneLine))) {
    $winLFObj->cbLFObjDT->SetCurSel($winLFObj->cbLFObjDT->FindStringExact($sample));
  # If not found
  } else { Win32::GUI::MessageBox($winLFObj, $STR{'formatNotFound'}.'...', $STR{'error'}, 0x40010); }

}  #--- End btnLFObjDTGuess_Click

#--------------------------#
sub tfLFObjPattern_Change
#--------------------------#
{
  my $pattern = $winLFObj->tfLFObjPattern->Text();
  if ($pattern and $winLFObj->chLFObjRegexAuto->Checked()) {
    my $regex = &patternLFRE($pattern);
    $winLFObj->tfLFObjRegex->Text($regex);
  }
  &isLFObjReady(0);
  
}  #--- End tfLFObjPattern_Change

#--------------------------#
sub patternLFRE
#--------------------------#
{
  # Local variables
  my $patternStr = shift;
  my @patterns   = split(/ /, $patternStr);
  # Possible values for patterns are : remoteIP, datetime+(datetime format), http_method, http_request, http_params, http_protocol,
  #                                    http_status, size, referer, referer-s (with spaces), useragent, useragent-s (with spaces), other
  my $regex;
  # Convert each pattern to the appropriate regex
  foreach my $pattern (@patterns) {
    if (length($pattern) > 1) {
      $regex .= ' ' if $regex;
      $regex .= "\\".$1 if $pattern =~ /^([\"\[])/; # " or [
      # For datetime pattern, gather regex from database
      if ($pattern =~ /datetime\(([^\]\)]+)\)/) {
        my $format = $1;
        $format    =~ s/%20/ /g;
        my ($sample, $pattern, $DTregex, $timezone) = &findInputDTFormat($format) if $format ne $STR{'selectDTFormat'};
        $regex .= '(' . $DTregex . ')' if $DTregex;
      }
      elsif ($pattern =~ /remoteIP/) { $regex .= '((?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|[a-fA-F0-9]\:|\:[a-fA-F0-9]))'; } # RemoteIP (IPv4 or IPv6)
      elsif ($pattern =~ /http_status/ or
             $pattern =~ /size/    ) { $regex .= '(\d+)';      } # Field is a number
      elsif ($pattern =~ /-s\"$/   ) { $regex .= '([^\"]+)';   } # Field may contains spaces
      elsif ($pattern =~ /other/   ) { $regex .= '[^\ \"]+';   } # Pattern we don't need to extract
      else                           { $regex .= '([^\ \"]+)'; } # Any other pattern
      $regex .= "\\".$1 if $pattern =~ /([\"\]])$/;  # " or ]
    } else { $regex .= $pattern; }
  }
  # Return regex
  if ($regex) {
    chomp($regex);
    return($regex);
  }

}  #--- End patternLFRE

#--------------------------#
sub tfLFObjRegex_Change { &isLFObjReady(0); }
#--------------------------#

#--------------------------#
sub chLFObjRegexAuto_Click
#--------------------------#
{
  my $pattern = $winLFObj->tfLFObjPattern->Text();
  if ($pattern and $winLFObj->chLFObjRegexAuto->Checked()) {
    my $regex = patternLFRE($pattern);
    $winLFObj->tfLFObjRegex->Text($regex);
  }
  &isLFObjReady(0);
  
}  #--- End chLFObjRegexAuto_Click

#--------------------------#
sub isLFObjReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  # Name provided
  if (!$winLFObj->tfLFObjName->Text()) {
    $winLFObj->tfLFObjPattern->Disable();
    $winLFObj->btnLFObjPatternInsert->Disable();
    $winLFObj->cbLFObjPattern->Disable();
    $winLFObj->tfLFObjRegex->Disable();
    $nextStep = $STR{'provideLFName'};
  } else {
    $winLFObj->tfLFObjPattern->Enable();
    $winLFObj->btnLFObjPatternInsert->Enable();
    $winLFObj->cbLFObjPattern->Enable();
    # Sample provided ?
    my $sample = $winLFObj->tfLFObjSample->Text();
    if (!$sample) {
      $winLFObj->tfLFObjPattern->Disable();
      $winLFObj->btnLFObjPatternInsert->Disable();
      $winLFObj->cbLFObjPattern->Disable();
      $winLFObj->tfLFObjRegex->Disable();
      $nextStep = $STR{'provideSample'};
    } else {
      $winLFObj->tfLFObjPattern->Enable();
      $winLFObj->btnLFObjPatternInsert->Enable();
      $winLFObj->cbLFObjPattern->Enable();
      # Pattern provided ?
      my $pattern = $winLFObj->tfLFObjPattern->Text();
      if ($pattern) {
        $winLFObj->tfLFObjRegex->Enable();
        # Regex provided ?
        my $regex = $winLFObj->tfLFObjRegex->Text();
        if ($regex) {
          my ($statusRegex, $msg) = &validRegex($regex);
          # Warning
          if      ($statusRegex == 2) {
            $winLFObj->lblLFObjRegexWarn->Show();
            $winLFObj->lblLFObjRegexOk->Hide();
            $winLFObj->lblLFObjRegexErr->Hide();
          # Error
          } elsif ($statusRegex == 1) {
            $winLFObj->lblLFObjRegexErr->Show();
            $winLFObj->lblLFObjRegexOk->Hide();
            $winLFObj->lblLFObjRegexWarn->Hide();
            $nextStep = $STR{'errRegex'};
          # Ok
          } else {
            $winLFObj->lblLFObjRegexOk->Show();
            $winLFObj->lblLFObjRegexErr->Hide();
            $winLFObj->lblLFObjRegexWarn->Hide();
          }
        } else {
          $winLFObj->lblLFObjRegexOk->Hide();
          $winLFObj->lblLFObjRegexErr->Hide();
          $winLFObj->lblLFObjRegexWarn->Hide();
          $nextStep = $STR{'errRegex'};
        }
        # Test and apply regex
        if (!$nextStep) {
          my %expr = ('expr' => '^'.$regex, 'regex' => 1);
          my ($result, $nbrRes, $refListRes) = &textExprAll($sample, \%expr, \%STR);
          if ($result) {
            $winLFObj->gridLFObjParsedData->DeleteNonFixedRows();
            my @listRes = split(/\t/, $$refListRes[0]);
            shift(@listRes);
            my @LFFields = split(/ /, $pattern);
            my %fieldOrder;
            my $i = 0;
            foreach my $field (@LFFields) {
              if    ($field =~ /remoteIP/     ) { $fieldOrder{remoteIP}      = $i++; }
              elsif ($field =~ /datetime/     ) { $fieldOrder{datetime}      = $i++; }
              elsif ($field =~ /http_method/  ) { $fieldOrder{http_method}   = $i++; }
              elsif ($field =~ /http_request/ ) { $fieldOrder{http_request}  = $i++; }
              elsif ($field =~ /http_params/  ) { $fieldOrder{http_params}   = $i++; }
              elsif ($field =~ /http_protocol/) { $fieldOrder{http_protocol} = $i++; }
              elsif ($field =~ /http_status/  ) { $fieldOrder{http_status}   = $i++; }
              elsif ($field =~ /size/         ) { $fieldOrder{size}          = $i++; }
              elsif ($field =~ /referer/      ) { $fieldOrder{referer}       = $i++; }
              elsif ($field =~ /useragent/    ) { $fieldOrder{useragent}     = $i++; }
            }
            $i = 1;
            $winLFObj->gridLFObjParsedData->SetRows(scalar(keys %fieldOrder)+1);
            foreach my $fName (sort { $fieldOrder{$a} <=> $fieldOrder{$b}} keys %fieldOrder) {
              $winLFObj->gridLFObjParsedData->SetCellText($i, 0, $fName);
              $winLFObj->gridLFObjParsedData->SetCellText($i, 1, $listRes[$i-1]);
              $i++;
            }
          } else { $winLFObj->gridLFObjParsedData->DeleteNonFixedRows(); }
          $winLFObj->gridLFObjParsedData->AutoSizeColumns();
          $winLFObj->gridLFObjParsedData->ExpandLastColumn();
          $winLFObj->gridLFObjParsedData->Refresh();
          # Test pattern minimum field
          $nextStep = $STR{'providePatternMin'} if ($pattern !~ /remoteIP/     or $pattern !~ /datetime/ or $pattern !~ /http_method/ or
                                                    $pattern !~ /http_request/ or $pattern !~ /http_status/);
        }
      } else { # No pattern
        $winLFObj->tfLFObjRegex->Disable();
        $nextStep = $STR{'providePattern'};
      }
    }
  }
  # Return an error message or enable the button
  if ($nextStep) {
    $winLFObj->btnLFObjAdd->Disable();
    $winLFObj->btnLFObjEdit->Disable();
    $winLFObj->btnLFObjNotReady->Enable();
    Win32::GUI::MessageBox($winLFObj, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winLFObj->btnLFObjAdd->Enable();
    $winLFObj->btnLFObjEdit->Enable();
    $winLFObj->btnLFObjNotReady->Disable();
  }
  
}  #--- End isLFObjReady

#--------------------------#
sub btnLFObjNotReady_Click { &isLFObjReady(1); }
#--------------------------#

#--------------------------#
sub btnLFObjAdd_Click
#--------------------------#
{
  # Local variables
  my $LFName   = $winLFObj->tfLFObjName->Text();
  my $sample   = $winLFObj->tfLFObjSample->Text();
  my $pattern  = $winLFObj->tfLFObjPattern->Text();
  my $regex    = $winLFObj->tfLFObjRegex->Text();
  my $LFDBFile = $winConfig->tfLFDB->Text();
  # Select or create Datetime database
  if (!-f $LFDBFile or !&validLFDB($LFDBFile)) {
    $LFDBFile = "$USERDIR\\LF.db";
    $winConfig->tfLFDB->Text($LFDBFile) if &createLFDB($LFDBFile);
  }
  # Add to database
  my $dsn = "DBI:SQLite:dbname=$LFDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Database: table = LF, Fields = name, sample, pattern, regex
    my $sth = $dbh->prepare('INSERT INTO LF (name, sample, pattern, regex) VALUES(?,?,?,?)');
    my $rv = $sth->execute($LFName, $sample, $pattern, $regex);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winLFDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Add to Grid
      if (my $newLine = $winLFDB->gridLF->InsertRow($sample, -1)) {
        $winLFDB->gridLF->SetCellText($newLine, 0, $LFName);
        $winLFDB->gridLF->SetCellText($newLine, 1, $sample);
        $winLFDB->gridLF->SetCellText($newLine, 2, $pattern);
        $winLFDB->gridLF->SetCellText($newLine, 3, $regex);
        # Refresh grid
        $winLFDB->gridLF->Refresh();
        $winLFDB->gridLF->SortCells(0, 1, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); });
        $winLFDB->gridLF->AutoSizeColumns();
        $win->cbLF->Add($LFName); # Add to combobox
        # Final message
        &winLFObj_Terminate();
        Win32::GUI::MessageBox($winLFDB, $STR{'addedLFObj'}, $STR{'winLFDB'}, 0x40040);
      } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End btnLFObjAdd_Click

#--------------------------#
sub btnLFObjEdit_Click
#--------------------------#
{
  # Local variables
  my $LFName   = $winLFObj->tfLFObjName->Text();
  my $sample   = $winLFObj->tfLFObjSample->Text();
  my $pattern  = $winLFObj->tfLFObjPattern->Text();
  my $regex    = $winLFObj->tfLFObjRegex->Text();
  my $LFDBFile = $winConfig->tfLFDB->Text();
  # Update database
  my $dsn = "DBI:SQLite:dbname=$LFDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Database: table = LF, Fields = name, sample, pattern, regex
    my $sth = $dbh->prepare('UPDATE LF SET sample = ?, pattern = ?, regex = ? WHERE ? == name');
    my $rv  = $sth->execute($sample, $pattern, $regex, $LFName);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winDTDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Update Grid
      for (my $i = 1; $i < $winLFDB->gridLF->GetRows(); $i++) {
        my $curNameRow = $winLFDB->gridLF->GetCellText($i, 0);
        if ($curNameRow eq $LFName) {
          $winLFDB->gridLF->SetCellText($i, 0, $LFName);
          $winLFDB->gridLF->SetCellText($i, 1, $sample);
          $winLFDB->gridLF->SetCellText($i, 2, $pattern);
          $winLFDB->gridLF->SetCellText($i, 3, $regex);
          # Refresh grid
          $winLFDB->gridLF->Refresh();
          $winLFDB->gridLF->AutoSizeColumns();
          # Final message
          &winLFObj_Terminate();
          Win32::GUI::MessageBox($winLFDB, $STR{'updatedLFObj'}, $STR{'winLFDB'}, 0x40040);
          last;
        } 
      }
      &winLFObj_Terminate();
    }
  }

}  #--- End btnLFObjEdit_Click

#--------------------------#
sub btnLFDel_Click
#--------------------------#
{
  # Local variables
  my $LFDBFile = $winConfig->tfLFDB->Text();
  # Get selected row
  my $selRow = ($winLFDB->gridLF->GetSelectedCellRange())[0];
  my $LFName = $winLFDB->gridLF->GetCellText($selRow, 0);
  # Delete in Datetime database
  my $dsn = "DBI:SQLite:dbname=$LFDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    my $sth = $dbh->prepare('DELETE FROM LF WHERE name == ?');
    my $rv = $sth->execute($LFName);
    if ($rv < 0) { Win32::GUI::MessageBox($winLFDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010); }
    else { 
      # Find the entry in grid and delete
      for (my $i = 1; $i < $winLFDB->gridLF->GetRows(); $i++) {
        my $curNameRow = $winLFDB->gridLF->GetCellText($i, 0);
        if ($curNameRow eq $LFName) {
          $winLFDB->gridLF->DeleteRow($i);
          # Refresh grid
          $winLFDB->gridLF->Refresh();
          $winLFDB->gridLF->SortCells(0, 1, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); });
          $winLFDB->gridLF->AutoSizeColumns();
          $win->cbLF->DeleteString($win->cbLF->FindStringExact($LFName)); # If entry is in combobox, delete it
          Win32::GUI::MessageBox($winLFDB, $STR{'deletedLFObj'}, $STR{'winLFDB'}, 0x40040);
          last;
        }
      }
    }
  }
  
}  #--- End btnLFDel_Click

#--------------------------#
sub btnLFObjCancel_Click { &winLFObj_Terminate(); }
#--------------------------#

#--------------------------#
sub winLFObj_Terminate
#--------------------------#
{
  $winLFObj->Hide();
  $winLFDB->Enable();
  $winLFDB->BringWindowToTop();
  return(0);

}  #--- End winLFObj_Terminate

#--------------------------#
sub winLFDB_Terminate
#--------------------------#
{
  $winLFDB->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winLFDB_Terminate

#--------------------------#
sub cbInputLFFormatAddITems
#--------------------------#
{
  # Browse Log format grid and list available Log format object for input
  my @inputFormats;
  for (my $i = 1; $i < $winLFDB->gridLF->GetRows(); $i++) {
    push(@inputFormats, $winLFDB->gridLF->GetCellText($i, 0));
  }
  # Update the combobox
  if (scalar(@inputFormats)) {
    $win->cbLF->Add($STR{'selectDTFormat'}.'...');
    foreach (@inputFormats) { $win->cbLF->Add($_); }
  }
  
}  #--- End cbInputLFFormatAddITems

#--------------------------#
sub btnLFGuess_Click
#--------------------------#
{
  # Guess format of the first item
  my ($status,$LFName, @listMatches) = &findLFFormatInLog(0, \$winLFDB, \$win);
  if ($status) {
    $win->cbLF->SetCurSel($win->cbLF->FindStringExact($LFName)); # Select format that match
    if ($status == 2) { # More than one match
      my $msg = $STR{'moreFormatMatch'};
      foreach (@listMatches) { $msg .= "\r\n- $_"; }
      Win32::GUI::MessageBox($win, $msg, $STR{'warning'}, 0x40030);
    }
  } else { Win32::GUI::MessageBox($win, $STR{'formatNotFound'}.'...', $STR{'error'}, 0x40010); } # If not found
  &isProcessReady(0);

}  #--- End btnLFGuess_Click

#--------------------------#
sub btnLAFileOrder_Click
#--------------------------#
{
  if ($win->tfInput->Text()) {
    &createWinFO() if !$winFO;
    $winFO->gridFO->DeleteNonFixedRows();
    # Feed Files grid (gridFO): Filename, File size, Last modified time, Path
    my %listFiles;
    &getListFiles(\%listFiles, \$winFileFormats, \$winFileFilters, \$win, \%STR);
    my $nbrFiles = scalar(keys %listFiles);
    if ($nbrFiles) {
      foreach my $file (keys %listFiles) {
        my @parts     = split(/\\/, $file);
        my $filename  = pop(@parts);
        my @stats     = stat($file);
        my $lastModif = DateTime->from_epoch(epoch => $stats[9]);
        if (my $row = $winFO->gridFO->InsertRow('-', -1)) {
          $winFO->gridFO->SetCellText($row, 0, $filename);
          $winFO->gridFO->SetCellText($row, 1, $stats[7]);
          $winFO->gridFO->SetCellText($row, 2, $lastModif->strftime('%F %T'));
          $winFO->gridFO->SetCellText($row, 3, $file);
        }
      }
      # Refresh grid
      $winFO->gridFO->Refresh();
      $winFO->gridFO->SortCells(2, 1, \&sortByDate);
      $winFO->gridFO->AutoSize();
      $winFO->gridFO->ExpandLastColumn();
      # Show File order window
      $winFO->Center($win);
      $winFO->Show();
      $win->Disable();
    } else { Win32::GUI::MessageBox($win, $STR{'noFile'}, $STR{'error'}, 0x40010); } # No files
  }
  return(1);

}  #--- End btnLAFileOrder_Click

#--------------------------#
sub createWinFO
#--------------------------#
{
  # File order window
  $winFO = Win32::GUI::Window->new( -name        => 'winFO'                ,
                                    -background  => [255, 255, 255]        ,
                                    -parent      => $win                   ,
                                    -text        => $STR{'LAFileOrder'}    ,
                                    -pos         => [$winPosX, $winPosY]   ,
                                    -size        => [$winWidth, 400]       ,
                                    -hasmaximize => 1                      ,
                                    -hasminimize => 1                      ,
                                    -resizable   => 1                      ,
                                    -dialogui    => 1                      , );
  $winFO->SetIcon($winICO);
  $winFO->AddGrid(        -name         => 'gridFO'                ,
                          -size         => [550,215]               ,
                          -pos          => [  5,  5]               ,
                          -background   => [255, 255, 255]         ,
                          -columns      => 4                       ,
                          -fixedrows    => 1                       ,
                          -fixedcolumns => 0                       ,
                          -editable     => 0                       , );
  $winFO->gridFO->SetListMode(1);
  $winFO->AddButton(      -name         => 'btnFOUp'               ,
                          -size         => [ 22, 22]               ,
                          -pos          => [557,  5]               ,
                          -bitmap       => $up16                   , );
  $winFO->AddButton(      -name         => 'btnFODown'             ,
                          -size         => [ 22, 22]               ,
                          -pos          => [557, 29]               ,
                          -bitmap       => $down16                 , );
  $winFO->AddButton(      -name         => 'btnFOOk'               ,
                          -text         => $STR{'Ok'}              ,
                          -size         => [ 60, 30]               ,
                          -pos          => [270,225]               ,
                          -font         => $font10                 ,
                          -ok           => 1                       ,
                          -default      => 1                       , );
  # Set List of source files grid header
  $winFO->gridFO->SetCellText(0, 0, $STR{'Filename'});
  $winFO->gridFO->SetCellText(0, 1, $STR{'rbFiltersSize'});
  $winFO->gridFO->SetCellText(0, 2, $STR{'rbFiltersLastModif'});
  $winFO->gridFO->SetCellText(0, 3, $STR{'Path'});
  $winFO->gridFO->SetSingleRowSelection();

}  #--- End createWinFO

#--------------------------#
sub winFO_Resize
#--------------------------#
{
  $winFO->gridFO->Width($winFO->ScaleWidth()-30);
  $winFO->gridFO->Height($winFO->ScaleHeight()-45);
  $winFO->gridFO->AutoSizeColumns();
  $winFO->gridFO->ExpandLastColumn();
  $winFO->gridFO->Refresh();
  $winFO->btnFOUp->Left($winFO->ScaleWidth()-24);
  $winFO->btnFODown->Left($winFO->ScaleWidth()-24);
  $winFO->btnFOOk->Top($winFO->ScaleHeight()-35);
  $winFO->btnFOOk->Left(($winFO->ScaleWidth()-60)/2);

}  #--- End winFO_Resize

#--------------------------#
sub gridFO_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  my $nbrRows = $winFO->gridFO->GetRows() - 1;
  if (!$row) {
    $winFO->gridFO->SetHeaderSort();
    my $order = $winFO->gridFO->GetSortAscending();
    if    ($column == 2) { $winFO->gridFO->SortCells($column, $order, \&sortByDate); }
    elsif ($column == 1) { $winFO->gridFO->SortCells($column, $order, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2); }); }
    else                 { $winFO->gridFO->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); }); }
    $winFO->gridFO->Refresh();
  # Up and down button, at least 2 expressions
  } elsif ($nbrRows > 1) {
    # Up button enabled if not the first one
    if ($row != 1) { $winFO->btnFOUp->Enable();  }
    else           { $winFO->btnFOUp->Disable(); }
    # Down button enabled if not the last one
    if ($row != $nbrRows) { $winFO->btnFODown->Enable();  }
    else                  { $winFO->btnFODown->Disable(); }
  }
  return(1);

}  #--- End gridFO_Click

#--------------------------#
sub btnFOUp_Click
#--------------------------#
{
  # Local variables
  my $upRow   = ($winFO->gridFO->GetSelectedCellRange())[0];
  my $downRow = $upRow - 1;
  # Get selected row values
  if ($downRow > 0) { # Not the first line
    # Values to move up
    my $upFilename    = $winFO->gridFO->GetCellText($upRow, 0);
    my $upFileSize    = $winFO->gridFO->GetCellText($upRow, 1);
    my $upLastModif   = $winFO->gridFO->GetCellText($upRow, 2);
    my $upPath        = $winFO->gridFO->GetCellText($upRow, 3);
    # Values to move down
    my $downFilename  = $winFO->gridFO->GetCellText($downRow, 0);
    my $downFileSize  = $winFO->gridFO->GetCellText($downRow, 1);
    my $downLastModif = $winFO->gridFO->GetCellText($downRow, 2);
    my $downPath      = $winFO->gridFO->GetCellText($downRow, 3);
    # Move values up
    $winFO->gridFO->SetCellText($downRow, 0, $upFilename);
    $winFO->gridFO->SetCellText($downRow, 1, $upFileSize);
    $winFO->gridFO->SetCellText($downRow, 2, $upLastModif);
    $winFO->gridFO->SetCellText($downRow, 3, $upPath);
    # Move values down
    $winFO->gridFO->SetCellText($upRow, 0, $downFilename);
    $winFO->gridFO->SetCellText($upRow, 1, $downFileSize);
    $winFO->gridFO->SetCellText($upRow, 2, $downLastModif);
    $winFO->gridFO->SetCellText($upRow, 3, $downPath);
    &gridFO_Click($downRow);
    $winFO->gridFO->SetSelectedCellRange($downRow, 0, $downRow, 3);
    $winFO->gridFO->Refresh();
  }
  return(1);
  
}  #--- End btnFOUp_Click

#--------------------------#
sub btnFODown_Click
#--------------------------#
{
  # Local variables
  my $downRow = ($winFO->gridFO->GetSelectedCellRange())[0];
  my $nbrRows = $winFO->gridFO->GetRows() - 1;
  my $upRow   = $downRow + 1;
  # Get selected row values
  if ($downRow < $winFO->gridFO->GetRows()) { # Not the last line
    # Values to move down
    my $downFilename  = $winFO->gridFO->GetCellText($downRow, 0);
    my $downFileSize  = $winFO->gridFO->GetCellText($downRow, 1);
    my $downLastModif = $winFO->gridFO->GetCellText($downRow, 2);
    my $downPath      = $winFO->gridFO->GetCellText($downRow, 3);
    # Values to move up
    my $upFilename    = $winFO->gridFO->GetCellText($upRow, 0);
    my $upFileSize    = $winFO->gridFO->GetCellText($upRow, 1);
    my $upLastModif   = $winFO->gridFO->GetCellText($upRow, 2);
    my $upPath        = $winFO->gridFO->GetCellText($upRow, 3);
    # Move values down
    $winFO->gridFO->SetCellText($upRow, 0, $downFilename);
    $winFO->gridFO->SetCellText($upRow, 1, $downFileSize);
    $winFO->gridFO->SetCellText($upRow, 2, $downLastModif);
    $winFO->gridFO->SetCellText($upRow, 3, $downPath);
    # Move values up
    $winFO->gridFO->SetCellText($downRow, 0, $upFilename);
    $winFO->gridFO->SetCellText($downRow, 1, $upFileSize);
    $winFO->gridFO->SetCellText($downRow, 2, $upLastModif);
    $winFO->gridFO->SetCellText($downRow, 3, $upPath);
    &gridFO_Click($upRow);
    $winFO->gridFO->SetSelectedCellRange($upRow, 0, $upRow, 3);
    $winFO->gridFO->Refresh();
  }
  return(1);
  
}  #--- End btnFODown_Click

#--------------------------#
sub btnFOOk_Click { &winFO_Terminate(); }
#--------------------------#

#--------------------------#
sub winFO_Terminate
#--------------------------#
{
  $winFO->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winFO_Terminate

#--------------------------#
sub btnLAFilters_Click
#--------------------------#
{
  &createWinLAFilters() if !$winLAFilters;
  # For create or update database, default filter type is white list
  if (!$winLAFilters->tvLAFilters->GetCount()) {
    $winLAFilters->TabSelFilters->SetCurSel(0); # White list filters
    &TabSelFilters_Click();
  } else {
    my $nbrSel = 0;
    if (my $nextNode = $winLAFilters->tvLAFilters->GetRoot()) {
      while ($nextNode) {
        if ($winLAFilters->tvLAFilters->ItemCheck($nextNode)) { $nbrSel++; }
        $nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode);
      }
    }
    if (!$nbrSel) {
      $winLAFilters->TabSelFilters->SetCurSel(0); # White list filters
      &TabSelFilters_Click();
    }
  }
  # Show Processing options window
  $winLAFilters->lblLAFiltersCaller->Text('0');
  $winLAFilters->Center($win);
  $winLAFilters->Show();
  $win->Disable();
  return(1);

}  #--- End btnLAFilters_Click

#--------------------------#
sub createWinLAFilters
#--------------------------#
{
  # Log Analysis Filters window
  $winLAFilters = Win32::GUI::Window->new(-name        => 'winLAFilters'         ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winLAFilters'}   ,
                                          -pos         => [$winPosX , $winPosY]  ,
                                          -size        => [570, 270]             ,
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      , );
  $winLAFilters->SetIcon($winICO);
  $winLAFilters->AddLabel(    -name         => 'lblLogo'               ,
                              -size         => [128,128]               ,
                              -pos          => [  5,  5]               ,
                              -bitmap       => $filterList128          ,
                              -background   => [255, 255, 255]         , );
  $winLAFilters->AddTabStrip( -name         => 'TabSelFilters'         ,
                              -size         => [$winWidth-154,413]     ,
                              -pos          => [140,  0]               ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       ,
                              -background => [255, 255, 255]         , );
  $winLAFilters->TabSelFilters->InsertItem(-text => $STR{'WhiteList'}, );
  $winLAFilters->TabSelFilters->InsertItem(-text => $STR{'Regular'}  , );
  $winLAFilters->TabSelFilters->InsertItem(-text => $STR{'IpList'}   , );
  $winLAFilters->AddLabel(    -name         => 'lblLAFiltersSel'       ,
                              -size         => [ 10, 22]               ,
                              -pos          => [ 10,170]               ,
                              -visible      => 0                       , ); # Hidden, not null if any item is selected
  $winLAFilters->AddLabel(    -name         => 'lblLAFiltersCaller'    ,
                              -size         => [ 10, 22]               ,
                              -pos          => [ 10,190]               ,
                              -visible      => 0                       , ); # Hidden, Caller: Create/Update (0), Query (1)
  $winLAFilters->AddTreeView( -name         => 'tvLAFilters'           ,
                              -size         => [400,200]               ,
                              -pos          => [145, 35]               ,
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -rootlines    => 1                       ,
                              -lines        => 1                       ,
                              -checkboxes   => 1                       ,
                              -buttons      => 1                       ,
                              -tabstop      => 1                       , );
  $winLAFilters->AddButton(   -name         => 'btnLAFiltersAdd'       ,
                              -size         => [ 22, 22]               ,
                              -pos          => [205, 35]               ,
                              -bitmap       => $filterAdd              ,
                              -tabstop      => 1                       , );
  $winLAFilters->AddButton(   -name         => 'btnLAFiltersEdit'      ,
                              -size         => [ 22, 22]               ,
                              -pos          => [205, 58]               ,
                              -bitmap       => $filterEdit             ,
                              -disabled     => 1                       ,
                              -tabstop      => 1                       , );
  $winLAFilters->AddButton(   -name         => 'btnLAFiltersDel'       ,
                              -size         => [ 22, 22]               ,
                              -pos          => [205, 81]               ,
                              -bitmap       => $filterDel              ,
                              -disabled     => 1                       ,
                              -tabstop      => 1                       , );
  $winLAFilters->AddTextfield(-name         => 'tfLAFiltersIPList'     ,
                              -size         => [400,200]               ,
                              -pos          => [145, 35]               ,
                              -multiline    => 1                       ,
                              -wantreturn   => 1                       ,
                              -vscroll      => 1                       ,
                              -autohscroll  => 1                       ,
                              -tabstop      => 1                       ,
                              -visible      => 0                       , );
  $winLAFilters->AddButton(   -name         => 'btnLAFiltersOk'        ,
                              -text         => $STR{'Ok'}              ,
                              -size         => [ 60, 30]               ,
                              -pos          => [$winWidth/2,215]       ,
                              -font         => $font10                 ,
                              -ok           => 1                       ,
                              -default      => 1                       ,
                              -tabstop      => 1                       , );

}  #--- End createWinLAFilters

#--------------------------#
sub TabSelFilters_Click
#--------------------------#
{
  # Local variables
  my $filterTypeStr = $winLAFilters->TabSelFilters->GetString($winLAFilters->TabSelFilters->SelectedItem());
  # White list tab
  if ($filterTypeStr eq $STR{'WhiteList'}) {
    $winLAFilters->tvLAFilters->Show();
    $winLAFilters->btnLAFiltersAdd->Show();
    $winLAFilters->btnLAFiltersEdit->Show();
    $winLAFilters->btnLAFiltersDel->Show();
    $winLAFilters->tvLAFilters->DeleteAllItems();
    &loadLAFilterSetDB(1, $CONFIG{'LAFILTERS_DB_FILE'}, \$winFilterSet, \$win, \$winLAFilters, \%STR);
    $winLAFilters->tfLAFiltersIPList->Hide();
  # Regular filters tab
  } elsif ($filterTypeStr eq $STR{'Regular'}) {
    $winLAFilters->tvLAFilters->Show();
    $winLAFilters->btnLAFiltersAdd->Show();
    $winLAFilters->btnLAFiltersEdit->Show();
    $winLAFilters->btnLAFiltersDel->Show();
    $winLAFilters->tvLAFilters->DeleteAllItems();
    &loadLAFilterSetDB(0, $CONFIG{'LAFILTERS_DB_FILE'}, \$winFilterSet, \$win, \$winLAFilters, \%STR);
    $winLAFilters->tfLAFiltersIPList->Hide();
  # IP list tab
  } else {
    $winLAFilters->tfLAFiltersIPList->Show();
    $winLAFilters->tvLAFilters->Hide();
    $winLAFilters->btnLAFiltersAdd->Hide();
    $winLAFilters->btnLAFiltersEdit->Hide();
    $winLAFilters->btnLAFiltersDel->Hide();
  }
  
}  #--- End TabSelFilters_Click

#--------------------------#
sub winLAFilters_Resize
#--------------------------#
{
  $winLAFilters->TabSelFilters->Width($winLAFilters->ScaleWidth()-138);
  $winLAFilters->TabSelFilters->Height($winLAFilters->ScaleHeight()+1);
  $winLAFilters->tvLAFilters->Width($winLAFilters->ScaleWidth()-172);
  $winLAFilters->tvLAFilters->Height($winLAFilters->ScaleHeight()-75);
  $winLAFilters->btnLAFiltersAdd->Left($winLAFilters->ScaleWidth()-25);
  $winLAFilters->btnLAFiltersEdit->Left($winLAFilters->ScaleWidth()-25);
  $winLAFilters->btnLAFiltersDel->Left($winLAFilters->ScaleWidth()-25);
  $winLAFilters->tfLAFiltersIPList->Width($winLAFilters->ScaleWidth()-152);
  $winLAFilters->tfLAFiltersIPList->Height($winLAFilters->ScaleHeight()-75);
  # Buttons
  $winLAFilters->btnLAFiltersOk->Left($winLAFilters->ScaleWidth()/2+30);
  $winLAFilters->btnLAFiltersOk->Top($winLAFilters->ScaleHeight()-35);
  
}  #--- End winLAFilters_Resize

#--------------------------#
sub btnLAFiltersOk_Click
#--------------------------#
{
  # Enumerate filters and dependencies
  my ($refFilterSets, $nbrFilterSets, $filterISP, $filterGeoIP, $filterUA,
      $filterWeekday, $whiteList) = &getSelFilterSets($winConfig->tfLAFiltersDB->Text(), \$winLAFilters, \%STR);
  # Create / Update Log Analysis database
  if (!$winLAFilters->lblLAFiltersCaller->Text()) {
    $win->chLAOptResISP->Checked(1)     if $filterISP     and !$win->lblCurrDBNbrResISPVal->Text();
    $win->chLAOptResGeoIP->Checked(1)   if $filterGeoIP   and !$win->lblCurrDBNbrResGeoIPVal->Text();
    $win->chLAOptResUA->Checked(1)      if $filterUA      and !$win->lblCurrDBResUAsVal->Text();
    $win->chLAOptResWeekday->Checked(1) if $filterWeekday and !$win->lblCurrDBResWDsVal->Text();
  # Query
  } else {
    my $SQLQuery = $win->tfLAQuery->Text();
    my $startQuery;
    my $endQuery;
    if ($SQLQuery =~ /^(SELECT.+FROM LOG) WHERE.+ ((?:GROUP BY|ORDER BY|HAVING COUNT).+)/) {
      $startQuery = $1;
      $endQuery   = $2;
    } elsif ($SQLQuery =~ /^(SELECT.+FROM LOG)/) { $startQuery = $1; }
    if ($startQuery) {
      my $timezone   = $winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'});
      $SQLQuery  = $startQuery;
      $SQLQuery  = &filtersAsSQLStr($refFilterSets, $SQLQuery.' WHERE ', $timezone, \%STR) if $nbrFilterSets;
      $SQLQuery .= $endQuery if $endQuery;
      $win->tfLAQuery->Text($SQLQuery);
    }
    &tfLAQuery_Change();
  }
  $winLAFilters->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(1);
 
}  #--- End btnLAFiltersOk_Click

#--------------------------#
sub winLAFilters_Terminate
#--------------------------#
{
  $winLAFilters->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winLAFilters_Terminate

#--------------------------#
sub rbDestDBCurr_Click
#--------------------------#
{
  $win->lblDestLADB->Hide();
  $win->tfDestDir->Hide();
  $win->btnDestDir->Hide();
  $win->chLASelectDB->Hide();
  &isProcessReady(0);

}  #--- End rbDestDBCurr_Click

#--------------------------#
sub rbDestDBNew_Click
#--------------------------#
{
  $win->lblDestLADB->Show();
  $win->tfDestDir->Show();
  $win->btnDestDir->Show();
  $win->chLASelectDB->Show();
  &isProcessReady(0);

}  #--- End rbDestDBNew_Click

#--------------------------#
sub btnLAQuerySelectCols_Click
#--------------------------#
{
  &createWinLAQueryCols() if !$winLAQueryCols;
  # Show Processing options window
  $winLAQueryCols->Center($win);
  $winLAQueryCols->Show();
  $win->Disable();
  return(1);

}  #--- End btnLAQuerySelectCols_Click

#--------------------------#
sub createWinLAQueryCols
#--------------------------#
{
  # Log Analysis - Select Columns window
  $winLAQueryCols = Win32::GUI::Window->new(-name        => 'winLAQueryCols'       ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'SelectColumn'}   ,
                                            -pos         => [$winPosX, $winPosY]   ,
                                            -size        => [300, 417]             ,
                                            -hasmaximize => 0                      ,
                                            -hasminimize => 0                      ,
                                            -resizable   => 0                      ,
                                            -dialogui    => 1                      , );
  $winLAQueryCols->SetIcon($winICO);
  $winLAQueryCols->AddCheckbox(   -name         => 'chLAQueryColsDistinct' ,
                                  -size         => [ 80, 22]               ,
                                  -pos          => [  5,  5]               ,
                                  -text         => 'DISTINCT'              ,
                                  -background   => [255, 255, 255]         ,
                                  -font         => $font10                 ,
                                  -checked      => 0                       ,
                                  -tabstop      => 1                       , );
  $winLAQueryCols->AddRadioButton(-name         => 'rbLAQueryColsAll'      ,
                                  -size         => [ 70, 22]               ,
                                  -pos          => [  5, 30]               ,
                                  -background   => [255, 255, 255]         ,
                                  -text         => "$STR{'All'} (*)"       ,
                                  -font         => $font10                 ,
                                  -group        => 1                       ,
                                  -checked      => 1                       ,
                                  -tabstop      => 1                       , );
  $winLAQueryCols->AddCheckbox(   -name         => 'chLAQueryColsAllCount' ,
                                  -size         => [ 80, 22]               ,
                                  -pos          => [ 80, 31]               ,
                                  -text         => $STR{'Count'}           ,
                                  -background   => [255, 255, 255]         ,
                                  -font         => $font10                 ,
                                  -tabstop      => 1                       , );
  $winLAQueryCols->AddRadioButton(-name         => 'rbLAQueryColsSel'      ,
                                  -size         => [150, 22]               ,
                                  -pos          => [  5, 55]               ,
                                  -background   => [255, 255, 255]         ,
                                  -text         => $STR{'SelectColumn'}.':',
                                  -font         => $font10                 ,
                                  -tabstop      => 1                       , );
  $winLAQueryCols->AddGrid(       -name         => 'gridLAQueryCols'       ,
                                  -size         => [260,259]               ,
                                  -pos          => [ 20, 85]               ,
                                  -background   => [255, 255, 255]         ,
                                  -columns      => 3                       ,
                                  -rows         => 11                      ,
                                  -fixedrows    => 1                       ,
                                  -fixedcolumns => 1                       ,
                                  -editable     => 0                       ,
                                  -tabstop      => 1                       , );
  $winLAQueryCols->gridLAQueryCols->SetRowResize(0);
  $winLAQueryCols->gridLAQueryCols->SetColumnResize(0);
  $winLAQueryCols->gridLAQueryCols->SetCellFormat(0, 1, 1);
  $winLAQueryCols->gridLAQueryCols->SetCellFormat(0, 2, 1);
  $winLAQueryCols->gridLAQueryCols->SetCellText(0, 1, $STR{'Count'}  );
  $winLAQueryCols->gridLAQueryCols->SetCellText(0, 2, $STR{'Columns'});
  for (my $i = 1; $i < 11; $i++) {
    $winLAQueryCols->gridLAQueryCols->SetCellType($i, 0, 4);
    $winLAQueryCols->gridLAQueryCols->SetCellType($i, 1, 4);
  }
  $winLAQueryCols->gridLAQueryCols->SetCellText( 1, 2, $STR{'LFclientIP'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 2, 2, $STR{'DTDB'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 3, 2, $STR{'LFHTTPmethod'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 4, 2, $STR{'LFHTTPreq'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 5, 2, $STR{'LFHTTPparam'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 6, 2, $STR{'LFHTTPprot'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 7, 2, $STR{'LFHTTPstatus'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 8, 2, $STR{'LFsize'});
  $winLAQueryCols->gridLAQueryCols->SetCellText( 9, 2, $STR{'LFReferer'});
  $winLAQueryCols->gridLAQueryCols->SetCellText(10, 2, $STR{'LFUA'});
  $winLAQueryCols->gridLAQueryCols->AutoSize();
  $winLAQueryCols->gridLAQueryCols->ExpandLastColumn();
  $winLAQueryCols->AddButton( -name     => 'btnLAQueryColsOk',
                              -text     => $STR{'Ok'}        ,
                              -size     => [ 60, 30]         ,
                              -pos      => [120,352]         ,
                              -font     => $font10           ,
                              -ok       => 1                 ,
                              -default  => 1                 , );

}  #--- End createWinLAQueryCols

#--------------------------#
sub rbLAQueryColsAll_Click
#--------------------------#
{
  # Uncheck all
  for (my $i = 1; $i < 12; $i++) {
    $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 0, 0);
    $winLAQueryCols->gridLAQueryCols->SetCellCheck($i, 1, 0);
  }

}  #--- End rbLAQueryColsAll_Click

#--------------------------#
sub gridLAQueryCols_Click
#--------------------------#
{
  # Check or uncheck
  my ($row, $col) = @_;
  if ($row and $col < 2) {
    if ($winLAQueryCols->gridLAQueryCols->GetCellCheck($row, $col)) {
      $winLAQueryCols->gridLAQueryCols->SetCellCheck($row, $col, 0);
    } else { $winLAQueryCols->gridLAQueryCols->SetCellCheck($row, $col, 1); }
  }
  $winLAQueryCols->rbLAQueryColsAll->Checked(0);
  $winLAQueryCols->rbLAQueryColsSel->Checked(1);
  return(1);

}  #--- End gridLAQueryCols_Click

#--------------------------#
sub btnLAQueryColsOk_Click
#--------------------------#
{
  # Local variables
  my $SQLQuery = $win->tfLAQuery->Text();
  my $kept;
  $kept = $1 if $SQLQuery =~ /^SELECT.+FROM LOG( WHERE.+)/;
  $SQLQuery  = 'SELECT ';
  $SQLQuery .= 'DISTINCT ' if $winLAQueryCols->chLAQueryColsDistinct->Checked();
  my $columns;
  # All columns
  if ($winLAQueryCols->rbLAQueryColsAll->Checked()) {
    if ($winLAQueryCols->chLAQueryColsAllCount->Checked()) { $columns = 'COUNT(*) '; }
    else { $columns = '* '; }
  # Selected columns
  } else {
    for (my $i = 1; $i < 12; $i++) {
      if ($winLAQueryCols->gridLAQueryCols->GetCellCheck($i, 0)) {
        if ($winLAQueryCols->gridLAQueryCols->GetCellCheck($i, 1)) {
          my $colStr = $winLAQueryCols->gridLAQueryCols->GetCellText($i, 2);
          $colStr = 'datetimeInt' if $colStr eq $STR{'DTDB'};
          $columns .= 'COUNT('.$colStr.'),';
        } else {
          my $colStr = $winLAQueryCols->gridLAQueryCols->GetCellText($i, 2);
          $colStr = 'datetimeInt' if $colStr eq $STR{'DTDB'};
          $columns .= $colStr.',';
        }
      }
    }
    if ($columns) { chop($columns); $columns .= ' '; }
  }
  if ($columns) {
    $SQLQuery .= $columns;
    $SQLQuery .= 'FROM LOG';
    $SQLQuery .= $kept if $kept;
    $win->tfLAQuery->Text($SQLQuery);
    &tfLAQuery_Change();
    $winLAQueryCols->Hide();
    $win->Enable();
    $win->BringWindowToTop();
  } else { Win32::GUI::MessageBox($win, $STR{'noColumnSel'}, $STR{'error'}, 0x40010); }
  return(1);
  
}  #--- End btnLAQueryColsOk_Click

#--------------------------#
sub winLAQueryCols_Terminate
#--------------------------#
{
  $winLAQueryCols->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winLAQueryCols_Terminate

#--------------------------#
sub btnLAQueryFilter_Click
#--------------------------#
{
  &createWinLAFilters() if !$winLAFilters;
  # Default filter type is regular
  if (!$winLAFilters->tvLAFilters->GetCount()) {
    $winLAFilters->TabSelFilters->SetCurSel(1); # Regular filters
    &TabSelFilters_Click();
  } else {
    my $nbrSel = 0;
    if (my $nextNode = $winLAFilters->tvLAFilters->GetRoot()) {
      while ($nextNode) {
        $nbrSel++ if $winLAFilters->tvLAFilters->ItemCheck($nextNode);
        $nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode);
      }
    }
    if (!$nbrSel) {
      $winLAFilters->tvLAFilters->DeleteAllItems();
      $winLAFilters->TabSelFilters->SetCurSel(1); # Regular filters
      &TabSelFilters_Click();
    }
  }
  # Show Processing options window
  $winLAFilters->lblLAFiltersCaller->Text('1');
  $winLAFilters->Center($win);
  $winLAFilters->Show();
  $win->Disable();
  return(1);

}  #--- End btnLAQueryFilter_Click

#--------------------------#
sub chLAQueryGroupBy_Click
#--------------------------#
{
  if ($win->chLAQueryGroupBy->Checked()) {
    $win->cbLAQueryGroupByCol->Enable();
    $win->btnLAQueryGroupByAdd->Enable();
  } else {
    $win->cbLAQueryGroupByCol->Disable();
    $win->btnLAQueryGroupByAdd->Disable();
  }

}  #--- End chLAQueryGroupBy_Click

#--------------------------#
sub btnLAQueryGroupByAdd_Click
#--------------------------#
{
  # Local variables
  my @colNames = ('remoteIP', 'datetimeInt', 'timeOfDay', 'weekday', 'http_method', 'http_request', 'http_params',
                  'http_protocol', 'http_status', 'size', 'referer', 'useragent');
  my $selCol   = $win->cbLAQueryGroupByCol->GetCurSel();
  my $SQLQuery = $win->tfLAQuery->Text();
  my $havingCount;
  my $orderBy;
  if ($SQLQuery =~ /( ORDER BY [^ ]+ [^ ]+)/) {
    $orderBy  = $1;
    $SQLQuery =~ s/ ORDER BY [^ ]+ [^ ]+//;
  }
  if ($SQLQuery =~ /( HAVING COUNT[^ ]+ [^ ]+ [^ ]+)/) {
    $havingCount = $1;
    $SQLQuery    =~ s/ HAVING COUNT[^ ]+ [^ ]+ [^ ]+//;
  }
  if ($SQLQuery =~ /GROUP BY ([^ ]+)/) {
    my $currSel = $1;
    $currSel   .= ','.$colNames[$selCol];
    $SQLQuery   =~ s/GROUP BY ([^ ]+)/GROUP BY $currSel/;
  } else { $SQLQuery   .= ' GROUP BY '.$colNames[$selCol]; }
  $SQLQuery .= $havingCount if $havingCount;
  $SQLQuery .= $orderBy     if $orderBy;
  $win->tfLAQuery->Text($SQLQuery);
  $win->chLAQueryGroupBy->Checked(0);
  $win->cbLAQueryGroupByCol->Disable();
  $win->btnLAQueryGroupByAdd->Disable();

}  #--- End btnLAQueryGroupByAdd_Click

#--------------------------#
sub chLAQueryOrderBy_Click
#--------------------------#
{
  if ($win->chLAQueryOrderBy->Checked()) {
    $win->cbLAQueryOrderByCol->Enable();
    $win->cbLAQueryOrderBy->Enable();
    $win->btnLAQueryOrderByAdd->Enable();
  } else {
    $win->cbLAQueryOrderByCol->Disable();
    $win->cbLAQueryOrderBy->Disable();
    $win->btnLAQueryOrderByAdd->Disable();
  }

}  #--- End chLAQueryOrderBy_Click

#--------------------------#
sub btnLAQueryOrderByAdd_Click
#--------------------------#
{
  # Local variables
  my @colNames = ('remoteIP', 'datetimeInt', 'weekday', 'http_method', 'http_request', 'http_params',
                  'http_protocol', 'http_status', 'size', 'referer', 'useragent');
  my $selCol   = $win->cbLAQueryOrderByCol->GetCurSel();
  my $order    = $win->cbLAQueryOrderBy->GetString($win->cbLAQueryOrderBy->GetCurSel());
  my $SQLQuery = $win->tfLAQuery->Text();
  my $havingCount;
  my $groupBy;
  if ($SQLQuery =~ /( GROUP BY [^ ]+)/) {
    $groupBy  = $1;
    $SQLQuery =~ s/ GROUP BY [^ ]+//;
  }
  if ($SQLQuery =~ /( HAVING COUNT[^ ]+ [^ ]+ [^ ]+)/) {
    $havingCount = $1;
    $SQLQuery    =~ s/ HAVING COUNT[^ ]+ [^ ]+ [^ ]+//;
  }
  $SQLQuery .= $groupBy     if $groupBy;
  $SQLQuery .= $havingCount if $havingCount;
  if ($SQLQuery =~ /ORDER BY ([^ ]+) [^ ]+/) {
    my $currSel = $1;
    $SQLQuery   =~ s/ ORDER BY [^ ]+ [^ ]+//;
    $currSel   .= ','.$colNames[$selCol];
    $SQLQuery  .= ' ORDER BY '.$currSel.' '.$order;
  } else { $SQLQuery .= ' ORDER BY '.$colNames[$selCol].' '.$order; }
  $win->tfLAQuery->Text($SQLQuery);
  $win->chLAQueryOrderBy->Checked(0);
  $win->cbLAQueryOrderByCol->Disable();
  $win->cbLAQueryOrderBy->Disable();
  $win->btnLAQueryOrderByAdd->Disable();

}  #--- End btnLAQueryOrderByAdd_Click

#--------------------------#
sub chLAQueryHavingCount_Click
#--------------------------#
{
  if ($win->chLAQueryHavingCount->Checked()) {
    $win->cbLAQueryHavingCountCol->Enable();
    $win->cbLAQueryHavingCount->Enable();
    $win->tfLAQueryHavingCount->Enable();
    $win->btnLAQueryHavingCountAdd->Enable();
  } else {
    $win->cbLAQueryHavingCountCol->Disable();
    $win->cbLAQueryHavingCount->Disable();
    $win->tfLAQueryHavingCount->Disable();
    $win->btnLAQueryHavingCountAdd->Disable();
  }

}  #--- End chLAQueryHavingCount_Click

#--------------------------#
sub btnLAQueryHavingCountAdd_Click
#--------------------------#
{
  if (my $number = $win->tfLAQueryHavingCount->Text()) {
    my @colNames = ('remoteIP', 'datetimeInt', 'timeOfDay', 'weekday', 'http_method', 'http_request', 'http_params',
                    'http_protocol', 'http_status', 'size', 'referer', 'useragent');
    my $selCol   = $win->cbLAQueryHavingCountCol->GetCurSel();
    my $operator = $win->cbLAQueryHavingCount->GetString($win->cbLAQueryHavingCount->GetCurSel());
    my $SQLQuery = $win->tfLAQuery->Text();
    my $groupBy;
    my $orderBy;
    if ($SQLQuery =~ /( GROUP BY [^ ]+)/) {
      $groupBy  = $1;
      $SQLQuery =~ s/ GROUP BY [^ ]+//;
    }
    if ($SQLQuery =~ /( ORDER BY [^ ]+ [^ ]+)/) {
      $orderBy  = $1;
      $SQLQuery =~ s/ ORDER BY [^ ]+ [^ ]+//;
    }
    $SQLQuery .= $groupBy if $groupBy;
    if ($SQLQuery =~ /HAVING COUNT[^ ]+ [^ ]+ [^ ]+/) {
      $SQLQuery =~ s/ HAVING COUNT[^ ]+ [^ ]+ [^ ]+//;
      $SQLQuery .= ' HAVING COUNT('.$colNames[$selCol].') '.$operator.' '.$number;
    } else { $SQLQuery .= ' HAVING COUNT('.$colNames[$selCol].') '.$operator.' '.$number; }
    $SQLQuery .= $orderBy if $orderBy;
    $win->tfLAQuery->Text($SQLQuery);
    $win->chLAQueryHavingCount->Checked(0);
    $win->cbLAQueryHavingCountCol->Disable();
    $win->cbLAQueryHavingCount->Disable();
    $win->btnLAQueryHavingCountAdd->Disable();
  }

}  #--- End btnLAQueryHavingCountAdd_Click

#--------------------------#
sub btnLAQuerySelectSaved_Click
#--------------------------#
{
  &createWinLASavedQueries() if !$winLASavedQueries;
  # Show Processing options window
  $winLASavedQueries->Center($win);
  $winLASavedQueries->Show();
  $win->Disable();
  return(1);

}  #--- End btnLAQuerySelectSaved_Click

#--------------------------#
sub createWinLASavedQueries
#--------------------------#
{
  # Log Analysis - Select Saved Queries window
  $winLASavedQueries = Win32::GUI::Window->new( -name        => 'winLASavedQueries'    ,
                                                -background  => [255, 255, 255]        ,
                                                -parent      => $win                   ,
                                                -text        => $STR{'SelectSaved'}    ,
                                                -pos         => [$winPosX, $winPosY]   ,
                                                -size        => [800, 300]             ,
                                                -hasmaximize => 1                      ,
                                                -hasminimize => 1                      ,
                                                -resizable   => 1                      ,
                                                -dialogui    => 1                      , );
  $winLASavedQueries->SetIcon($winICO);
  $winLASavedQueries->AddGrid(    -name         => 'gridQueries'  ,
                                  -pos          => [  5,  5]      ,
                                  -size         => [780,260]      ,
                                  -background   => [255, 255, 255],
                                  -columns      => 5              ,
                                  -fixedrows    => 1              ,
                                  -fixedcolumns => 0              ,
                                  -editable     => 0              , );
  $winLASavedQueries->gridQueries->SetListMode(1);
  # Popup menu for Saved Queries grid
  $gridLASavedQueriesMenu = new Win32::GUI::Menu(
    'gridLASavedQueriesMenu' => 'gridLASavedQueriesMenu',
    "> $STR{'Edit'}"         => 'savedQueriesEdit'      ,
    "> $STR{'Delete'}"       => 'savedQueriesDelete'    ,
  );
  # Saved Queries grid header
  $winLASavedQueries->gridQueries->SetCellText(0, 0, $STR{'Category'});
  $winLASavedQueries->gridQueries->SetCellText(0, 1, $STR{'Name'}    );
  $winLASavedQueries->gridQueries->SetCellText(0, 2, $STR{'used'}    );
  $winLASavedQueries->gridQueries->SetCellText(0, 3, $STR{'Date'}    );
  $winLASavedQueries->gridQueries->SetCellText(0, 4, $STR{'Query'}   );
  $winLASavedQueries->gridQueries->SetCellFormat(0, 0, 1);
  $winLASavedQueries->gridQueries->SetCellFormat(0, 1, 1);
  $winLASavedQueries->gridQueries->SetCellFormat(0, 2, 1);
  $winLASavedQueries->gridQueries->SetCellFormat(0, 3, 1);
  $winLASavedQueries->gridQueries->AutoSize();
  $winLASavedQueries->gridQueries->ExpandLastColumn();
  &loadSavedQueriesDB($CONFIG{'SAVED_QUERIES_DB_FILE'}, \$winLASavedQueries, \$win, \%STR) if $CONFIG{'SAVED_QUERIES_DB_FILE'};
  
}  #--- End createWinLASavedQueries

#--------------------------#
sub winLASavedQueries_Resize
#--------------------------#
{
  $winLASavedQueries->gridQueries->Width($winLASavedQueries->ScaleWidth()-10);
  $winLASavedQueries->gridQueries->Height($winLASavedQueries->ScaleHeight()-10);
  $winLASavedQueries->gridQueries->AutoSize();
  $winLASavedQueries->gridQueries->ExpandLastColumn();
  my $sortedCol = $winLASavedQueries->gridQueries->GetSortColumn();
  my $currWidth = $winLASavedQueries->gridQueries->GetColumnWidth($sortedCol);
  $winLASavedQueries->gridQueries->SetColumnWidth($sortedCol, $currWidth+15);
  return(0);

}  #--- End winLASavedQueries_Resize

#--------------------------#
sub gridQueries_Click
#--------------------------#
{
  my ($row, $column) = @_;
  # Sort grid
  if (!$row) {
    $winLASavedQueries->gridQueries->SetHeaderSort();
    my $order = $winLASavedQueries->gridQueries->GetSortAscending();
    $winLASavedQueries->gridQueries->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); });
    $winLASavedQueries->gridQueries->AutoSize();
    $winLASavedQueries->gridQueries->ExpandLastColumn();
    $winLASavedQueries->gridQueries->Refresh();
    my $currWidth = $winLASavedQueries->gridQueries->GetColumnWidth($column);
    $winLASavedQueries->gridQueries->SetColumnWidth($column, $currWidth+15);
  }
  
}   #--- End gridQueries_Click

#--------------------------#
sub gridQueries_DblClick
#--------------------------#
{
  my ($row, $column) = @_;
  # Select query
  if ($row) {
    my $SQLQuery = $winLASavedQueries->gridQueries->GetCellText($row, 4);
    $win->tfLAQuery->Text($SQLQuery) if $SQLQuery;
    &tfLAQuery_Change();
    &winLASavedQueries_Terminate();
  }
  
}   #--- End gridQueries_DblClick

#--------------------------#
sub gridQueries_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my (@coord) = $winLASavedQueries->gridQueries->GetSelectedCellRange();
  # Select the right entry if not selected or select has change
  $winLASavedQueries->gridQueries->SetSelectedCellRange($row, 0, $row, 5)
  if (($coord[0] and ($row < $coord[0])) or ($coord[2] and ($row > $coord[2])) or !$coord[0]);
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winLASavedQueries->TrackPopupMenu($gridLASavedQueriesMenu->{gridLASavedQueriesMenu},$X,$Y);

}  #--- End gridQueries_RClick

#--------------------------#
sub savedQueriesEdit_Click
#--------------------------#
{
  # Local variables
  my $row = ($winLASavedQueries->gridQueries->GetSelectedCellRange())[0];
  my ($queryCat, $queryName, $query);
  if ($row != 0) {
    $queryCat  = $winLASavedQueries->gridQueries->GetCellText($row, 0);
    $queryName = $winLASavedQueries->gridQueries->GetCellText($row, 1);
    $query     = $winLASavedQueries->gridQueries->GetCellText($row, 4);
  }
  if (!$winSaveQuery) { &createWinSaveQuery(); }
  $winSaveQuery->lblSQLQueryEditRow->Text($row);
  $winSaveQuery->tfSQLQueryName->Text($queryName);
  $winSaveQuery->cbSQLQueryCat->Clear();
  # Feed category combobox
  if (my $savedQueriesDB = $CONFIG{'SAVED_QUERIES_DB_FILE'}) {
    if ($savedQueriesDB and -f $savedQueriesDB and &validSavedQueriesDB($savedQueriesDB)) {
      my $dsn = "DBI:SQLite:dbname=$savedQueriesDB";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1 })) {
        my $all = $dbh->selectall_arrayref('SELECT DISTINCT cat FROM QUERIES ORDER BY cat ASC');
        foreach my $row (@$all) { $winSaveQuery->cbSQLQueryCat->AddString(@$row[0]); }
      }
    }
  }
  $winSaveQuery->cbSQLQueryCat->Text($queryCat);
  $winSaveQuery->tfSQLQuery->Text($query);
  $winSaveQuery->tfSQLQuery->Enable();
  $winSaveQuery->Center($winLASavedQueries);
  $winSaveQuery->Show();
  $winSaveQuery->btnSQLQueryOk->Enable();
  $winLASavedQueries->Disable();

}  #--- End savedQueriesEdit_Click

#--------------------------#
sub savedQueriesDelete_Click
#--------------------------#
{
  # Local variables
  my (@coord)        = $winLASavedQueries->gridQueries->GetSelectedCellRange();
  my $nbrEntries     = $winLASavedQueries->gridQueries->GetRows()-1;
  my $savedQueriesDB = $CONFIG{'SAVED_QUERIES_DB_FILE'};
  my %Entries2del;
  # Select queries to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winLASavedQueries->gridQueries->IsCellSelected($row, 0)) {
      $Entries2del{$row}{cat}  = $winLASavedQueries->gridQueries->GetCellText($row, 0);
      $Entries2del{$row}{name} = $winLASavedQueries->gridQueries->GetCellText($row, 1);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winLASavedQueries->gridQueries->Refresh();
      # Status bar
      &winPb_Terminate;
      $winLASavedQueries->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrEntries2del = (keys %Entries2del);
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winLASavedQueries);
    $winPb->Show();
    $winLASavedQueries->Disable();
    $winLASavedQueries->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$savedQueriesDB";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 0, AutoCommit => 1 })) {
      # Loop each entry and delete
      my $j = 0;
      foreach my $row (sort {$b <=> $a} keys %Entries2del) {
        if ($Entries2del{$row}{cat} and $Entries2del{$row}{name}) {
          # Delete entry in DB
          # Database: table = QUERIES, Fields = name, cat, query, used, time
          my $sth = $dbh->prepare('DELETE FROM QUERIES where cat = ? and name = ?');
          my $rv  = $sth->execute($Entries2del{$row}{cat}, $Entries2del{$row}{name});
          if ($rv < 0) { Win32::GUI::MessageBox($winLASavedQueries, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else {
            # Find the entry in grid and delete
            my $currCat  = $winLASavedQueries->gridQueries->GetCellText($row, 0);
            my $currName = $winLASavedQueries->gridQueries->GetCellText($row, 1);
            $winLASavedQueries->gridQueries->DeleteRow($row) if $Entries2del{$row}{cat} eq $currCat and $Entries2del{$row}{name} eq $currName;
          }
        }
        $j++;
        $winPb->lblCount->Text("$j / $nbrEntries2del");
        $winPb->pbWinPb->StepIt();
      }
      $dbh->disconnect();
    } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
    $winLASavedQueries->ChangeCursor($ARROW);
    &winPb_Terminate;
    $winLASavedQueries->gridQueries->AutoSize();
    $winLASavedQueries->gridQueries->ExpandLastColumn();
    $winLASavedQueries->gridQueries->Refresh();
    my $sortedCol = $winLASavedQueries->gridQueries->GetSortColumn();
    my $currWidth = $winLASavedQueries->gridQueries->GetColumnWidth($sortedCol);
    $winLASavedQueries->gridQueries->SetColumnWidth($sortedCol, $currWidth+15);
  });
  return(1);

}  #--- End savedQueriesDelete_Click

#--------------------------#
sub winLASavedQueries_Terminate
#--------------------------#
{
  $winLASavedQueries->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winLASavedQueries_Terminate

#--------------------------#
sub btnLAQueryEdit_Click { $win->tfLAQuery->Enable(); }
#--------------------------#

#--------------------------#
sub btnLAQueryReset_Click
#--------------------------#
{
  $win->tfLAQuery->Text('');
  $win->tfLAQuery->Disable();
  &tfLAQuery_Change();
  
}   #--- End btnLAQueryReset_Click

#--------------------------#
sub createWinSaveQuery
#--------------------------#
{
  # Create or Edit a SQL Query window
  $winSaveQuery = Win32::GUI::Window->new(-name        => 'winSaveQuery'         ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $winLASavedQueries     ,
                                          -text        => $STR{'winSaveQuery'}   ,
                                          -pos         => [$winPosX , $winPosY]  ,
                                          -size        => [800, 220]             ,
                                          -minsize     => [800, 220]             ,
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      , );
  $winSaveQuery->SetIcon($winICO);
  $winSaveQuery->AddLabel(      -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  5,  5]               ,
                                -bitmap       => $queryDB128             ,
                                -background   => [255, 255, 255]         , );
  # Create or edit SQL Query
  $winSaveQuery->AddLabel(      -name         => 'lblSQLQueryEditRow'   ,
                                -size         => [ 10, 22]               ,
                                -pos          => [757,  8]               ,
                                -visible      => 0                       , );
  $winSaveQuery->AddLabel(      -name         => 'lblSQLQueryName'       ,
                                -size         => [ 80, 22]               ,
                                -pos          => [140, 13]               ,
                                -text         => $STR{'Name'}.':'        ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winSaveQuery->AddTextfield(  -name         => 'tfSQLQueryName'        ,
                                -size         => [240, 22]               ,
                                -pos          => [225, 10]               ,
                                -tabstop      => 1                       , );
  $winSaveQuery->AddLabel(      -name         => 'lblSQLQueryCat'        ,
                                -size         => [ 80, 22]               ,
                                -pos          => [140, 43]               ,
                                -text         => $STR{'Category'}.':'    ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winSaveQuery->AddCombobox(   -name         => 'cbSQLQueryCat'         ,
                                -size         => [240, 50]               ,
                                -pos          => [225, 40]               ,
                                -dropdown     => 1                       ,
                                -tabstop      => 1                       , );
  $winSaveQuery->AddLabel(      -name         => 'lblSQLQuery'           ,
                                -size         => [ 80, 22]               ,
                                -pos          => [140, 73]               ,
                                -text         => $STR{'Query'}.':'       ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winSaveQuery->AddTextfield(  -name         => 'tfSQLQuery'            ,
                                -size         => [500, 44]               ,
                                -pos          => [225, 70]               ,
                                -font         => $font10                 ,
                                -multiline    => 1                       ,
                                -wantreturn   => 1                       ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winSaveQuery->AddButton(     -name         => 'btnSQLQueryOk'         ,
                                -size         => [100, 30]               ,
                                -pos          => [260,335]               ,
                                -text         => $STR{'SetAddFilter'}    ,
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winSaveQuery->AddButton(     -name         => 'btnSQLQueryCancel'     ,
                                -size         => [100, 30]               ,
                                -pos          => [370,335]               ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );
  # Autocomplete function
  $winSaveQuery->cbSQLQueryCat->Hook(CBN_EDITCHANGE, sub {
    my ($hObject, $wParam, $lParam, $iType, $iMsgCode) = @_;
    return 1 unless $iType == WM_COMMAND;
    if ($winSaveQuery->tfSQLQueryName->Text() and $winSaveQuery->cbSQLQueryCat->Text() and $winSaveQuery->tfSQLQuery->Text()) {
      $winSaveQuery->btnSQLQueryOk->Enable();
    } else { $winSaveQuery->btnSQLQueryOk->Disable(); }
    1;
  });
  
}  #--- End createWinSaveQuery
  
#--------------------------#
sub btnLAQuerySave_Click
#--------------------------#
{
  # Local variables
  &createWinLASavedQueries() if !$winLASavedQueries;
  &createWinSaveQuery()      if !$winSaveQuery;
  $winSaveQuery->lblSQLQueryEditRow->Text(0);
  $winSaveQuery->tfSQLQueryName->Text('');
  $winSaveQuery->cbSQLQueryCat->Clear();
  # Feed category combobox
  if (my $savedQueriesDB = $CONFIG{'SAVED_QUERIES_DB_FILE'}) {
    if ($savedQueriesDB and -f $savedQueriesDB and &validSavedQueriesDB($savedQueriesDB)) {
      my $dsn = "DBI:SQLite:dbname=$savedQueriesDB";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1 })) {
        my $all = $dbh->selectall_arrayref('SELECT DISTINCT cat FROM QUERIES ORDER BY cat ASC');
        foreach my $row (@$all) { $winSaveQuery->cbSQLQueryCat->AddString(@$row[0]); }
      }
    }
  }
  $winSaveQuery->tfSQLQuery->Text($win->tfLAQuery->Text()) if $win->tfLAQuery->Text();
  $winSaveQuery->tfSQLQuery->Disable();
  $winSaveQuery->Center($win);
  $winSaveQuery->Show();
  $win->Disable();

}  #--- End btnLAQuerySave_Click

#--------------------------#
sub winSaveQuery_Resize
#--------------------------#
{
  my $middle = $winSaveQuery->ScaleWidth()/2+50;
  $winSaveQuery->tfSQLQueryName->Width($middle-150);
  $winSaveQuery->cbSQLQueryCat->Width($middle-150);
  $winSaveQuery->tfSQLQuery->Width($winSaveQuery->ScaleWidth()-230);
  $winSaveQuery->tfSQLQuery->Height($winSaveQuery->ScaleHeight()-120);
  # Buttons
  $winSaveQuery->btnSQLQueryOk->Left($middle-105);
  $winSaveQuery->btnSQLQueryCancel->Left($middle+5);
  $winSaveQuery->btnSQLQueryOk->Top($winSaveQuery->ScaleHeight()-40);
  $winSaveQuery->btnSQLQueryCancel->Top($winSaveQuery->ScaleHeight()-40);
  
}  #--- End winSaveQuery_Resize

#--------------------------#
sub tfSQLQueryName_Change
#--------------------------#
{
  if ($winSaveQuery->tfSQLQueryName->Text() and $winSaveQuery->cbSQLQueryCat->Text() and $winSaveQuery->tfSQLQuery->Text()) {
    $winSaveQuery->btnSQLQueryOk->Enable();
  } else { $winSaveQuery->btnSQLQueryOk->Disable(); }
  
}  #--- End tfSQLQueryName_Change

#--------------------------#
sub cbSQLQueryCat_Change
#--------------------------#
{
  my $selItem = $winSaveQuery->cbSQLQueryCat->GetString($winSaveQuery->cbSQLQueryCat->GetCurSel());
  $winSaveQuery->cbSQLQueryCat->Text($selItem);
  if ($winSaveQuery->tfSQLQueryName->Text() and $winSaveQuery->cbSQLQueryCat->Text() and $winSaveQuery->tfSQLQuery->Text()) {
    $winSaveQuery->btnSQLQueryOk->Enable();
  } else { $winSaveQuery->btnSQLQueryOk->Disable(); }
  
}  #--- End cbSQLQueryCat_Change

#--------------------------#
sub btnSQLQueryOk_Click
#--------------------------#
{
  # Local variables
  my $editRow        = $winSaveQuery->lblSQLQueryEditRow->Text();
  my $queryName      = $winSaveQuery->tfSQLQueryName->Text();
  my $queryCat       = $winSaveQuery->cbSQLQueryCat->Text();
  my $query          = $winSaveQuery->tfSQLQuery->Text();
  my $savedQueriesDB = $CONFIG{'SAVED_QUERIES_DB_FILE'};
  # Load the Saved Queries
  if ($winLASavedQueries->gridQueries->GetRows() < 2 and $savedQueriesDB and -f $savedQueriesDB and &validSavedQueriesDB($savedQueriesDB)) {
    &loadSavedQueriesDB($savedQueriesDB, \$winLASavedQueries, \$win, \%STR);
  # Select or create Saved Queries database
  } else {
    $savedQueriesDB = "$USERDIR\\SavedQueries.db";
    if (&createSavedQueriesDB($savedQueriesDB)) {
      $winConfig->tfSavedQueriesDB->Text($savedQueriesDB);
      $CONFIG{'SAVED_QUERIES_DB_FILE'} = $savedQueriesDB;
    }
  }
  # Add or edit in database
  my $dsn = "DBI:SQLite:dbname=$savedQueriesDB";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Test if name already exists
    if (!$editRow and $dbh->selectrow_array('SELECT name FROM QUERIES WHERE name == ?', undef, $queryName)) {
      Win32::GUI::MessageBox($win, $STR{'errEntryExists'}.'!', $STR{'error'}, 0x40010);
    } else {
      # If editing, delete the entry
      if ($editRow) {
        my $oldQueryCat  = $winLASavedQueries->gridQueries->GetCellText($editRow, 0);
        my $oldQueryName = $winLASavedQueries->gridQueries->GetCellText($editRow, 1);
        # Database: table = QUERIES, Fields = name, cat, query, used, time
        my $sth = $dbh->prepare('DELETE FROM QUERIES where cat = ? and name = ?');
        my $rv  = $sth->execute($oldQueryCat, $oldQueryName);
        if ($rv < 0) {
          Win32::GUI::MessageBox($winSaveQuery, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
          &winSaveQuery_Terminate();
          $winLASavedQueries->Center($win);
          $winLASavedQueries->Show();
          return(1);
        }
        # Delete in grid
        $winLASavedQueries->gridQueries->DeleteRow($editRow);
      }      
      # Database: table = QUERIES, Fields = name, cat, query, used, time
      my $sth  = $dbh->prepare('INSERT INTO QUERIES (name, cat, query, used, time) VALUES(?,?,?,?,?)');
      my $time = time;
      my $rv   = $sth->execute($queryName, $queryCat, $query, 0, $time);
      my ($sec, $min, $hour, $mday, $mon, $year) = (localtime($time))[0,1,2,3,4,5];
      $year += 1900;
      $mon++;
      my $timeStr = sprintf("%04d\-%02d\-%02d %02d:%02d:%02d", $year, $mon, $mday, $hour, $min, $sec);
      # Add to Grid
      if (my $newLine = $winLASavedQueries->gridQueries->InsertRow($queryName, -1)) {
        $winLASavedQueries->gridQueries->SetCellText($newLine, 0, $queryCat );
        $winLASavedQueries->gridQueries->SetCellText($newLine, 1, $queryName );
        $winLASavedQueries->gridQueries->SetCellText($newLine, 2, 0);
        $winLASavedQueries->gridQueries->SetCellText($newLine, 3, $timeStr);
        $winLASavedQueries->gridQueries->SetCellText($newLine, 4, $query);
        $winLASavedQueries->gridQueries->SortCells(0, 1, sub { my ($e1, $e2) = @_; return ($e1 cmp $e2); });
        $winLASavedQueries->gridQueries->Refresh();
        $winLASavedQueries->gridQueries->AutoSize();
        my $currWidth = $winLASavedQueries->gridQueries->GetColumnWidth(0);
        $winLASavedQueries->gridQueries->SetColumnWidth(0, $currWidth+15);
        $winLASavedQueries->gridQueries->ExpandLastColumn();
        # Final message
        Win32::GUI::MessageBox($win, $STR{'SavedQuery'}.'!', "XL-Parser $VERSION", 0x40040);
        &winSaveQuery_Terminate();
        if (!$winLASavedQueries->IsVisible()) {
          $winLASavedQueries->Center($win);
          $winLASavedQueries->Show();
        }
      } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }
  
}  #--- End btnSQLQueryOk_Click

#--------------------------#
sub btnSQLQueryCancel_Click { &winSaveQuery_Terminate(); }
#--------------------------#

#--------------------------#
sub winSaveQuery_Terminate
#--------------------------#
{
  $winSaveQuery->Hide();
  if ($winSaveQuery->lblSQLQueryEditRow->Text()) {
    $winLASavedQueries->Enable();
    $winLASavedQueries->BringWindowToTop();
  } else { 
    $win->Enable();
    $win->BringWindowToTop();
  }
  return(0);

}  #--- End winSaveQuery_Terminate

#--------------------------#
sub tfLAQuery_Change
#--------------------------#
{
  if (my $query = $win->tfLAQuery->Text()) {
    $win->btnLAQueryFilter->Enable();
    $win->chLAQueryGroupBy->Enable();
    $win->chLAQueryOrderBy->Enable();
    $win->chLAQueryHavingCount->Enable();
    $win->btnLAQueryReset->Enable();
    $win->btnLAQuerySave->Enable();
  } else {
    $win->btnLAQueryFilter->Disable();
    $win->chLAQueryGroupBy->Disable();
    $win->chLAQueryOrderBy->Disable();
    $win->chLAQueryHavingCount->Disable();
    $win->btnLAQueryReset->Disable();
    $win->btnLAQuerySave->Disable();
  }
  &isProcessReady(0);
  return(1);

}  #--- End tfLAQuery_Change

#--------------------------#
sub btnLAQueryReportOpt_Click
#--------------------------#
{
  # Show window
  if ($winReport->tfReportDir->Text()) { $winReport->btnReportOk->Enable();  }
  else                                 { $winReport->btnReportOk->Disable(); }
  $winReport->Center($win);
  $winReport->Show();
  $win->Disable();
  
}  #--- End btnLAQueryReportOpt_Click

#--------------------------#
sub btnLASearchReportOpt_Click
#--------------------------#
{
  # Show window
  if ($winReport->tfReportDir->Text()) { $winReport->btnReportOk->Enable();  }
  else                                 { $winReport->btnReportOk->Disable(); }
  $winReport->Center($win);
  $winReport->Show();
  $win->Disable();
  
}  #--- End btnLASearchReportOpt_Click

#--------------------------#
sub gridLASearchSAInd_Click
#--------------------------#
{
  # Check or uncheck
  my ($row, $col) = @_;
  if (!$col and !$row) {
    if ($win->gridLASearchSAInd->GetCellCheck(0, 0)) { # Uncheck all
      for (my $i = 0; $i <= $win->gridLASearchSAInd->GetRows(); $i++) { $win->gridLASearchSAInd->SetCellCheck($i, 0, 0); }
    } else {                                           # Check all
      for (my $i = 0; $i <= $win->gridLASearchSAInd->GetRows(); $i++) { $win->gridLASearchSAInd->SetCellCheck($i, 0, 1); }
    }
  }
  &isProcessReady(0);
  return(1);

}  #--- End gridLASearchSAInd_Click

#--------------------------#
sub gridLASearchSAInd_EndEdit
#--------------------------#
{
  # Local variables
  my ($row, $col) = @_;
  if ($row) {
    # Selected row values
    my $name    = $win->gridLASearchSAInd->GetCellText($row, 1);
    my $score   = $win->gridLASearchSAInd->GetCellText($row, 2);
    my $limit   = $win->gridLASearchSAInd->GetCellText($row, 3);
    my $options = $win->gridLASearchSAInd->GetCellText($row, 4);
    # If file already exists, load values
    my $refIndicators = &loadSAInd("$USERDIR\\SA_Indicators.json", \$win, \%STR);
    # Save changes
    if ($$refIndicators{$row}{name} eq $name) {
      $$refIndicators{$row}{score}   = $score;
      $$refIndicators{$row}{limit}   = $limit;
      $$refIndicators{$row}{options} = $options if $options;
      # Save indicators in JSON file
      my $jsonObj = JSON->new;
      my $jsonText = $jsonObj->encode($refIndicators);
      if (open(my $json, '>:encoding(cp1252)', "$USERDIR\\SA_Indicators.json")) {
        print $json $jsonText;
        close($json);
        $win->btnLASearchReset->Enable();
      }
    }
  }

}  #--- End gridLASearchSAInd_EndEdit

#--------------------------#
sub btnLASearchSaveOptions_Click
#--------------------------#
{
  # Local variables
  my %searchParams;
  $searchParams{dbFile} = $win->tfInput->Text();
  my $destDir           = $searchParams{dbFile};
  while (chop($destDir) ne "\\") { } # Dir only
  # Get current search result id
  my $currSearchID;
  if (opendir(DIR,"$destDir\\")) {
    while (my $file = readdir(DIR)) {
      if ($file =~ /CurrentSearchResults-(\d+).json/) {
        $currSearchID = $1;
        last;
      }
    }
    closedir(DIR);
  }
  # No current search, ask for a file
  if (!$currSearchID and my $resFile = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                                                    -title         => $STR{'selFile'}.':'        ,
                                                                    -filter        => ['JSON (*.json)', '*.json'],
                                                                    -filemustexist => 1                          ,
                                                                    -directory     => $destDir                   ,
                                                                    -explorer      => 1                          , )) {
    if (open(my $json, $resFile)) {
      my $jsonText = <$json>;
      close($json);
      if ($jsonText =~ /"procID":"([\d+]+)"/) { $currSearchID = $1; }
    }
  }
  # Save options
  if ($currSearchID) {
    $searchParams{reportDir}    = $winReport->tfReportDir->Text();
    $searchParams{maxResults}   = $win->tfLASearchSAMaxRes->Text();
    $searchParams{reportFormat} = $winReport->cbReportFormat->GetString($winReport->cbReportFormat->GetCurSel());
    $searchParams{replReport}   = 1 if $winReport->chReplaceReport->Checked();
    $searchParams{openReport}   = 1 if $winReport->chOpenReport->Checked();
    $searchParams{incHeader}    = 1 if $winReport->chReportOptIncHeaders->Checked();
    $searchParams{incSource}    = 1 if $winReport->chReportOptIncSource->Checked();
    $searchParams{incISP}       = 1 if $winReport->chReportOptIncISP->Checked();
    $searchParams{incGeoIP}     = 1 if $winReport->chReportOptIncGeoIP->Checked();
    $searchParams{incUADetails} = 1 if $winReport->chReportOptIncUADetails->Checked();
    $searchParams{incWeekdays}  = 1 if $winReport->chReportOptIncWeekday->Checked();
    my $selOutputDTFormat       = $winReport->cbOutputDTFormat->GetCurSel();
    $searchParams{localTZ}      = $winConfig->cbLocalTZ->GetString($winConfig->cbLocalTZ->GetCurSel());
    $searchParams{language}     = $winConfig->cbDefaultLang->GetString($winConfig->cbDefaultLang->GetCurSel());
    ($searchParams{outPattern}, $searchParams{outTZ}) = (&infoDTFormat($winReport->cbOutputDTFormat->GetString($selOutputDTFormat)))[1,3];
    # Get selected columns options
    &createWinLAQueryCols() if !$winLAQueryCols;
    $searchParams{DISTINCT}    = 1 if $winLAQueryCols->chLAQueryColsDistinct->Checked();
    $searchParams{cols}{ALL}   = 1 if $winLAQueryCols->rbLAQueryColsAll->Checked();
    $searchParams{cols}{COUNT} = 1 if $winLAQueryCols->chLAQueryColsAllCount->Checked();
    if (!$searchParams{cols}{ALL}) {
      # Selected columns
      for (my $i = 1; $i < 12; $i++) {
        if ($winLAQueryCols->gridLAQueryCols->GetCellCheck($i, 0)) {
          $searchParams{cols}{$i}{colName} = $winLAQueryCols->gridLAQueryCols->GetCellText($i, 2);
          $searchParams{cols}{$i}{colName} = 'datetimeInt' if $searchParams{cols}{$i}{colName} eq $STR{'DTDB'};
          $searchParams{cols}{$i}{COUNT}   = 1 if $winLAQueryCols->gridLAQueryCols->GetCellCheck($i, 1);
        }
      }
    }
    # Get selected indicators
    for (my $i = 1; $i <= $win->gridLASearchSAInd->GetRows(); $i++) {
      if ($win->gridLASearchSAInd->GetCellCheck($i, 0)) {
        my $indicator = $win->gridLASearchSAInd->GetCellText($i, 1);
        $searchParams{selIndicators}{$indicator}{score}  = $win->gridLASearchSAInd->GetCellText($i, 2);
        $searchParams{selIndicators}{$indicator}{limit}  = $win->gridLASearchSAInd->GetCellText($i, 3);
        $searchParams{selIndicators}{$indicator}{option} = $win->gridLASearchSAInd->GetCellText($i, 4);
      }
    }
    # Save query params and options as JSON
    my $jsonObj  = JSON->new;
    my $jsonText = $jsonObj->encode(\%searchParams);
    if (open(my $json, '>:encoding(cp1252)', "$destDir\\CurrentSearchParams-" . $currSearchID .'.json')) {
      print $json $jsonText;
      close($json);
      Win32::GUI::MessageBox($win, $STR{'SavedOptions'}, "XL-Parser $VERSION", 0x40040);
    }
  }
  return(1);
  
}  #--- End btnLASearchSaveOptions_Click

#--------------------------#
sub btnLASearchOpenResults_Click
#--------------------------#
{
  # Local variables
  my $dir = $winReport->tfReportDir->Text();
  my $resFile;
  # Select the json file
  if ($dir) {
    $resFile = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                            -title         => $STR{'selFile'}.':'        ,
                                            -filter        => ['JSON (*.json)', '*.json'],
                                            -filemustexist => 1                          ,
                                            -directory     => $dir                       ,
                                            -explorer      => 1                          , );
  } else {
    $resFile = Win32::GUI::GetOpenFileName( -owner         => $win                       ,
                                            -title         => $STR{'selFile'}.':'        ,
                                            -filter        => ['JSON (*.json)', '*.json'],
                                            -filemustexist => 1                          ,
                                            -explorer      => 1                          , );
  }
  # Validate the file and launch the process
  if ($resFile and -T $resFile) {
    if (open(my $json, $resFile)) {
      my $jsonText = <$json>;
      close($json);
      # Valid database
      if ($jsonText =~ /"selIndicators":/ and $jsonText =~ /"ACTs":/ and $jsonText =~ /"ByIPs":/ and
          $jsonText =~ /"dbFile":"([^\"]+)"/) {
        my $fileDbFile = $1;
        if ($fileDbFile ne $win->tfInput->Text() and $fileDbFile =~ /\\([^\\]+)$/) {
          my $filename = $1;
          # Dbfile Path must be change in JSON file
          if ($win->tfInput->Text() =~ /$filename/) {
            if (open(my $json, $resFile)) { # Open the file
              my $jsonText = <$json>;
              close($json);
              my $jsonObj     = JSON->new;
              my $refResults  = $jsonObj->decode($jsonText);
              $$refResults{dbFile}    = $win->tfInput->Text(); # Change the path
              $$refResults{reportDir} = $$refResults{dbFile};
              while (chop($$refResults{reportDir}) ne "\\") { } # Dir only
              if (open(my $json, '>:encoding(cp1252)', $resFile)) { # Save the file
                $jsonObj  = JSON->new;
                $jsonText = $jsonObj->encode($refResults);
                print $json $jsonText;
                close($json);
              }
            }
          # Results doesn't match the selected database
          } else {
            Win32::GUI::MessageBox($win, $STR{'errDBFilePath'}, $STR{'error'}, 0x40010);
            return(1);
          }
        }
        # Open Suspicious Activities Results
        my $procID;
        if ($jsonText =~ /"procID":"([\d+]+)"/) { $procID = $1;   }
        else                                    { $procID = time; }
        my $command = 'XL-Parser-process ' . "LADB-SAResults $procID \"$PROGDIR\" \"$resFile\" \"$USERDIR\"";
        Win32::Process::Create(my $processObj, $PROGDIR .'\XL-Parser-process.exe', $command, 0, NORMAL_PRIORITY_CLASS, $PROGDIR);
        $win->gridLASearchSAInd->BringWindowToTop();
      } else { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }
  return(1);
  
}  #--- End btnLASearchOpenResults_Click

#--------------------------#
sub btnLASearchReset_Click
#--------------------------#
{
  unlink("$USERDIR\\SA_Indicators.json") if -f "$USERDIR\\SA_Indicators.json";
  $win->gridLASearchSAInd->DeleteNonFixedRows();
  &loadSAIndGrid("$USERDIR\\SA_Indicators.json", \$win, \%STR);
  $win->btnLASearchReset->Disable();

}  #--- End btnLASearchReset_Click

#--------------------------#
sub cbOutputDTFormat_Change
#--------------------------#
{
  # Remember
  $CONFIG{'DEFAULT_OUTPUT_DT_FORMAT'} = $winReport->cbOutputDTFormat->GetString($winReport->cbOutputDTFormat->GetCurSel());
  &saveConfig($CONFIG_FILE, \%CONFIG);
  
}  #--- End cbOutputDTFormat_Change

#--------------------------#
sub btnOutputFormatDTDB_Click
#--------------------------#
{
  if (my $selRow = ($winDTDB->gridDT->GetSelectedCellRange())[0]) {
    $winDTDB->btnDTEdit->Enable();
    $winDTDB->btnDTDel->Enable();
  } else {
    $winDTDB->btnDTEdit->Disable();
    $winDTDB->btnDTDel->Disable();
  }
  $winDTDB->Center($win);
  $winDTDB->Show();
  $win->Disable();
  return(1);

}  #--- End btnOutputFormatDTDB_Click

#--------------------------#
sub tvLAFilters_Click
#--------------------------#
{
  # Local variables
  my ($X, $Y)      = Win32::GUI::GetCursorPos();
  $X              -= $winLAFilters->tvLAFilters->AbsLeft();
  $Y              -= $winLAFilters->tvLAFilters->AbsTop();
  my $clickedNode  = $winLAFilters->tvLAFilters->HitTest($X, $Y);
  # It's a parent, Checkbox Select/Unselect all
  if ($X >= 25 and $X <= 37 and $clickedNode) {
    $winLAFilters->tvLAFilters->SelectItem($clickedNode);
    my %selItem = $winLAFilters->tvLAFilters->GetItem($clickedNode);
    my $checked = $winLAFilters->tvLAFilters->ItemCheck($clickedNode);
    # It's a parent
    if (exists($selItem{'-parent'}) and !$selItem{'-parent'}) {
      if (!$checked and
        my $nextNode = $winLAFilters->tvLAFilters->GetChild($clickedNode)) {
        $winLAFilters->tvLAFilters->ItemCheck($nextNode, 1);
        while ($nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode)) {
          $winLAFilters->tvLAFilters->ItemCheck($nextNode, 1);
        }
      } elsif ($nextNode = $winLAFilters->tvLAFilters->GetChild($clickedNode)) {
        $winLAFilters->tvLAFilters->ItemCheck($nextNode, 0);
        while ($nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode)) {
          $winLAFilters->tvLAFilters->ItemCheck($nextNode, 0);
        }
      }
    }
  # It's a child
  } elsif ($X >= 44 and $X <= 56 and $clickedNode) {
    my $checked = 0;
    $winLAFilters->tvLAFilters->SelectItem($clickedNode);
    my %currItem = $winLAFilters->tvLAFilters->GetItem($clickedNode);
    $checked = 1 if ($currItem{'-state'} == 4098 or $currItem{'-state'} == 4194 or $currItem{'-state'} == 8192);
    if (my $parentNode = $winLAFilters->tvLAFilters->GetParent($clickedNode)) {
      # Check category
      if ($checked) { $winLAFilters->tvLAFilters->ItemCheck($parentNode, 1); }
      # Unchecked item, uncheck category if no more checked items
      else {
        my $nextNode = $parentNode;
        # Enumerate all childs
        if (my $nextChildNode = $winLAFilters->tvLAFilters->GetChild($nextNode)) {
          my %currItem = $winLAFilters->tvLAFilters->GetItem($nextChildNode);
          $checked = 1 if ($currItem{'-state'} == 4098 or $currItem{'-state'} == 4194 or $currItem{'-state'} == 8192);
          if (!$checked) {
            while ($nextChildNode = $winLAFilters->tvLAFilters->GetNextSibling($nextChildNode)) {
              %currItem = $winLAFilters->tvLAFilters->GetItem($nextChildNode);
              $checked = 1 if ($currItem{'-state'} == 4098 or $currItem{'-state'} == 4194 or $currItem{'-state'} == 8192);
            }
          }
        }
        $winLAFilters->tvLAFilters->ItemCheck($parentNode, 0) if !$checked;
      }
    }
  # No clicked node, uncheck all
  } elsif (!$clickedNode) {
    my $nextNode = $winLAFilters->tvLAFilters->GetRoot();
    while ($nextNode) {
      $winLAFilters->tvLAFilters->SetItem($nextNode, -selected => 0);
      if (my $nextChildNode = $winLAFilters->tvLAFilters->GetChild($nextNode)) {
        $winLAFilters->tvLAFilters->SetItem($nextChildNode, -selected => 0);
        while ($nextChildNode = $winLAFilters->tvLAFilters->GetNextSibling($nextChildNode)) {
          $winLAFilters->tvLAFilters->SetItem($nextChildNode, -selected => 0);
        }
      }
      $nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode)
    }
    $winLAFilters->lblLAFiltersSel->Text(0);
    $winLAFilters->btnLAFiltersEdit->Disable();
    $winLAFilters->btnLAFiltersDel->Disable();
  }
  $winLAFilters->tvLAFilters->BringWindowToTop();
  
}  #--- End tvLAFilters_Click

#--------------------------#
sub tvLAFilters_NodeClick
#--------------------------#
{
  # Local variables
  my $selNode = shift;
  my %selItem = $winLAFilters->tvLAFilters->GetItem($selNode);
  my $parentNode;
  # Child node
  if (exists($selItem{'-parent'}) and $selItem{'-parent'}) {
    $winLAFilters->btnLAFiltersEdit->Enable();
    $winLAFilters->btnLAFiltersDel->Enable();
  # Parent node
  } else {
    $winLAFilters->btnLAFiltersEdit->Disable();
    $winLAFilters->btnLAFiltersDel->Enable();
  }
  $winLAFilters->lblLAFiltersSel->Text(1);
  $winLAFilters->tvLAFilters->BringWindowToTop();

}  #--- End tvLAFilters_NodeClick

#--------------------------#
sub btnLAFiltersAdd_Click
#--------------------------#
{
  &createWinFilterSet() if !$winFilterSet;
  # Reset value
  $winFilterSet->lblFilterSetEditRow->Text(0);
  $winFilterSet->tfFilterSetName->Text('');
  $winFilterSet->gridFilterSetFilters->DeleteNonFixedRows();
  # If category selected
  if ($winLAFilters->lblLAFiltersSel->Text() and my $selNode = $winLAFilters->tvLAFilters->GetSelection()) {
    my %selItem = $winLAFilters->tvLAFilters->GetItem($selNode);
    if (my $parentNode = $winLAFilters->tvLAFilters->GetParent($selNode)) {
      my %parentItem = $winLAFilters->tvLAFilters->GetItem($parentNode);
      $winFilterSet->tfFilterSetCat->Text($parentItem{-text});
    } else { $winFilterSet->tfFilterSetCat->Text($selItem{-text}); }
    $winFilterSet->tfFilterSetCat->Disable();
  } else {
    $winFilterSet->tfFilterSetCat->Text('');
    $winFilterSet->tfFilterSetCat->Enable();
  }
  # Show Filter Set window
  $winFilterSet->Center($win);
  $winFilterSet->Show();
  $winLAFilters->Disable();
  
}  #--- End btnLAFiltersAdd_Click

#--------------------------#
sub createWinFilterSet
#--------------------------#
{
  # Create or Edit a Filter Set window
  $winFilterSet = Win32::GUI::Window->new(-name        => 'winFilterSet'         ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winFilterSet'}   ,
                                          -pos         => [$winPosX , $winPosY]  ,
                                          -size        => [$winWidth, 260]       ,
                                          -minsize     => [$winWidth, 260]       ,
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      , );
  $winFilterSet->SetIcon($winICO);
  $winFilterSet->AddLabel(      -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  5,  5]               ,
                                -bitmap       => $filterList128          ,
                                -background   => [255, 255, 255]         , );
  # Create or edit a Filter Set
  $winFilterSet->AddLabel(      -name         => 'lblFilterSetEditRow'   ,
                                -size         => [ 10, 22]               ,
                                -pos          => [757,  8]               ,
                                -visible      => 0                       , );
  $winFilterSet->AddLabel(      -name         => 'lblFilterSetCat'       ,
                                -size         => [ 80, 22]               ,
                                -pos          => [145,  8]               ,
                                -text         => $STR{'Category'}.':'    ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winFilterSet->AddTextfield(  -name         => 'tfFilterSetCat'        ,
                                -size         => [240, 22]               ,
                                -pos          => [230,  5]               ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddLabel(      -name         => 'lblFilterSetName'      ,
                                -size         => [ 80, 22]               ,
                                -pos          => [500,  8]               ,
                                -text         => $STR{'Name'}.':'        ,
                                -font         => $font10                 ,
                                -background   => [255, 255, 255]         , );
  $winFilterSet->AddTextfield(  -name         => 'tfFilterSetName'       ,
                                -size         => [240, 22]               ,
                                -pos          => [585,  5]               ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddGrid(       -name         => 'gridFilterSetFilters'  ,
                                -size         => [555, 95]               ,
                                -pos          => [145, 35]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 6                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -tabstop      => 1                       , );
  $winFilterSet->gridFilterSetFilters->SetListMode(1);
  $winFilterSet->AddButton(     -name         => 'btnFilterSetFFAdd'     ,
                                -size         => [ 22, 22]               ,
                                -pos          => [757, 35]               ,
                                -bitmap       => $filterAdd              ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetFFEdit'    ,
                                -size         => [ 22, 22]               ,
                                -pos          => [757, 59]               ,
                                -bitmap       => $filterEdit             ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetFFDel'     ,
                                -size         => [ 22, 22]               ,
                                -pos          => [757, 83]               ,
                                -bitmap       => $filterDel              ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetFFUp'      ,
                                -size         => [ 22, 22]               ,
                                -pos          => [757,107]               ,
                                -bitmap       => $up16                   ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetFFDown'    ,
                                -size         => [ 22, 22]               ,
                                -pos          => [757,131]               ,
                                -bitmap       => $down16                 ,
                                -disabled     => 1                       ,
                                -tabstop      => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetNotReady'  ,
                                -size         => [ 30, 30]               ,
                                -pos          => [$winWidth/2,335]   ,
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetOk'        ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2+35,335]    ,
                                -text         => $STR{'SetAddFilter'}    ,
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winFilterSet->AddButton(     -name         => 'btnFilterSetCancel'    ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2+140,335]   ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );
  # Create or edit a Filter Set grid header
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 0, $STR{'Operator'} );
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 1, $STR{'Field'}    );
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 2, $STR{'Condition'});
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 3, $STR{'Case'}     );
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 4, $STR{'Regex'}    );
  $winFilterSet->gridFilterSetFilters->SetCellText(0, 5, $STR{'Value'}    );
  $winFilterSet->gridFilterSetFilters->AutoSize();
  $winFilterSet->gridFilterSetFilters->ExpandLastColumn();
  
}  #--- End createWinFilterSet

#--------------------------#
sub btnLAFiltersEdit_Click
#--------------------------#
{
  &createWinFilterSet() if !$winFilterSet;
  # Local variables
  my $selNode = $winLAFilters->tvLAFilters->GetSelection();
  if ($selNode) {
    my %selItem    = $winLAFilters->tvLAFilters->GetItem($selNode);
    my $parentNode = $winLAFilters->tvLAFilters->GetParent($selNode);
    my %parentItem = $winLAFilters->tvLAFilters->GetItem($parentNode);
    # Reset value
    $winFilterSet->tfFilterSetCat->Text('');
    $winFilterSet->tfFilterSetName->Text('');
    $winFilterSet->gridFilterSetFilters->DeleteNonFixedRows();
    # Gather value
    my $filterSetCat  = $parentItem{-text};
    my $filterSetName = $selItem{-text};
    my $whiteList     = 0;
    my $refFilters    = &getFilterSetFilters($winConfig->tfLAFiltersDB->Text(), $filterSetCat, $filterSetName);
    if ($refFilters) {
      # Set Expression tab control values
      $winFilterSet->lblFilterSetEditRow->Text(1);
      $winFilterSet->tfFilterSetCat->Text($filterSetCat);
      $winFilterSet->tfFilterSetCat->Disable();
      $winFilterSet->tfFilterSetName->Text($filterSetName);
      delete($$refFilters{category});
      delete($$refFilters{name});
      delete($$refFilters{whiteList});
      foreach my $index (sort keys %{$refFilters}) {
        # Ex.: "1":{"operator":"-","value":"33.33.33.33","regex":0,"case":0,"condition":"is","field":"remoteIP"}
        if (exists($$refFilters{$index}) and my $row = $winFilterSet->gridFilterSetFilters->InsertRow('-', -1)) {
          if ($$refFilters{$index}{operator} and $row > 1) {
            $winFilterSet->gridFilterSetFilters->SetCellText($row, 0, $$refFilters{$index}{operator});
            $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 0, 1);
            $winFilterSet->gridFilterSetFilters->SetCellType($row, 0, 6);
            $winFilterSet->gridFilterSetFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
          }
          $winFilterSet->gridFilterSetFilters->SetCellText($row, 1, $$refFilters{$index}{field});
          $winFilterSet->gridFilterSetFilters->SetCellText($row, 2, $$refFilters{$index}{condition});
          $winFilterSet->gridFilterSetFilters->SetCellType($row, 3, 4);
          $winFilterSet->gridFilterSetFilters->SetCellType($row, 4, 4);
          if ($$refFilters{$index}{case})  { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 3, 1);  }
          else                             { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 3, 0);  }
          if ($$refFilters{$index}{regex}) { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 4, 1);  }
          else                             { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 4, 0);  }
          $winFilterSet->gridFilterSetFilters->SetCellText($row, 5, $$refFilters{$index}{value});
          $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 1, 0);
          $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 2, 0);
          $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 3, 0);
          $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 4, 0);
          $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 5, 0);
        }
      }
      $winFilterSet->gridFilterSetFilters->AutoSizeColumns();
      $winFilterSet->gridFilterSetFilters->ExpandLastColumn();
      $winFilterSet->gridFilterSetFilters->Refresh();
      # Show Filter Set window
      $winFilterSet->Center($win);
      $winFilterSet->Show();
      $winLAFilters->Disable();
      &isFilterSetReady(0);
    } # Error loading FilterSet
  }
  return(1);

}  #--- End btnLAFiltersEdit_Click

#--------------------------#
sub btnLAFiltersDel_Click
#--------------------------#
{
  # Local variables
  my $selNode = $winLAFilters->tvLAFilters->GetSelection();
  if ($selNode) {
    my %selItem           = $winLAFilters->tvLAFilters->GetItem($selNode);
    my $parentNode        = $winLAFilters->tvLAFilters->GetParent($selNode);
    my $LAFilterSetDBFile = $winConfig->tfLAFiltersDB->Text();
    my $filterSetCat;
    my @listDelFilters;
    # A category is selected
    if (!$parentNode) {
      $filterSetCat = $selItem{-text};
      my $answer = Win32::GUI::MessageBox($winLAFilters, "$STR{'DeleteFilterCat'} $selItem{-text} ?", $STR{'winLAFilters'}, 0x1024);
      return(1) if $answer == 7; # Answer: Yes (6), No (7)
      my $childNode = $winLAFilters->tvLAFilters->GetChild($selNode);
      while ($childNode) {
        my %selItem = $winLAFilters->tvLAFilters->GetItem($childNode);
        push(@listDelFilters, $selItem{-text});
        $childNode = $winLAFilters->tvLAFilters->GetNextSibling($childNode);
      }
    # A filter set is selected
    } else {
      push(@listDelFilters, $selItem{-text});
      my %parentItem = $winLAFilters->tvLAFilters->GetItem($parentNode);
      $filterSetCat  = $parentItem{-text};
    }
    
    # Remove from database
    foreach my $filterSetName (@listDelFilters) {
      if (&delLAFilterSetDB($LAFilterSetDBFile, $filterSetCat, $filterSetName)) {
        # Remove from treeview
        $winLAFilters->tvLAFilters->DeleteItem($selNode);
        # Category is empty, Remove it
        $winLAFilters->tvLAFilters->DeleteItem($parentNode) if !$winLAFilters->tvLAFilters->GetChild($parentNode);
        # Delete the json file
        my @dirParts = split(/\\/, $LAFilterSetDBFile);
        pop(@dirParts);
        my $jsonDir = join("\\", @dirParts) . "\\" . 'Filters';
        my $jsonFilterFile = "$jsonDir\\$filterSetCat\.$filterSetName\.json";
        unlink($jsonFilterFile) if -e $jsonFilterFile;
      }
    }
  }
  return(1);
  
}  #--- End btnLAFiltersDel_Click

#--------------------------#
sub winFilterSet_Resize
#--------------------------#
{
  my $middle = $winFilterSet->ScaleWidth()/2+50;
  $winFilterSet->tfFilterSetCat->Width($middle-250);
  $winFilterSet->lblFilterSetName->Left($middle);
  $winFilterSet->tfFilterSetName->Left($middle+85);
  $winFilterSet->tfFilterSetName->Width($middle-215);
  $winFilterSet->gridFilterSetFilters->Width($winFilterSet->ScaleWidth()-174);
  $winFilterSet->gridFilterSetFilters->Height($winFilterSet->ScaleHeight()-85);
  $winFilterSet->gridFilterSetFilters->ExpandColumnsToFit();
  $winFilterSet->gridFilterSetFilters->Refresh();
  $winFilterSet->btnFilterSetFFAdd->Left($winFilterSet->ScaleWidth()-26);
  $winFilterSet->btnFilterSetFFEdit->Left($winFilterSet->ScaleWidth()-26);
  $winFilterSet->btnFilterSetFFDel->Left($winFilterSet->ScaleWidth()-26);
  $winFilterSet->btnFilterSetFFUp->Left($winFilterSet->ScaleWidth()-26);
  $winFilterSet->btnFilterSetFFDown->Left($winFilterSet->ScaleWidth()-26);
  # Buttons
  $winFilterSet->btnFilterSetNotReady->Left($middle-135);
  $winFilterSet->btnFilterSetOk->Left($middle-95);
  $winFilterSet->btnFilterSetCancel->Left($middle+15);
  $winFilterSet->btnFilterSetNotReady->Top($winFilterSet->ScaleHeight()-40);
  $winFilterSet->btnFilterSetOk->Top($winFilterSet->ScaleHeight()-40);
  $winFilterSet->btnFilterSetCancel->Top($winFilterSet->ScaleHeight()-40);
  
}  #--- End winFilterSet_Resize

#--------------------------#
sub tfFilterSetName_Change { &isFilterSetReady(0); }
#--------------------------#

#--------------------------#
sub btnFilterSetFFAdd_Click
#--------------------------#
{
  if (!$winFieldFilter) { &createWinFieldFilter(); }
  # Reset Value
  $winFieldFilter->cFieldFilterOp->SetCurSel(0);
  $winFieldFilter->lblFieldFilterEditRow->Text('');
  $winFieldFilter->cbFieldFilterFF->SetCurSel(0);
  $winFieldFilter->cbFieldFilterFFC->SetCurSel(0);
  $winFieldFilter->tfFieldFilterFFV->Text('');
  $winFieldFilter->chFieldFilterFFVCase->Checked(0);
  $winFieldFilter->chFieldFilterFFVRegex->Checked(0);
  $winFieldFilter->cbFieldFilterFFV->SetCurSel(0);
  $winFieldFilter->TabFieldFilters->SetCurSel(0);
  &TabFieldFilters_Click();
  # Enable/Disable operator
  if ($winFilterSet->gridFilterSetFilters->GetRows() > 1) { $winFieldFilter->cFieldFilterOp->Enable();  }
  else                                                    { $winFieldFilter->cFieldFilterOp->Disable(); }
  &cbFieldFilterFF_Change();
  # Show window
  $winFieldFilter->Center($winFilterSet);
  $winFieldFilter->Show();
  $winFilterSet->Disable();

}  #--- End btnFilterSetFFAdd_Click

#--------------------------#
sub createWinFieldFilter
#--------------------------#
{
  # Field Filter window
  $winFieldFilter = Win32::GUI::Window->new(-name        => 'winFieldFilter'       ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'winFieldFilter'} ,
                                            -pos         => [$winPosX , $winPosY]  ,
                                            -size        => [$winWidth, 265]       ,
                                            -minsize     => [$winWidth, 265]       ,
                                            -hasmaximize => 1                      ,
                                            -hasminimize => 1                      ,
                                            -resizable   => 1                      ,
                                            -dialogui    => 1                      , );
  $winFieldFilter->SetIcon($winICO);
  $winFieldFilter->AddLabel(    -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  5,  5]               ,
                                -bitmap       => $filterList128          ,
                                -background   => [255, 255, 255]         , );
  # Create or edit a Filter Set
  $winFieldFilter->AddTabStrip( -name         => 'TabFieldFilters'       ,
                                -size         => [$winWidth-154,413]     ,
                                -pos          => [140,  0]               ,
                                -font         => $font10                 ,
                                -tabstop      => 1                       ,
                                -background => [255, 255, 255]         , );
  $winFieldFilter->TabFieldFilters->InsertItem(-text => $STR{'Filter'}         , );
  $winFieldFilter->TabFieldFilters->InsertItem(-text => $STR{'fieldFilterDB'}  , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterOp'      ,
                                    -size         => [100, 22]               ,
                                    -pos          => [150, 38]               ,
                                    -text         => $STR{'Operator'}.':'    ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         , );
  $winFieldFilter->AddCombobox(     -name         => 'cFieldFilterOp'        ,
                                    -size         => [ 60, 24]               ,
                                    -pos          => [255, 35]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->cFieldFilterOp->Add($STR{'OR'}, $STR{'AND'}, );
  $winFieldFilter->cFieldFilterOp->SetCurSel(0);
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterEditRow' ,
                                    -size         => [ 10, 22]               ,
                                    -pos          => [400, 38]               ,
                                    -visible      => 0                       , ); # Hidden, Edit mode from caller
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterEditDB'  ,
                                    -size         => [ 10, 22]               ,
                                    -pos          => [400, 38]               ,
                                    -visible      => 0                       , ); # Hidden, Edit mode from Database grid, contains id in DB and row in grid
  # Set/Add/Edit a Field Filter
  $winFieldFilter->AddButton(       -name         => 'btnFieldFilterAddDB'   ,
                                    -size         => [ 24, 24]               ,
                                    -pos          => [$winWidth-28, 35]      ,
                                    -bitmap       => $addDB                  ,
                                    -tip          => $STR{'btnFieldFilterAddDBTip'},
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddButton(       -name         => 'btnFieldFilterSaveDB'  ,
                                    -size         => [ 24, 24]               ,
                                    -pos          => [$winWidth-28, 35]      ,
                                    -bitmap       => $saveDB                 ,
                                    -tip          => $STR{'btnExtractExprSaveDBTip'},
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFF'      ,
                                    -size         => [100, 22]               ,
                                    -pos          => [150, 68]               ,
                                    -text         => $STR{'Field'}.':'       ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         , );
  $winFieldFilter->AddCombobox(     -name         => 'cbFieldFilterFF'       ,
                                    -size         => [140, 24]               ,
                                    -pos          => [255, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->cbFieldFilterFF->Add($STR{'LFclientIP'}, $STR{'isp'}, $STR{'GeoIPDB'}, $STR{'DTDB'}, $STR{'Weekday'},
                                        $STR{'LFHTTPmethod'}, $STR{'LFHTTPreq'}, $STR{'LFHTTPparam'}, $STR{'LFHTTPprot'},
                                        $STR{'LFHTTPstatus'}, $STR{'LFsize'}, $STR{'LFReferer'}, $STR{'LFUA'}, $STR{'LFUA-t'},
                                        $STR{'LFUA-os'},$STR{'LFUA-b'}, $STR{'LFUA-d'}, $STR{'LFUA-l'});
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFFC'     ,
                                    -size         => [100, 22]               ,
                                    -pos          => [150, 98]               ,
                                    -text         => $STR{'Condition'}.':'   ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         , );
  $winFieldFilter->AddCombobox(     -name         => 'cbFieldFilterFFC'      ,
                                    -size         => [140, 24]               ,
                                    -pos          => [255, 95]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->cbFieldFilterFFC->Add($STR{'is'}, $STR{'isNot'}, lc($STR{'Contains'}), $STR{'notContain'});
  $winFieldFilter->cbFieldFilterFFC->SetCurSel(0);
  $winFieldFilter->AddButton(       -name         => 'btnFieldFilterLoadVal' ,
                                    -size         => [200, 25]               ,
                                    -pos          => [400, 95]               ,
                                    -text         => $STR{'loadValue'}       ,
                                    -font         => $font10                 ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFFV'     ,
                                    -size         => [100, 22]               ,
                                    -pos          => [150,128]               ,
                                    -text         => $STR{'Value'}.':'       ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFFVOk'   ,
                                    -size         => [302, 26]               ,
                                    -pos          => [254,124]               ,
                                    -background   => [  0, 255,   0]         ,
                                    -visible      => 0                       , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFFVErr'  ,
                                    -size         => [302, 26]               ,
                                    -pos          => [254,124]               ,
                                    -background   => [255,   0,   0]         ,
                                    -visible      => 0                       , );
  $winFieldFilter->AddLabel(        -name         => 'lblFieldFilterFFVWarn' ,
                                    -size         => [302, 26]               ,
                                    -pos          => [254,124]               ,
                                    -background   => [255, 255,   0]         ,
                                    -visible      => 0                       , );
  $winFieldFilter->AddTextfield(    -name         => 'tfFieldFilterFFV'      ,
                                    -size         => [300, 24]               ,
                                    -pos          => [255,125]               ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddCheckbox(     -name         => 'chFieldFilterFFVCase'  ,
                                    -size         => [125, 22]               ,
                                    -pos          => [255,155]               ,
                                    -text         => $STR{'Case'}            ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddCheckbox(     -name         => 'chFieldFilterFFVRegex' ,
                                    -size         => [ 80, 22]               ,
                                    -pos          => [390,155]               ,
                                    -text         => $STR{'Regex'}           ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddDateTime(     -name         => 'dtFieldFilterFFVDate'  ,
                                    -size         => [110, 24]               ,
                                    -pos          => [255,125]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "shortdate"             ,
                                    -shownone     => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddDateTime(     -name         => 'dtFieldFilterFFVTime'  ,
                                    -size         => [110, 24]               ,
                                    -pos          => [380,125]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "time"                  ,
                                    -shownone     => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winFieldFilter->AddCombobox(     -name         => 'cbFieldFilterFFV'      ,
                                    -size         => [190, 24]               ,
                                    -pos          => [255,125]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  # Filter Database
  $winFieldFilter->AddGrid(     -name         => 'gridFFDB'              ,
                                -size         => [$winWidth-182,140]     ,
                                -pos          => [150, 65]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 6                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -editable     => 0                       ,
                                -visible      => 0                       ,
                                -tabstop      => 1                       , );
  $winFieldFilter->gridFFDB->SetListMode(1);
  # Popup menu for Expression Database grid
  $gridFFDBDBMenu = new Win32::GUI::Menu(
    "gridFFDBMenu"     => "gridFFDBMenu",
    "> $STR{'Edit'}"   => "FFDBEdit"    ,
    "> $STR{'Delete'}" => "FFDBDelete"  ,
  );
  $winFieldFilter->AddButton(   -name         => 'btnFieldFilterNotReady',
                                -size         => [ 30, 30]               ,
                                -pos          => [ 95,160]               ,
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winFieldFilter->AddButton(   -name         => 'btnFieldFilterOk'      ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2-20,335]    ,
                                -text         => $STR{'SetAddFilter'}    ,
                                -font         => $font10                 ,
                                -disabled     => 1                       , );
  $winFieldFilter->AddButton(   -name         => 'btnFieldFilterCancel'  ,
                                -size         => [100, 30]               ,
                                -pos          => [$winWidth/2+10,335]    ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );
  # Filter List grid header
  $winFieldFilter->gridFFDB->SetCellText(0, 0, 'Id'             ); # Hidden
  $winFieldFilter->gridFFDB->SetCellText(0, 1, $STR{'Field'}    );
  $winFieldFilter->gridFFDB->SetCellText(0, 2, $STR{'Condition'});
  $winFieldFilter->gridFFDB->SetCellText(0, 3, $STR{'Case'}     );
  $winFieldFilter->gridFFDB->SetCellText(0, 4, $STR{'Regex'}    );
  $winFieldFilter->gridFFDB->SetCellText(0, 5, $STR{'Value'}    );
  $winFieldFilter->gridFFDB->EnableColumnHide();
  $winFieldFilter->gridFFDB->EnableHiddenColUnhide(0);
  $winFieldFilter->gridFFDB->SetColumnWidth(0,0);
  $winFieldFilter->gridFFDB->AutoSize();
  $winFieldFilter->gridFFDB->ExpandLastColumn();
  # Load the Log Analysis Filters Database
  if ($CONFIG{'LAFILTERS_DB_FILE'}                    and -f $CONFIG{'LAFILTERS_DB_FILE'} and
      &validLAFiltersDB($CONFIG{'LAFILTERS_DB_FILE'}) and &validLAFilterSetDB($CONFIG{'LAFILTERS_DB_FILE'})) {
    &loadLAFiltersDB(  $CONFIG{'LAFILTERS_DB_FILE'}, \$winFieldFilter, \$win, \%STR);
  } else { # Database doesn't exist, create it with FILTERS and FILTER_SET tables
    my $LAFiltersDBFile = "$USERDIR\\LA_Filters.db";
    if (&createLAFiltersDB($LAFiltersDBFile) and &createLAFilterSetDB($LAFiltersDBFile)) {
      $CONFIG{'LAFILTERS_DB_FILE'} = $LAFiltersDBFile;
      $winConfig->tfLAFiltersDB->Text($LAFiltersDBFile);
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Create the directory for FilterSet files (json)
      mkdir("$USERDIR\\Filters") if !-d "$USERDIR\\Filters";
    }
  }

}  #--- End createWinFieldFilter

#--------------------------#
sub gridFilterSetFilters_Click
#--------------------------#
{
  # Local variables
  my $row     = shift;
  my $nbrRows = $winFilterSet->gridFilterSetFilters->GetRows() - 1;
  # Up and down button, at least 2 expressions
  if ($nbrRows > 1 and $row != 0) {
    # Up button enabled if not the first one
    if ($row != 1) { $winFilterSet->btnFilterSetFFUp->Enable();  }
    else           { $winFilterSet->btnFilterSetFFUp->Disable(); }
    # Down button enabled if not the last one
    if ($row != $nbrRows) { $winFilterSet->btnFilterSetFFDown->Enable();  }
    else                  { $winFilterSet->btnFilterSetFFDown->Disable(); }
  }
  # Enable buttons
  $winFilterSet->btnFilterSetFFEdit->Enable();
  $winFilterSet->btnFilterSetFFDel->Enable();
  return(1);

}  #--- End gridFilterSetFilters_Click

#--------------------------#
sub gridFilterSetFilters_DblClick { &btnFilterSetFFEdit_Click(); }
#--------------------------#

#--------------------------#
sub btnFilterSetFFUp_Click
#--------------------------#
{
  # Local variables
  my $upRow   = ($winFilterSet->gridFilterSetFilters->GetSelectedCellRange())[0];
  my $downRow = $upRow - 1;
  # Get selected row values
  if ($downRow > 0) { # Not the first line
    # Values to move up
    my $upOperator      = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 0);
    my $upField         = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 1);
    my $upCondition     = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 2);
    my $upCase          = $winFilterSet->gridFilterSetFilters->GetCellCheck($upRow, 3);
    my $upRegex         = $winFilterSet->gridFilterSetFilters->GetCellCheck($upRow, 4);
    my $upValue         = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 5);
    # Values to move down
    my $downOperator    = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 0);
    my $downField       = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 1);
    my $downCondition   = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 2);
    my $downCase        = $winFilterSet->gridFilterSetFilters->GetCellCheck($downRow, 3);
    my $downRegex       = $winFilterSet->gridFilterSetFilters->GetCellCheck($downRow, 4);
    my $downValue       = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 5);
    # Move values up
    if ($downRow == 1)  { $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 0, '-');         } # First row, no operator
    else                { $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 0, $upOperator); }
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 1, $upField);
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 2, $upCondition);
    if ($upCase)        { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 3, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 3, 0);  }
    if ($upRegex)       { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 4, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 4, 0);  }
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 5, $upValue);
    # Move values down
    if ($downRow == 1)  { $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 0, $STR{'OR'});    } # Operator was '-'
    else                { $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 0, $downOperator); }
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 1, $downField);
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 2, $downCondition);
    if ($downCase)      { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 3, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 3, 0);  }
    if ($downRegex)     { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 4, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 4, 0);  }
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 5, $downValue);
    &gridFilterSetFilters_Click($downRow);
    $winFilterSet->gridFilterSetFilters->Refresh();
    $winFilterSet->gridFilterSetFilters->SetSelectedCellRange($downRow, 0, $downRow, 5);
  }
  return(1);
  
}  #--- End btnFilterSetFFUp_Click

#--------------------------#
sub btnFilterSetFFDown_Click
#--------------------------#
{
  # Local variables
  my $downRow = ($winFilterSet->gridFilterSetFilters->GetSelectedCellRange())[0];
  my $nbrRows = $winFilterSet->gridFilterSetFilters->GetRows() - 1;
  my $upRow   = $downRow + 1;
  # Get selected row values
  if ($downRow < $winFilterSet->gridFilterSetFilters->GetRows()) { # Not the last line
    # Values to move down
    my $downOperator    = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 0);
    my $downField       = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 1);
    my $downCondition   = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 2);
    my $downCase        = $winFilterSet->gridFilterSetFilters->GetCellCheck($downRow, 3);
    my $downRegex       = $winFilterSet->gridFilterSetFilters->GetCellCheck($downRow, 4);
    my $downValue       = $winFilterSet->gridFilterSetFilters->GetCellText( $downRow, 5);
    # Values to move up
    my $upOperator      = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 0);
    my $upField         = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 1);
    my $upCondition     = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 2);
    my $upCase          = $winFilterSet->gridFilterSetFilters->GetCellCheck($upRow, 3);
    my $upRegex         = $winFilterSet->gridFilterSetFilters->GetCellCheck($upRow, 4);
    my $upValue         = $winFilterSet->gridFilterSetFilters->GetCellText( $upRow, 5);
    # Move values down
    if ($downRow == 1)  { $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 0, $STR{'OR'});    } # Operator was '-'
    else                { $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 0, $downOperator); }
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 1, $downField);
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 2, $downCondition);
    if ($downCase)      { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 3, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 3, 0);  }
    if ($downRegex)     { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 4, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($upRow, 4, 0);  }
    $winFilterSet->gridFilterSetFilters->SetCellText($upRow, 5, $downValue);
    # Move values up
    if ($downRow == 1)  { $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 0, '-');         } # First row, no operator
    else                { $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 0, $upOperator); }
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 1, $upField);
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 2, $upCondition);
    if ($upCase)        { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 3, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 3, 0);  }
    if ($upRegex)       { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 4, 1);  }
    else                { $winFilterSet->gridFilterSetFilters->SetCellCheck($downRow, 4, 0);  }
    $winFilterSet->gridFilterSetFilters->SetCellText($downRow, 5, $upValue);
    &gridFilterSetFilters_Click($upRow);
    $winFilterSet->gridFilterSetFilters->Refresh();
    $winFilterSet->gridFilterSetFilters->SetSelectedCellRange($upRow, 0, $upRow, 5);
  }
  return(1);
  
}  #--- End btnFilterSetFFDown_Click

#--------------------------#
sub btnFilterSetFFEdit_Click
#--------------------------#
{
  # Local variables
  my $row = ($winFilterSet->gridFilterSetFilters->GetSelectedCellRange())[0];
  &createWinFieldFilter() if !$winFieldFilter;
  if ($row != 0) {  
    # Gather values of current selection
    my $operator  = $winFilterSet->gridFilterSetFilters->GetCellText( $row, 0);
    my $field     = $winFilterSet->gridFilterSetFilters->GetCellText( $row, 1);
    my $condition = $winFilterSet->gridFilterSetFilters->GetCellText( $row, 2);
    my $case      = $winFilterSet->gridFilterSetFilters->GetCellCheck($row, 3);
    my $regex     = $winFilterSet->gridFilterSetFilters->GetCellCheck($row, 4);
    my $value     = $winFilterSet->gridFilterSetFilters->GetCellText( $row, 5);
    # Set Value
    $winFieldFilter->btnFieldFilterAddDB->Show();
    $winFieldFilter->lblFieldFilterEditRow->Text($row);
    $winFieldFilter->TabFieldFilters->SetCurSel(0);
    &TabFieldFilters_Click();
    if ($row == 1) { # First line, no operator
      $winFieldFilter->cFieldFilterOp->SetCurSel(0);
      $winFieldFilter->cFieldFilterOp->Disable();
    } else {
      $winFieldFilter->cFieldFilterOp->SetCurSel($winFieldFilter->cFieldFilterOp->FindStringExact($operator));
      $winFieldFilter->cFieldFilterOp->Enable();
    }
    $winFieldFilter->cbFieldFilterFF->SetCurSel($winFieldFilter->cbFieldFilterFF->FindStringExact($field));
    &cbFieldFilterFF_Change();
    $winFieldFilter->cbFieldFilterFFC->SetCurSel($winFieldFilter->cbFieldFilterFFC->FindStringExact($condition));
    &cbFieldFilterFFC_Change();
    if ($field eq $STR{'LFHTTPmethod'} or $field eq $STR{'Weekday'} or $field eq $STR{'LFHTTPprot'} or $field eq $STR{'LFHTTPstatus'} or
        $field eq $STR{'LFUA-t'}       or $field eq $STR{'LFUA-os'} or $field eq $STR{'LFUA-b'}     or
        $field eq $STR{'LFUA-d'}       or $field eq $STR{'LFUA-l'}) {
      $winFieldFilter->cbFieldFilterFFV->SetCurSel($winFieldFilter->cbFieldFilterFFV->FindStringExact($value));
    } elsif ($field eq $STR{'DTDB'}) {
      if ($value =~ /(\d+)-(\d+)-(\d+)/) { $winFieldFilter->dtFieldFilterFFVDate->SetDate($3,$2,$1);              }
      else                               { $winFieldFilter->dtFieldFilterFFVDate->SetNone();                      }
      if ($value =~ /(\d+):(\d+):(\d+)/) { $winFieldFilter->dtFieldFilterFFVTime->SetDateTime(2017,1,1,$1,$2,$3); }
      else                               { $winFieldFilter->dtFieldFilterFFVTime->SetNone();                      }
    } else {
      $winFieldFilter->tfFieldFilterFFV->Text($value);
      if ($case)  { $winFieldFilter->chFieldFilterFFVCase->Checked(1);  }
      else        { $winFieldFilter->chFieldFilterFFVCase->Checked(0);  }
      if ($regex) { $winFieldFilter->chFieldFilterFFVRegex->Checked(1); }
      else        { $winFieldFilter->chFieldFilterFFVRegex->Checked(0); }
    }
    # Show window
    $winFieldFilter->Center($winFilterSet);
    $winFieldFilter->Show();
    $winFilterSet->Disable();
  }
  return(1);
  
}  #--- End btnFilterSetFFEdit_Click
  
#--------------------------#
sub btnFilterSetFFDel_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $winFilterSet->gridFilterSetFilters->GetSelectedCellRange();
  my $firstSelectedRow;
  my $lastSelectedRow;
  if    ($coord[2]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[2]; }
  elsif ($coord[0]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[0]; }
  else {
    $firstSelectedRow = $winFilterSet->gridFilterSetFilters->GetRows()-1;
    $lastSelectedRow  = $winFilterSet->gridFilterSetFilters->GetRows()-1;
  }
  # Delete selected row
  for (my $row = $lastSelectedRow; $row >= $firstSelectedRow; $row--) { $winFilterSet->gridFilterSetFilters->DeleteRow($row); }
  # Reset first line operator
  if ($winFilterSet->gridFilterSetFilters->GetCellText(1, 0) ne '-') {
    $winFilterSet->gridFilterSetFilters->SetCellText(1, 0, '-');
    $winFilterSet->gridFilterSetFilters->SetCellEditable(1, 0, 0);
  }
  # Disable buttons ?
  if      ($winFilterSet->gridFilterSetFilters->GetRows() == 1) {
    $winFilterSet->btnFilterSetFFEdit->Disable();
    $winFilterSet->btnFilterSetFFDel->Disable();
  } elsif ($winFilterSet->gridFilterSetFilters->GetRows() == 2) {
    $winFilterSet->btnFilterSetFFUp->Disable();
    $winFilterSet->btnFilterSetFFDown->Disable();
  }
  $winFilterSet->gridFilterSetFilters->AutoSizeColumns();
  $winFilterSet->gridFilterSetFilters->ExpandLastColumn();
  $winFilterSet->gridFilterSetFilters->Refresh();
  &isFilterSetReady(0);

}  #--- End btnFilterSetFFDel_Click

#--------------------------#
sub isFilterSetReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  if    (!$winFilterSet->tfFilterSetCat->Text())              { $nextStep = $STR{'setFilterCat'};  }
  elsif (!$winFilterSet->tfFilterSetName->Text())             { $nextStep = $STR{'setFilterName'}; }
  elsif ($winFilterSet->gridFilterSetFilters->GetRows() <= 1) { $nextStep = $STR{'setFilter'};     }
  # Return an error message or enable the button
  if ($nextStep) {
    $winFilterSet->btnFilterSetOk->Disable();
    $winFilterSet->btnFilterSetNotReady->Enable();
    Win32::GUI::MessageBox($winFilterSet, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winFilterSet->btnFilterSetOk->Enable();
    $winFilterSet->btnFilterSetNotReady->Disable();
  }
  
}  #--- End isFilterSetReady

#--------------------------#
sub btnFilterSetNotReady_Click { &isFilterSetReady(1); }
#--------------------------#

#--------------------------#
sub btnFilterSetCancel_Click { &winFilterSet_Terminate(); }
#--------------------------#

#--------------------------#
sub winFilterSet_Terminate
#--------------------------#
{
  $winFilterSet->Hide();
  $winLAFilters->Enable();
  $winLAFilters->BringWindowToTop();
  return(0);

}  #--- End winFilterSet_Terminate

#--------------------------#
sub btnFilterSetOk_Click
#--------------------------#
{
  # Local variables
  my $editRow           = $winFilterSet->lblFilterSetEditRow->Text();
  my $LAFilterSetDBFile = $winConfig->tfLAFiltersDB->Text();
  my %filterSet;
  my $filterSetName;
  my $filterSetExists;
  my $answer;
  my $return;
  # Filter Set
  $filterSet{category}  = $winFilterSet->tfFilterSetCat->Text();
  $filterSetName        = $winFilterSet->tfFilterSetName->Text();
  $filterSet{name}      = $filterSetName =~ s/[\<\>\:\"\/\\\|\?\*]/_/gr;
  $filterSet{whiteList} = 0;
  $filterSet{whiteList} = 1 if !$winLAFilters->TabSelFilters->SelectedItem();
  # Gather filters
  for (my $i = 1; $i < $winFilterSet->gridFilterSetFilters->GetRows(); $i++) {
    $filterSet{$i}{operator}  = $winFilterSet->gridFilterSetFilters->GetCellText( $i, 0);
    $filterSet{$i}{field}     = $winFilterSet->gridFilterSetFilters->GetCellText( $i, 1);
    $filterSet{$i}{condition} = $winFilterSet->gridFilterSetFilters->GetCellText( $i, 2);
    $filterSet{$i}{case}      = $winFilterSet->gridFilterSetFilters->GetCellCheck($i, 3);
    $filterSet{$i}{regex}     = $winFilterSet->gridFilterSetFilters->GetCellCheck($i, 4);
    $filterSet{$i}{value}     = $winFilterSet->gridFilterSetFilters->GetCellText( $i, 5);
  }
  # Test if Filter Name in Category already exists, if it exists, ask to replace (only JSON is replaced, data in database are not modified)
  if (!$editRow and &isFilterSetExists($LAFilterSetDBFile, $filterSet{category}, $filterSetName)) {
    $filterSetExists = 1;
    $answer = Win32::GUI::MessageBox($winFilterSet, "$STR{'FilterSetExists'} ?", $STR{'LAFiltersDB'}, 0x1024); # Yes (6), No (7)
  } else { $answer = 6; }
  if ($answer == 6) {
    # Create or update JSON
    my $jsonObj = JSON->new;
    my $jsonText = $jsonObj->encode(\%filterSet);
    mkdir("$USERDIR\\Filters") if !-d "$USERDIR\\Filters";
    my $jsonFilterFile = "$USERDIR\\Filters\\$filterSet{category}\.$filterSet{name}\.json";
    if (open(my $json, '>:encoding(cp1252)', $jsonFilterFile)) {
      print $json $jsonText;
      close($json);
      # If it's a new Filter Set
      if (!$editRow and !$filterSetExists) {
        # Select or create Filter Set database
        if (!$LAFilterSetDBFile or !-f $LAFilterSetDBFile or !&validLAFilterSetDB($LAFilterSetDBFile)) {
          $LAFilterSetDBFile = "$USERDIR\\LA_Filters.db";
          $winConfig->tfLAFiltersDB->Text($LAFilterSetDBFile) if &createLAFilterSetDB($LAFilterSetDBFile);
        }
        if (&addLAFilterSetDB($LAFilterSetDBFile, $filterSet{category}, $filterSetName, $filterSet{whiteList}, $jsonFilterFile)) {
          # If category exists in treeview, add a child
          my $added = 0;
          my $firstNode = $winLAFilters->tvLAFilters->GetRoot();
          if ($firstNode) {
            my %node     = $winLAFilters->tvLAFilters->GetItem($firstNode);
            if ($node{'-text'} eq $filterSet{category}) {
              $winLAFilters->tvLAFilters->InsertItem(-parent => $firstNode, -text => $filterSetName);
              $added = 1;
            } else {
              my $nextNode = $firstNode;
              while ($nextNode = $winLAFilters->tvLAFilters->GetNextSibling($nextNode)) {
                %node    = $winLAFilters->tvLAFilters->GetItem($nextNode);
                if ($node{'-text'} eq $filterSet{category}) {
                  $winLAFilters->tvLAFilters->InsertItem(-parent => $nextNode, -text => $filterSetName);
                  $added = 1;
                  last;
                }
              }
            }
          }
          # Else, add parent and child
          if (!$added) {
            my $parent = $winLAFilters->tvLAFilters->InsertItem( -text => $filterSet{category});
            $winLAFilters->tvLAFilters->InsertItem(-parent => $parent, -text => $filterSetName);
          }
          $winLAFilters->tvLAFilters->SortChildren($firstNode);
        } else { $return = $STR{'errUpdatingDB'}; }
      } # Else, Edit mode, nothing to edit in database
    } else { $return = "$STR{'errorWriting'} JSON"; }
    &winFilterSet_Terminate();
    if ($return) { Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010); }
    else {
      if (!$editRow) { Win32::GUI::MessageBox($win, $STR{'addedFilterSetDB'} , "XL-Parser $VERSION", 0x40040); }
      else           { Win32::GUI::MessageBox($win, $STR{'editedFilterSetDB'}, "XL-Parser $VERSION", 0x40040); }
    }
  }

}  #--- End btnFilterSetOk_Click

#--------------------------#
sub winFieldFilter_Resize
#--------------------------#
{
  $winFieldFilter->TabFieldFilters->Width($winFieldFilter->ScaleWidth()-138);
  $winFieldFilter->TabFieldFilters->Height($winFieldFilter->ScaleHeight()+1);
  # Set, add or edit a Field Filter
  $winFieldFilter->btnFieldFilterAddDB->Left($winFieldFilter->ScaleWidth()-28);
  $winFieldFilter->btnFieldFilterSaveDB->Left($winFieldFilter->ScaleWidth()-28);
  $winFieldFilter->lblFieldFilterFFVOk->Width($winFieldFilter->ScaleWidth()-258);
  $winFieldFilter->lblFieldFilterFFVErr->Width($winFieldFilter->ScaleWidth()-258);
  $winFieldFilter->lblFieldFilterFFVWarn->Width($winFieldFilter->ScaleWidth()-258);
  $winFieldFilter->tfFieldFilterFFV->Width($winFieldFilter->ScaleWidth()-260);
  $winFieldFilter->cbFieldFilterFFV->Width($winFieldFilter->ScaleWidth()-260);
  # Field Filter Database
  $winFieldFilter->gridFFDB->Width($winFieldFilter->ScaleWidth()-155);
  $winFieldFilter->gridFFDB->Height($winFieldFilter->ScaleHeight()-115);
  $winFieldFilter->gridFFDB->AutoSize();
  $winFieldFilter->gridFFDB->ExpandLastColumn();
  $winFieldFilter->gridFFDB->Refresh();
  # Buttons
  $winFieldFilter->btnFieldFilterNotReady->Top($winFieldFilter->ScaleHeight()-40);
  $winFieldFilter->btnFieldFilterOk->Top($winFieldFilter->ScaleHeight()-40);
  $winFieldFilter->btnFieldFilterCancel->Top($winFieldFilter->ScaleHeight()-40);
  $winFieldFilter->btnFieldFilterNotReady->Left($winFieldFilter->ScaleWidth()/2-80);
  $winFieldFilter->btnFieldFilterOk->Left($winFieldFilter->ScaleWidth()/2-40);
  $winFieldFilter->btnFieldFilterCancel->Left($winFieldFilter->ScaleWidth()/2+70);
  
}  #--- End winFieldFilter_Resize

#--------------------------#
sub TabFieldFilters_Click
#--------------------------#
{
  # Set/Add/Edit a Field Filter
  if (!$winFieldFilter->TabFieldFilters->SelectedItem()) {
    # Edit from Database
    if ($winFieldFilter->lblFieldFilterEditDB->Text()) {
      $winFieldFilter->btnFieldFilterSaveDB->Show();
      $winFieldFilter->btnFieldFilterAddDB->Hide();
    } else {
      $winFieldFilter->btnFieldFilterAddDB->Show();
      $winFieldFilter->btnFieldFilterSaveDB->Hide();
    }
    $winFieldFilter->lblFieldFilterFF->Show();
    $winFieldFilter->cbFieldFilterFF->Show();
    $winFieldFilter->lblFieldFilterFFC->Show();
    $winFieldFilter->cbFieldFilterFFC->Show();
    $winFieldFilter->lblFieldFilterFFV->Show();
    &cbFieldFilterFF_Change() if !$winFieldFilter->lblFieldFilterEditDB->Text();
    # Hide Field Filter Database controls
    $winFieldFilter->gridFFDB->Hide();
  # Field Filter Database
  } else {
    $winFieldFilter->gridFFDB->Show();
    # Hide Set/Add/Edit Field Filter controls
    $winFieldFilter->btnFieldFilterAddDB->Hide();
    $winFieldFilter->btnFieldFilterSaveDB->Hide();
    $winFieldFilter->lblFieldFilterFF->Hide();
    $winFieldFilter->cbFieldFilterFF->Hide();
    $winFieldFilter->lblFieldFilterFFC->Hide();
    $winFieldFilter->cbFieldFilterFFC->Hide();
    $winFieldFilter->btnFieldFilterLoadVal->Hide();
    $winFieldFilter->lblFieldFilterFFV->Hide();
    $winFieldFilter->lblFieldFilterFFVOk->Hide();
    $winFieldFilter->lblFieldFilterFFVErr->Hide();
    $winFieldFilter->lblFieldFilterFFVWarn->Hide();
    $winFieldFilter->tfFieldFilterFFV->Hide();
    $winFieldFilter->chFieldFilterFFVCase->Hide();
    $winFieldFilter->chFieldFilterFFVRegex->Hide();
    $winFieldFilter->dtFieldFilterFFVDate->Hide();
    $winFieldFilter->dtFieldFilterFFVTime->Hide();
    $winFieldFilter->cbFieldFilterFFV->Hide();
  }
  &isFieldFilterReady(0);
  
}  #--- End TabFieldFilters_Click

#--------------------------#
sub cbFieldFilterFF_Change
#--------------------------#
{
  # Local variables
  my $filterField = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
  # Feed Field Filter Condition list
  $winFieldFilter->cbFieldFilterFFC->Clear();
  $winFieldFilter->cbFieldFilterFFV->Clear();
  if ($filterField) {
    if      ($filterField ne $STR{'isp'} and $filterField ne $STR{'GeoIPDB'}) {
      $winFieldFilter->cbFieldFilterFFC->Add($STR{'is'}, $STR{'isNot'});
    }
    if      ($filterField eq $STR{'DTDB'}) { $winFieldFilter->cbFieldFilterFFC->Add(lc($STR{'Before'}), lc($STR{'After'}));
    } elsif ($filterField eq $STR{'LFclientIP'}   or $filterField eq $STR{'isp'}       or $filterField eq $STR{'GeoIPDB'}     or
             $filterField eq $STR{'LFHTTPmethod'} or $filterField eq $STR{'LFHTTPreq'} or $filterField eq $STR{'LFHTTPparam'} or
             $filterField eq $STR{'LFHTTPprot'}   or $filterField eq $STR{'LFReferer'} or $filterField eq $STR{'LFUA'}        or
             $filterField eq $STR{'LFUA-t'}       or $filterField eq $STR{'LFUA-os'}   or $filterField eq $STR{'LFUA-b'}      or
             $filterField eq $STR{'LFUA-d'}       or $filterField eq $STR{'LFUA-l'}) {
      $winFieldFilter->cbFieldFilterFFC->Add(lc($STR{'Contains'}), $STR{'notContain'});
    } elsif ($filterField eq $STR{'LFHTTPstatus'} or $filterField eq $STR{'LFsize'}) {
      $winFieldFilter->cbFieldFilterFFC->Add(lc($STR{'Smaller'}), lc($STR{'Bigger'}));
    }
    $winFieldFilter->cbFieldFilterFFC->SetCurSel(0);
    &cbFieldFilterFFC_Change();
    # Show date and time input box
    if ($filterField eq $STR{'DTDB'}) {
      $winFieldFilter->dtFieldFilterFFVDate->Show();
      $winFieldFilter->dtFieldFilterFFVTime->Show();
      $winFieldFilter->lblFieldFilterFFVOk->Hide();
      $winFieldFilter->lblFieldFilterFFVErr->Hide();
      $winFieldFilter->lblFieldFilterFFVWarn->Hide();
      $winFieldFilter->tfFieldFilterFFV->Hide();
      $winFieldFilter->chFieldFilterFFVCase->Hide();
      $winFieldFilter->chFieldFilterFFVRegex->Hide();
      $winFieldFilter->cbFieldFilterFFV->Hide();
    # Show date and time input box
    } elsif ($filterField eq $STR{'Weekday'}) {
      $winFieldFilter->cbFieldFilterFFV->Clear();
      $winFieldFilter->cbFieldFilterFFV->Show();
      $winFieldFilter->lblFieldFilterFFVOk->Hide();
      $winFieldFilter->lblFieldFilterFFVErr->Hide();
      $winFieldFilter->lblFieldFilterFFVWarn->Hide();
      $winFieldFilter->tfFieldFilterFFV->Hide();
      $winFieldFilter->chFieldFilterFFVCase->Hide();
      $winFieldFilter->chFieldFilterFFVRegex->Hide();
      $winFieldFilter->dtFieldFilterFFVDate->Hide();
      $winFieldFilter->dtFieldFilterFFVTime->Hide();
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'monday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'tuesday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'wednesday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'thursday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'friday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'saturday'});
      $winFieldFilter->cbFieldFilterFFV->Add($STR{'sunday'});
      $winFieldFilter->cbFieldFilterFFV->SetCurSel(0);
      $winFieldFilter->cbFieldFilterFFV->BringWindowToTop();
    # Show textfield
    } else {
      my $condition = $winFieldFilter->cbFieldFilterFFC->GetString($winFieldFilter->cbFieldFilterFFC->GetCurSel());
      $winFieldFilter->tfFieldFilterFFV->Show();
      if ($filterField eq $STR{'LFsize'} or $filterField eq $STR{'LFHTTPprot'}) { $winFieldFilter->chFieldFilterFFVCase->Hide(); }
      else { $winFieldFilter->chFieldFilterFFVCase->Show(); }
      if ($condition eq lc($STR{'Contains'})) { $winFieldFilter->chFieldFilterFFVRegex->Show(); }
      else {
        $winFieldFilter->chFieldFilterFFVRegex->Hide();
        $winFieldFilter->lblFieldFilterFFVOk->Hide();
        $winFieldFilter->lblFieldFilterFFVErr->Hide();
        $winFieldFilter->lblFieldFilterFFVWarn->Hide();
      }
      $winFieldFilter->dtFieldFilterFFVDate->Hide();
      $winFieldFilter->dtFieldFilterFFVTime->Hide();
      $winFieldFilter->cbFieldFilterFFV->Hide();
    }
  }
  &isFieldFilterReady(0);

}  #--- End cbFieldFilterFF_Change

#--------------------------#
sub cbFieldFilterFFC_Change
#--------------------------#
{
  # Local variables
  my $filterField = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
  my $condition   = $winFieldFilter->cbFieldFilterFFC->GetString($winFieldFilter->cbFieldFilterFFC->GetCurSel());
  my $dbFile      = $win->tfInput->Text();
  # Show Load values from DB button
  if ($dbFile and $dbFile =~ /.db$/ and -f $dbFile and $filterField ne $STR{'DTDB'} and $filterField ne $STR{'Weekday'} and
      ($condition eq $STR{'is'} or $condition eq $STR{'isNot'})) {
    $winFieldFilter->btnFieldFilterLoadVal->Show();
  } else { $winFieldFilter->btnFieldFilterLoadVal->Hide(); }
  # Show textfield
  if ($condition eq lc($STR{'Contains'}) or $condition eq lc($STR{'notContain'})) {
    $winFieldFilter->tfFieldFilterFFV->Show();
    $winFieldFilter->chFieldFilterFFVCase->Show();
    $winFieldFilter->dtFieldFilterFFVDate->Hide();
    $winFieldFilter->dtFieldFilterFFVTime->Hide();
    $winFieldFilter->cbFieldFilterFFV->Hide();
  }
  # Show Regex option
  if ($condition eq lc($STR{'Contains'})) { $winFieldFilter->chFieldFilterFFVRegex->Show(); }
  else {
    $winFieldFilter->chFieldFilterFFVRegex->Hide();
    $winFieldFilter->lblFieldFilterFFVOk->Hide();
    $winFieldFilter->lblFieldFilterFFVErr->Hide();
    $winFieldFilter->lblFieldFilterFFVWarn->Hide();
  }
  
}  #--- End cbFieldFilterFFC_Change

#--------------------------#
sub tfFieldFilterFFV_Change     { &isFieldFilterReady(0); }
sub cbFieldFilterFFV_Change     { &isFieldFilterReady(0); }
sub chFieldFilterFFVRegex_Click { &isFieldFilterReady(0); }
#--------------------------#

#--------------------------#
sub btnFieldFilterLoadVal_Click
#--------------------------#
{
  # Local variables
  my $filterField = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
  my $dbFile      = $win->tfInput->Text();
  # Feed the list
  my $refListVal  = &listValFilterFieldDB($filterField, $dbFile, \$win, \%STR);
  my $nbrValues   = scalar(@{$refListVal});
  if ($nbrValues) {
    $winFieldFilter->cbFieldFilterFFV->Clear();
    $winFieldFilter->cbFieldFilterFFV->Show();
    $winFieldFilter->lblFieldFilterFFVOk->Hide();
    $winFieldFilter->lblFieldFilterFFVErr->Hide();
    $winFieldFilter->lblFieldFilterFFVWarn->Hide();
    $winFieldFilter->tfFieldFilterFFV->Hide();
    $winFieldFilter->chFieldFilterFFVCase->Hide();
    $winFieldFilter->chFieldFilterFFVRegex->Hide();
    $winFieldFilter->dtFieldFilterFFVDate->Hide();
    $winFieldFilter->dtFieldFilterFFVTime->Hide();
    foreach (@{$refListVal}) { $winFieldFilter->cbFieldFilterFFV->Add($_); }
    $winFieldFilter->cbFieldFilterFFV->SetCurSel(0);
    $winFieldFilter->cbFieldFilterFFV->BringWindowToTop();
  } else {
    $winFieldFilter->tfFieldFilterFFV->Show();
    $winFieldFilter->chFieldFilterFFVCase->Show();
    $winFieldFilter->dtFieldFilterFFVDate->Hide();
    $winFieldFilter->dtFieldFilterFFVTime->Hide();
    $winFieldFilter->cbFieldFilterFFV->Hide();
  }
  &isFieldFilterReady(0);

}  #--- End btnFieldFilterLoadVal_Click

#--------------------------#
sub gridFFDB_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  # Sorting
  if (!$row) {
    $winFieldFilter->gridFFDB->SetHeaderSort();
    my $order = $winFieldFilter->gridFFDB->GetSortAscending();
    if    (!$column)    { $winFieldFilter->gridFFDB->SortCells($column, $order, sub { my ($e1, $e2) = @_; return ($e1 <=> $e2);         }); }
    elsif ($column != 3 and $column != 4) { $winFieldFilter->gridFFDB->SortCells($column, $order, sub { my ($e1, $e2) = @_; return (lc($e1) cmp lc($e2)); }); }
    $winFieldFilter->gridFFDB->Refresh();
  }
  &isFieldFilterReady(0);

}  #--- End gridFFDB_Click

#--------------------------#
sub gridFFDB_RClick
#--------------------------#
{
  # Show popup menu
  my ($row, $column) = @_;
  my (@coord) = $winFieldFilter->gridFFDB->GetSelectedCellRange();
  # Select the right entry if not selected or select has change
  $winFieldFilter->gridFFDB->SetSelectedCellRange($row, 0, $row, 5)
  if (($coord[0] and ($row < $coord[0])) or ($coord[2] and ($row > $coord[2])) or !$coord[0]);
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winFieldFilter->TrackPopupMenu($gridFFDBDBMenu->{gridFFDBMenu},$X, $Y);
  &isFieldFilterReady(0);

}  #--- End gridFFDB_RClick

#--------------------------#
sub gridFFDB_DblClick
#--------------------------#
{
  my $row = ($winFieldFilter->gridFFDB->GetSelectedCellRange())[0];
  &btnFieldFilterOk_Click() if $row != 0;

}  #--- End gridFFDB_DblClick

#--------------------------#
sub FFDBEdit_Click
#--------------------------#
{
  # Local variables
  my $row = ($winFieldFilter->gridFFDB->GetSelectedCellRange())[0];
  if ($row != 0) {
    # Gather values of current selection
    my $id        = $winFieldFilter->gridFFDB->GetCellText( $row, 0);
    my $field     = $winFieldFilter->gridFFDB->GetCellText( $row, 1);
    my $condition = $winFieldFilter->gridFFDB->GetCellText( $row, 2);
    my $case      = $winFieldFilter->gridFFDB->GetCellCheck($row, 3);
    my $regex     = $winFieldFilter->gridFFDB->GetCellCheck($row, 4);
    my $value     = $winFieldFilter->gridFFDB->GetCellText( $row, 5);
    # Set Value
    $winFieldFilter->lblFieldFilterEditDB->Text("$id, $row");
    $winFieldFilter->cbFieldFilterFF->SetCurSel($winFieldFilter->cbFieldFilterFF->FindStringExact($field));
    &cbFieldFilterFF_Change();
    $winFieldFilter->cbFieldFilterFFC->SetCurSel($winFieldFilter->cbFieldFilterFFC->FindStringExact($condition));
    &cbFieldFilterFFC_Change();
    if ($field eq $STR{'Weekday'} or $field eq $STR{'LFHTTPmethod'} or $field eq $STR{'LFHTTPprot'} or $field eq $STR{'LFHTTPstatus'} or
        $field eq $STR{'LFUA-t'}  or $field eq $STR{'LFUA-os'}      or $field eq $STR{'LFUA-b'}     or $field eq $STR{'LFUA-d'}       or
        $field eq $STR{'LFUA-l'}) {
      $winFieldFilter->cbFieldFilterFFV->SetCurSel($winFieldFilter->cbFieldFilterFFV->FindStringExact($value));
    } elsif ($field eq $STR{'DTDB'}) {
      if ($value =~ /(\d+)-(\d+)-(\d+)/) { $winFieldFilter->dtFieldFilterFFVDate->SetDate($3,$2,$1);              }
      else                               { $winFieldFilter->dtFieldFilterFFVDate->SetNone();                      }
      if ($value =~ /(\d+):(\d+):(\d+)/) { $winFieldFilter->dtFieldFilterFFVTime->SetDateTime(2017,1,1,$1,$2,$3); }
      else                               { $winFieldFilter->dtFieldFilterFFVTime->SetNone();                      }
    } else {
      $winFieldFilter->tfFieldFilterFFV->Text($value);
      if ($case)  { $winFieldFilter->chFieldFilterFFVCase->Checked(1);  }
      else        { $winFieldFilter->chFieldFilterFFVCase->Checked(0);  }
      if ($regex) { $winFieldFilter->chFieldFilterFFVRegex->Checked(1); }
      else        { $winFieldFilter->chFieldFilterFFVRegex->Checked(0); }
    }
    # Go to Create/Ad/Edit Field Filter tab
    $winFieldFilter->TabFieldFilters->SetCurSel(0);
    &TabFieldFilters_Click();
  }
  &isFieldFilterReady(0);

}  #--- End FFDBEdit_Click

#--------------------------#
sub FFDBDelete_Click
#--------------------------#
{
  # Local variables
  my (@coord)         = $winFieldFilter->gridFFDB->GetSelectedCellRange();
  my $nbrEntries      = $winFieldFilter->gridFFDB->GetRows();
  my $LAFiltersDBFile = $winConfig->tfLAFiltersDB->Text();
  my @Entries2del;
  # Select data to delete
  my $lastSelectedRow; 
  if ($coord[2]) { $lastSelectedRow = $coord[2]; }
  else           { $lastSelectedRow = $coord[0]; }
  for (my $row = $coord[0]; $row <= $lastSelectedRow; $row++) {
    if ($winFieldFilter->gridFFDB->IsCellSelected($row, 0)) {
      my $idEntry = $winFieldFilter->gridFFDB->GetCellText($row, 0);
      push(@Entries2del, $idEntry);
    }
  }
  $THR = threads->create(sub {
    # Thread 'cancellation' signal handler
    $SIG{'KILL'} = sub {
      $winFieldFilter->gridFFDB->Refresh();
      # Status bar
      &winPb_Terminate;
      $winFieldFilter->ChangeCursor($ARROW);
      threads->exit();
    };
    # Show progress window
    my $nbrEntries2del = @Entries2del;
    $winPb->lblPbCurr->Text($STR{'deletingEntries'});
    $winPb->lblCount->Text("0 / $nbrEntries2del");
    $winPb->pbWinPb->SetRange(0, $nbrEntries2del);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->Center($winFieldFilter);
    $winPb->Show();
    $winFieldFilter->Disable();
    $winFieldFilter->ChangeCursor($HOURGLASS);
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$LAFiltersDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Loop each entry and delete
    my $j = 0;
    foreach my $idEntry2del (@Entries2del) {
      for (my $i = 0; $i < $nbrEntries; $i++) {
        my $idEntry = $winFieldFilter->gridFFDB->GetCellText($i, 0);
        if ($idEntry eq $idEntry2del) {
          # Delete entry in DB
          # Database: table = FILTERS, Fields = id, field, cond, value, matchcase, regex
          my $sth = $dbh->prepare('DELETE from FILTERS where id == ?');
          my $rv = $sth->execute($idEntry);
          if ($rv < 0) { Win32::GUI::MessageBox($winFieldFilter, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
          else { 
            # Find the entry in grid and delete
            for (my $k = $i; $k < $winFieldFilter->gridFFDB->GetRows(); $k++) {
              my $currIdExpr = $winFieldFilter->gridFFDB->GetCellText($k, 0);
              if ($idEntry eq $currIdExpr) {
                $winFieldFilter->gridFFDB->DeleteRow($k);
                last;
              }
            }
          }
          last;
        }
      }
      $j++;
      $winPb->lblCount->Text("$j / $nbrEntries2del");
      $winPb->pbWinPb->StepIt();
    }
    $winFieldFilter->ChangeCursor($ARROW);
    &winPb_Terminate;
    $dbh->disconnect();
    $winFieldFilter->gridFFDB->Refresh();
  });
  return(1);

}  #--- End FFDBDelete_Click

#--------------------------#
sub btnFieldFilterAddDB_Click
#--------------------------#
{
  # Local variables
  my $nbrFilters = $winFilterSet->gridFilterSetFilters->GetRows();
  my $operator   = $winFieldFilter->cFieldFilterOp->GetString($winFieldFilter->cFieldFilterOp->GetCurSel());
  my $editRow    = $winFieldFilter->lblFieldFilterEditRow->Text();
  my $field      = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
  my $condition  = $winFieldFilter->cbFieldFilterFFC->GetString($winFieldFilter->cbFieldFilterFFC->GetCurSel());
  my ($value, $case, $regex);
  # Value could be text/regex, date and time or a selection (combobox)
  if ($field eq $STR{'Weekday'} or $field eq $STR{'LFHTTPmethod'} or $field eq $STR{'LFHTTPprot'} or $field eq $STR{'LFHTTPstatus'} or
      $field eq $STR{'LFUA-t'}  or $field eq $STR{'LFUA-os'}      or $field eq $STR{'LFUA-b'}     or $field eq $STR{'LFUA-d'}       or
      $field eq $STR{'LFUA-l'}) {
    if ($field eq $STR{'Weekday'}) { $value = $winFieldFilter->cbFieldFilterFFV->GetCurSel(); }
    else { $value = $winFieldFilter->cbFieldFilterFFV->GetString($winFieldFilter->cbFieldFilterFFV->GetCurSel()); }
    $case  = undef;
    $regex = undef;
  } elsif ($field eq $STR{'DTDB'}) {
    if (!$winFieldFilter->dtFieldFilterFFVDate->IsNone()) {
      my ($d, $m  , $y) = $winFieldFilter->dtFieldFilterFFVDate->GetDate();
      $value = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
    }
    if (!$winFieldFilter->dtFieldFilterFFVTime->IsNone()) {
      my ($h, $min, $s) = $winFieldFilter->dtFieldFilterFFVTime->GetTime();
      $value .= ' ' if $value;
      $value .= sprintf("%02d:%02d:%02d", $h, $min, $s);
    }
    $case  = undef;
    $regex = undef;
  } else {
    $value = $winFieldFilter->tfFieldFilterFFV->Text();
    $case  = $winFieldFilter->chFieldFilterFFVCase->Checked();
    $regex = $winFieldFilter->chFieldFilterFFVRegex->Checked();
  }
  # Select or create Log Analysis Filters database
  my $LAFiltersDBFile = $winConfig->tfLAFiltersDB->Text();
  if (!-f $LAFiltersDBFile or !&validLAFiltersDB($LAFiltersDBFile)) {
    $LAFiltersDBFile = "$USERDIR\\LA_Filters.db";
    $winConfig->tfLAFiltersDB->Text($LAFiltersDBFile) if &createLAFiltersDB($LAFiltersDBFile);
  }
  # Add to Log Analysis Filters database
  my $dsn = "DBI:SQLite:dbname=$LAFiltersDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Last entry
    my $nbrLogEntries = $dbh->selectrow_array('SELECT COUNT(id) FROM FILTERS');
    my $id = $nbrLogEntries + 1;
    # Add to database
    # Database: table = FILTERS, Fields = id, field, cond, value, matchcase, regex
    my $sth = $dbh->prepare('INSERT INTO FILTERS (id, field, cond, matchcase, regex, value) VALUES(?,?,?,?,?,?)');
    my $rv = $sth->execute($id, $field, $condition, $case, $regex, $value);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winFieldFilter, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Add to Grid
      if (my $newLine = $winFieldFilter->gridFFDB->InsertRow($id, -1)) {
        $winFieldFilter->gridFFDB->SetCellText($newLine, 0, $id);
        $winFieldFilter->gridFFDB->SetCellText($newLine, 1, $field);
        $winFieldFilter->gridFFDB->SetCellText($newLine, 2, $condition);
        $winFieldFilter->gridFFDB->SetCellType($newLine, 3, 4);
        $winFieldFilter->gridFFDB->SetCellType($newLine, 4, 4);
        if ($case)   { $winFieldFilter->gridFFDB->SetCellCheck($newLine, 3, 1);  }
        else         { $winFieldFilter->gridFFDB->SetCellCheck($newLine, 3, 0);  }
        if ($regex)  { $winFieldFilter->gridFFDB->SetCellCheck($newLine, 4, 1);  }
        else         { $winFieldFilter->gridFFDB->SetCellCheck($newLine, 4, 0);  }
        $winFieldFilter->gridFFDB->SetCellText($newLine, 5, $value);
        # Refresh grid
        $winFieldFilter->gridFFDB->AutoSizeColumns();
        $winFieldFilter->gridFFDB->ExpandLastColumn();
        # Final message
        Win32::GUI::MessageBox($winFieldFilter, $STR{'addedFilterDB'}, $STR{'fieldFilterDB'}, 0x40040);
      } else { Win32::GUI::MessageBox($winFieldFilter, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }
  # Return to Filters Database tab
  $winFieldFilter->TabFieldFilters->SetCurSel(1);
  &TabFieldFilters_Click();
  &isFieldFilterReady(0);

}  #--- End btnFieldFilterAddDB_Click

#--------------------------#
sub btnFieldFilterSaveDB_Click
#--------------------------#
{
  # Local variables
  my ($id, $row) = split(/, /, $winFieldFilter->lblFieldFilterEditDB->Text());
  my $operator   = $winFieldFilter->cFieldFilterOp->GetString($winFieldFilter->cFieldFilterOp->GetCurSel());
  my $field      = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
  my $condition  = $winFieldFilter->cbFieldFilterFFC->GetString($winFieldFilter->cbFieldFilterFFC->GetCurSel());
  my ($value, $case, $regex);
  # Value could be text/regex, date and time or a selection (combobox)
  if ($field eq $STR{'Weekday'} or $field eq $STR{'LFHTTPmethod'} or $field eq $STR{'LFHTTPprot'} or $field eq $STR{'LFHTTPstatus'} or
      $field eq $STR{'LFUA-t'}  or $field eq $STR{'LFUA-os'}      or $field eq $STR{'LFUA-b'}     or $field eq $STR{'LFUA-d'}       or
      $field eq $STR{'LFUA-l'}) {
    if ($field eq $STR{'Weekday'}) { $value = $winFieldFilter->cbFieldFilterFFV->GetCurSel(); }
    else { $value = $winFieldFilter->cbFieldFilterFFV->GetString($winFieldFilter->cbFieldFilterFFV->GetCurSel()); }
    $case  = undef;
    $regex = undef;
  } elsif ($field eq $STR{'DTDB'}) {
    if (!$winFieldFilter->dtFieldFilterFFVDate->IsNone()) {
      my ($d, $m  , $y) = $winFieldFilter->dtFieldFilterFFVDate->GetDate();
      $value = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
    }
    if (!$winFieldFilter->dtFieldFilterFFVTime->IsNone()) {
      my ($h, $min, $s) = $winFieldFilter->dtFieldFilterFFVTime->GetTime();
      $value .= ' ' if $value;
      $value .= sprintf("%02d:%02d:%02d", $h, $min, $s);
    }
    $case  = undef;
    $regex = undef;
  } else {
    $value = $winFieldFilter->tfFieldFilterFFV->Text();
    $case  = $winFieldFilter->chFieldFilterFFVCase->Checked();
    $regex = $winFieldFilter->chFieldFilterFFVRegex->Checked();
  }
  # Edit row in Log Analysis Filters database
  my $LAFiltersDBFile = $winConfig->tfLAFiltersDB->Text();
  my $dsn = "DBI:SQLite:dbname=$LAFiltersDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Database: table = FILTERS, Fields = id, field, cond, value, matchcase, regex
    my $sth = $dbh->prepare('UPDATE FILTERS SET field = ?, cond = ?, matchcase = ?, regex = ?, value = ? WHERE id == ?');
    my $rv  = $sth->execute($field, $condition, $case, $regex, $value, $id);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winFieldFilter, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Edit in Grid
      $winFieldFilter->gridFFDB->SetCellText($row, 0, $id);
      $winFieldFilter->gridFFDB->SetCellText($row, 1, $field);
      $winFieldFilter->gridFFDB->SetCellText($row, 2, $condition);
      if ($case)   { $winFieldFilter->gridFFDB->SetCellCheck($row, 3, 1);  }
      else         { $winFieldFilter->gridFFDB->SetCellCheck($row, 3, 0);  }
      if ($regex)  { $winFieldFilter->gridFFDB->SetCellCheck($row, 4, 1);  }
      else         { $winFieldFilter->gridFFDB->SetCellCheck($row, 4, 0);  }
      $winFieldFilter->gridFFDB->SetCellText($row, 5, $value);
      $winFieldFilter->gridFFDB->Refresh();
      # Final message
      Win32::GUI::MessageBox($winFieldFilter, $STR{'editedFilterDB'}, $STR{'fieldFilterDB'}, 0x40040);
    }
  }
  # Reset values
  $winFieldFilter->tfFieldFilterFFV->Text('');
  $winFieldFilter->chFieldFilterFFVCase->Checked(0);
  $winFieldFilter->chFieldFilterFFVRegex->Checked(0);
  $winFieldFilter->cbFieldFilterFFV->SetCurSel(0);
  # Return to Filters Database tab
  $winFieldFilter->lblFieldFilterEditDB->Text('');
  $winFieldFilter->btnFieldFilterAddDB->Show();
  $winFieldFilter->btnFieldFilterSaveDB->Hide();
  $winFieldFilter->TabFieldFilters->SetCurSel(1);
  &TabFieldFilters_Click();
  &isFieldFilterReady(0);

}  #--- End btnFieldFilterSaveDB_Click

#--------------------------#
sub isFieldFilterReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $selTab  = $winFieldFilter->TabFieldFilters->SelectedItem();
  my $nextStep;
  # Create/Add/Edit Field Filter tab
  if (!$selTab) {
    my $field = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
    my $value = $winFieldFilter->tfFieldFilterFFV->Text();
    # Value is text
    if ($field and $field ne $STR{'DTDB'}) {
      if (!$value and !$winFieldFilter->cbFieldFilterFFV->Count()) {
        $nextStep = $STR{'setValue'};
      # Value is a regex
      } elsif ($winFieldFilter->chFieldFilterFFVRegex->Checked()) {
        # Regex provided ?
        if ($value) {
          my ($statusRegex, $msg) = &validRegex($value);
          # Warning
          if      ($statusRegex == 2) {
            $winFieldFilter->lblFieldFilterFFVWarn->Show();
            $winFieldFilter->lblFieldFilterFFVOk->Hide();
            $winFieldFilter->lblFieldFilterFFVErr->Hide();
          # Error
          } elsif ($statusRegex == 1) {
            $winFieldFilter->lblFieldFilterFFVErr->Show();
            $winFieldFilter->lblFieldFilterFFVOk->Hide();
            $winFieldFilter->lblFieldFilterFFVWarn->Hide();
            $nextStep = $STR{'errRegex'};
          # Ok
          } else {
            $winFieldFilter->lblFieldFilterFFVOk->Show();
            $winFieldFilter->lblFieldFilterFFVErr->Hide();
            $winFieldFilter->lblFieldFilterFFVWarn->Hide();
          }
        } else {
          $winFieldFilter->lblFieldFilterFFVOk->Hide();
          $winFieldFilter->lblFieldFilterFFVErr->Hide();
          $winFieldFilter->lblFieldFilterFFVWarn->Hide();
          $nextStep = $STR{'errRegex'};
        }
      } else {
        $winFieldFilter->lblFieldFilterFFVOk->Hide();
        $winFieldFilter->lblFieldFilterFFVErr->Hide();
        $winFieldFilter->lblFieldFilterFFVWarn->Hide();
      }
      # Value couldn't contain quote character
      $nextStep = $STR{'errQuote'} if $value =~ /'/;
    }
  # Filters Database tab
  } elsif (!($winFieldFilter->gridFFDB->GetSelectedCellRange())[0]) { $nextStep = $STR{'selFilter'}; }
  # Return an error message or enable the button
  if ($nextStep) {
    $winFieldFilter->btnFieldFilterAddDB->Disable();
    $winFieldFilter->btnFieldFilterSaveDB->Disable();
    $winFieldFilter->btnFieldFilterOk->Disable();
    $winFieldFilter->btnFieldFilterNotReady->Enable();
    Win32::GUI::MessageBox($winSelFileFilters, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winFieldFilter->btnFieldFilterAddDB->Enable();
    $winFieldFilter->btnFieldFilterSaveDB->Enable();
    $winFieldFilter->btnFieldFilterOk->Enable();
    $winFieldFilter->btnFieldFilterNotReady->Disable();
  }
  
}  #--- End isFieldFilterReady
  
#--------------------------#
sub btnFieldFilterNotReady_Click { &isFieldFilterReady(1); }
#--------------------------#

#--------------------------#
sub btnFieldFilterCancel_Click
#--------------------------#
{
  $winFieldFilter->lblFieldFilterEditRow->Text('');
  $winFieldFilter->lblFieldFilterEditDB->Text('');
  &winFieldFilter_Terminate();

}  #--- End btnFieldFilterCancel_Click

#--------------------------#
sub winFieldFilter_Terminate
#--------------------------#
{
  $winFieldFilter->Hide();
  $win->BringWindowToTop();
  $winFilterSet->Enable();
  $winFilterSet->BringWindowToTop();
  return(0);

}  #--- End winFieldFilter_Terminate
  
#--------------------------#
sub btnFieldFilterOk_Click
#--------------------------#
{
  # Local variables
  my $selTab     = $winFieldFilter->TabFieldFilters->SelectedItem();
  my $nbrFilters = $winFilterSet->gridFilterSetFilters->GetRows();
  my $operator   = $winFieldFilter->cFieldFilterOp->GetString($winFieldFilter->cFieldFilterOp->GetCurSel());
  my $editRow    = $winFieldFilter->lblFieldFilterEditRow->Text();
  my ($field, $condition, $value, $case, $regex);
  # From Create/Add/Edit Field Filter tab
  if (!$selTab) {
    $field     = $winFieldFilter->cbFieldFilterFF->GetString($winFieldFilter->cbFieldFilterFF->GetCurSel());
    $condition = $winFieldFilter->cbFieldFilterFFC->GetString($winFieldFilter->cbFieldFilterFFC->GetCurSel());
    # Value could be text/regex, date and time or a selection (combobox)
    if ($winFieldFilter->cbFieldFilterFFV->Count()) {
      if ($field eq $STR{'Weekday'}) { $value = $winFieldFilter->cbFieldFilterFFV->GetCurSel(); }
      else { $value = $winFieldFilter->cbFieldFilterFFV->GetString($winFieldFilter->cbFieldFilterFFV->GetCurSel()); }
    } elsif ($field eq $STR{'DTDB'}) {
      if (!$winFieldFilter->dtFieldFilterFFVDate->IsNone()) {
        my ($d, $m  , $y) = $winFieldFilter->dtFieldFilterFFVDate->GetDate();
        $value = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      }
      if (!$winFieldFilter->dtFieldFilterFFVTime->IsNone()) {
        my ($h, $min, $s) = $winFieldFilter->dtFieldFilterFFVTime->GetTime();
        $value .= ' ' if $value;
        $value .= sprintf("%02d:%02d:%02d", $h, $min, $s);
      }
    } else {
      $value = $winFieldFilter->tfFieldFilterFFV->Text();
      $case  = $winFieldFilter->chFieldFilterFFVCase->Checked();
      $regex = $winFieldFilter->chFieldFilterFFVRegex->Checked();
    }
  # Filters Database tab
  } else {
    my $row = ($winFieldFilter->gridFFDB->GetSelectedCellRange())[0];
    if ($row != 0) {  
      # Gather values of current selection
      $field     = $winFieldFilter->gridFFDB->GetCellText( $row, 1);
      $condition = $winFieldFilter->gridFFDB->GetCellText( $row, 2);
      $case      = $winFieldFilter->gridFFDB->GetCellCheck($row, 3);
      $regex     = $winFieldFilter->gridFFDB->GetCellCheck($row, 4);
      $value     = $winFieldFilter->gridFFDB->GetCellText( $row, 5);
      # Filters that require resolving
      if    ($field eq $STR{'isp'}    ) { $win->chLAOptResISP->Checked(1); }
      elsif ($field eq $STR{'GeoIPDB'}) { $win->chLAOptResGeoIP->Checked(1); }
      elsif ($field eq $STR{'LFUA-t'} or $field eq $STR{'LFUA-os'} or $field eq $STR{'LFUA-b'} or
             $field eq $STR{'LFUA-d'} or $field eq $STR{'LFUA-l'}) { $win->chLAOptResUA->Checked(1); }
      elsif ($field eq $STR{'Weekday'}) { $win->chLAOptResWeekday->Checked(1); }
    }
  }
  # Add to grid
  my $row;
  if ($editRow) { $row = $editRow; } # Edit mode
  else          { $row = $winFilterSet->gridFilterSetFilters->InsertRow('-', -1); }
  if ($row) {
    if ($operator and $row > 1) {
      $winFilterSet->gridFilterSetFilters->SetCellText($row, 0, $operator);
      $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 0, 1);
      $winFilterSet->gridFilterSetFilters->SetCellType($row, 0, 6);
      $winFilterSet->gridFilterSetFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
    }
    $winFilterSet->gridFilterSetFilters->SetCellText($row, 1, $field);
    $winFilterSet->gridFilterSetFilters->SetCellText($row, 2, $condition);
    $winFilterSet->gridFilterSetFilters->SetCellType($row, 3, 4);
    $winFilterSet->gridFilterSetFilters->SetCellType($row, 4, 4);
    if ($case)   { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 3, 1);  }
    else         { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 3, 0);  }
    if ($regex)  { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 4, 1);  }
    else         { $winFilterSet->gridFilterSetFilters->SetCellCheck($row, 4, 0);  }
    $winFilterSet->gridFilterSetFilters->SetCellText($row, 5, $value);
    $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 1, 0);
    $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 2, 0);
    $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 3, 0);
    $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 4, 0);
    $winFilterSet->gridFilterSetFilters->SetCellEditable($row, 5, 0);
    $winFilterSet->gridFilterSetFilters->AutoSizeColumns();
    $winFilterSet->gridFilterSetFilters->ExpandLastColumn();
    $winFilterSet->gridFilterSetFilters->Refresh();
  }
  &winFieldFilter_Terminate();  
  &isFilterSetReady(0);

}  #--- End btnFieldFilterOk_Click

#--------------------------#
sub rbSplitBySize_Click      { &chSplitTypeChange; }
sub tfSplitBySizeFrag_Change { &isProcessReady(0); }
sub rbSplitByLines_Click     { &chSplitTypeChange; }
sub rbSplitByTime_Click      { &chSplitTypeChange; }
sub cbSplitTimeFormat_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub chSplitTypeChange
#--------------------------#
{
  # Show SplitBySize controls
  if ($win->rbSplitBySize->Checked()) {
    $win->lblSplitBySize->Show();
    $win->tfSplitBySizeFrag->Show();
    $win->cbSplitBySizeUnit->Show();
    $win->chSplitUseDTFN->Show();
    # Hide SplitByLines controls
    $win->lblSplitByLinesNbr->Hide();
    $win->tfSplitByLinesNbr->Hide();
    $win->upDownLinesNbr->Hide();
    # Hide SplitByTime controls
    $win->lblSplitByTime->Hide();
    $win->cbSplitByTimeInter->Hide();
    if (!$win->chSplitUseDTFN->Checked()) {
      $win->lblSplitTimeFormat->Hide();
      $win->lblSplitTimeFormat->Hide();
      $win->cbSplitTimeFormat->Hide();
      $win->btnSplitTimeDTDB->Hide();
      $win->btnSplitTimeFormatGuess->Hide();
    }
  # Show SplitByLines controls
  } elsif ($win->rbSplitByLines->Checked()) {
    $win->lblSplitByLinesNbr->Show();
    $win->tfSplitByLinesNbr->Show();
    $win->upDownLinesNbr->Show();
    $win->chSplitUseDTFN->Show();
    # Hide SplitBySize controls
    $win->lblSplitBySize->Hide();
    $win->tfSplitBySizeFrag->Hide();
    $win->cbSplitBySizeUnit->Hide();
    # Hide SplitByTime controls
    $win->lblSplitByTime->Hide();
    $win->cbSplitByTimeInter->Hide();
    if (!$win->chSplitUseDTFN->Checked()) {
      $win->lblSplitTimeFormat->Hide();
      $win->lblSplitTimeFormat->Hide();
      $win->cbSplitTimeFormat->Hide();
      $win->btnSplitTimeDTDB->Hide();
      $win->btnSplitTimeFormatGuess->Hide();
    }
  # Show SplitByTime controls
  } else {
    $win->lblSplitByTime->Show();
    $win->cbSplitByTimeInter->Show();
    $win->lblSplitTimeFormat->Show();
    $win->lblSplitTimeFormat->Show();
    $win->cbSplitTimeFormat->Show();
    $win->btnSplitTimeDTDB->Show();
    $win->btnSplitTimeFormatGuess->Show();
    # Hide SplitBySize controls
    $win->lblSplitBySize->Hide();
    $win->tfSplitBySizeFrag->Hide();
    $win->cbSplitBySizeUnit->Hide();
    $win->chSplitUseDTFN->Hide();
    # Hide SplitByLines controls
    $win->lblSplitByLinesNbr->Hide();
    $win->tfSplitByLinesNbr->Hide();
    $win->upDownLinesNbr->Hide();
  }
  &isProcessReady(0);

}  #--- End chSplitTypeChange

#--------------------------#
sub chSplitUseDTFN_Click
#--------------------------#
{
  # Enable time format controls
  if ($win->chSplitUseDTFN->Checked()) {
    $win->lblSplitTimeFormat->Show();
    $win->cbSplitTimeFormat->Show();
    $win->btnSplitTimeDTDB->Show();
    $win->btnSplitTimeFormatGuess->Show();
  } else {
    $win->lblSplitTimeFormat->Hide();
    $win->cbSplitTimeFormat->Hide();
    $win->btnSplitTimeDTDB->Hide();
    $win->btnSplitTimeFormatGuess->Hide();
  }
  &isProcessReady(0);

}  #--- End chSplitUseDTFN_Click
  
#--------------------------#
sub btnSplitTimeDTDB_Click
#--------------------------#
{
  if (my $selRow = ($winDTDB->gridDT->GetSelectedCellRange())[0]) {
    $winDTDB->btnDTEdit->Enable();
    $winDTDB->btnDTDel->Enable();
  } else {
    $winDTDB->btnDTEdit->Disable();
    $winDTDB->btnDTDel->Disable();
  }
  $winDTDB->Center($win);
  $winDTDB->Show();
  $win->Disable();
  return(1);

}  #--- End btnSplitTimeDTDB_Click
  
#--------------------------#
sub btnSplitTimeFormatGuess_Click
#--------------------------#
{
  # Guess format of the first item
  if (my $sample = (&findDTFormatInLog(0))) {
    $win->cbSplitTimeFormat->SetCurSel($win->cbSplitTimeFormat->FindStringExact($sample));
    &isProcessReady(0);
  # If not found
  } else { Win32::GUI::MessageBox($win, $STR{'formatNotFound'}.'...', $STR{'error'}, 0x40010); }

}  #--- End btnSplitTimeFormatGuess_Click

#--------------------------#
sub tfSplitDestDir_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub btnSplitDestDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir       = $win->tfSplitDestDir->Text();
  my $LAFunctionStr = $win->LAFunctions->GetString($win->LAFunctions->SelectedItem());
  my $dir;
  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
  }
  if ($lastDir) {
    $dir = Win32::GUI::BrowseForFolder(-owner      => $win                 ,
                                       -title      => $STR{'selDirDst'}.':',
                                       -folderonly => 1                    ,
                                       -directory  => $lastDir             ,
                                       -newui      => 1                    , );
  } else {
    $dir = Win32::GUI::BrowseForFolder(-owner      => $win                 ,
                                       -title      => $STR{'selDirDst'}.':',
                                       -folderonly => 1                    ,
                                       -newui      => 1                    , );
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $win->tfSplitDestDir->Text($dir);
  }
  &isProcessReady(0);
  
}  #--- End btnSplitDestDir_Click

#--------------------------#
sub findDTFormatInLog
#--------------------------#
{
  # Local variables
  my $firstLine = shift;
  # Get first line of one file in input
  if (!$firstLine and ($win->rbInputDir->Checked() or $win->rbInputFiles->Checked())) {
    my $oneFile = &getOneFile;
    if (open(my $fh, $oneFile)) {
      while (<$fh>) { $firstLine = $_ if $_ !~ /^#/; }
      close($fh);
    }
  }
  # Compare with all input format
  if ($firstLine) {
    for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
      my $regex = $winDTDB->gridDT->GetCellText($i, 2);
      if ($firstLine =~ /($regex)/i) {
        my $pattern = $winDTDB->gridDT->GetCellText($i, 1);
        # Format
        my $partItem = $1 =~ s/ +/ /gr;
        my $strp = DateTime::Format::Strptime->new(pattern => $pattern, zone_map => \%ZONE_MAP);
        return($winDTDB->gridDT->GetCellText($i, 0)) if $strp->parse_datetime($partItem);
      }
    }
  }
  return(0);
  
}  #--- End findDTFormatInLog

#--------------------------#
sub findInputDTFormat
#--------------------------#
{
  # Local variables
  my $item = shift;
  # Guess format
  for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
    my $regex = $winDTDB->gridDT->GetCellText($i, 2);
    if ($item =~ /($regex)/i) {
      my $pattern = $winDTDB->gridDT->GetCellText($i, 1);
      # Format
      my $partItem = $1 =~ s/ +/ /gr;
      my $strp = DateTime::Format::Strptime->new(pattern => $pattern, zone_map => \%ZONE_MAP);
      if (my $dt = $strp->parse_datetime($partItem)) {
        my $timezone;
        $timezone = $winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}) if $winDTDB->gridDT->GetCellText($i, 3) eq 'local';
        return($winDTDB->gridDT->GetCellText($i, 0), $winDTDB->gridDT->GetCellText($i, 1),
               $winDTDB->gridDT->GetCellText($i, 2), $timezone);
      }
    }
  }
  return(0);
  
}  #--- End findInputDTFormat

#--------------------------#
sub infoDTFormat
#--------------------------#
{
  # Local variables
  my $sample = shift;  
  # Guess format
  for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
    my $curSampleRow = $winDTDB->gridDT->GetCellText($i, 0);
    if ($curSampleRow eq $sample) {
      return($winDTDB->gridDT->GetCellText($i, 0), $winDTDB->gridDT->GetCellText($i, 1),
             $winDTDB->gridDT->GetCellText($i, 2), $winDTDB->gridDT->GetCellText($i, 3));
    }
  }
  return(0);
  
}  #--- End infoDTFormat

#--------------------------#
sub getOneFile
#--------------------------#
{
  # Get one file from input
  my $dir = $win->tfInput->Text();
  if (!-d $dir) {
    my $filesStr = $dir;
    # Multiple files
    if ($filesStr =~ /" "/) {
      my @items   = split(/" "/, $filesStr);
      my $baseDir = shift(@items);
      $baseDir    =~ s/^\"//;
      my $item    = shift(@items);
      $item       =~ s/\"$//;
      return("$baseDir\\$item");
    # Single file
    } else { return($filesStr); }
  # Directory (List files and apply filters)
  } else {
    my @subFolders;
    # Open base directory
    $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir);
    if (opendir(DIR,"$dir\\")) {
      while (my $file = readdir(DIR)) {
        my $filePath = "$dir\\$file";
        if ((-d $filePath) and ($file !~ /^\.\.?$/) and ($file ne 'System Volume Information')) { # It's a directory
          push(@subFolders, $filePath) if $win->chInputDirRecurse->Checked(); # Subfolders option
        } elsif (!-d $filePath and -e $filePath) { return($filePath); } # It's a file
      }
      closedir(DIR);
    }
    # List folders and files in subfolders
    if ($win->chInputDirRecurse->Checked() and scalar(@subFolders) > 0) {
      foreach my $subFolder (@subFolders) {
        $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$subFolder);
        if (opendir(DIR,"$subFolder\\")) {
          while (my $file = readdir(DIR)) {
            my $filePath = "$subFolder\\$file";
            if    ((-d $filePath) and ($file !~ /^\.\.?$/)) { push(@subFolders, $filePath); } # It's a directory
            elsif (!-d $filePath and -e $filePath         ) { return($filePath);            } # It's a file
          }
          closedir(DIR);
        }
      }
    }
  }
  
}  #--- End getOneFile

#--------------------------#
sub gridDT_Click
#--------------------------#
{
  $winDTDB->btnDTEdit->Enable();
  $winDTDB->btnDTDel->Enable();
  return(1);

}  #--- End gridDT_Click

#--------------------------#
sub gridDT_DblClick { &btnDTEdit_Click(); }
#--------------------------#

#--------------------------#
sub sortGridDT
#--------------------------#
{
  my ($a, $b) = @_;
  return (length($a) <=> length($b));

}  #--- End sortGridDT

#--------------------------#
sub btnDTAdd_Click
#--------------------------#
{
  &createWinDTObj() if !$winDTObj;
  # Reset all values
  $winDTObj->tfDTObjSample->Text('');
  $winDTObj->tfDTObjSample->ReadOnly(0);
  $winDTObj->tfDTObjPattern->Text('');
  $winDTObj->cbDTObjPattern->SetCurSel(0);
  $winDTObj->lblDTObjRegexOk->Hide();
  $winDTObj->lblDTObjRegexErr->Hide();
  $winDTObj->lblDTObjRegexWarn->Hide();
  $winDTObj->tfDTObjRegex->Text('');
  $winDTObj->chDTObjRegexAuto->Checked(1);
  $winDTObj->rbDTObjTZLocal->Checked(1);
  $winDTObj->rbDTObjTZUTC->Checked(0);
  $winDTObj->rbDTObjTZOtherOffset->Checked(0);
  $winDTObj->rbDTObjTZOtherName->Checked(0);
  $winDTObj->cbDTObjTZOffset->SetCurSel(0);
  $winDTObj->cbDTObjTZName->SetCurSel(0);
  $winDTObj->lblDTObjParsedData->Text('');
  $winDTObj->cbDTObjUseAs->SetCurSel(0);
  $winDTObj->tfDTObjComment->Text('');
  # Update controls
  $winDTObj->btnDTObjFromInput->Enable();
  $winDTObj->btnDTObjAdd->Show();
  $winDTObj->btnDTObjEdit->Hide();
  $winDTObj->Center($win);
  $winDTObj->Show();
  $winDTDB->Disable();
  return(1);

}  #--- End btnDTAdd_Click

#--------------------------#
sub btnDTEdit_Click
#--------------------------#
{
  &createWinDTObj() if !$winDTObj;
  # Local variables
  my %useAsInd = ($STR{'Input'} => 0, $STR{'output'} => 1, $STR{'both'} => 2, $STR{'none'} => 3);
  # Load the current values
  my $selRow = ($winDTDB->gridDT->GetSelectedCellRange())[0];
  $winDTObj->tfDTObjSample->Text($winDTDB->gridDT->GetCellText($selRow, 0));
  $winDTObj->tfDTObjSample->ReadOnly(1);
  $winDTObj->tfDTObjPattern->Text($winDTDB->gridDT->GetCellText($selRow, 1));
  $winDTObj->tfDTObjRegex->Text($winDTDB->gridDT->GetCellText($selRow, 2));
  my $timezone = $winDTDB->gridDT->GetCellText($selRow, 3);
  if      ($timezone eq 'local') {
    $winDTObj->rbDTObjTZLocal->Checked(1);
    $winDTObj->rbDTObjTZUTC->Checked(0);
    $winDTObj->rbDTObjTZOtherOffset->Checked(0);
    $winDTObj->rbDTObjTZOtherName->Checked(0);
  } elsif ($timezone eq 'UTC') {
    $winDTObj->rbDTObjTZLocal->Checked(0);
    $winDTObj->rbDTObjTZUTC->Checked(1);
    $winDTObj->rbDTObjTZOtherOffset->Checked(0);
    $winDTObj->rbDTObjTZOtherName->Checked(0);
  } elsif ($timezone =~ /[\+\-]?\d{4}/) {
    $winDTObj->rbDTObjTZLocal->Checked(0);
    $winDTObj->rbDTObjTZUTC->Checked(0);
    $winDTObj->rbDTObjTZOtherOffset->Checked(1);
    $winDTObj->rbDTObjTZOtherName->Checked(0);
    $winDTObj->cbDTObjTZOffset->SetCurSel($winDTObj->cbDTObjTZOffset->FindStringExact($timezone));
  } else {
    $winDTObj->rbDTObjTZLocal->Checked(0);
    $winDTObj->rbDTObjTZUTC->Checked(0);
    $winDTObj->rbDTObjTZOtherOffset->Checked(0);
    $winDTObj->rbDTObjTZOtherName->Checked(1);
    $winDTObj->cbDTObjTZName->SetCurSel($winDTObj->cbDTObjTZName->FindStringExact($timezone));
  }
  my $useAsStr = $winDTDB->gridDT->GetCellText($selRow, 4); # 0 = Input, 1 = Output, 2 = Both, 3 = None
  $winDTObj->cbDTObjUseAs->SetCurSel($useAsInd{$useAsStr}) if exists($useAsInd{$useAsStr});
  if ($winDTDB->gridDT->GetCellText($selRow, 5)) { $winDTObj->tfDTObjComment->Text($winDTDB->gridDT->GetCellText($selRow, 5)); }
  else                                           { $winDTObj->tfDTObjComment->Text(''); }
  # Update controls
  $winDTObj->btnDTObjFromInput->Disable();
  $winDTObj->btnDTObjEdit->Show();
  $winDTObj->btnDTObjAdd->Hide();
  $winDTObj->Center($win);
  $winDTObj->Show();
  $winDTDB->Disable();
  return(1);

}  #--- End btnDTEdit_Click

#--------------------------#
sub createWinDTObj
#--------------------------#
{
  # Datetime Object window
  $winDTObj = Win32::GUI::Window->new(-name        => 'winDTObj'             ,
                                      -background  => [255, 255, 255]        ,
                                      -parent      => $win                   ,
                                      -text        => $STR{'winDTObj'}       ,
                                      -pos         => [$winPosX, $winPosY]   ,
                                      -size        => [690, 290]             ,
                                      -hasmaximize => 0                      ,
                                      -hasminimize => 0                      ,
                                      -resizable   => 0                      ,
                                      -dialogui    => 1                      , );
  $winDTObj->SetIcon($winICO);
  $winDTObj->AddLabel(          -name         => 'lblDTObjSample'        ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5,  8]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'sample'}.':'      ,
                                -font         => $font10                 , );
  $winDTObj->AddTextfield(      -name         => 'tfDTObjSample'         ,
                                -size         => [285, 24]               ,
                                -pos          => [100,  5]               ,
                                -tabstop      => 1                       , );
  $winDTObj->AddButton(         -name         => 'btnDTObjFromInput'     ,
                                -size         => [150, 24]               ,
                                -pos          => [390,  5]               ,
                                -text         => $STR{'btnDTObjFromInput'},
                                -font         => $font10                 , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjPattern'       ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5, 38]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'pattern'}.':'     ,
                                -font         => $font10                 , );
  $winDTObj->AddTextfield(      -name         => 'tfDTObjPattern'        ,
                                -size         => [260, 24]               ,
                                -pos          => [100, 35]               ,
                                -tabstop      => 1                       ,
                                -disabled     => 1                       , );
  $winDTObj->AddButton(         -name         => 'btnDTObjPatternInsert' ,
                                -size         => [ 24, 24]               ,
                                -pos          => [362, 35]               ,
                                -bitmap       => $left16Bmp              ,
                                -tip          => $STR{'btnPatternAdd'}   ,
                                -disabled     => 1                       , );
  $winDTObj->AddCombobox(       -name         => 'cbDTObjPattern'        ,
                                -size         => [260,100]               ,
                                -pos          => [390, 35]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       ,
                                -disabled     => 1                       , );
  $winDTObj->cbDTObjPattern->Add('%B - ' . $STR{'MonthNameFull'}                 ,
                                 '%b - ' . $STR{'MonthNameAbbr'}                 ,
                                 '%D - ' . $STR{'EquivalentTo'}  . ' %m/%d/%y'   ,
                                 '%d - ' . $STR{'DayOfTheMonth'} . ' (01-31)'    ,
                                 '%e - ' . $STR{'DayOfTheMonth'} . ' (1-31)'     ,
                                 '%F - ' . $STR{'EquivalentTo'}  . ' %Y-%m-%d'   ,
                                 '%H - ' . $STR{'pattern7'}      . ' (00-23)'    ,
                                 '%I - ' . $STR{'pattern8'}      . ' (01-12)'    ,
                                 '%M - ' . $STR{'Minutes'}       . ' (00-59)'    ,
                                 '%m - ' . $STR{'Month'}         . ' (01-12)'    ,
                                 '%p - ' . $STR{'AMorPM'}                        ,
                                 '%R - ' . $STR{'EquivalentTo'}  . ' %H:%M'      ,
                                 '%r - ' . $STR{'EquivalentTo'}  . ' %I:%M:%S %p',
                                 '%S - ' . $STR{'Seconds'}       . ' (00-60)'    ,
                                 '%T - ' . $STR{'EquivalentTo'}  . ' %H:%M:%S'   ,
                                 '%v - ' . $STR{'EquivalentTo'}  . ' %e-%b-%Y'   ,
                                 '%w - ' . $STR{'Weekday'}       . ' (0-6)'      ,
                                 '%Y - ' . $STR{'Year1'}                         ,
                                 '%y - ' . $STR{'Year2'}                         ,
                                 '%Z - ' . $STR{'TZN'}                           ,
                                 '%z - ' . $STR{'TZO'}                           , );
  $winDTObj->cbDTObjPattern->SetCurSel(0);
  $winDTObj->AddButton(         -name         => 'btnDTObjPatternHelp'   ,
                                -size         => [ 24, 24]               ,
                                -pos          => [652, 35]               ,
                                -bitmap       => $help16Bmp              ,
                                -tip          => $STR{'btnHelpTip'}      , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjRegex'         ,
                                -size         => [ 95, 24]               ,
                                -pos          => [  5, 68]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Regex'}.':'       ,
                                -font         => $font10                 , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjRegexOk'       ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99, 64]               ,
                                -background   => [  0, 255,   0]         ,
                                -visible      => 0                       , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjRegexErr'      ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99, 64]               ,
                                -background   => [255,   0,   0]         ,
                                -visible      => 0                       , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjRegexWarn'     ,
                                -size         => [287, 26]               ,
                                -pos          => [ 99, 64]               ,
                                -background   => [255, 255,   0]         ,
                                -visible      => 0                       , );
  $winDTObj->AddTextfield(      -name         => 'tfDTObjRegex'          ,
                                -size         => [285, 24]               ,
                                -pos          => [100, 65]               ,
                                -tabstop      => 1                       ,
                                -disabled     => 1                       , );
  $winDTObj->AddCheckbox(       -name         => 'chDTObjRegexAuto'      ,
                                -size         => [150, 22]               ,
                                -pos          => [390, 65]               ,
                                -text         => $STR{'matchPattern'}    ,
                                -background   => [255, 255, 255]         ,
                                -font         => $font10                 ,
                                -checked      => 1                       , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjTZ'            ,
                                -size         => [ 95, 22]               ,
                                -pos          => [  5, 98]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'timezone'}.':'    ,
                                -font         => $font10                 , );
  $winDTObj->AddRadioButton(    -name         => 'rbDTObjTZLocal'        ,
                                -size         => [ 70, 22]               ,
                                -pos          => [100, 95]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'Local'}           ,
                                -font         => $font10                 ,
                                -checked      => 1                       ,
                                -group        => 1                       , );
  $winDTObj->AddRadioButton(    -name         => 'rbDTObjTZUTC'          ,
                                -size         => [ 70, 22]               ,
                                -pos          => [100,125]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'UTC'}             ,
                                -font         => $font10                 , );
  $winDTObj->AddRadioButton(    -name         => 'rbDTObjTZOtherOffset'  ,
                                -size         => [110, 22]               ,
                                -pos          => [175, 95]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'otherOffset'}.':' ,
                                -font         => $font10                 , );
  $winDTObj->AddCombobox(       -name         => 'cbDTObjTZOffset'       ,
                                -size         => [ 65,100]               ,
                                -pos          => [290, 95]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       , );
  $winDTObj->cbDTObjTZOffset->Add('+1200','+1130','+1100','+1030','+1000','+0900','+0930','+0800','+0700',
                                  '+0630','+0600','+0530','+0500','+0430','+0400','+0330','+0300','+0200',
                                  '+0100','+0000','-0100','-0200','-0300','-0330','-0400','-0500','-0600',
                                  '-0700','-0800','-0830','-0900','-0930','-1000','-1100','-1200', );
  $winDTObj->cbDTObjTZOffset->SetCurSel(19);
  $winDTObj->AddRadioButton(    -name         => 'rbDTObjTZOtherName'    ,
                                -size         => [110, 22]               ,
                                -pos          => [175,125]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'otherName'}.':'   ,
                                -font         => $font10                 , );
  $winDTObj->AddCombobox(       -name         => 'cbDTObjTZName'         ,
                                -size         => [260,100]               ,
                                -pos          => [290,125]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjParsed'        ,
                                -size         => [ 95, 22]               ,
                                -pos          => [  5,158]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'parsed'}.':'      ,
                                -font         => $font10                 , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjParsedData'    ,
                                -size         => [400, 22]               ,
                                -pos          => [100,158]               ,
                                -background   => [255, 255, 255]         ,
                                -foreground   => [204,   0,  51]         ,
                                -font         => $font10                 , );
  $winDTObj->AddLabel(          -name         => 'lblDTObjUseAs'         ,
                                -size         => [ 95, 22]               ,
                                -pos          => [  5,188]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'useAs'}.':'       ,
                                -font         => $font10                 , );
  $winDTObj->AddCombobox(       -name         => 'cbDTObjUseAs'          ,
                                -size         => [ 80,100]               ,
                                -pos          => [100,185]               ,
                                -font         => $font10                 ,
                                -dropdownlist => 1                       ,
                                -vscroll      => 1                       , );
  $winDTObj->cbDTObjUseAs->Add( $STR{'Input'}, $STR{'output'}, $STR{'both'}, $STR{'none'},);
  $winDTObj->cbDTObjUseAs->SetCurSel(0);
  $winDTObj->AddLabel(          -name         => 'lblDTObjComment'       ,
                                -size         => [ 95, 24]               ,
                                -pos          => [280,188]               ,
                                -background   => [255, 255, 255]         ,
                                -text         => $STR{'comment'}.':'     ,
                                -font         => $font10                 , );
  $winDTObj->AddTextfield(      -name         => 'tfDTObjComment'        ,
                                -size         => [285, 24]               ,
                                -pos          => [380,185]               ,
                                -tabstop      => 1                       , );
  $winDTObj->AddButton(         -name         => 'btnDTObjNotReady'      ,
                                -size         => [ 30, 30]               ,
                                -pos          => [255,220]               ,
                                -text         => '?'                     ,
                                -font         => $font10                 , );
  $winDTObj->AddButton(         -name         => 'btnDTObjAdd'           ,
                                -size         => [ 60, 30]               ,
                                -pos          => [295,220]               ,
                                -text         => $STR{'add'}             ,
                                -font         => $font10                 ,
                                -disabled     => 1                       ,
                                -visible      => 0                       , );
  $winDTObj->AddButton(         -name         => 'btnDTObjEdit'          ,
                                -size         => [ 60, 30]               ,
                                -pos          => [295,220]               ,
                                -text         => $STR{'Edit'}            ,
                                -font         => $font10                 ,
                                -disabled     => 1                       ,
                                -visible      => 0                       , );
  $winDTObj->AddButton(         -name         => 'btnDTObjCancel'        ,
                                -size         => [ 70, 30]               ,
                                -pos          => [360,220]               ,
                                -text         => $STR{'cancel'}          ,
                                -font         => $font10                 , );
  # List of timezone
  my @listTZ = DateTime::TimeZone->all_names;
  foreach (@listTZ) { $winDTObj->cbDTObjTZName->Add($_); }
  $winDTObj->cbDTObjTZName->SetCurSel(0);
  
}  #--- End createWinDTObj

#--------------------------#
sub tfDTObjSample_Change { &isDTObjReady(0); }
#--------------------------#

#--------------------------#
sub btnDTObjFromInput_Click
#--------------------------#
{
  # Get first line of one file in input
  my $firstLine;
  if ($win->rbInputDir->Checked() or $win->rbInputFiles->Checked()) {
    my $oneFile = &getOneFile;
    if (open(my $fh, $oneFile)) {
      while (<$fh>) { $firstLine = $_ if $_ !~ /^#/; }
      close($fh);
      $winDTObj->tfDTObjSample->Text($firstLine);
    }
  }
  &isDTObjReady(0);
  
}  #--- End btnDTObjFromInput_Click

#--------------------------#
sub btnDTObjPatternInsert_Click
#--------------------------#
{
  # Local variables
  my $patternObjSel = $winDTObj->cbDTObjPattern->GetCurSel();
  my @patterns = ('%B', '%b', '%D', '%d', '%e', '%F', '%H', '%I', '%M', '%m',
                  '%p', '%R', '%r', '%S', '%T', '%v', '%w', '%Y', '%y', '%Z',
                  '%z', );
  $winDTObj->tfDTObjPattern->Append($patterns[$patternObjSel]);
  &isDTObjReady(0);

}  #--- End btnDTObjPatternInsert_Click

#--------------------------#
sub patternDTRE
#--------------------------#
{
  # Local variables
  my $formatREStr = shift;
  # Possibles value are:
  my %formatRE = ('%A' => '(?:Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)', # full weekday name
                  '%a' => '(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)', # abbreviated weekday name
                  '%B' => '(?:January|February|March|April|May|June|July|August|September|October|November|December)', # full month name
                  '%b' => '(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)', # abbreviated month name
                  '%C' => '\d{2}', # (year / 100) as decimal number; single digits are preceded by a zero.
                  '%D' => '\d{2}\/\d{2}\/\d{2}', # %m/%d/%y
                  '%d' => '\d{2}', # day of the month as a decimal number (01-31)
                  '%e' => '\d{1,2}', # day of the month as a decimal number (1-31); single digits are preceded by a blank.
                  '%F' => '\d{4}\-\d{2}\-\d{2}', # %Y-%m-%d
                  '%H' => '\d{2}', # hour (24-hour clock) as a decimal number (00-23)
                  '%I' => '\d{2}', # hour (12-hour clock) as a decimal number (01-12)
                  '%j' => '\d{3}', # day of the year as a decimal number (001-366)
                  '%k' => '\d{1,2}', # hour (24-hour clock) as a decimal number (0-23); single digits are preceded by a blank.
                  '%l' => '\d{1,2}', # hour (12-hour clock) as a decimal number (1-12); single digits are preceded by a blank.
                  '%M' => '\d{2}', # minute as a decimal number (00-59)
                  '%m' => '\d{1,2}', # month as a decimal number (01-12)
                  '%n' => '\n', # newline
                  '%p' => '[ap]\.?m\.?', # national representation of either "ante meridiem" (a.m.)  or "post meridiem" (p.m.)  as appropriate.
                  '%R' => '\d{2}:\d{2}', # %H:%M
                  '%r' => '\d{1,2}:\d{2}:\d{2} [ap]\.?m\.?', # %I:%M:%S %p
                  '%S' => '\d{2}', # second as a decimal number (00-60)
                  '%s' => '\d{10,13}', # number of seconds since the Epoch
                  '%T' => '\d{2}:\d{2}:\d{2}', # %H:%M:%S
                  '%R' => '\d{2}:\d{2}', # %H:%M
                  '%t' => '\t', # tab
                  '%U' => '\d{2}', # week number of the year (Sunday as the first day of the week) as a decimal number (00-53).
                  '%u' => '[1-7]', # weekday (Monday as the first day of the week) as a decimal number (1-7).
                  '%V' => '\d{2}', # week number of the year (Monday as the first day of the week) as a decimal number (01-53)
                  '%v' => '\d{1,2}\-[a-zA-Z]{3}\-\d{4}', # %e-%b-%Y
                  '%W' => '\d{2}', # week number of the year as a decimal number (00-53).
                  '%w' => '[0-6]', # weekday (Sunday as the first day of the week) as a decimal number (0-6).
                  '%Y' => '\d{4}', # year with century as a decimal number
                  '%y' => '\d{2}', # year without century as a decimal number (00-99)
                  '%Z' => '[\w\/]+', # time zone name
                  '%z' => '[\-\+]?\d{4}', # time zone offset from UTC
                  );
  # Convert other format string from strftime format (%) to regex
  foreach my $matchRE (keys %formatRE) { $formatREStr =~ s/$matchRE/$formatRE{$matchRE}/ge; }
  return($formatREStr);

}  #--- End patternDTRE

#--------------------------#
sub tfDTObjPattern_Change
#--------------------------#
{
  # Local variables
  my $pattern = $winDTObj->tfDTObjPattern->Text();
  if ($pattern =~ /%\w/ and $winDTObj->chDTObjRegexAuto->Checked()) {
    my $regex = patternDTRE($pattern);
    $winDTObj->tfDTObjRegex->Text($regex);
  }
  &isDTObjReady(0);
  
}  #--- End tfDTObjPattern_Change

#--------------------------#
sub btnDTObjPatternHelp_Click
#--------------------------#
{
  # Open Default browser to a help page on Strftime
  $win->ShellExecute('open', 'http://strftime.net/','','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), $STR{'error'}, 0x40010);
  
}  #--- End btnDTObjPatternHelp_Click

#--------------------------#
sub tfDTObjRegex_Change { &isDTObjReady(0); }
#--------------------------#

#--------------------------#
sub chDTObjRegexAuto_Click
#--------------------------#
{
  # Local variables
  my $pattern = $winDTObj->tfDTObjPattern->Text();
  if ($pattern =~ /%\w/ and $winDTObj->chDTObjRegexAuto->Checked()) {
    my $regex = patternDTRE($pattern);
    $winDTObj->tfDTObjRegex->Text($regex);
  }
  &isDTObjReady(0);
  
}  #--- End chDTObjRegexAuto_Click

#--------------------------#
sub isDTObjReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  # Sample provided ?
  my $sample = $winDTObj->tfDTObjSample->Text();
  if (!$sample) {
    $winDTObj->tfDTObjPattern->Disable();
    $winDTObj->btnDTObjPatternInsert->Disable();
    $winDTObj->cbDTObjPattern->Disable();
    $winDTObj->tfDTObjRegex->Disable();
    $nextStep = $STR{'provideSample'};
  } else {
    $winDTObj->tfDTObjPattern->Enable();
    $winDTObj->btnDTObjPatternInsert->Enable();
    $winDTObj->cbDTObjPattern->Enable();
    # Pattern provided ?
    my $pattern = $winDTObj->tfDTObjPattern->Text();
    if ($pattern =~ /%\w/) {
      $winDTObj->tfDTObjRegex->Enable();
      # Regex provided ?
      my $regex = $winDTObj->tfDTObjRegex->Text();
      if ($regex) {
        my ($statusRegex, $msg) = &validRegex($regex);
        # Warning
        if      ($statusRegex == 2) {
          $winDTObj->lblDTObjRegexWarn->Show();
          $winDTObj->lblDTObjRegexOk->Hide();
          $winDTObj->lblDTObjRegexErr->Hide();
        # Error
        } elsif ($statusRegex == 1) {
          $winDTObj->lblDTObjRegexErr->Show();
          $winDTObj->lblDTObjRegexOk->Hide();
          $winDTObj->lblDTObjRegexWarn->Hide();
          $nextStep = $STR{'errRegex'};
        # Ok
        } else {
          $winDTObj->lblDTObjRegexOk->Show();
          $winDTObj->lblDTObjRegexErr->Hide();
          $winDTObj->lblDTObjRegexWarn->Hide();
        }
      } else {
        $winDTObj->lblDTObjRegexOk->Hide();
        $winDTObj->lblDTObjRegexErr->Hide();
        $winDTObj->lblDTObjRegexWarn->Hide();
        $nextStep = $STR{'errRegex'};
      }
      # Test regex and pattern
      if (!$nextStep) {
        my $strp = DateTime::Format::Strptime->new(pattern => $pattern, zone_map => \%ZONE_MAP);
        if ($sample =~ /$regex/i and my $parsedPattern = $strp->parse_datetime($sample)) {
          $winDTObj->lblDTObjParsedData->Text($parsedPattern->strftime($pattern));
          # Timezone ?
          if ($pattern =~ /%[Zzs]/) {
            $winDTObj->rbDTObjTZLocal->Disable();
            $winDTObj->rbDTObjTZUTC->Disable();
            $winDTObj->rbDTObjTZOtherOffset->Disable();
            $winDTObj->cbDTObjTZOffset->Disable();
            $winDTObj->rbDTObjTZOtherName->Disable();
            $winDTObj->cbDTObjTZName->Disable();
          } else { # No timezone in pattern, must specify
            $winDTObj->rbDTObjTZLocal->Enable();
            $winDTObj->rbDTObjTZUTC->Enable();
            $winDTObj->rbDTObjTZOtherOffset->Enable();
            $winDTObj->cbDTObjTZOffset->Enable();
            $winDTObj->rbDTObjTZOtherName->Enable();
            $winDTObj->cbDTObjTZName->Enable();
          }
        } else { $winDTObj->lblDTObjParsedData->Text(''); }
      }
    } else {
      $winDTObj->tfDTObjRegex->Disable();
      $nextStep = $STR{'providePattern'};
    }
  }
  # Return an error message or enable the button
  if ($nextStep) {
    $winDTObj->btnDTObjAdd->Disable();
    $winDTObj->btnDTObjEdit->Disable();
    $winDTObj->btnDTObjNotReady->Enable();
    Win32::GUI::MessageBox($winDTObj, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winDTObj->btnDTObjAdd->Enable();
    $winDTObj->btnDTObjEdit->Enable();
    $winDTObj->btnDTObjNotReady->Disable();
  }
  
}  #--- End isDTObjReady

#--------------------------#
sub btnDTObjNotReady_Click { &isDTObjReady(1); }
#--------------------------#

#--------------------------#
sub btnDTObjAdd_Click
#--------------------------#
{
  # Local variables
  my $sample   = $winDTObj->tfDTObjSample->Text();
  my $pattern  = $winDTObj->tfDTObjPattern->Text();
  my $regex    = $winDTObj->tfDTObjRegex->Text();
  my $comment  = $winDTObj->tfDTObjComment->Text();
  $comment     = 'NULL' if !$comment;
  my $useAs    = $winDTObj->cbDTObjUseAs->GetCurSel(); # 0 = Input, 1 = Output, 2 = Both, 3 = None (hidden)
  my @useAsStr = ($STR{'Input'}, $STR{'output'}, $STR{'both'}, $STR{'none'});
  my $DTDBFile = $winConfig->tfDTDB->Text();
  my $timezone; # Default timezone, used if not specified in pattern
  # Timezone
  if    ($winDTObj->rbDTObjTZLocal->Checked()) { $timezone = 'local'; } # Local
  elsif ($winDTObj->rbDTObjTZUTC->Checked())   { $timezone = 'UTC';   } # UTC
  elsif ($winDTObj->rbDTObjTZOtherOffset->Checked()) {                  # Other, offset
    $timezone = $winDTObj->cbDTObjTZOffset->GetString($winDTObj->cbDTObjTZOffset->GetCurSel());
  } elsif ($winDTObj->rbDTObjTZOtherName->Checked()) {                # Other, name
    $timezone = $winDTObj->cbDTObjTZName->GetString($winDTObj->cbDTObjTZName->GetCurSel());
  } else { $timezone = 'NULL'; }
  # Select or create Datetime database
  if (!-f $DTDBFile or !&validDTDB($DTDBFile)) {
    $DTDBFile = "$USERDIR\\DT.db";
    $winConfig->tfDTDB->Text($DTDBFile) if &createDTDB($DTDBFile);
  }
  # Add to database
  my $dsn = "DBI:SQLite:dbname=$DTDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Database: table = DT, Fields = sample, pattern, regex, timezone, use_as, comment
    my $sth = $dbh->prepare("insert into DT (sample,pattern,regex,timezone,use_as,comment) values(?,?,?,?,?,?)");
    my $rv = $sth->execute($sample, $pattern, $regex, $timezone, $useAs, $comment);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winDTDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Add to Grid
      if (my $newLine = $winDTDB->gridDT->InsertRow($sample, -1)) {
        $winDTDB->gridDT->SetCellText($newLine, 0, $sample);
        $winDTDB->gridDT->SetCellText($newLine, 1, $pattern);
        $winDTDB->gridDT->SetCellText($newLine, 2, $regex);
        $winDTDB->gridDT->SetCellText($newLine, 3, $timezone);
        $winDTDB->gridDT->SetCellText($newLine, 4, $useAsStr[$useAs]);
        $winDTDB->gridDT->SetCellText($newLine, 5, $comment) if $comment ne 'NULL';
        # Refresh grid
        $winDTDB->gridDT->SortCells(1, 0, \&sortGridDT);
        $winDTDB->gridDT->AutoSizeColumns();
        $winDTDB->gridDT->ExpandColumnsToFit();
        # Add to combobox
        if (!$useAs     or $useAs == 2) { $win->cbSplitTimeFormat->Add($sample); $winLFObj->cbLFObjDT->Add($sample); }
        if ($useAs == 1 or $useAs == 2) { $winReport->cbOutputDTFormat->Add($sample); }
        # Final message
        &winDTObj_Terminate();
        Win32::GUI::MessageBox($winDTDB, $STR{'addedDTObj'}, $STR{'winDTDB'}, 0x40040);
      } else { Win32::GUI::MessageBox($win, $STR{'errNewLine'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End btnDTObjAdd_Click

#--------------------------#
sub btnDTObjEdit_Click
#--------------------------#
{
  # Local variables
  my $sample   = $winDTObj->tfDTObjSample->Text();
  my $pattern  = $winDTObj->tfDTObjPattern->Text();
  my $regex    = $winDTObj->tfDTObjRegex->Text();
  my $comment  = $winDTObj->tfDTObjComment->Text();
  $comment     = 'NULL' if !$comment;
  my $useAs    = $winDTObj->cbDTObjUseAs->GetCurSel(); # 0 = Input, 1 = Output, 2 = Both, 3 = None (hidden)
  my @useAsStr = ($STR{'Input'}, $STR{'output'}, $STR{'both'}, $STR{'none'});
  my $DTDBFile = $winConfig->tfDTDB->Text();
  my $timezone; # Default timezone, used if not specified in pattern
  # Timezone
  if    ($winDTObj->rbDTObjTZLocal->Checked()) { $timezone = 'local'; } # Local
  elsif ($winDTObj->rbDTObjTZUTC->Checked())   { $timezone = 'UTC';   } # UTC
  elsif ($winDTObj->rbDTObjTZOtherOffset->Checked()) {                  # Other, offset
    $timezone = $winDTObj->cbDTObjTZOffset->GetString($winDTObj->cbDTObjTZOffset->GetCurSel());
  } elsif ($winDTObj->rbDTObjTZOtherName->Checked()) {                # Other, name
    $timezone = $winDTObj->cbDTObjTZName->GetString($winDTObj->cbDTObjTZName->GetCurSel());
  } else { $timezone = 'NULL'; }
  # Update database
  my $dsn = "DBI:SQLite:dbname=$DTDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    # Database: table = DT, Fields = sample, pattern, regex, timezone, use_as, comment
    my $sth = $dbh->prepare("UPDATE DT SET pattern = ?, regex = ?, timezone = ?, use_as = ?, comment = ? WHERE ? == sample");
    my $rv  = $sth->execute($pattern, $regex, $timezone, $useAs, $comment, $sample);
    if ($rv < 0) {
      Win32::GUI::MessageBox($winDTDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    } else {
      # Update Grid
      for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
        my $curSampleRow = $winDTDB->gridDT->GetCellText($i, 0);
        if ($curSampleRow eq $sample) {
          $winDTDB->gridDT->SetCellText($i, 1, $pattern);
          $winDTDB->gridDT->SetCellText($i, 2, $regex);
          $winDTDB->gridDT->SetCellText($i, 3, $timezone);
          $winDTDB->gridDT->SetCellText($i, 4, $useAsStr[$useAs]);
          $winDTDB->gridDT->SetCellText($i, 5, $comment) if $comment ne 'NULL';
          # Refresh grid
          $winDTDB->gridDT->SortCells(1, 0, \&sortGridDT);
          $winDTDB->gridDT->AutoSizeColumns();
          $winDTDB->gridDT->ExpandColumnsToFit();
          # Add to combobox
          if (!$useAs or $useAs == 2) { # Add to input
            if ((my $index = $win->cbSplitTimeFormat->FindStringExact($sample)) > 1) { # Already in Combobox ?
              my $inComboboxSample = $win->cbSplitTimeFormat->GetString($index);
              $win->cbSplitTimeFormat->Add($sample) if $inComboboxSample ne $sample;
            } else { $win->cbSplitTimeFormat->Add($sample); }
          } elsif ((my $index = $win->cbSplitTimeFormat->FindStringExact($sample)) > 1) {
            my $inComboboxSample = $win->cbSplitTimeFormat->GetString($index);
            $win->cbSplitTimeFormat->DeleteString($index) if $inComboboxSample eq $sample;
          }
          if ($useAs == 1 or $useAs == 2) { # Add to output
            if ((my $index = $winReport->cbOutputDTFormat->FindStringExact($sample)) > 1) { # Already in Combobox ?
              my $inComboboxSample = $winReport->cbOutputDTFormat->GetString($index);
              $winReport->cbOutputDTFormat->Add($sample) if $inComboboxSample ne $sample;
            } else { $winReport->cbOutputDTFormat->Add($sample); }
          } elsif ((my $index = $winReport->cbOutputDTFormat->FindStringExact($sample)) > 1) {
            my $inComboboxSample = $winReport->cbOutputDTFormat->GetString($index);
            $winReport->cbOutputDTFormat->DeleteString($index) if $inComboboxSample eq $sample;
          }
          # Final message
          &winDTObj_Terminate();
          Win32::GUI::MessageBox($winDTDB, $STR{'updatedDTObj'}, $STR{'winDTDB'}, 0x40040);
          last;
        } 
      }
      &winDTObj_Terminate();
    }
  }

}  #--- End btnDTObjEdit_Click

#--------------------------#
sub btnDTDel_Click
#--------------------------#
{
  # Local variables
  my $DTDBFile = $winConfig->tfDTDB->Text();
  # Get selected row
  my $selRow = ($winDTDB->gridDT->GetSelectedCellRange())[0];
  my $sample = $winDTDB->gridDT->GetCellText($selRow, 0);
  # Delete in Datetime database
  my $dsn = "DBI:SQLite:dbname=$DTDBFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    my $sth = $dbh->prepare("DELETE from DT where sample == ?");
    my $rv = $sth->execute($sample);
    if ($rv < 0) { Win32::GUI::MessageBox($winDTDB, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010); }
    else { 
      # Find the entry in grid and delete
      for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
        my $curSampleRow = $winDTDB->gridDT->GetCellText($i, 0);
        if ($curSampleRow eq $sample) {
          $winDTDB->gridDT->DeleteRow($i);
          # Refresh grid
          $winDTDB->gridDT->SortCells(1, 0, \&sortGridDT);
          $winDTDB->gridDT->AutoSizeColumns();
          $winDTDB->gridDT->ExpandColumnsToFit();
          # If entry is in combobox, delete it
          $win->cbSplitTimeFormat->DeleteString($win->cbSplitTimeFormat->FindStringExact($sample));
          $winReport->cbOutputDTFormat->DeleteString($winReport->cbOutputDTFormat->FindStringExact($sample));
          Win32::GUI::MessageBox($winDTDB, $STR{'deletedDTObj'}, $STR{'winDTDB'}, 0x40040);
          last;
        }
      }
    }
  }
  
}  #--- End btnDTDel_Click

#--------------------------#
sub createDTDB
#--------------------------#
{
  # Local variables
  my $DTDBFile = shift;
  # Create a new database
  my $dsn = "DBI:SQLite:dbname=$DTDBFile";
  my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 }) or return(0);
  # Create main table
  my $stmt = qq(CREATE TABLE IF NOT EXISTS DT
                (sample     VARCHAR(255)  NOT NULL,
                 pattern    VARCHAR(255)  NOT NULL,
                 regex      VARCHAR(255)  NOT NULL,
                 timezone   VARCHAR(255)          ,
                 use_as     INT                   ,
                 comment    VARCHAR(255)          ,
                 PRIMARY KEY (sample)));
  my $rv = $dbh->do($stmt);
  return(0) if $rv < 0;
  $dbh->disconnect();
  return(1);
  
}  #--- End createDTDB

#--------------------------#
sub loadDTDB
#--------------------------#
{
  # Local variables
  my $DTDBFile = $winConfig->tfDTDB->Text();
  my @useAsStr = ($STR{'Input'}, $STR{'output'}, $STR{'both'}, $STR{'none'});
  if (-f $DTDBFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$DTDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Check if DT table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    }
    my @info = $sth->fetchrow_array;
    $sth->finish();
    if ($info[2] eq 'DT') { # If table DT exists, than load data
      my $all = $dbh->selectall_arrayref("SELECT * FROM DT ORDER BY sample ASC");
      # Database: table = DT, Fields = sample, pattern, regex, timezone, use_as, comment
      # Feed the grid
      my $i = 1;
      $winDTDB->gridDT->SetRows(scalar(@$all)+1);
      foreach my $row (@$all) {
        my (@values) = @$row;
        $winDTDB->gridDT->SetCellText($i, 0, $values[0]); # Sample
        $winDTDB->gridDT->SetCellText($i, 1, $values[1]); # Pattern
        $winDTDB->gridDT->SetCellText($i, 2, $values[2]); # Regex
        $winDTDB->gridDT->SetCellText($i, 3, $values[3]) if $values[3] ne 'NULL'; # Timezone
        $winDTDB->gridDT->SetCellText($i, 4, $useAsStr[$values[4]]);              # Use As
        $winDTDB->gridDT->SetCellText($i, 5, $values[5]) if $values[5] ne 'NULL'; # Comment
        $i++;
      }
      # Refresh grid
      $winDTDB->gridDT->SortCells(1, 0, \&sortGridDT);
      $winDTDB->gridDT->AutoSizeColumns();
      $winDTDB->gridDT->ExpandColumnsToFit();
      $dbh->disconnect();
      return(1);
    } else { Win32::GUI::MessageBox($win, $STR{'errorDB'}, $STR{'error'}, 0x40010); return(0); }
  } else { return(0); }

}  #--- End loadDTDB

#--------------------------#
sub btnDTObjCancel_Click { &winDTObj_Terminate(); }
#--------------------------#

#--------------------------#
sub winDTObj_Terminate
#--------------------------#
{
  $winDTObj->Hide();
  $winDTDB->Enable();
  $winDTDB->Show();
  $winDTDB->BringWindowToTop();
  return(0);

}  #--- End winDTObj_Terminate

#--------------------------#
sub winDTDB_Resize
#--------------------------#
{
  $winDTDB->gridDT->Width($winDTDB->ScaleWidth()-39);
  $winDTDB->gridDT->Height($winDTDB->ScaleHeight()-10);
  $winDTDB->gridDT->AutoSizeColumns();
  $winDTDB->gridDT->ExpandLastColumn();
  $winDTDB->gridDT->Refresh();
  $winDTDB->btnDTAdd->Left($winDTDB->ScaleWidth()-32);
  $winDTDB->btnDTEdit->Left($winDTDB->ScaleWidth()-32);
  $winDTDB->btnDTDel->Left($winDTDB->ScaleWidth()-32);

}  #--- End winDTDB_Resize

#--------------------------#
sub winDTDB_Terminate
#--------------------------#
{
  $winDTDB->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winDTDB_Terminate

#--------------------------#
sub cbInputDTFormatAddITems
#--------------------------#
{
  # Browse Datetime grid and list available Datetime object for input
  my @inputFormats;
  for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
    my $useAs = $winDTDB->gridDT->GetCellText($i, 4);
    push(@inputFormats, $winDTDB->gridDT->GetCellText($i, 0)) if $useAs eq $STR{'Input'} or $useAs eq $STR{'both'};
  }
  # Update the combobox
  if (scalar(@inputFormats)) {
    $win->cbSplitTimeFormat->Add($STR{'selectDTFormat'}.'...');
    $winLFObj->cbLFObjDT->Add($STR{'selectDTFormat'}.'...');
    foreach (@inputFormats) {
      $winLFObj->cbLFObjDT->Add($_);
      $win->cbSplitTimeFormat->Add($_);
    }
  }
  
}  #--- End cbInputDTFormatAddITems

#--------------------------#
sub cbOutputDTFormatAddITems
#--------------------------#
{
  # Local variables
  my @outputFormats;
  # Browse Datetime grid and list available Datetime object for output
  for (my $i = 1; $i < $winDTDB->gridDT->GetRows(); $i++) {
    my $useAs = $winDTDB->gridDT->GetCellText($i, 4);
    push(@outputFormats, $winDTDB->gridDT->GetCellText($i, 0)) if $useAs eq $STR{'output'} or $useAs eq $STR{'both'};
  }
  # Update the combobox
  if (scalar(@outputFormats)) { foreach (@outputFormats) { $winReport->cbOutputDTFormat->Add($_); } }
  
}  #--- End cbOutputDTFormatAddITems

#--------------------------#
sub chLALogRejected_Click
#--------------------------#
{
  if ($win->chLALogRejected->Checked()) {
    $win->chLAIgnoreComments->Checked(1);
    $win->chLAIgnoreComments->Enable();
  } else {
    $win->chLAIgnoreComments->Checked(0);
    $win->chLAIgnoreComments->Disable();
  }
  
}  #--- End chLALogRejected_Click

#--------------------------#
sub tfDestDir_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub btnDestDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir       = $win->tfDestDir->Text();
  my $LAFunctionStr = $win->LAFunctions->GetString($win->LAFunctions->SelectedItem());
  my $dir;
  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
  }
  if ($lastDir) {
    # Create a new database
    if ($win->rbLACreateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBNew->Checked())) {
      $dir = Win32::GUI::GetSaveFileName( -owner           => $win                     ,
                                          -title           => $STR{'selectDBFile'}.':' ,
                                          -file            => "XL-Parser_log.db"       ,
                                          -filter          => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                          -directory       => $lastDir                 ,
                                          -explorer        => 1                        , );
    # Update an existing database
    } elsif ($win->rbLAUpdateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBCurr->Checked())) {
      $dir = Win32::GUI::GetSaveFileName( -owner           => $win                     ,
                                          -title           => $STR{'selectDBFile'}.':' ,
                                          -filter          => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                          -filemustexist   => 1                        ,
                                          -directory       => $lastDir                 ,
                                          -explorer        => 1                        ,
                                          -overwriteprompt => 0                        , );
    }
  } else {
    # Create a new database
    if ($win->rbLACreateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBNew->Checked())) {
      $dir = Win32::GUI::GetSaveFileName( -owner           => $win                     ,
                                          -title           => $STR{'selectDBFile'}.':' ,
                                          -file            => "XL-Parser_log.db"       ,
                                          -filter          => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                          -explorer        => 1                        , );
    # Update an existing database
    } elsif ($win->rbLAUpdateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBCurr->Checked())) {
      $dir = Win32::GUI::GetSaveFileName( -owner           => $win                     ,
                                          -title           => $STR{'selectDBFile'}.':' ,
                                          -filter          => ["XL-Parser $STR{'rbInputDatabase'} (*.db)", '*.db'] ,
                                          -filemustexist   => 1                        ,
                                          -explorer        => 1                        ,
                                          -overwriteprompt => 0                        , );
    }
  }
  # Selected folder
  if ($dir) {
    # Valid database
    if    ($win->rbLAUpdateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBCurr->Checked()) and
           &validLADB($dir)) { $win->tfDestDir->Text($dir); }
    elsif ($win->rbLACreateDB->Checked() or ($LAFunctionStr eq $STR{'updateDB'} and $win->rbDestDBNew->Checked())) {
      $win->tfDestDir->Text($dir);
    }
  }
  &isProcessReady(0);
  
}  #--- End btnDestDir_Click

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winReport->tfReportDir->Text();
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'REPORT_DIR'} = $saveDir;
    &saveConfig($CONFIG_FILE, \%CONFIG);
    $winReport->btnReportOk->Enable();
  } else { # Invalid dir or no dir
    delete($CONFIG{'REPORT_DIR'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    $winReport->btnReportOk->Disable();
    if ($saveDir) {
      $winReport->tfReportDir->Text('');
      Win32::GUI::MessageBox($winReport, $STR{'invalidDir'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfReportDir_Change
  
#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winReport->tfReportDir->Text();
  my $dir;
  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winReport          ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -directory  => $lastDir               ,
                                        -newui      => 1                      , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winReport          ,
                                        -title      => $STR{'btnReportDirTip'},
                                        -folderonly => 1                      ,
                                        -newui      => 1                      , );
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $winReport->tfReportDir->Text($dir);
  }
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenReportDir_Click
#--------------------------#
{
  # Open Window Explorer
  my $outputDir = $winReport->tfReportDir->Text();
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $outputDir", 0, NORMAL_PRIORITY_CLASS, ".") if -d $outputDir;

}  #--- End btnOpenReportDir_Click

#--------------------------#
sub chReplaceReport_Click
#--------------------------#
{
  # Save the choice
  if ($winReport->chReplaceReport->Checked()) {
    $CONFIG{'REPORT_REPLACE_REPORT'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'REPORT_REPLACE_REPORT'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chReplaceReport_Click

#--------------------------#
sub chOpenReport_Click
#--------------------------#
{
  # Save the choice
  if ($winReport->chOpenReport->Checked()) {
    $CONFIG{'REPORT_AUTO_OPEN'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'REPORT_AUTO_OPEN'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chOpenReport_Click

#--------------------------#
sub btnLACurrDBFiles_Click
#--------------------------#
{
  &createWinLACurrDBFiles() if !$winLACurrDBFiles;
  # Load the Saved Queries
  &loadCurrDBFiles($win->tfInput->Text(), \$winLACurrDBFiles, \$win, \%STR) if $winLACurrDBFiles->gridCurrDBListFiles->GetRows() < 2;
  # Show Processing options window
  $winLACurrDBFiles->Center($win);
  $winLACurrDBFiles->Show();
  return(1);

}  #--- End btnLACurrDBFiles_Click

#--------------------------#
sub createWinLACurrDBFiles
#--------------------------#
{
  # Log Analysis - Current Database source files window
  $winLACurrDBFiles = Win32::GUI::Window->new(-name        => 'winLACurrDBFiles'     ,
                                              -background  => [255, 255, 255]        ,
                                              -parent      => $win                   ,
                                              -text        => $STR{'winLACurrDBFiles'},
                                              -pos         => [$winPosX, $winPosY]   ,
                                              -size        => [850, 400]             ,
                                              -hasmaximize => 1                      ,
                                              -hasminimize => 1                      ,
                                              -resizable   => 1                      ,
                                              -dialogui    => 1                      , );
  $winLACurrDBFiles->SetIcon($winICO);
  $winLACurrDBFiles->AddGrid( -name         => 'gridCurrDBListFiles'   ,
                              -size         => [830,360]               ,
                              -pos          => [  5,  5]               ,
                              -background   => [255, 255, 255]         ,
                              -columns      => 9                       ,
                              -fixedrows    => 1                       ,
                              -fixedcolumns => 0                       ,
                              -editable     => 0                       , );
  $winLACurrDBFiles->gridCurrDBListFiles->SetListMode(1);
  # Popup menu for gridCurrDBListFiles
  $gridCurrDBListFilesMenu = new Win32::GUI::Menu(
    "gridCurrDBListFilesMenu" => "gridCurrDBListFilesMenu",
    "> $STR{'ChangePath'}..." => "changePath"             ,
  );
  
}  #--- End createWinLACurrDBFiles

#--------------------------#
sub btnLACurrDBFiltered_Click
#--------------------------#
{
  # Local variables
  my $file = $win->tfInput->Text() . '.FilteredLines.log';
  $win->ShellExecute('open', $file,'','',1) if -T $file;
  return(1);

}  #--- End btnLACurrDBFiltered_Click

#--------------------------#
sub btnLACurrDBRejected_Click
#--------------------------#
{
  # Local variables
  my $file = $win->tfInput->Text() . '.RejectedLines.log';
  $win->ShellExecute('open', $file,'','',1) if -T $file;
  return(1);

}  #--- End btnLACurrDBRejected_Click

#--------------------------#
sub winLACurrDBFiles_Resize
#--------------------------#
{
  $winLACurrDBFiles->gridCurrDBListFiles->Width($winLACurrDBFiles->ScaleWidth()-10);
  $winLACurrDBFiles->gridCurrDBListFiles->Height($winLACurrDBFiles->ScaleHeight()-10);
  $winLACurrDBFiles->gridCurrDBListFiles->AutoSize();
  $winLACurrDBFiles->gridCurrDBListFiles->ExpandLastColumn();
  return(0);

}  #--- End winLACurrDBFiles_Resize

#--------------------------#
sub gridCurrDBListFiles_RClick
#--------------------------#
{
  # Show popup menu
  my $row = shift;
  $winLACurrDBFiles->gridCurrDBListFiles->SetSelectedCellRange($row, 0, $row, 8);
  my ($X, $Y) = Win32::GUI::GetCursorPos();
  $winLACurrDBFiles->TrackPopupMenu($gridCurrDBListFilesMenu->{gridCurrDBListFilesMenu},$X, $Y);
  return(1);

}  #--- End gridCurrDBListFiles_RClick

#--------------------------#
sub changePath_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $winLACurrDBFiles->gridCurrDBListFiles->GetSelectedCellRange();
  my $lastDir = $winLACurrDBFiles->gridCurrDBListFiles->GetCellText($coord[0], 0);
  my $dir;
  my @parts = split(/\\/, $lastDir);
  pop(@parts);
  $lastDir = join("\\", @parts);
  # Show BrowseForFolder dialog window
  if (-d $lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winLACurrDBFiles ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winLACurrDBFiles ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 , );
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    my $dbFile = $win->tfInput->Text();
    my $dsn    = "DBI:SQLite:dbname=$dbFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth = $dbh->prepare("UPDATE FILES SET path = ? WHERE path == ?");
      for (my $row = 1; $row <= $winLACurrDBFiles->gridCurrDBListFiles->GetRows(); $row++) {
        my $currPath = $winLACurrDBFiles->gridCurrDBListFiles->GetCellText($row, 0);
        my $exists   = $winLACurrDBFiles->gridCurrDBListFiles->GetCellText($row, 1);
        if ($exists eq $STR{'No'}) {
          my @partsPath    = split(/\\/, $currPath);
          my $currFilename = pop(@partsPath);
          my $newPath      = $dir . "\\" . $currFilename;
          if (-f $newPath) {
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellText($row, 0, $newPath);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellText($row, 1, $STR{'Yes'});
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 0, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 1, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 2, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 3, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 4, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 5, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 6, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 7, [0,0,0]);
            $winLACurrDBFiles->gridCurrDBListFiles->SetCellColor($row, 8, [0,0,0]);
            # Change path in database
            my $rv = $sth->execute($newPath, $currPath);
            Win32::GUI::MessageBox($winLACurrDBFiles, $STR{'errUpdatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010) if $rv < 0;
            $winLACurrDBFiles->gridCurrDBListFiles->SetSelectedCellRange($row, 0, $row, 8, 0, 0)
            if $winLACurrDBFiles->gridCurrDBListFiles->IsCellSelected($row, 0);
          }
        }
      }
      Win32::GUI::MessageBox($winLACurrDBFiles, $STR{'updatedDB'}.'!' , "XL-Parser $VERSION", 0x40040);
      $sth->finish();
      $dbh->disconnect();
      $winLACurrDBFiles->gridCurrDBListFiles->AutoSizeColumns();
      $winLACurrDBFiles->gridCurrDBListFiles->ExpandColumnsToFit();
      $winLACurrDBFiles->gridCurrDBListFiles->Refresh();
    } else { Win32::GUI::MessageBox($winLACurrDBFiles, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  }
  return(1);

}  #--- End changePath_Click

#--------------------------#
sub winLACurrDBFiles_Terminate
#--------------------------#
{
  $winLACurrDBFiles->Hide();
  $win->BringWindowToTop();
  return(0);

}  #--- End winLACurrDBFiles_Terminate

#--------------------------#
sub btnReportOk_Click
#--------------------------#
{
  $winReport->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  
}  #--- End btnReportOk_Click

#--------------------------#
sub winReport_Terminate
#--------------------------#
{
  $winReport->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winReport_Terminate

#--------------------------#
sub createCW
#--------------------------#
{
  # Create Config Wizard Window
  my $winCW  = Win32::GUI::DialogBox->new(-name        => 'winCW'             ,
                                          -parent      => $win                ,
                                          -text        => $STR{'winCW'}       ,
                                          -pos         => [$winPosX, $winPosY],
                                          -size        => [500, 310]          ,
                                          -background  => [255, 255, 255]     ,
                                          -hasmaximize => 0                   ,
                                          -hasminimize => 1                   ,
                                          -helpbutton  => 0                   ,
                                          -resizable   => 0                   ,
                                          -dialogui    => 1                   , );
  $winCW->SetIcon($winICO);
  $winCW->AddLabel(     -name        => 'lblConfigLogo'       ,
                        -size        => [128,128]             ,
                        -pos         => [  0,  5]             ,
                        -bitmap      => $config128Bmp         , );
  $winCW->AddLabel(     -name        => 'lblSetGenOpt'        ,
                        -size        => [320, 22]             ,
                        -pos         => [140, 10]             ,
                        -font        => $font10               ,
                        -text        => $STR{'SetGenOpt'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSetGenOptDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 10]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  # Databases
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDB'        ,
                        -size        => [320, 22]             ,
                        -pos         => [140, 30]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'GeoIPDB2'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 30]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBError'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 30]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIINDB'          ,
                        -size        => [320, 22]             ,
                        -pos         => [140, 50]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'IINLocalDB2'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIINDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 50]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLIINDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 50]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDB'          ,
                        -size        => [320, 22]             ,
                        -pos         => [140, 70]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'lblTLDDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBDone'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 70]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLTLDDBError'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 70]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  # XL-Parser Database
  $winCW->AddLabel(     -name        => 'lblExprHistoryDB'    ,
                        -size        => [320, 22]             ,
                        -pos         => [140, 90]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnExprHistoryNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblExprHistoryDBDone',
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 90]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblExprHistoryDBError',
                        -size        => [ 20, 20]             ,
                        -pos         => [465, 90]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblExprDB'           ,
                        -size        => [320, 22]             ,
                        -pos         => [140,110]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnExprNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblExprDBDone'       ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,110]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblExprDBError'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,110]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLFDB'             ,
                        -size        => [320, 22]             ,
                        -pos         => [140,130]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadLFDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLFDBDone'         ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,130]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLFDBError'        ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,130]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLAFiltersDB'      ,
                        -size        => [320, 22]             ,
                        -pos         => [140,150]             ,
                        -font        => $font10               ,
                        -text        => $STR{'btnLAFiltersNewTip'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLAFiltersDBDone'  ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,150]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLAFiltersDBError' ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,150]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSavedQueriesDB'   ,
                        -size        => [320, 22]             ,
                        -pos         => [140,170]             ,
                        -font        => $font10               ,
                        -text        => $STR{'savedQueriesDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSavedQueriesDBDone',
                        -size        => [ 20, 20]             ,
                        -pos         => [465,170]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSavedQueriesDBError',
                        -size        => [ 20, 20]             ,
                        -pos         => [465,170]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  # XL-Toolkit Databases
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDB'     ,
                        -size        => [320, 22]             ,
                        -pos         => [140,190]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'XLWhoisDB2'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDBDone' ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,190]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDBError',
                        -size        => [ 20, 20]             ,
                        -pos         => [465,190]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblResTLDDB'         ,
                        -size        => [320, 22]             ,
                        -pos         => [140,210]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'ResTLDDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblResTLDDBDone'     ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,210]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblResTLDDBError'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,210]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLDTDB'           ,
                        -size        => [320, 22]             ,
                        -pos         => [140,230]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'winDTDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLDTDBDone'       ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,230]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLDTDBError'      ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,230]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  # OUI (MAC Addresses) - At last, because ieee.org is very slow
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDB'       ,
                        -size        => [320, 22]             ,
                        -pos         => [140,250]             ,
                        -font        => $font10               ,
                        -text        => $STR{'LocateThe'}.$STR{'OUIDB2'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDBDone'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,250]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDBError'  ,
                        -size        => [ 20, 20]             ,
                        -pos         => [465,250]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  return(\$winCW);

}  #--- End createCW

#--------------------------#
sub firstStart
#--------------------------#
{
  # Local variables
  my $refWinCW = shift;
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, $STR{'configSetPart'}, "XL-Parser $VERSION", 0x40040);
    threads->exit();
  };
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
  };
  # Yes (6), No (7)
  my $answer = Win32::GUI::MessageBox($win, $STR{'firstStart'}, $STR{'winConfig'}, 0x1024);
  if ($answer == 6) {
    my $dir;
    # Use default directory ? (program directory)
    $answer = Win32::GUI::MessageBox($win, $STR{'defaultDir'}.' ('.$USERDIR.') ?', $STR{'winConfig'}, 0x1024);
    # Answer is no, open popup to let user choose a different location
    if ($answer == 7) {
      # Select a folder
      $dir = Win32::GUI::BrowseForFolder( -owner      => $$refWinCW         ,
                                          -title      => $STR{'selDir'}.':' ,
                                          -folderonly => 1                  ,
                                          -newui      => 1                  ,
                                          -directory  => $USERDIR           , );
    # Answer is yes, use default dir
    } else { $dir = $USERDIR; }
    # Selected folder
    if ($dir and -d $dir) {
      $$refWinCW->Top($win->Top()+5);
      $$refWinCW->Left($win->Left()+310);
      $$refWinCW->Show();
      # Set General options
      $$refWinCW->lblSetGenOpt->Show();
      # Tool
      $winConfig->chAutoUpdate->Checked(1);      
      $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
      # Functions
      $winConfig->tfLookupTO->Text(10); # Set Nslookup timeout to 10 seconds
      $CONFIG{'NSLOOKUP_TIMEOUT'} = 10;
      my $index = 0;
      my $localTZ;
      eval     { $localTZ = DateTime::TimeZone->new(name => 'local'); }; # Find local timezone
      if (!$@) { $index = $winConfig->cbLocalTZ->FindStringExact($localTZ->{name}); }
      else     { $index = 107; } # Default is America/New_York
      $winConfig->cbLocalTZ->SetCurSel($index);
      $CONFIG{'LOCAL_TIMEZONE'} = $index;
      $winConfig->cbDefaultLang->SetCurSel($winConfig->cbDefaultLang->FindStringExact('en-US')); # Default language to en-US
      $CONFIG{'DEFAULT_LANG'} = 'en-US';
      &saveConfig($CONFIG_FILE, \%CONFIG);
      $$refWinCW->lblSetGenOptDone->Show();
      # Databases
      my $return = 0;
      my $defaultPath;
      # GeoIP Database
      $$refWinCW->lblDLGeoIPDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\GeoLiteCity.dat";
      if (-f $defaultPath and &validGeoIPDB($defaultPath)) { # Database exists in XL-Tools user dir, check if update available
        $winConfig->tfGeoIPDB->Text($defaultPath);
        $$refWinCW->lblDLGeoIPDB->Text($STR{'Updating'}.' '.$STR{'GeoIPDB2'});
        &updateGeoIPDB(0, $VERSION, $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig, \$winPb, \$win, \%STR);
        $$refWinCW->lblDLGeoIPDBDone->Show();
      } else {
        $$refWinCW->lblDLGeoIPDB->Text($STR{'Downloading'}.' '.$STR{'GeoIPDB2'});
        $return = &downloadGeoIPDB("$dir\\GeoLiteCity.dat", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                   \$winConfig, \$winPb, \$win, \%STR);
        if ($return) { # Error
          $$refWinCW->lblDLGeoIPDBError->Show();
          Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblDLGeoIPDBDone->Show(); }
      }
      $winConfig->chGeoIPDBAutoUpt->Checked(1); # Set auto update for GeoIP Database
      $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # IINDB Database
      $$refWinCW->lblDLIINDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\IIN.db";
      if (-f $defaultPath and &validIINDB($defaultPath)) { # Database exists in XL-Tools user dir
        $winConfig->tfIINDB->Text($defaultPath);
        $$refWinCW->lblDLIINDBDone->Show();
      } else {
        $$refWinCW->lblDLIINDB->Text($STR{'Downloading'}.' '.$STR{'IINLocalDB2'});
        $return = &downloadIINDB("$dir\\IIN.db", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                                 \$winPb, \$win, \%STR);
        if ($return) { # Error
          $$refWinCW->lblDLIINDBError->Show();
          Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblDLIINDBDone->Show(); }
      }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # TLD Database
      $$refWinCW->lblDLTLDDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois\\effective_tld_names.dat";
      if (-f $defaultPath and &validTLDDB($defaultPath)) { # Database exists in XL-Whois user dir, check if update available
        $winConfig->tfTLDDB->Text($defaultPath);
        $$refWinCW->lblDLTLDDB->Text($STR{'Updating'}.' '.$STR{'lblTLDDB'});
        &updateTLDDB(0, $VERSION, $defaultPath, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig, \$winPb, \$win, \%STR);
        $$refWinCW->lblDLTLDDBDone->Show();
      } else {
        $$refWinCW->lblDLTLDDB->Text($STR{'Downloading'}.' '.$STR{'lblTLDDB'});
        $return = &downloadTLDDB(0, $VERSION, "$dir\\effective_tld_names.dat", \$HOURGLASS, \$ARROW, $CONFIG_FILE,
                                 \%CONFIG, \$winConfig, \$winPb, \$win, \%STR);
        if ($return) { # Error
          $$refWinCW->lblDLTLDDBError->Show();
          Win32::GUI::MessageBox($$refWinCW, "$STR{'errorMsg'}: $return", $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblDLTLDDBDone->Show(); } # Success
      }
      $winConfig->chTLDDBAutoUpt->Checked(1); # Set auto update for TLD Database
      $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # XL-Parser Database
      # Expression History Database
      $$refWinCW->lblExprHistoryDB->Show();
      my $exprHistoDbFile = "$dir\\ExprHisto.db";
      $return = &createExprHistoDB($exprHistoDbFile);
      # Success
      if ($return) {
        $winConfig->tfExprHistoDB->Text($exprHistoDbFile);
        $CONFIG{'EXPR_HISTO_DB'} = $exprHistoDbFile;
        $$refWinCW->lblExprHistoryDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblExprHistoryDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errorCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Expression Database
      $$refWinCW->lblExprDB->Show();
      my $exprDbFile = "$dir\\Expr.db";
      $return = &createExprDB($exprDbFile);
      # Success
      if ($return) {
        $winConfig->tfExprDB->Text($exprDbFile);
        $CONFIG{'EXPR_DB'} = $exprDbFile;
        $$refWinCW->lblExprDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblExprDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errorCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Log Format Database
      $$refWinCW->lblLFDB->Show();
      $return = &downloadLFDB("$dir\\LF.db", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                              \$winLFDB, \$winLFObj, \$winPb, \$win, \%STR);
      if ($return) { $$refWinCW->lblLFDBError->Show(); }
      else         { $$refWinCW->lblLFDBDone->Show();  }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Filters Database
      $$refWinCW->lblLAFiltersDB->Show();
      my $LAFiltersDBFile = "$dir\\LA_Filters.db";
      if (&createLAFiltersDB($LAFiltersDBFile) and &createLAFilterSetDB($LAFiltersDBFile)) {
        $CONFIG{'LAFILTERS_DB_FILE'} = $LAFiltersDBFile;
        $winConfig->tfLAFiltersDB->Text($LAFiltersDBFile);
        mkdir("$dir\\Filters");
        $$refWinCW->lblLAFiltersDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblLAFiltersDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errorCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      # Saved queries Database
      $$refWinCW->lblSavedQueriesDB->Show();
      my $savedQueriesDBFile = "$dir\\SavedQueries.db";
      if (&createSavedQueriesDB($savedQueriesDBFile)) {
        $CONFIG{'SAVED_QUERIES_DB_FILE'} = $savedQueriesDBFile;
        $winConfig->tfSavedQueriesDB->Text($savedQueriesDBFile);
        $$refWinCW->lblSavedQueriesDBDone->Show();
      # Error
      } else {
        $$refWinCW->lblSavedQueriesDBError->Show();
        Win32::GUI::MessageBox($$refWinCW, $STR{'errorCreatingDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      }
      # XL-Toolkit Databases
      # ISP (XL-Whois) database
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois\\Whois.db";
      my $XLWHOISDBFile;
      $$refWinCW->lblLocXLWhoisDB->Show();
      if (-f $defaultPath) { $XLWHOISDBFile = $defaultPath; }
      else {
        # Is XL-Whois installed on this system?
        $answer = Win32::GUI::MessageBox($$refWinCW, $STR{'XLWhoisExists'}.'?', $STR{'winConfig'}, 0x1024);
        # Answer is yes, select the XL-Whois database
        if ($answer == 6) {
          $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -title         => $STR{'LocateThe'}.$STR{'XLWhoisDB2'}.':',
                                                        -defaultfilter => 0          ,
                                                        -filemustexist => 1          ,
                                                        -file          => 'Whois.db' ,
                                                        -explorer      => 1          , );
        }
      }
      if ($XLWHOISDBFile and -f $XLWHOISDBFile) {
        $winConfig->tfXLWHOISDB->Text($XLWHOISDBFile);
        $CONFIG{'XLWHOIS_DB_FILE'} = $XLWHOISDBFile;
        $$refWinCW->lblLocXLWhoisDBDone->Show();
      } else { $$refWinCW->lblLocXLWhoisDBError->Show(); }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Resolve TLD Database
      $$refWinCW->lblResTLDDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\Customs\\Resolve TLD.db";
      if (-f $defaultPath and &validResTLDDB($defaultPath)) { # Database exists in XL-Tools user dir
        $winConfig->tfResTLDDB->Text($defaultPath);
        $$refWinCW->lblResTLDDBDone->Show();
      } else {
        $$refWinCW->lblDLTLDDB->Text($STR{'Downloading'}.' '.$STR{'ResTLDDB'});
        $return = &downloadResTLDDB("$dir\\Resolve TLD.db", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                    \$winConfig, \$winPb, \$win, \%STR);
        if ($return) { 
          $$refWinCW->lblResTLDDBError->Show();
          Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblResTLDDBDone->Show(); }
      }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # DTDB Database
      $$refWinCW->lblDLDTDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\DT.db";
      if (-f $defaultPath and &validDTDB($defaultPath)) { # Valid DTDB in XL-Tools user dir
        $winConfig->tfDTDB->Text($defaultPath);
        &loadDTDB;
        &cbInputDTFormatAddITems();
        $winLFObj->cbLFObjDT->SetCurSel(0);
        $win->cbSplitTimeFormat->SetCurSel(0);
        &cbOutputDTFormatAddITems();
        if ($CONFIG{'DEFAULT_OUTPUT_DT_FORMAT'}) {
          $winReport->cbOutputDTFormat->SetCurSel($winReport->cbOutputDTFormat->FindStringExact($CONFIG{'DEFAULT_OUTPUT_DT_FORMAT'}));
        } else { $winReport->cbOutputDTFormat->SetCurSel(0); }
        $$refWinCW->lblDLDTDBDone->Show();
      } else { # No DTDB, download it
        $$refWinCW->lblDLTLDDB->Text($STR{'Downloading'}.' '.$STR{'winDTDB'});
        $return = &downloadDTDB("$dir\\DT.db", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                                \$winLFObj, \$winDTDB, \$winReport, \$winPb, \$win, \%STR);
        if ($return) { 
          $$refWinCW->lblDLDTDBError->Show();
          Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblDLDTDBDone->Show(); }
      }
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # MACOUI Database
      $$refWinCW->lblDLMACOUIDB->Show();
      $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\oui.db";
      if (-f $defaultPath and &validMACOUIDB($defaultPath)) { # Database exists in XL-Tools user dir, check if update available
        $winConfig->tfMACOUIDB->Text($defaultPath);
        $$refWinCW->lblDLMACOUIDB->Text($STR{'Updating'}.' '.$STR{'OUIDB2'});
        &updateMACOUIDB(0, $VERSION, $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig, \$winPb, \$win, \%STR);
        $$refWinCW->lblDLMACOUIDBDone->Show();
      } else {
        $$refWinCW->lblDLMACOUIDB->Text($STR{'Downloading'}.' '.$STR{'OUIDB2'});
        $return = &downloadMACOUIDB("$dir\\oui.db", $dir, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                                    \$winPb, \$win, \%STR);
        if ($return) { # $return contains error msg if any
          $$refWinCW->lblDLMACOUIDBError->Show();
          Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
        } else { $$refWinCW->lblDLMACOUIDBDone->Show(); }
      }
      $winConfig->chMACOUIDBAutoUpt->Checked(0); # Default is no auto update
      $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 0;
      &saveConfig($CONFIG_FILE, \%CONFIG);
      # Close Configuration Wizard
      $$refWinCW->Hide();
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($win, $STR{'configSet'}, "XL-Parser $VERSION", 0x40040);
    }
  }

}  #--- End firstStart

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  $winConfig->Center($win);
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->btnOpenUserDir->Show();
    $winConfig->lblFuncShadowT->Show();
    $winConfig->lblFuncT->Show();
    $winConfig->chFullScreen->Show();
    $winConfig->chRememberPos->Show();
    $winConfig->lblNsLookupTO1->Show();
    $winConfig->tfLookupTO->Show();
    $winConfig->lblNsLookupTO2->Show();
    $winConfig->lblLocalTZ->Show();
    $winConfig->cbLocalTZ->Show();
    $winConfig->lblDefaultLang->Show();
    $winConfig->cbDefaultLang->Show();
    # Hide Databases tab
    $winConfig->lblMACOUIDBShadowT->Hide();
    $winConfig->lblMACOUIDBT->Hide();
    $winConfig->chMACOUIDBAutoUpt->Hide();
    $winConfig->tfMACOUIDB->Hide();
    $winConfig->btnMACOUIDB->Hide();
    $winConfig->btnMACOUIDBUpt->Hide();
    $winConfig->btnMACOUIDBImport->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
    $winConfig->lblIINDBShadowT->Hide();
    $winConfig->lblIINDBT->Hide();
    $winConfig->tfIINDB->Hide();
    $winConfig->btnIINDB->Hide();
    $winConfig->btnIINDBUpt->Hide();
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    # Hide XL-Parser databases tab
    $winConfig->lblExprHistoDBShadowT->Hide();
    $winConfig->lblExprHistoDBT->Hide();
    $winConfig->tfExprHistoDB->Hide();
    $winConfig->btnExprHistoDB->Hide();
    $winConfig->btnNewExprHistoDB->Hide();
    $winConfig->tfExprDB->Hide();
    $winConfig->btnExprDB->Hide();
    $winConfig->btnNewExprDB->Hide();
    $winConfig->btnExprDBImport->Hide();
    $winConfig->lblLFDBShadowT->Hide();
    $winConfig->lblLFDBT->Hide();
    $winConfig->tfLFDB->Hide();
    $winConfig->btnLFDB->Hide();
    $winConfig->btnNewLFDB->Hide();
    $winConfig->btnLFDBUpt->Hide();
    $winConfig->lblLAFiltersDBShadowT->Hide();
    $winConfig->lblLAFiltersDBT->Hide();
    $winConfig->tfLAFiltersDB->Hide();
    $winConfig->btnNewLAFiltersDB->Hide();
    $winConfig->btnLAFiltersDB->Hide();
    $winConfig->lblSavedQueriesDBShadowT->Hide();
    $winConfig->lblSavedQueriesDBT->Hide();
    $winConfig->tfSavedQueriesDB->Hide();
    $winConfig->btnSavedQueriesDB->Hide();
    $winConfig->btnNewSavedQueriesDB->Hide();
    # Hide XL-Toolkit databases tab
    $winConfig->lblXLWHOISDBShadowT->Hide();
    $winConfig->lblXLWHOISDBT->Hide();
    $winConfig->tfXLWHOISDB->Hide();
    $winConfig->btnXLWHOISDB->Hide();
    $winConfig->lblResTLDDBShadowT->Hide();
    $winConfig->lblResTLDDBT->Hide();
    $winConfig->tfResTLDDB->Hide();
    $winConfig->btnResTLDDB->Hide();
    $winConfig->btnResTLDDBUpt->Hide();
    $winConfig->lblDTDBShadowT->Hide();
    $winConfig->lblDTDBT->Hide();
    $winConfig->tfDTDB->Hide();
    $winConfig->btnDTDB->Hide();
    $winConfig->btnNewDTDB->Hide();
    $winConfig->btnDTDBUpt->Hide();
  # Show Databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    # Databases tab
    $winConfig->lblMACOUIDBShadowT->Show();
    $winConfig->lblMACOUIDBT->Show();
    $winConfig->chMACOUIDBAutoUpt->Show();
    $winConfig->tfMACOUIDB->Show();
    $winConfig->btnMACOUIDB->Show();
    $winConfig->btnMACOUIDBUpt->Show();
    $winConfig->btnMACOUIDBImport->Show();
    $winConfig->lblGeoIPDBShadowT->Show();
    $winConfig->lblGeoIPDBT->Show();
    $winConfig->chGeoIPDBAutoUpt->Show();
    $winConfig->tfGeoIPDB->Show();
    $winConfig->btnGeoIPDB->Show();
    $winConfig->btnGeoIPDBUpt->Show();
    $winConfig->lblIINDBShadowT->Show();
    $winConfig->lblIINDBT->Show();
    $winConfig->tfIINDB->Show();
    $winConfig->btnIINDB->Show();
    $winConfig->btnIINDBUpt->Show();
    $winConfig->lblTLDDBShadowT->Show();
    $winConfig->lblTLDDBT->Show();
    $winConfig->chTLDDBAutoUpt->Show();
    $winConfig->tfTLDDB->Show();
    $winConfig->btnTLDDB->Show();
    $winConfig->btnTLDDBUpt->Show();
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->chFullScreen->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblLocalTZ->Hide();
    $winConfig->cbLocalTZ->Hide();
    $winConfig->lblDefaultLang->Hide();
    $winConfig->cbDefaultLang->Hide();
    # Hide XL-Toolkit databases tab
    $winConfig->lblXLWHOISDBShadowT->Hide();
    $winConfig->lblXLWHOISDBT->Hide();
    $winConfig->tfXLWHOISDB->Hide();
    $winConfig->btnXLWHOISDB->Hide();
    $winConfig->lblResTLDDBShadowT->Hide();
    $winConfig->lblResTLDDBT->Hide();
    $winConfig->tfResTLDDB->Hide();
    $winConfig->btnResTLDDB->Hide();
    $winConfig->btnResTLDDBUpt->Hide();
    $winConfig->lblDTDBShadowT->Hide();
    $winConfig->lblDTDBT->Hide();
    $winConfig->tfDTDB->Hide();
    $winConfig->btnDTDB->Hide();
    $winConfig->btnNewDTDB->Hide();
    $winConfig->btnDTDBUpt->Hide();
    # Hide XL-Parser databases tab
    $winConfig->lblExprHistoDBShadowT->Hide();
    $winConfig->lblExprHistoDBT->Hide();
    $winConfig->tfExprHistoDB->Hide();
    $winConfig->btnExprHistoDB->Hide();
    $winConfig->btnNewExprHistoDB->Hide();
    $winConfig->tfExprDB->Hide();
    $winConfig->btnExprDB->Hide();
    $winConfig->btnNewExprDB->Hide();
    $winConfig->btnExprDBImport->Hide();
    $winConfig->lblLFDBShadowT->Hide();
    $winConfig->lblLFDBT->Hide();
    $winConfig->tfLFDB->Hide();
    $winConfig->btnLFDB->Hide();
    $winConfig->btnNewLFDB->Hide();
    $winConfig->btnLFDBUpt->Hide();
    $winConfig->lblLAFiltersDBShadowT->Hide();
    $winConfig->lblLAFiltersDBT->Hide();
    $winConfig->tfLAFiltersDB->Hide();
    $winConfig->btnLAFiltersDB->Hide();
    $winConfig->btnNewLAFiltersDB->Hide();
    $winConfig->lblSavedQueriesDBShadowT->Hide();
    $winConfig->lblSavedQueriesDBT->Hide();
    $winConfig->tfSavedQueriesDB->Hide();
    $winConfig->btnSavedQueriesDB->Hide();
    $winConfig->btnNewSavedQueriesDB->Hide();
  # Show XL-Parser databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 2) {
    $winConfig->lblExprHistoDBShadowT->Show();
    $winConfig->lblExprHistoDBT->Show();
    $winConfig->tfExprHistoDB->Show();
    $winConfig->btnExprHistoDB->Show();
    $winConfig->btnNewExprHistoDB->Show();
    $winConfig->tfExprDB->Show();
    $winConfig->btnExprDB->Show();
    $winConfig->btnNewExprDB->Show();
    $winConfig->btnExprDBImport->Show();
    $winConfig->lblLFDBShadowT->Show();
    $winConfig->lblLFDBT->Show();
    $winConfig->tfLFDB->Show();
    $winConfig->btnLFDB->Show();
    $winConfig->btnNewLFDB->Show();
    $winConfig->btnLFDBUpt->Show();
    $winConfig->lblLAFiltersDBShadowT->Show();
    $winConfig->lblLAFiltersDBT->Show();
    $winConfig->tfLAFiltersDB->Show();
    $winConfig->btnLAFiltersDB->Show();
    $winConfig->btnNewLAFiltersDB->Show();
    $winConfig->lblSavedQueriesDBShadowT->Show();
    $winConfig->lblSavedQueriesDBT->Show();
    $winConfig->tfSavedQueriesDB->Show();
    $winConfig->btnSavedQueriesDB->Show();
    $winConfig->btnNewSavedQueriesDB->Show();
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->chFullScreen->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblLocalTZ->Hide();
    $winConfig->cbLocalTZ->Hide();
    $winConfig->lblDefaultLang->Hide();
    $winConfig->cbDefaultLang->Hide();
    # Hide Databases tab
    $winConfig->lblMACOUIDBShadowT->Hide();
    $winConfig->lblMACOUIDBT->Hide();
    $winConfig->chMACOUIDBAutoUpt->Hide();
    $winConfig->tfMACOUIDB->Hide();
    $winConfig->btnMACOUIDB->Hide();
    $winConfig->btnMACOUIDBUpt->Hide();
    $winConfig->btnMACOUIDBImport->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
    $winConfig->lblIINDBShadowT->Hide();
    $winConfig->lblIINDBT->Hide();
    $winConfig->tfIINDB->Hide();
    $winConfig->btnIINDB->Hide();
    $winConfig->btnIINDBUpt->Hide();
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    # Hide XL-Toolkit databases tab
    $winConfig->lblXLWHOISDBShadowT->Hide();
    $winConfig->lblXLWHOISDBT->Hide();
    $winConfig->tfXLWHOISDB->Hide();
    $winConfig->btnXLWHOISDB->Hide();
    $winConfig->lblResTLDDBShadowT->Hide();
    $winConfig->lblResTLDDBT->Hide();
    $winConfig->tfResTLDDB->Hide();
    $winConfig->btnResTLDDB->Hide();
    $winConfig->btnResTLDDBUpt->Hide();
    $winConfig->lblDTDBShadowT->Hide();
    $winConfig->lblDTDBT->Hide();
    $winConfig->tfDTDB->Hide();
    $winConfig->btnDTDB->Hide();
    $winConfig->btnNewDTDB->Hide();
    $winConfig->btnDTDBUpt->Hide();
  # Show XL-Toolkit databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 3) {
    $winConfig->lblXLWHOISDBShadowT->Show();
    $winConfig->lblXLWHOISDBT->Show();
    $winConfig->tfXLWHOISDB->Show();
    $winConfig->btnXLWHOISDB->Show();
    $winConfig->lblResTLDDBShadowT->Show();
    $winConfig->lblResTLDDBT->Show();
    $winConfig->tfResTLDDB->Show();
    $winConfig->btnResTLDDB->Show();
    $winConfig->btnResTLDDBUpt->Show();
    $winConfig->lblDTDBShadowT->Show();
    $winConfig->lblDTDBT->Show();
    $winConfig->tfDTDB->Show();
    $winConfig->btnDTDB->Show();
    $winConfig->btnNewDTDB->Show();
    $winConfig->btnDTDBUpt->Show();
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->chFullScreen->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblLocalTZ->Hide();
    $winConfig->cbLocalTZ->Hide();
    $winConfig->lblDefaultLang->Hide();
    $winConfig->cbDefaultLang->Hide();
    # Hide Databases tab
    $winConfig->lblMACOUIDBShadowT->Hide();
    $winConfig->lblMACOUIDBT->Hide();
    $winConfig->chMACOUIDBAutoUpt->Hide();
    $winConfig->tfMACOUIDB->Hide();
    $winConfig->btnMACOUIDB->Hide();
    $winConfig->btnMACOUIDBUpt->Hide();
    $winConfig->btnMACOUIDBImport->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
    $winConfig->lblIINDBShadowT->Hide();
    $winConfig->lblIINDBT->Hide();
    $winConfig->tfIINDB->Hide();
    $winConfig->btnIINDB->Hide();
    $winConfig->btnIINDBUpt->Hide();
    $winConfig->lblTLDDBShadowT->Hide();
    $winConfig->lblTLDDBT->Hide();
    $winConfig->chTLDDBAutoUpt->Hide();
    $winConfig->tfTLDDB->Hide();
    $winConfig->btnTLDDB->Hide();
    $winConfig->btnTLDDBUpt->Hide();
    # Hide XL-Parser databases tab
    $winConfig->lblExprHistoDBShadowT->Hide();
    $winConfig->lblExprHistoDBT->Hide();
    $winConfig->tfExprHistoDB->Hide();
    $winConfig->btnExprHistoDB->Hide();
    $winConfig->btnNewExprHistoDB->Hide();
    $winConfig->tfExprDB->Hide();
    $winConfig->btnExprDB->Hide();
    $winConfig->btnNewExprDB->Hide();
    $winConfig->btnExprDBImport->Hide();
    $winConfig->lblLFDBShadowT->Hide();
    $winConfig->lblLFDBT->Hide();
    $winConfig->tfLFDB->Hide();
    $winConfig->btnLFDB->Hide();
    $winConfig->btnNewLFDB->Hide();
    $winConfig->btnLFDBUpt->Hide();
    $winConfig->lblLAFiltersDBShadowT->Hide();
    $winConfig->lblLAFiltersDBT->Hide();
    $winConfig->tfLAFiltersDB->Hide();
    $winConfig->btnLAFiltersDB->Hide();
    $winConfig->btnNewLAFiltersDB->Hide();
    $winConfig->lblSavedQueriesDBShadowT->Hide();
    $winConfig->lblSavedQueriesDBT->Hide();
    $winConfig->tfSavedQueriesDB->Hide();
    $winConfig->btnSavedQueriesDB->Hide();
    $winConfig->btnNewSavedQueriesDB->Hide();
  }
  
}  #--- End configTab_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnOpenUserDir_Click
#--------------------------#
{
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $USERDIR", 0, NORMAL_PRIORITY_CLASS, ".") if -d $USERDIR;

}  #--- End btnOpenUserDir_Click

#--------------------------#
sub btnCheckUpdate_Click { &updateTool(1, $VERSION, \$winConfig, \$win, \%STR); }
#--------------------------#

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub chFullScreen_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chFullScreen->Checked()) {
    $CONFIG{'FULL_SCREEN'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'FULL_SCREEN'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chFullScreen_Click

#--------------------------#
sub chRememberPos_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chRememberPos->Checked()) {
    $CONFIG{'REMEMBER_POS'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'REMEMBER_POS'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chRememberPos_Click

#--------------------------#
sub tfLookupTO_Change
#--------------------------#
{
  # Local variables
  my $lookupTO = $winConfig->tfLookupTO->Text();
  # Remember
  if ($lookupTO) {
    $CONFIG{'NSLOOKUP_TIMEOUT'} = $lookupTO;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End tfLookupTO_Change

#--------------------------#
sub cbLocalTZ_Change
#--------------------------#
{
  # Remember
  $CONFIG{'LOCAL_TIMEZONE'} = $winConfig->cbLocalTZ->GetCurSel();
  &saveConfig($CONFIG_FILE, \%CONFIG);
  
}  #--- End cbLocalTZ_Change

#--------------------------#
sub cbDefaultLang_Change
#--------------------------#
{
  # Remember
  $CONFIG{'DEFAULT_LANG'} = $winConfig->cbDefaultLang->GetString($winConfig->cbDefaultLang->GetCurSel());
  &saveConfig($CONFIG_FILE, \%CONFIG);
  
}  #--- End cbDefaultLang_Change

#--------------------------#
sub chMACOUIDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chMACOUIDBAutoUpt->Checked() == 1) {
    $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chMACOUIDBAutoUpt_Click

#--------------------------#
sub tfMACOUIDB_Change
#--------------------------#
{
  # Local variables
  my $MACOUIDBFile = $winConfig->tfMACOUIDB->Text();
  # Remember
  if ($MACOUIDBFile and -f $MACOUIDBFile and &validMACOUIDB($MACOUIDBFile)) {
    $CONFIG{'MACOUI_DB_FILE'} = $MACOUIDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'MACOUI_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($MACOUIDBFile) {
      $winConfig->tfMACOUIDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfMACOUIDB_Change

#--------------------------#
sub btnMACOUIDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfMACOUIDB->Text();
  my $MACOUIDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $MACOUIDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                                -title         => $STR{'selMACOUIFile'}.':' ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'OUI.db'                  ,
                                                -explorer      => 1                         , );
  } else {
    $MACOUIDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                                -title         => $STR{'selMACOUIFile'}.':' ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -file          => 'OUI.db'                  ,
                                                -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfMACOUIDB->Text($MACOUIDBFile) if $MACOUIDBFile and -f $MACOUIDBFile;
  return(1);

}  #--- End btnMACOUIDB_Click

#--------------------------#
sub btnMACOUIDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        # Delete temp files if converting was in progress
        if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
          my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
          unlink($localMACOUIDB.'-journal');
          unlink($localMACOUIDB);
        }
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        # Delete temp files if converting was in progress
        if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
          my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
          unlink($localMACOUIDB.'-journal');
          unlink($localMACOUIDB);
        }
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      &updateMACOUIDB(1, $VERSION, $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
										  \$winPb, \$win, \%STR);
    });
  }
  return(1);
  
}  #--- End btnMACOUIDBUpt_Click

#--------------------------#
sub btnMACOUIDBImport_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    # Local variables
    my $lastDir = $winConfig->tfMACOUIDB->Text();
    my $MACOUIFile;
    # Show OpenFile dialog window for the oui.txt file
    if ($lastDir) {
      my (@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      $MACOUIFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                         ,
                                                -title         => $STR{'selectFile'}.'oui.txt:'      ,
                                                -filter        => [$STR{'text'}.' (*.txt)', '*.txt'] ,
                                                -filemustexist => 1                                  ,
                                                -directory     => $lastDir                           ,
                                                -explorer      => 1                                  , );
    } else {
      $MACOUIFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                         ,
                                                -title         => $STR{'selectFile'}.'oui.txt:'      ,
                                                -filter        => [$STR{'text'}.' (*.txt)', '*.txt'] ,
                                                -filemustexist => 1                                  ,
                                                -explorer      => 1                                  , );
    }
    # Selected file
    if ($MACOUIFile and -T $MACOUIFile) {
      # Show SaveFileWindow for database
      my $localMACOUIDB = Win32::GUI::GetSaveFileName(-owner            => $winConfig                       ,
                                                      -title            => $STR{'selPathDB'}.':'            ,
                                                      -file             => 'OUI.db'                         ,
                                                      -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                                      -overwriteprompt  => 1                                , );
      if ($localMACOUIDB) {
        $THR_UPDATE = threads->create(sub {
          # Thread 'cancellation' signal handler
          $SIG{'KILL'} = sub {
            # Delete temp files
            unlink($localMACOUIDB.'-journal') if -e $localMACOUIDB.'-journal';
            unlink($localMACOUIDB)            if -e $localMACOUIDB;
            $winConfig->tfMACOUIDB->Text('');
            delete($CONFIG{'MACOUI_DB_FILE'});
            &saveConfig($CONFIG_FILE, \%CONFIG);
            $win->ChangeCursor($ARROW);
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            $winPb->Hide();
            threads->exit();
          };
          # Thread 'die' signal handler
          $SIG{__DIE__} = sub {
            # Delete temp files
            unlink($localMACOUIDB.'-journal') if -e $localMACOUIDB.'-journal';
            unlink($localMACOUIDB)            if -e $localMACOUIDB;
            $winConfig->tfMACOUIDB->Text('');
            delete($CONFIG{'MACOUI_DB_FILE'});
            &saveConfig($CONFIG_FILE, \%CONFIG);
            my $errMsg = (split(/ at /,$_[0]))[0];
            chomp($errMsg);
            $errMsg =~ s/[\t\r\n]/ /g;
            $win->ChangeCursor($ARROW);
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            $winPb->Hide();
            Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
          };
          my $return = &importMACOUIDatabase(0, $localMACOUIDB, $MACOUIFile); # $return contains error msg if any
        if ($return) { Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);                     }
        else         { Win32::GUI::MessageBox($win, $STR{'importedOUIDB'}, "XL-Parser $VERSION", 0x40040); }
        });
      }
    }
  }
  return(1);
  
}  #--- End btnMACOUIDBImport_Click

#--------------------------#
sub chGeoIPDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chGeoIPDBAutoUpt->Checked() == 1) {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chGeoIPDBAutoUpt_Click

#--------------------------#
sub tfGeoIPDB_Change
#--------------------------#
{
  # Local variables
  my $GeoIPDBFile = $winConfig->tfGeoIPDB->Text();
  # Remember
  if ($GeoIPDBFile and -f $GeoIPDBFile and &validGeoIPDB($GeoIPDBFile)) {
    $CONFIG{'GEOIP_DB_FILE'} = $GeoIPDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'GEOIP_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($GeoIPDBFile) {
      $winConfig->tfGeoIPDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfGeoIPDB_Change

#--------------------------#
sub btnGeoIPDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfGeoIPDB->Text();
  my $GeoIPDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => $STR{'selGeoIPFile'}.':'  ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'GeoLiteCity.dat'         ,
                                                -explorer      => 1                         , );
  } else {
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => $STR{'selGeoIPFile'}.':'  ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -file          => 'GeoLiteCity.dat'         ,
                                                -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfGeoIPDB->Text($GeoIPDBFile) if $GeoIPDBFile and -f $GeoIPDBFile;
  return(1);

}  #--- End btnGeoIPDB_Click

#--------------------------#
sub btnGeoIPDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      &updateGeoIPDB(1, $VERSION, $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                     \$winPb, \$win, \%STR);
    });
  }
  return(1);
  
}  #--- End btnGeoIPDBUpt_Click

#--------------------------#
sub tfExprHistoDB_Change
#--------------------------#
{
  # Local variables
  my $exprHistoDBFile = $winConfig->tfExprHistoDB->Text();
  # Remember
  if ($exprHistoDBFile and -f $exprHistoDBFile and &validExprHistoDB($exprHistoDBFile)) {
    $CONFIG{'EXPR_HISTO_DB'} = $exprHistoDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'EXPR_HISTO_DB'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($exprHistoDBFile) {
      $winConfig->tfExprHistoDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfExprHistoDB_Change

#--------------------------#
sub btnExprHistoDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfExprHistoDB->Text();
  my $exprHistoDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $exprHistoDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                    -title         => $STR{'selectDBFile'}.':'   ,
                                                    -defaultfilter => 0                          ,
                                                    -filemustexist => 1                          ,
                                                    -directory     => $lastDir                   ,
                                                    -file          => 'ExprHisto.db'             ,
                                                    -explorer      => 1                          , );
  } else {
    $exprHistoDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                    -title         => $STR{'selectDBFile'}.':'   ,
                                                    -defaultfilter => 0                          ,
                                                    -filemustexist => 1                          ,
                                                    -file          => 'ExprHisto.db'             ,
                                                    -explorer      => 1                          , );
  }
  # Selected file
  $winConfig->tfExprHistoDB->Text($exprHistoDBFile) if $exprHistoDBFile and -f $exprHistoDBFile;
  return(1);

}  #--- End btnExprHistoDB_Click

#--------------------------#
sub btnNewExprHistoDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $exprHistoDBFile = Win32::GUI::GetSaveFileName(-owner            => $winConfig                       ,
                                                    -title            => $STR{'selPathDB'}.':'            ,
                                                    -file             => 'ExprHisto.db'                   ,
                                                    -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                                    -overwriteprompt  => 1                                , );
  if ($exprHistoDBFile and &createExprHistoDB($exprHistoDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'exprHistory'}, 0x40040);
    $winConfig->tfExprHistoDB->Text($exprHistoDBFile);
  }
  return(1);
  
}  #--- End btnNewExprHistoDB_Click

#--------------------------#
sub tfExprDB_Change
#--------------------------#
{
  # Local variables
  my $exprDBFile = $winConfig->tfExprDB->Text();
  # Remember
  if ($exprDBFile and -f $exprDBFile and &validExprDB($exprDBFile)) {
    $CONFIG{'EXPR_DB'} = $exprDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'EXPR_DB'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($exprDBFile) {
      $winConfig->tfExprDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfExprDB_Change

#--------------------------#
sub btnExprDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfExprDB->Text();
  my $exprDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $exprDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -directory     => $lastDir                   ,
                                              -file          => 'Expr.db'                  ,
                                              -explorer      => 1                          , );
  } else {
    $exprDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -file          => 'Expr.db'                  ,
                                              -explorer      => 1                          , );
  }
  # Selected file
  $winConfig->tfExprDB->Text($exprDBFile) if $exprDBFile and -f $exprDBFile;
  return(1);

}  #--- End btnExprDB_Click

#--------------------------#
sub btnNewExprDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $exprDBFile = Win32::GUI::GetSaveFileName( -owner            => $winConfig                       ,
                                                -title            => $STR{'selPathDB'}.':'            ,
                                                -file             => 'Expr.db'                        ,
                                                -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                                -overwriteprompt  => 1                                , );
  if ($exprDBFile and &createExprDB($exprDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'exprDatabase'}, 0x40040);
    $winConfig->tfExprDB->Text($exprDBFile);
  }
  return(1);
  
}  #--- End btnNewExprDB_Click

#--------------------------#
sub btnExprDBImport_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $exprDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                -title         => $STR{'selectDBFile'}.':'   ,
                                                -defaultfilter => 0                          ,
                                                -filemustexist => 1                          ,
                                                -file          => 'Expr.db'                  ,
                                                -explorer      => 1                          , );
  if ($exprDBFile and &validExprDB($exprDBFile)) {
    # Load all expressions from the database to import
    my $dsn = "DBI:SQLite:dbname=$exprDBFile";
    my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
              or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
    # Check if EXPR_DB table exists
    my $sth;
    eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
    if ($@) {
      Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      return(0);
    }
    my @info = $sth->fetchrow_array;
    $sth->finish();
    if ($info[2] eq 'EXPR_DB') { # If table EXPR_DB exists, than load data
      my $all = $dbh->selectall_arrayref("SELECT * FROM EXPR_DB");
      $dbh->disconnect();
      # Connect to the current database
      my $curExprDBFile = $winConfig->tfExprDB->Text();
      $dsn = "DBI:SQLite:dbname=$curExprDBFile";
      $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })
             or Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}.$DBI::errstr, $STR{'error'}, 0x40010);
      # Database: table = EXPR_DB, Fields = used, matchcase, regex, invert, expr, comment
      my $sth = $dbh->prepare("insert or ignore into EXPR_DB (used, matchcase, regex, invert, expr, comment) values(?,?,?,?,?,?)");
      # Add each expression that don't already exists
      foreach my $row (@$all) {
        my (@values) = @$row;
        my $rv = $sth->execute(0, $values[1], $values[2], $values[3], $values[4], $values[5]);
        if ($rv < 0) {
          Win32::GUI::MessageBox($winExtraction, $STR{'errorMsg'}.$DBI::errstr, $STR{'error'}, 0x40010);
          return(0);
        }
      }
      return(1);
    } else { Win32::GUI::MessageBox($win, $STR{'errorDB'}, $STR{'error'}, 0x40010); return(0); }
    # Final message
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'exprDatabase'}, 0x40040);
  }
  
}  #--- End btnExprDBImport_Click

#--------------------------#
sub tfLFDB_Change
#--------------------------#
{
  # Local variables
  my $LFDBFile = $winConfig->tfLFDB->Text();
  # Remember
  if ($LFDBFile and -f $LFDBFile and &validLFDB($LFDBFile)) {
    $CONFIG{'LF_DB_FILE'} = $LFDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'LF_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($LFDBFile) {
      $winConfig->tfLFDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfLFDB_Change

#--------------------------#
sub btnLFDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLFDB->Text();
  my $LFDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $LFDBFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -directory     => $lastDir                   ,
                                              -file          => 'LF.db'                    ,
                                              -explorer      => 1                          , );
  } else {
    $LFDBFile = Win32::GUI::GetOpenFileName(  -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -file          => 'LF.db'                    ,
                                              -explorer      => 1                          , );
  }
  # Selected file
  if ($LFDBFile and -f $LFDBFile) {
    $winConfig->tfLFDB->Text($LFDBFile);
    $CONFIG{'LF_DB_FILE'} = $LFDBFile;
  }
  return(1);

}  #--- End btnLFDB_Click

#--------------------------#
sub btnNewLFDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $LFDBFile = Win32::GUI::GetSaveFileName( -owner            => $winConfig                       ,
                                              -title            => $STR{'selPathDB'}.':'            ,
                                              -file             => 'LF.db'                          ,
                                              -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                              -overwriteprompt  => 1                                , );
  if ($LFDBFile and &createLFDB($LFDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'winLFDB'}, 0x40040);
    $winConfig->tfLFDB->Text($LFDBFile);
  }
  return(1);
  
}  #--- End btnNewLFDB_Click

#--------------------------#
sub btnLFDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      my $errMsg = &downloadLFDB("$USERDIR\\LF.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                 \$winConfig, \$winLFDB, \$winLFObj, \$winPb, \$win, \%STR);
      if ($errMsg) { Win32::GUI::MessageBox($win, "$errMsg"          , $STR{'error'}      , 0x40010); }
      else         { Win32::GUI::MessageBox($win, $STR{'updatedLFDB'}, "XL-Parser $VERSION", 0x40040); }
    });
  }
  return(1);
  
}  #--- End btnLFDBUpt_Click

#--------------------------#
sub tfLAFiltersDB_Change
#--------------------------#
{
  # Local variables
  my $LAFiltersDBFile = $winConfig->tfLAFiltersDB->Text();
  # Remember
  if ($LAFiltersDBFile and -f $LAFiltersDBFile and &validLAFilterSetDB($LAFiltersDBFile)) {
    $CONFIG{'LAFILTERS_DB_FILE'} = $LAFiltersDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'LAFILTERS_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($LAFiltersDBFile) {
      $winConfig->tfLAFiltersDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfLAFiltersDB_Change

#--------------------------#
sub btnLAFiltersDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLAFiltersDB->Text();
  my $LAFiltersDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $LAFiltersDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                    -title         => $STR{'selectDBFile'}.':'   ,
                                                    -defaultfilter => 0                          ,
                                                    -filemustexist => 1                          ,
                                                    -directory     => $lastDir                   ,
                                                    -file          => 'LA_Filters.db'            ,
                                                    -explorer      => 1                          , );
  } else {
    $LAFiltersDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                    -title         => $STR{'selectDBFile'}.':'   ,
                                                    -defaultfilter => 0                          ,
                                                    -filemustexist => 1                          ,
                                                    -file          => 'LA_Filters.db'            ,
                                                    -explorer      => 1                          , );
  }
  # Selected file
  if ($LAFiltersDBFile and -f $LAFiltersDBFile) {
    $winConfig->tfLAFiltersDB->Text($LAFiltersDBFile);
    $CONFIG{'LAFILTERS_DB_FILE'} = $LAFiltersDBFile;
  }
  return(1);

}  #--- End btnLAFiltersDB_Click

#--------------------------#
sub btnNewLAFiltersDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $LAFiltersDBFile = Win32::GUI::GetSaveFileName(-owner            => $winConfig                       ,
                                                    -title            => $STR{'selPathDB'}.':'            ,
                                                    -file             => 'LA_Filters.db'                  ,
                                                    -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                                    -overwriteprompt  => 1                                , );
  if ($LAFiltersDBFile and &createLAFiltersDB($LAFiltersDBFile) and &createLAFilterSetDB($LAFiltersDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'LAFiltersDB'}, 0x40040);
    $winConfig->tfLAFiltersDB->Text($LAFiltersDBFile);
  }
  return(1);
  
}  #--- End btnNewLAFiltersDB_Click

#--------------------------#
sub tfSavedQueriesDB_Change
#--------------------------#
{
  # Local variables
  my $savedQueriesDBFile = $winConfig->tfSavedQueriesDB->Text();
  # Remember
  if ($savedQueriesDBFile and -f $savedQueriesDBFile and &validSavedQueriesDB($savedQueriesDBFile)) {
    $CONFIG{'SAVED_QUERIES_DB_FILE'} = $savedQueriesDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'SAVED_QUERIES_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($savedQueriesDBFile) {
      $winConfig->tfSavedQueriesDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfSavedQueriesDB_Change

#--------------------------#
sub btnSavedQueriesDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfSavedQueriesDB->Text();
  my $savedQueriesDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $savedQueriesDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                                      -title         => $STR{'selectDBFile'}.':'   ,
                                                      -defaultfilter => 0                          ,
                                                      -filemustexist => 1                          ,
                                                      -directory     => $lastDir                   ,
                                                      -file          => 'SavedQueries.db'          ,
                                                      -explorer      => 1                          , );
  } else {
    $savedQueriesDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                                      -title         => $STR{'selectDBFile'}.':'   ,
                                                      -defaultfilter => 0                          ,
                                                      -filemustexist => 1                          ,
                                                      -file          => 'SavedQueries.db'          ,
                                                      -explorer      => 1                          , );
  }
  # Selected file
  if ($savedQueriesDBFile and -f $savedQueriesDBFile) {
    $winConfig->tfSavedQueriesDB->Text($savedQueriesDBFile);
    $CONFIG{'SAVED_QUERIES_DB_FILE'} = $savedQueriesDBFile;
  }
  return(1);

}  #--- End btnSavedQueriesDB_Click

#--------------------------#
sub btnNewSavedQueriesDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $savedQueriesDBFile = Win32::GUI::GetSaveFileName( -owner            => $winConfig                       ,
                                                        -title            => $STR{'selPathDB'}.':'            ,
                                                        -file             => 'SavedQueries.db'                ,
                                                        -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                                        -overwriteprompt  => 1                                , );
  if ($savedQueriesDBFile and &createSavedQueriesDB($savedQueriesDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'savedQueriesDB'}, 0x40040);
    $winConfig->tfSavedQueriesDB->Text($savedQueriesDBFile);
  }
  return(1);
  
}  #--- End btnNewSavedQueriesDB_Click

#--------------------------#
sub tfXLWHOISDB_Change
#--------------------------#
{
  # Local variables
  my $XLWHOISDBFile = $winConfig->tfXLWHOISDB->Text();
  # Remember
  if ($XLWHOISDBFile and -f $XLWHOISDBFile and &validXLWHOISDB($XLWHOISDBFile)) {
    $CONFIG{'XLWHOIS_DB_FILE'} = $XLWHOISDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'XLWHOIS_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($XLWHOISDBFile) {
      $winConfig->tfXLWHOISDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfXLWHOISDB_Change

#--------------------------#
sub btnXLWHOISDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfXLWHOISDB->Text();
  my $XLWHOISDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                  -title         => $STR{'selectDBFile'}.':'   ,
                                                  -defaultfilter => 0                          ,
                                                  -filemustexist => 1                          ,
                                                  -directory     => $lastDir                   ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  } else {
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                  -title         => $STR{'selectDBFile'}.':'   ,
                                                  -defaultfilter => 0                          ,
                                                  -filemustexist => 1                          ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  }
  # Selected file
  $winConfig->tfXLWHOISDB->Text($XLWHOISDBFile) if $XLWHOISDBFile and -f $XLWHOISDBFile;
  return(1);

}  #--- End btnXLWHOISDB_Click

#--------------------------#
sub tfIINDB_Change
#--------------------------#
{
  # Local variables
  my $IINDBFile = $winConfig->tfIINDB->Text();
  # Remember
  if ($IINDBFile and -f $IINDBFile and &validIINDB($IINDBFile)) {
    $CONFIG{'IIN_DB_FILE'} = $IINDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'IIN_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($IINDBFile) {
      $winConfig->tfIINDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfIINDB_Change

#--------------------------#
sub btnIINDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIINDB->Text();
  my $IINDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $IINDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -directory     => $lastDir                   ,
                                              -file          => 'IIN.db'                   ,
                                              -explorer      => 1                          , );
  } else {
    $IINDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -file          => 'IIN.db'                   ,
                                              -explorer      => 1                          , );
  }
  # Selected file
  if ($IINDBFile and -f $IINDBFile) {
    $winConfig->tfIINDB->Text($IINDBFile);
    $CONFIG{'IIN_DB_FILE'} = $IINDBFile;
  }
  return(1);

}  #--- End btnIINDB_Click

#--------------------------#
sub btnIINDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      my $errMsg = &downloadIINDB("$USERDIR\\IIN.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                  \$winConfig, \$winPb, \$win, \%STR);
      if ($errMsg) { Win32::GUI::MessageBox($win, "$errMsg"           , $STR{'error'}      , 0x40010); }
      else         { Win32::GUI::MessageBox($win, $STR{'updatedIINDB'}, "XL-Parser $VERSION", 0x40040); }
    });
  }
  return(1);
  
}  #--- End btnIINDBUpt_Click

#--------------------------#
sub chTLDDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chTLDDBAutoUpt->Checked()) {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 1;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    $CONFIG{'TLD_DB_AUTO_UPDATE'} = 0;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  }

}  #--- End chTLDDBAutoUpt_Click

#--------------------------#
sub tfTLDDB_Change
#--------------------------#
{
  # Local variables
  my $TLDdbFile = $winConfig->tfTLDDB->Text();
  # Remember
  if ($TLDdbFile and -f $TLDdbFile and &validTLDDB($TLDdbFile)) {
    $CONFIG{'TLD_DB_FILE'} = $TLDdbFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'TLD_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($TLDdbFile) {
      $winConfig->tfTLDDB->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfTLDDB_Change

#--------------------------#
sub btnTLDDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfTLDDB->Text();
  my $TLDdbFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => $STR{'btnTLDDBTip'}.':'   ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -directory     => $lastDir                  ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  } else {
    $TLDdbFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                              -title         => $STR{'btnTLDDBTip'}.':'   ,
                                              -defaultfilter => 0                         ,
                                              -filemustexist => 1                         ,
                                              -file          => 'effective_tld_names.dat' ,
                                              -explorer      => 1                         , );
  }
  # Selected file
  $winConfig->tfTLDDB->Text($TLDdbFile) if $TLDdbFile and -f $TLDdbFile;
  return(1);

}  #--- End btnTLDDB_Click

#--------------------------#
sub btnTLDDBUpt_Click
#--------------------------#
{
  threads->create(sub {
    &updateTLDDB(1, $VERSION, $winConfig->tfTLDDB->Text(), \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG, \$winConfig,
                 \$winPb, \$win, \%STR);
  });
  return(1);
  
}  #--- End btnTLDDBUpt_Click

#--------------------------#
sub tfResTLDDB_Change
#--------------------------#
{
  # Local variables
  my $resTLDDBFile = $winConfig->tfResTLDDB->Text();
  # Remember
  if ($resTLDDBFile and -f $resTLDDBFile and &validResTLDDB($resTLDDBFile)) {
    $CONFIG{'RES_TLD_DB_FILE'} = $resTLDDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'RES_TLD_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($resTLDDBFile) {
      $winConfig->tfResTLDDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfResTLDDB_Change

#--------------------------#
sub btnResTLDDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfResTLDDB->Text();
  my $resTLDDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $resTLDDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig              ,
                                                -title         => $STR{'selectDBFile'}.':',
                                                -defaultfilter => 0                       ,
                                                -filemustexist => 1                       ,
                                                -directory     => $lastDir                ,
                                                -file          => 'Resolve TLD.db'        ,
                                                -explorer      => 1                       , );
  } else {
    $resTLDDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig              ,
                                                -title         => $STR{'selectDBFile'}.':',
                                                -defaultfilter => 0                       ,
                                                -filemustexist => 1                       ,
                                                -file          => 'Resolve TLD.db'        ,
                                                -explorer      => 1                       , );
  }
  # Selected file
  if ($resTLDDBFile and -f $resTLDDBFile) {
    $winConfig->tfResTLDDB->Text($resTLDDBFile);
    $CONFIG{'RES_TLD_DB_FILE'} = $resTLDDBFile;
  }
  return(1);

}  #--- End btnResTLDDB_Click

#--------------------------#
sub btnResTLDDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      my $errMsg = &downloadResTLDDB("$USERDIR\\Resolve TLD.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                     \$winConfig, \$winPb, \$win, \%STR);
      if ($errMsg) { Win32::GUI::MessageBox($winConfig, "$errMsg"              , $STR{'error'}      , 0x40010); }
      else         { Win32::GUI::MessageBox($winConfig, $STR{'updatedResTLDDB'}, "XL-Parser $VERSION", 0x40040); }
      $winConfig->BringWindowToTop();
    });
  }
  return(1);
  
}  #--- End btnResTLDDBUpt_Click

#--------------------------#
sub tfDTDB_Change
#--------------------------#
{
  # Local variables
  my $DTDBFile = $winConfig->tfDTDB->Text();
  # Remember
  if ($DTDBFile and -f $DTDBFile and &validDTDB($DTDBFile)) {
    $CONFIG{'DT_DB_FILE'} = $DTDBFile;
    &saveConfig($CONFIG_FILE, \%CONFIG);
  } else {
    delete($CONFIG{'DT_DB_FILE'});
    &saveConfig($CONFIG_FILE, \%CONFIG);
    if ($DTDBFile) {
      $winConfig->tfDTDB->Text('');
      Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010) if $START == 1;
    }
  }

}  #--- End tfDTDB_Change

#--------------------------#
sub btnDTDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfDTDB->Text();
  my $DTDBFile;
  # Show OpenFile dialog window
  if ($lastDir) {
    my (@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $DTDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                            -title         => $STR{'selectDBFile'}.':'   ,
                                            -defaultfilter => 0                          ,
                                            -filemustexist => 1                          ,
                                            -directory     => $lastDir                   ,
                                            -file          => 'DT.db'                    ,
                                            -explorer      => 1                          , );
  } else {
    $DTDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                 ,
                                            -title         => $STR{'selectDBFile'}.':'   ,
                                            -defaultfilter => 0                          ,
                                            -filemustexist => 1                          ,
                                            -file          => 'DT.db'                    ,
                                            -explorer      => 1                          , );
  }
  # Selected file
  if ($DTDBFile and -f $DTDBFile) {
    $winConfig->tfDTDB->Text($DTDBFile);
    $CONFIG{'DT_DB_FILE'} = $DTDBFile;
  }
  return(1);

}  #--- End btnDTDB_Click

#--------------------------#
sub btnNewDTDB_Click
#--------------------------#
{
  # Show SaveFileWindow for database
  my $DTDBFile = Win32::GUI::GetSaveFileName( -owner            => $winConfig                       ,
                                              -title            => $STR{'selPathDB'}.':'            ,
                                              -file             => 'DT.db'                          ,
                                              -filter           => [$STR{'dbFile'}.' (*.db)', '.db'],
                                              -overwriteprompt  => 1                                , );
  if ($DTDBFile and &createDTDB($DTDBFile)) {
    Win32::GUI::MessageBox($winConfig, $STR{'createdDB'}, $STR{'winDTDB'}, 0x40040);
    $winConfig->tfDTDB->Text($DTDBFile);
  }
  return(1);
  
}  #--- End btnNewDTDB_Click

#--------------------------#
sub btnDTDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      my $errMsg = &downloadDTDB("$USERDIR\\DT.db", $USERDIR, \$HOURGLASS, \$ARROW, $CONFIG_FILE, \%CONFIG,
                                 \$winConfig, \$winLFObj, \$winDTDB, \$winReport, \$winPb, \$win, \%STR);
      if ($errMsg) { Win32::GUI::MessageBox($win, "$errMsg"          , $STR{'error'}      , 0x40010); }
      else         { Win32::GUI::MessageBox($win, $STR{'updatedDTDB'}, "XL-Parser $VERSION", 0x40040); }
    });
  }
  return(1);
  
}  #--- End btnDTDBUpt_Click

#--------------------------#
sub lblNotReady_Click { &isProcessReady(1); }
#--------------------------#

#--------------------------#
sub isProcessReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $input   = $win->tfInput->Text();
  my $nextStep;
  # Input is folder or file(s), must be a valid folder or file
  if (($win->rbInputDir->Checked() or $win->rbInputFiles->Checked())) {
    if ($input) {
      my $dir;
      if ($input =~ /" "/) { $input =~ s/"//g; $dir = (split(/ /, $input))[0]; }
      else { $dir = $input; }
      $nextStep = $STR{'selectInput'} if !-d $dir and !-e $dir;
    } else { $nextStep = $STR{'selectInput'}; }
  # Input is database, must be a valid database
  } elsif ($win->rbInputDatabase->Checked()) {
    if (($input and $input !~ /\.db$/ or !(&validLADB($input))) or !$input) {
      # Reset value
      $win->lblCurrDBLastUpdateVal->Text('');
      $win->lblCurrDBPeriodVal->Text('');
      $win->lblCurrDBNbrEntriesVal->Text('');
      $win->lblCurrDBFilteredVal->Text('');
      $win->lblCurrDBRejectedVal->Text('');
      $win->lblCurrDBLogFormatVal->Text('');
      $win->tfCurrDBFiltersVal->Text('');
      $win->btnLACurrDBRejected->Disable();
      $win->btnLACurrDBFiltered->Disable();
      $win->lblCurrDBNbrResISPVal->Text('');
      $win->lblCurrDBNbrResGeoIPVal->Text('');
      $win->lblCurrDBResUAsVal->Text('');
      $win->lblCurrDBResWDsVal->Text('');
      $winLACurrDBFiles->gridCurrDBListFiles->DeleteNonFixedRows() if $winLACurrDBFiles;
      $nextStep = $STR{'selectInput'};
    }
  # Input is Clipboard, must contains text
  } elsif ($win->rbInputClipboard->Checked() and !Win32::Clipboard::GetText()) { $nextStep = $STR{'selectInput'}; }
  if ($nextStep) {
    $win->btnExtractAdd->Disable();
    $win->tvSO->Disable();
  } else {
    $win->btnExtractAdd->Enable();
    $win->tvSO->Enable();
  }
  # Extraction - Expression
  if (!$nextStep and $win->TabFunctions->GetString($win->TabFunctions->SelectedItem())         eq $STR{'Extraction'} and
                     $win->ExtractFunctions->GetString($win->ExtractFunctions->SelectedItem()) eq $STR{'Expression'} and
                     $win->gridExtraction->GetRows() < 2) {
    $nextStep = $STR{'setExpr'};
  }
  # Extraction - Special objects
  if (!$nextStep and $win->TabFunctions->GetString($win->TabFunctions->SelectedItem())         eq $STR{'Extraction'}  and
                     $win->ExtractFunctions->GetString($win->ExtractFunctions->SelectedItem()) eq $STR{'SpecObjects'} and
                     !$win->chSO_Status->Checked()) {
    # At least one object must be checked
    $nextStep = $STR{'setSO'};
  }
  # Log Analysis
  if ($win->TabFunctions->GetString($win->TabFunctions->SelectedItem()) eq $STR{'WebLogAnalysis'}) {
    my $LAFunctionStr = $win->LAFunctions->GetString($win->LAFunctions->SelectedItem());
    # Create or Update database
    if (!$win->rbInputDatabase->Checked()) {
      $win->btnLAFilters->Enable();
      if ($nextStep) { $win->btnLFGuess->Disable(); }
      else           { $win->btnLFGuess->Enable();  }
      # A log format must be selected
      if (!$nextStep and $win->cbLF->IsVisible() and !$win->cbLF->GetCurSel()) { $nextStep = $STR{'setLogFormat'}; }
      # A destination folder is required
      elsif (!$nextStep and !$win->tfDestDir->Text())                          { $nextStep = $STR{'setDestDir'};   }
    # Update database
    } elsif ($LAFunctionStr eq $STR{'updateDB'}) {
      # Create a new database, a destination database is required
      $nextStep = $STR{'selectDBFile'} if !$nextStep and $win->rbDestDBNew->Checked() and !$win->tfDestDir->Text();
    # Query Database
    } elsif ($LAFunctionStr eq $STR{'QueryDB'}) {
      # A SQL Query must be set or selected
      if    (!$nextStep and !$win->tfLAQuery->Text()) {
        $nextStep = $STR{'setSQLQuery'};
        $win->lblLAQueryErr->Hide();
        $win->lblLAQueryOk->Hide();
      }
      # Test query
      if (!$nextStep and my $query = $win->tfLAQuery->Text() and my $dbFile = $win->tfInput->Text()) {
        if ($query =~ /SELECT/ and $query =~ /FROM/) {
          $dbFile = encode('utf8', $dbFile);
          my $dsn = "DBI:SQLite:dbname=$dbFile";
          if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, PrintError => 0, PrintWarn  => 1 })) {
            eval    { my $sth = $dbh->prepare($query); };
            if ($@) { # Error in query
              $win->lblLAQueryErr->Show();
              $win->lblLAQueryOk->Hide();
              my $err = (split(/ at /, $@))[0];
              $nextStep = $STR{'errQuery'} . ': '.$err;
            } else { $win->lblLAQueryOk->Show();  $win->lblLAQueryErr->Hide(); } # Query OK
          } else   { $win->lblLAQueryErr->Show(); $win->lblLAQueryOk->Hide();  } # Cannot connect to DB
        } else     { $win->lblLAQueryErr->Show(); $win->lblLAQueryOk->Hide();  } # Query incomplete
      }
      # A destination folder is required
      elsif (!$nextStep and !$winReport->tfReportDir->Text()) { $nextStep = $STR{'setDestDir'};  }
    # Search Database - Suspicious activities
    } elsif ($LAFunctionStr eq $STR{'SearchSA'}) {
      # At least one selected indicator
      my $selected = 0;
      for (my $i = 1; $i <= $win->gridLASearchSAInd->GetRows(); $i++) {
        if ($win->gridLASearchSAInd->GetCellCheck($i, 0) and $win->gridLASearchSAInd->GetCellText($i, 1) and
            $win->gridLASearchSAInd->GetCellText( $i, 2) and $win->gridLASearchSAInd->GetCellText($i, 3)) { $selected = 1; last; }
      }
      $nextStep = $STR{'selectIndicator'} if !$selected;
    }
  }
  # Split Logs
  if ($win->TabFunctions->GetString($win->TabFunctions->SelectedItem()) eq $STR{'SplitLogs'}) {
    # For split logs, input must be a file or multiple files or a folder
    if ((!$win->rbInputDir->Checked() and !$win->rbInputFiles->Checked()) or (!-d $input and !-T $input)) {
      $nextStep = $STR{'splitLogsBadInput'};
    }
    if (!$nextStep) {
      if ($win->rbSplitByTime->Checked() or
          (($win->rbSplitBySize->Checked() or $win->rbSplitByLines->Checked()) and $win->chSplitUseDTFN->Checked())) {
        $win->btnSplitTimeFormatGuess->Enable();
      } else { $win->btnSplitTimeFormatGuess->Disable(); }
      # With By Size, a file size is required
      if ($win->rbSplitBySize->Checked() and !$win->tfSplitBySizeFrag->Text()) {        $nextStep = $STR{'setDestFileSize'};
      # With By Lines, a number of lines is required
      } elsif ($win->rbSplitByLines->Checked() and !$win->tfSplitByLinesNbr->Text()) {  $nextStep = $STR{'setNbrLines'};
      # With By Time (or By Size with use datetime in filename option), a format must be selected
      } elsif ($win->rbSplitByTime->Checked() and !$win->cbSplitTimeFormat->GetCurSel() or
               ($win->rbSplitBySize->Checked() and $win->chSplitUseDTFN->Checked() and !$win->cbSplitTimeFormat->GetCurSel())) {
        $nextStep = $STR{'setInputDTFormat'};
      # A destination folder is required
      } elsif (!$win->tfSplitDestDir->Text() or !-d $win->tfSplitDestDir->Text()) { $nextStep = $STR{'setDestDir'}; }
    }
  }
  # Return an error message or enable the button
  $win->lblFooter->Hide();
  $win->btnProcess->Hide();
  $win->btnWinConfig->Hide();
  $win->btnHelp->Hide();
  $win->btnAbout->Hide();
  $win->lblFooter->Show();
  $win->btnProcess->Show();
  $win->btnWinConfig->Show();
  $win->btnHelp->Show();
  $win->btnAbout->Show();
  if ($nextStep) {
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    Win32::GUI::MessageBox($win, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $win->btnProcess->Enable();
    $win->lblNotReady->Hide();
  }

}  #--- End isProcessReady

#--------------------------#
sub btnProcess_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010); }
  else {
    # Log analysis : Database exists in the destination folder
    my $LAFunctionStr = $win->LAFunctions->GetString($win->LAFunctions->SelectedItem());
    if ($win->TabFunctions->GetString($win->TabFunctions->SelectedItem()) eq $STR{'WebLogAnalysis'} and
        ((!$win->rbInputDatabase->Checked() and $win->rbLACreateDB->Checked()) or
         ($win->LAFunctions->GetString($win->LAFunctions->SelectedItem()) eq $STR{'updateDB'} and $win->rbDestDBNew->Checked())) and
        -e ($win->tfDestDir->Text())) {
      unlink($win->tfDestDir->Text());
    }
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
        threads->exit();
      };
      # Local variables
      my $functionStr        = $win->TabFunctions->GetString($win->TabFunctions->SelectedItem());
      my $extractFunctionStr = $win->ExtractFunctions->GetString($win->ExtractFunctions->SelectedItem());
      # Switch to Results tab
      if ($functionStr eq $STR{'Extraction'}) {
        $win->lblFooter->Hide();
        $win->btnWinConfig->Hide();
        $win->btnHelp->Hide();
        $win->btnAbout->Hide();
        $win->lblFooter->Show();
        $win->btnWinConfig->Show();
        $win->btnHelp->Show();
        $win->btnAbout->Show();
      }
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->btnProcess->Hide();
      $win->btnStop->Show();
      $win->ChangeCursor($HOURGLASS);
      # Extraction - Expression
      if ($functionStr eq $STR{'Extraction'} and $extractFunctionStr eq $STR{'Expression'}) {
        my $reportDir = $winReport->tfReportDir->Text();
        &extractExprFiles($PROGDIR, $USERDIR, $reportDir, \$winFileFilters, \$winFileFormats, \$winExtraction,
                          \$winExprOpt, \$winConfig, \$win, \%STR) if $reportDir and -d $reportDir;
      # Extraction - Special objects
      } elsif ($functionStr eq $STR{'Extraction'} and $extractFunctionStr eq $STR{'SpecObjects'}) {
        my $reportDir = $winReport->tfReportDir->Text();
        &extractSOFiles($PROGDIR, $USERDIR, $reportDir, \$winFileFilters, \$winFileFormats, \$win, \%STR, \%CONFIG) if $reportDir and -d $reportDir;
      # Log analysis
      } elsif ($functionStr eq $STR{'WebLogAnalysis'}) {
        # Create or update Log database
        if (!$win->rbInputDatabase->Checked()) {
          &createLADB($PROGDIR, $USERDIR, \$winLFDB, \$winDTDB, \$winFileFilters, \$winFileFormats, \$winLAFilters, \$win, \$winConfig,
                      \$winFO, \%STR, \%CONFIG);
        # Update Log database (existing database)
        } elsif ($LAFunctionStr eq $STR{'updateDB'}) {
          &updateLADB($PROGDIR, $USERDIR, \$winLAFilters, \$win, \$winConfig, \%CONFIG, \%STR);
        # Query Database
        } elsif ($LAFunctionStr eq $STR{'QueryDB'} ) {
          &createWinLASavedQueries() if !$winLASavedQueries;
          &queryLADB(   $PROGDIR, $USERDIR, \$winReport, \$winLASavedQueries, \$winConfig, \$win, \%STR);
        }
        # Search Suspicious activities
        elsif   ($LAFunctionStr eq $STR{'SearchSA'}) { searchSA_LADB($PROGDIR, $USERDIR, \$winLAQueryCols, \$winReport, \$winConfig, \$win, \%STR); }
      # Split Logs
      } elsif ($functionStr eq $STR{'SplitLogs'}) { &splitLogs(\$winFileFormats, \$winFileFilters, \%ZONE_MAP, \$win, \%STR); }
      # Hide Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->btnProcess->Show();
      $win->btnStop->Hide();
      $win->ChangeCursor($ARROW);
      &isProcessReady(0);
      # Final message
      my $message;
      if ($functionStr eq $STR{'WebLogAnalysis'} and (!$win->rbInputDatabase->Checked() or $LAFunctionStr eq $STR{'updateDB'})) {
        if (!$win->rbInputDatabase->Checked()) {
          if ($win->rbLAUpdateDB->Checked()) { $message = $STR{'updatedDB'}.'!'; }
          else                               { $message = $STR{'createdDB'}.'!'; }
        } else {
          if ($win->rbDestDBCurr->Checked()) { $message = $STR{'updatedDB'}.'!'; }
          else                               { $message = $STR{'createdDB'}.'!'; }
        }
      } else { $message = "$STR{'Searching'} $STR{'Finished'}"; }
      if (!$functionStr eq $STR{'WebLogAnalysis'} or !$LAFunctionStr eq $STR{'QueryDB'} or !$winReport->chOpenReport->Checked()) {
        Win32::GUI::MessageBox($win, $message , "XL-Parser $VERSION", 0x40040);
      }
      # Select database when finished
      if ($functionStr eq $STR{'WebLogAnalysis'} and (!$win->rbInputDatabase->Checked() or $LAFunctionStr eq $STR{'updateDB'})
          and $win->chLASelectDB->Checked() and my $dbFile = $win->tfDestDir->Text()) {
        $win->lblCurrDBPeriodVal->Text(0); # Force update of Current Database infos
        $win->tfInput->Text($dbFile);
        $win->rbInputDatabase->Checked(1);
        $win->rbInputDir->Checked(0);
        $win->rbInputFiles->Checked(0);
        $win->rbInputClipboard->Checked(0);
        $win->LAFunctions->SetCurSel(0);
        &rbInputDatabase_Click();
      } elsif ($functionStr eq $STR{'WebLogAnalysis'} and $LAFunctionStr eq $STR{'updateDB'}) {
        $win->lblCurrDBPeriodVal->Text(0); # Force update of Current Database infos
        &rbInputDatabase_Click();
      }
    });
  }

}  #--- End btnProcess_Click
  
#--------------------------#
sub btnStop_Click
#--------------------------#
{
  # Stop requests
  $THR_PROCESS->kill('KILL')->detach() if $THR_PROCESS and $THR_PROCESS->is_running();
  return(1);

}  #--- End btnStop_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open Firefox to XL-FileTools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-Parser",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                    ,
                                              -parent      => $win                          ,
                                              -text        => $STR{'about'}.' XL-Parser'    ,
                                              -pos         => [$winPosX, $winPosY]          ,
                                              -size        => [520, 170]                    ,
                                              -background  => [255, 255, 255]               ,
                                              -hasmaximize => 0                             ,
                                              -hasminimize => 1                             ,
                                              -helpbutton  => 0                             ,
                                              -resizable   => 0                             ,
                                              -dialogui    => 1                             , );
  $winAbout->SetIcon($winICO);
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'Version'}:\n$STR{'Website'}:\n$STR{'Author'}:\n$STR{'TranslatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10b                ,
                        -foreground  => [ 50, 180,  0]          ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'TranslatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2016-2017 Alain Rioux', );
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub validRegex
#--------------------------#
{
  # Local variables
  my $regex = shift;
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else {
      # Valid but senseless regex
      return(2, undef) if $regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/;
      return(0, undef);
    }
  }
  
}  #--- End validRegex

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb->lblPbCurr->Text($STR{'cancelling'});
    $winPb->lblCount->Text('');
    &winPb_Terminate;
    $THR->kill('KILL')->detach();
    $winPb->ChangeCursor($ARROW);
  } elsif ($THR_UPDATE and $THR_UPDATE->is_running()) { $THR_UPDATE->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub winPb_Terminate
#--------------------------#
{
  $winPb->Hide();
  if ($winExtraction and $winExtraction->IsVisible()) {
    $winExtraction->Enable();
    $winExtraction->BringWindowToTop();
  } elsif ($winFieldFilter and $winFieldFilter->IsVisible()) {
    $winFieldFilter->Enable();
    $winFieldFilter->BringWindowToTop();
  } elsif ($winLASavedQueries and $winLASavedQueries->IsVisible()) {
    $winLASavedQueries->Enable();
    $winLASavedQueries->BringWindowToTop();
  } else { $win->Enable(); }
  return(1);

}  #--- End winPb_Terminate